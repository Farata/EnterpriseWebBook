<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.7">
<title>Enterprise Web Development: From Desktop to Mobile</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


/*
 * Theme specific overrides of the preceding (asciidoc.css) CSS.
 *
 */
body {
  font-family: Garamond, Georgia, serif;
  font-size: 17px;
  color: #3E4349;
  line-height: 1.3em;
}
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Garmond, Georgia, serif;
  font-weight: normal;
  border-bottom-width: 0;
  color: #3E4349;
}
div.title, caption.title { color: #596673; font-weight: bold; }
h1 { font-size: 240%; }
h2 { font-size: 180%; }
h3 { font-size: 150%; }
h4 { font-size: 130%; }
h5 { font-size: 115%; }
h6 { font-size: 100%; }
#header h1 { margin-top: 0; }
#toc {
  color: #444444;
  line-height: 1.5;
  padding-top: 1.5em;
}
#toctitle {
  font-size: 20px;
}
#toc a {
    border-bottom: 1px dotted #999999;
    color: #444444 !important;
    text-decoration: none !important;
}
#toc a:hover {
    border-bottom: 1px solid #6D4100;
    color: #6D4100 !important;
    text-decoration: none !important;
}
div.toclevel1 { margin-top: 0.2em; font-size: 16px; }
div.toclevel2 { margin-top: 0.15em; font-size: 14px; }
em, dt, td.hdlist1 { color: black; }
strong { color: #3E4349; }
a { color: #004B6B; text-decoration: none; border-bottom: 1px dotted #004B6B; }
a:visited { color: #615FA0; border-bottom: 1px dotted #615FA0; }
a:hover { color: #6D4100; border-bottom: 1px solid #6D4100; }
div.tableblock > table, table.tableblock { border: 3px solid #E8E8E8; }
th.tableblock, td.tableblock { border: 1px solid #E8E8E8; }
ul > li > * { color: #3E4349; }
pre, tt, .monospaced { font-family: Consolas,Menlo,'Deja Vu Sans Mono','Bitstream Vera Sans Mono',monospace; }
tt, .monospaced { font-size: 0.9em; color: black;
}
div.exampleblock > div.content, div.sidebarblock > div.content, div.listingblock > div.content { border-width: 0 0 0 3px; border-color: #E8E8E8; }
div.verseblock { border-left-width: 0; margin-left: 3em; }
div.quoteblock { border-left-width: 3px; margin-left: 0; margin-right: 0;}
div.admonitionblock td.content { border-left: 3px solid #E8E8E8; }
@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(3);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>Enterprise Web Development: From Desktop to Mobile</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<!--
<a href="https://github.com/Farata/EnterpriseWebBook"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Check the book on GitHub"></a> -->

<iframe src="http://ghbtns.com/github-btn.html?user=Farata&repo=EnterpriseWebBook&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="170px" height="30px"></iframe>
</div>
</div>
<div class="sect1">
<h2 id="_table_of_contents">Table of Contents</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Introduction
</p>
</li>
<li>
<p>
Part 1. Desktop
</p>
</li>
<li>
<p>
Ch1. HTML5 and its New APIs
</p>
</li>
<li>
<p>
Ch2. Advanced Intro to JavaScript            (draft&#8217;s ready, not edited)
</p>
</li>
<li>
<p>
Ch3. Mocking Up the Save Sick Child              (draft&#8217;s ready, not edited)
</p>
</li>
<li>
<p>
Ch4. Using Ajax and JSON                     (draft&#8217;s ready, not edited)
</p>
</li>
<li>
<p>
Ch5. Save Sick Child with jQuery             (draft&#8217;s ready, not edited)
</p>
</li>
<li>
<p>
Ch6. Save Sick Child with Ext JS             (work in progress)
</p>
</li>
<li>
<p>
Ch7. Large Scale JavaScript Project
</p>
</li>
<li>
<p>
Ch8. Test-Driven Development with JavaScript (work in progress)
</p>
</li>
<li>
<p>
Ch9. Replacing HTTP with WebSockets          (draft&#8217;s ready, not edited)
</p>
</li>
<li>
<p>
Ch10. Securing Web Applications
s
</p>
</li>
<li>
<p>
Part 2. Mobile
</p>
</li>
<li>
<p>
Ch11. Responsive Design: One Site Fits All   (draft&#8217;s ready, not edited)
</p>
</li>
<li>
<p>
Ch12. Save Sick Child With jQuery Mobile
</p>
</li>
<li>
<p>
Ch13. Save Sick Child With Sencha Touch
</p>
</li>
<li>
<p>
Ch14. Hybrid Applications: HTML + Native API
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>This is a home of the upcoming book «Enterprise Web Development. From Desktop to Mobile». The authors of this book are Yakov Fain, Victor Rasputnis, Viktor Gamov, and Anatole Tartakovsky. They all work for <a href="http://www.faratasystems.com">Farata Systems</a>.</p></div>
<div class="paragraph"><p>This book will be printed in the Summer of 2013, but you can <strong><span class="line-through">enjoy</span></strong> read the current manuscript enterprisewebbook.com. The sources of this book are located at <a href="https://github.com/Farata/EnterpriseWebBook">Github</a>.</p></div>
<div class="paragraph"><p>The book is released under a Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/">license</a> meaning you can both get a copy of the book for free or help to further improve it. This book will be printed and available for purchase via <a href="http://oreilly.com">O’Reilly Media</a>. Readers will have an option of purchasing this book in a number of digital formats.</p></div>
<div class="sect2">
<h3 id="_what_8217_s_an_enterprise_web_application">What&#8217;s an Enterprise Web Application?</h3>
<div class="paragraph"><p>This book has the word Enterprise in its title, which needs to be explained, and we&#8217;ll do it by examples. Creating a Web application that will process orders is not the same as creating a Web site to publish
blogs. Enterprise applications include company-specific workflows, and usually they need to be integrated with number of internal systems, data sources and processes.</p></div>
<div class="paragraph"><p>Google Doc is not an enterprise Web application. But Google appliance integrating search operating on company documents, databases, processes, tickets, and providing collaboration is - it integrates
consumer-workforce front office with what the company does (back office).</p></div>
<div class="paragraph"><p>Google Maps is not an enterprise application. But Google Maps integrated with the company site used by insurance agents to plan daily route, scheduling, doing address verification and geo-coding is.</p></div>
<div class="paragraph"><p>Just using a Web application in some business doesn&#8217;t make it an enterprise Web application. If you take Gmail as is, it won&#8217;t be an enterprise application until you integrate it into another process of your business.</p></div>
<div class="paragraph"><p>Is an online game an enterprise application? It depends on the game. A multi-player online roulette game hooked up to a payment system, and maintaining users' accounts is an enterprise Web application. But
playing Sudoku online doesn&#8217;t feel too enterprisey.</p></div>
<div class="paragraph"><p>How about a dating Web site? If the site just offers an ability to display singles - it&#8217;s just a publishing site as there is not much of a business there. Can you turn a dating Web site into an enterprise
application? It&#8217;s possible.</p></div>
<div class="paragraph"><p>Some people will argue that an enterprise application must supports multiple users, high data load, be scalable, have business and persistence layers, offer professional support et al. We don&#8217;t believe
that a Web application should do all this to qualify for the adjective <em>enterprise</em>.</p></div>
<div class="paragraph"><p>Let&#8217;s create a simple definition of an enterprise Web application:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>"An enterprise Web application is the one that helps an organization running its business online"</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>In this book we are going to build a Save the Child Web application that will allow people to register, donate, find local kids that need help, match donors and recipients, upload images, videos and display
statistics. Would these feature make Save the Child an enterprise Web application? Yes, our non-for-profit organization that collects donations for ill kids is our enterprise.</p></div>
<div class="paragraph"><p>During the last decade the authors of this book worked on many enterprise Web applications using variety of programming languages and frameworks: HTML, JavaScript, Java, and Flex to name a few. Apache Flex
and Java produce compiled code that runs in a well known and predictable virtual machine (JVM and Flash Player respectively).</p></div>
<div class="paragraph"><p>This book is about developing software using what&#8217;s known as HTML5 stack. But only the first chapter of this book will offer you an overview of the selected HTML5 tags and APIs. The second chapter is an
advanced introduction to JavaScript. The rest of the chapters are about designing, re-designing, developing, and re-developing a sample Web site Save Sick Child. You&#8217;ll be learning whatever is required for building this Web application on the go.</p></div>
<div class="paragraph"><p>You&#8217;ll be using dynamic HTML (DHTML), which is HTML5, JavaScript, and Cascading Style
Sheets (CSS). We&#8217;ll add to the mix the XMLHttpRequest object that lives in a Web browser and communicates with the server without the need to refresh the entire Web page (a.k.a. AJAX). JSON will be our data format
of choice for data exchange between the Web browser and the server.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/warning.png" alt="Warning">
</td>
<td class="content">It&#8217;s not possible to provide the detailed coverage of all programming languages, frameworks and tools used in this rather short book. You&#8217;ll need to do some additional reading with more in-depth coverage of certain topics. This book is for practitioner who need to learn while developing a project.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_from_dhtml_to_html5">From DHTML to HTML5</h3>
<div class="paragraph"><p>DHTML has been introduced in Microsoft Internet Explorer (IE) 5, and several years later it was substituted with a more popular acronym AJAX. Back in 1999 Microsoft introduced <span class="monospaced">XMLHttpRequest</span> object to allow the Web version of their mail client Outlook to update the browser&#8217;s window without the need to refresh the entire Web page. The market share of IE5 was about 90% at the time, and in enterprises it was literally the only approved browser.</p></div>
<div class="paragraph"><p>Many years passed by and today&#8217;s Internet ecosystems changed quite a bit. Web browsers are a lot smarter and performance of JavaScript improved substantially. The browsers support 6-8-12 simultaneous connections per domain (as opposed to 2 five years ago), which gave a performance boost to all AJAX applications. At least one third of all Web requests is being made from smart phones or tablets. Apple Inc. started their war against browser&#8217;s plugins hence using embedded Java VM or Flash Player is not an option there. The growing need to support a huge variety of mobile devices gave another boost for HTML5 stack, which is supported by all devices.</p></div>
<div class="paragraph"><p>But choosing HTML5 as the least common denominator that works in various devices and browsers means lowering requirements for your enterprise project. From the very beginning parameters like reliability, ability to adapt to different the screen sizes and densities will be simplified comparing to developing for one specific VM, device or OS. Instead of implementing these features, the functional specification will include testing under several Web browsers, in many different screen sizes and
resolutions. HTML5 developers spend a lot more time in the debugger that people who develop for a known VM.
Get ready to solving problems like a dropdown does not show any data in one browser while working fine in all others. Can you imagine a situation when the click event is not always generated while working in Java, Flex, or Silverlight? Get ready for such surprises while testing your DHTML application.</p></div>
<div class="paragraph"><p>You&#8217;ll save some time because there is no need to compile JavaScript, but you&#8217;ll spend more time testing deployed code. The final deliverable of an HTML5 project may have as low as half of the functionality
comparing to the same project developed for a VM. But you&#8217;ll gain a little better Web adaptability, easier implementation of full text search and mashups. The integration with other technologies will also
become easier with HTML/JavaScript. If all these advantages are important to your application choose HTML5.</p></div>
<div class="paragraph"><p>JavaScript will enforce its limitations on any serious and complex enterprise project. You can develop a number of fairly independent windows, but creating a well tested and reliable HTML5 takes time.</p></div>
<div class="paragraph"><p>In this book we&#8217;ll be using some JavaScript frameworks - the are dozens of those on the market. Several of them promise to cover all the needs of your Web application. Overall, there are two main categories of
frameworks:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>a) Those that allow you to take an existing DHTML Web site and easily add new attributes to all or some page elements so they would start shining, blinking, or do some other fun stuff. Such frameworks don&#8217;t promote component-based development. They may not include navigation components, grids, trees, which are pretty typical for any UI of the corporate tasks. JQuery is probably the best representative of this group- it&#8217;s light (30Kb), extendable, and easy to learn.</p></div>
<div class="paragraph"><p>b) Another group of frameworks offers rich libraries of high-level components and allow you to extend them.But overall, such components are supposed to be used together becoming a platform for your Web UI. These components process some events, offer support of the Model-View-Controller paradigm, have a proprietary way of laying out elements on the Web page, organize navigation et al. Ext JS from Sencha belongs to this group.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>We&#8217;ll use both JQuery and Ext JS and will show you how to develop Web applications with each of these popular frameworks. JQuery is good for improving an existing JavaScript site. JQuery can be used to program
about 80% of a Web site. You should use it for the look and feel support, which is what it&#8217;s meant for. But you can&#8217;t use it for building your application component model. The component model of Ext JS is
applicable in about 20% of a Web site, which includes an application piece rather than just being a set of Web pages. Typically it&#8217;s a serious view navigator or a wizard to implement a serious business
process or a workflow that includes a client&#8217;s part.</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>JavaScript frameworks are hiding from software developers all incompatibilities and take care of the cases when a Web browser doesn&#8217;t support some HTML5, CSS3, or JavaScript features yet.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>High-level UI components and a workflow support are needed for a typical enterprise application where the user needs to perform several steps to complete the business process. And these 20% of an application&#8217;s code will require 80% of the project time of complex development. So choosing a framework is not the most difficult task. The main problem with DHTML projects is not how to pick the best JavaScript framework for
development, but finding the right software developers. Lack of qualified developers increases the importance of using specialized frameworks for code testing. The entire code base must be thoroughly
tested over and over again. We&#8217;ll discuss this subject in the Chapter 5 dedicated to test-driven development.</p></div>
<div class="paragraph"><p>A JavaScript developer has to remember all unfinished pieces of code. Many things that we take for granted with compiled languages simply don&#8217;t exist in JavaScript. For example, in Java or C# just by looking at
the method signature you know what are the data types of the method&#8217;s parameters. In JavaScript you can only guess if the parameter names are self descriptive. Take the Google&#8217;s framework GWT that allows developers write code in Java with auto-generation of the JavaScript code. Writing code in one language with further conversion and deployment in another one is a controversial idea unless the source and generated languages are very similar. We&#8217;re not big fans of GWT, because after writing the code you&#8217;ll need
to be able to debug it. This is when a Java developer meets a foreign language JavaScript.The ideology and psychology of programming in JavaScript and Java are different. A person who writes in Java/GWT has
to know how to read and interpret deployed JavaScript code. On the other hand, using TypeScript or CoffeeScript to produce JavaScript code can be a time saver.</p></div>
<div class="paragraph"><p>The Ext JS framework creators decided to extend JavaScript introducing their version of classes and more familiar syntax for object-oriented languages. Technically they are extending or replacing the constructs of the JavaScript itself extending the alphabet. Ext JS recommends creating objects using <span class="monospaced">ext.create</span> instead of the operator <span class="monospaced">new</span>. But Ext JS is still a JavaScript framework.</p></div>
<div class="paragraph"><p>JQuery framework substantially simplifies working with browser&#8217;s DOM elements and there are millions of small components that know how to do one thing well, for example, an image slider. But it&#8217;s still JavaScript and requires developers to understand the power of JavaScript functions, callbacks, and closures.</p></div>
</div>
<div class="sect2">
<h3 id="_should_we_develop_in_html5_if_its_standard_is_not_finalized_yet">Should we develop in HTML5 if its standard is not finalized yet?</h3>
<div class="paragraph"><p>The short answer is yes. If you are planning to develop mainly for the mobile market, it&#8217;s well equipped with the latest Web browsers and if you&#8217;ll run into issues there. they won&#8217;t be caused by the lack of HTML5
support. In the market of the enterprise Web applications, the aging Internet Explorer 8 is still being widely used and they don&#8217;t support some of the HTML5 specific features. But it&#8217;s not a show stopper either.If you are using one of the JavaScript frameworks that offers cross-browser compatibility, most likely, they take care of IE8 issues.</p></div>
<div class="paragraph"><p>The more conservative approach to achieving the browser compatibility is not by relying on the framework promises, but by testing and adjusting your application in different browsers. The chances are that you may
need to be fixing the framework&#8217;s code here and there. Maintaining compatibility is a huge challenge for any framework&#8217;s vendor, which in some cases can consist of just one developer. You shouldn&#8217;t have hard
feelings against the developers behind the framework of your choice. These guys simply don&#8217;t have time to fix everything. You need to form an attitude that a JavaScript framework is similar to a good Legos set that will require your creativity too. Don&#8217;t get angry. Cure the framework. Spend some time working on the framework, and then work on your application code. Ideally, submit your fixes back to the framework&#8217;s
code base - most of them are open source.</p></div>
<div class="paragraph"><p>If you are planning to write pure JavaScript, add a tiny framework Modernizr to your code base, which will detect if a certain feature is supported by the user&#8217;s Web browser, and if not - provide an alternative solution. We like the analogy with TV sets. People with latest 3D HD TV sets and those who have 50-year old black and white televisions can watch the same movie even though the quality of the picture will be drastically different.</p></div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="paragraph"><p>If you are starting working on your first HTML5 enterprise project, get ready to solve the same tasks as Java, JavaFX, Silverlight, or Flexdevelopers face:</p></div>
<div class="ulist"><ul>
<li>
<p>
Reliability of the network communications. What if the data never arrive from/to the server? Is it possible to recover the lost data? Where they got lost? Can we re-send the lost data? What to do with
duplicates?
</p>
</li>
<li>
<p>
Modularization of your application. If your application has certain rarely used menus don&#8217;t even load the code that handles this menu.
</p>
</li>
<li>
<p>
Perceived performance. How quickly the main window of your application is loaded to the user&#8217;s computer? How heavy is the framework&#8217;s code base?
</p>
</li>
<li>
<p>
Should you store the application state on the server or on the client?
</p>
</li>
<li>
<p>
Does the framework offer a rich library of components?
</p>
</li>
<li>
<p>
Does the framework support creation of loosely coupled application components? Is the event model well designed?
</p>
</li>
<li>
<p>
Does the framework of your choice cover most of the needs of your application, or you&#8217;ll need to use several frameworks?
</p>
</li>
<li>
<p>
Is well written documentation available?
</p>
</li>
<li>
<p>
Does the framework of your choice locks you in? Does it restrict your choices? Can you easily replace this framework with another one if need be?
</p>
</li>
<li>
<p>
Is there an active community to ask for help with technical questions?
</p>
</li>
</ul></div>
<div class="paragraph"><p>We could continue adding items to this list. But our main message is that developing HTML5 applications is not just about adding tag video and canvas to a Web page. It&#8217;s about serious JavaScript programming.</p></div>
</div>
</div>
</div>
<h1 id="_part_1_desktop">Part 1: Desktop</h1>
<div class="sect1">
<h2 id="_html5_and_its_new_apis">HTML5 and its New APIs</h2>
<div class="sectionbody">
<div class="paragraph"><p>This is the first and only chapter in this book that&#8217;s dedicated to HTML5. You&#8217;ll get familiar with some new HTML tags that were introduced to make the markup more semantic and convenient. We&#8217;ll also provide a brief overview of selected APIs that are included in HTML5 spec (Web Storage, WebSQL, Web
Sockets, and Web Workers).</p></div>
<div class="paragraph"><p>The majority of the modern Web browsers already support the current version of HTML5 specification. The question is if the users of your Web application have or rather can have a modern browser installed on
their device? There are two groups of users that will stick to the outdated browsers for some time:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Computer illiterate people who are afraid of installing any new software one their PCs. Especially, people of the older generation. <em>"John, after the last visit of our grandson our computer works even slower than before. Please don&#8217;t let him install these new fancy browsers here. I just need my old Internet Explorer, access to Hotmail and Facebook".</em>
</p>
</li>
<li>
<p>
Business users working for large corporations, where all the installations of the software on their PCs is done by professional system administrators. They say, <em>"We have 50000 PCs in or firm. An upgrade from Internet Explorer version 8 to version 9 is a major undertaking. Internal users work with about a hundred Web applications on a regular basis. They can install whatever browser they want, but if some of these application won&#8217;t work as expected, the users will flood us with support requests we&#8217;re not qualified to resolve</em> . Hence the strategy of using the lowest denominator browser often wins.
</p>
</li>
</ol></div>
<div class="paragraph"><p>In the worst case scenario, Web developers need to make both of these groups happy. Take an online banking - this old couple has to be able to use your Web application from their old PCs otherwise they can transfer their lifetime savings to a different bank which doesn&#8217;t require the later version of Firefox for online banking.</p></div>
<div class="paragraph"><p>Does it mean that enterprise Web developers shouldn&#8217;t even bother using HTML5 that&#8217;s not 100% supported? Not at all. This means that a substantial portion of their application&#8217;s code will be will be bloated
by the if-statements figuring out what this specific Web browser supports and providing several solutions that keep your application on float in any Web browser. This what makes the job of DHTML developers a lot more difficult than of, say Java developers who know exactly the environment where their code will work. Of you don&#8217;t install the JavaRuntime of version 1.6 our application won&#8217;t work. As simple as
that. How about asking Java developers writing applications that will work in any runtime released during the last 10 years? No, we&#8217;re not that nasty.</p></div>
<div class="paragraph"><p>Do you believe it would be a good idea for Amazon or Facebook to re-write their UI in Java? Of course not unless they want to loose half of their customers who will be scared to death after seeing the message
of the 20-step Java installer asking for the access to the internals of their computer. Each author of this book is a Java developer, and we love using Java… on the server side. But when it comes to the consumer facing Web applications it&#8217;s just not there yet.</p></div>
<div class="paragraph"><p>So what&#8217;s the bottom line? We have to learn how to develop Web applications that won&#8217;t require installing any new software on the user&#8217;s machines. Today it&#8217;s DHTML or, let&#8217;s stick to the modern terminology,
HTML5 stack.</p></div>
<div class="paragraph"><p>In the unfortunate event of needing to support both new and old HTML and CSS implementations you can use <a href="http://html5boilerplate.com/">HTML5 Boilerplate</a> that is not a framework, but a template for creating a new
HTML project that will support HTML5 and CSS3 elements but will work even in the hostile environments of the older browsers. It&#8217;s like broadcasting a TV show in HD, but letting the cavemen with the 50-year
old black-and-white tubes watching it too.</p></div>
<div class="paragraph"><p>HTML Boilerplate comes is a really simple way to start your project pre-packaged with solutions and workarounds offered by well known gurus in the industry. Make no mistake, your codebase may be larger that you wanted - for example, the initial CSS starts with 500 lines accommodating the old and new browsers, but it may be your safety net.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Watch
<a href="http://net.tutsplus.com/tutorials/html-css-techniques/the-official-guide-to-html5-boilerplate/">this
screencast by Paul Irish</a>, a co-creator of HTML5 Boilerplate. You can also read the current version of the
<a href="https://github.com/h5bp/html5-boilerplate/blob/v4.0.0/doc/usage.md">Getting started with HTML5 Boilerplate</a> on Github.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_overview_of_selected_html_5_tags">Overview of Selected HTML 5 Tags</h3>
<div class="paragraph"><p>In this section we&#8217;ll overview a small set of the new HTML5 tags and attributes that are very practical for enterprise Web developers. For example, we are not going to review the <span class="monospaced">&lt;canvas&gt;</span> tag that allows you to draw freely in a predefined rectangular area. But we will show you some HTML5 goodies that are practical and useful for Web forms.</p></div>
<div class="sect3">
<h4 id="_html5_forms_brief_overview">HTML5 Forms: Brief Overview</h4>
<div class="paragraph"><p>It&#8217;s hard to imagine an enterprise Web application that is not using forms. At the very minimum the Contact Us form has to be there. A login view is yet another example of the HTML form that almost every enterprise application needs. Our sample application Save Sick Child will need it too.</p></div>
<div class="paragraph"><p>We&#8217;ll start with the prompts. Showing the hints or prompts right inside the input field will save you some screen space. HTML5 has a special attribute <span class="monospaced">placeholder</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_html5_new_apis">HTML5 New APIs</h3>
<div class="paragraph"><p>TODO</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_introduction_to_javascript">Advanced Introduction to JavaScript</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter is dedicated to the JavaScript programming language. Our challenging goal is "From Zero to Hero in 50 pages". While in the future chapters you&#8217;ll see how JavaScript frameworks can greatly minimize the amount of the JavaScript code that you need to write manually, you still need to understand the language itself.</p></div>
<div class="paragraph"><p>This chapter starts with basics of the language, but then it quickly progresses to such advanced topics
as <em>prototypal inheritance, callbacks, and closures</em>. If you prefer fat manuals covering each and every detail of programming languages, we can recommend you the book "JavaScript: The Definite Guide", Sixth Edition by David Flanagan.</p></div>
<div class="paragraph"><p>Besides the JavaScript coverage this chapter includes a section on the tools (IDEs, debuggers, Web inspectors et al.) that will make your development process more productive.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/important.png" alt="Important">
</td>
<td class="content">While you can skip some sections of this book as not relevant to your needs, we recommend you to read each section of this chapter in order. Most of the materials presented here expect you to understand the previous content of this chapter.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_javascript_a_brief_history">JavaScript: A Brief History</h3>
<div class="paragraph"><p>The JavaScript programming language was designed in 1995 by Brendan Eich, who was working for Netscape Communications Corporation at the time. His goal was to allow developers create more interactive Web pages. Initially the name of this language was Mocha, then LiveScript, and finally Netscape agreed with Sun Microsystems, creator of Java to rename it to JavaScript.</p></div>
<div class="paragraph"><p>A year later, the language was given to an international standards body called ECMA, which formalized the language into <em>ECMAScript standard</em> so that other Web browser vendors could create their implementation of this standard. JavaScript is not the only language created based on the ECMAScript specification - ActionScript is a good example of another popular dialect of ECMAScript.</p></div>
<div class="paragraph"><p>To learn more about the history of JavaScript from the source watch the Brendan Eich’s presentation
<a href="http://www.youtube.com/watch?v=Rj49rmc01Hs">"JavaScript at 17"</a> at O’Reilly’s conference Fluent 2012.</p></div>
<div class="paragraph"><p>Vast majority of today&#8217;s JavaScript code is being executed by the Web browsers, butthere are JavaScript engines that can execute JavaScript code independently. For example, <a href="http://code.google.com/p/v8/">Google’s V8</a> JavaScript engine implements ECMAScript 5 and is used not only in the Chrome browser, but can run in a standalone mode and can be embedded in any C++ application. Using the same programming language on the client and the server is the main selling point of node.js, which runs in V8. Oracle’s Java Development Kit (JDK) 8 will include the JavaScript engine Nashorn that not only can run on both the server and the client computers, but also allows to embed the fragments of JavaScript into Java programs.</p></div>
<div class="paragraph"><p>In the 90th, JavaScript was considered a second class language used mainly for prettifying Web pages. In 2005 the techniques known as AJAX (see Chapter 4) made a significant impact to the way Web pages were built. With AJAX, the specific content inside the Web page could be updated without the need to make a full page refresh. For example, Google&#8217;s gmail that inserts just one line at the top of your input box whenever the new email arrives - it doesn&#8217;t re-retrieve the entire content of your Inbox from the server.</p></div>
<div class="paragraph"><p>AJAX gave a second birth to JavaScript. But the vendors of Web browsers were not eager to implement the latest specifications of ECMAScript. Browsers’ incompatibility and lack of good development tools  prevented JavaScript from becoming the language of choice for Web applications. Let’s not forget about the ubiquitous Flash Player – an excellent VM supported by all desktop Web browsers. Rich Internet Applications written in ActionScript were compiled into the byte code and executed by Flash Player on the user’s machine inside the Web browser.</p></div>
<div class="paragraph"><p>If AJAX saved JavaScript, then rapid proliferation of tablets and smartphones made it really hot. Today&#8217;s mobile devices come equipped with modern Web browsers, and in the mobile world there is no need to make sure that your Web application will work in the 4-year old Internet Explorer 8. Adobe&#8217;s decision to stop supporting Flash Player in the mobile Web browsers is yet another reason to turn to JavaScript if your Web application has to be accessed from smartphones or tablets.</p></div>
<div class="paragraph"><p>ECMASript, 5th Edition has been published in 2009 and is currently supported by all modern Web browsers. If you are interested in discovering if specific features of ECMAScript 5 are supported by a particular Web browser, check the latest version of the <a href="http://kangax.github.com/es5-compat-table/#">ECMAScript 5
compatibility table</a>. At the time of this writing the snapshot of the Chrome Browser v. 22 looks as in <a href="#FIG2-1">[FIG2-1]</a> below:</p></div>
<div class="imageblock" id="FIG2-1">
<div class="content">
<img src="images/fig_02_01.jpg" alt="images/fig_02_01.jpg">
</div>
<div class="title">Figure 1. ECMAScript 5 Compatibility Sample Chart</div>
</div>
<div class="paragraph"><p>JavaScript became the lowest common denominator available on thousands of different devices. Yes, the JavaScript engines are not exactly the same on thousands devices that people use to login to Facebook,
but they are pretty close, and using some of the JavaScript frameworks spare you from worrying about their incompatibilities.</p></div>
<div class="paragraph"><p>JavaScript is an interpreted language that arrives to the Web browser as text. The JavaScript engine optimizes and compiles the code before the execution. If the JavaScript engine is a part of a Web page, the browser will load and execute the JavaScript code embedded or referenced between the HTML tags <span class="monospaced">&lt;script&gt;</span> and <span class="monospaced">&lt;/script&gt;</span>. JavaScript was originally created for Web browsers, which were supposed to display whatever content has successfully arrived. What if an image has not arrived from the server? You’ll see a broken image icon. What if erroneous JavaScript code with syntax errors has arrived to the browser? Well, the engine will try to execute whatever has arrived. The end users may appreciate such browser&#8217;s forgiveness when at least some content is available, but the software developers should be ready to spend more time debugging (in multiple browsers) the errors that could have been caught by compilers in other programming languages.</p></div>
</div>
<div class="sect2">
<h3 id="_why_declaring_javascript_variables">Why Declaring JavaScript Variables</h3>
<div class="paragraph"><p>JavaScript is a weakly typed language hence the developers don’t have a luxury of strong compiler&#8217;s help that Java or C# developers enjoy. This is easily explainable. Imagine that if in Java or C# instead of declaring variables of specific data types everything would be of type <span class="monospaced">Object</span>, and you could assign to it any value – a string, a number, or a custom object <span class="monospaced">Person</span>. This would substantially complicate the ability of the compiler to weed out all possible errors. You don’t need to declare variables in JavaScript – just assign a value and the JavaScript engine will figure out the proper type during the execution of your code.For example, the variable named <span class="monospaced">girlfriend</span> will have a data type of <span class="monospaced">String</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>girlfriendName=“Mary”;</pre>
</div></div>
<div class="paragraph"><p>Since I haven’t used the keyword <span class="monospaced">var</span> in front of <span class="monospaced">girlfriend</span>, this variable will have the global scope. Variables declared with <span class="monospaced">var</span> inside functions are local. Consider the following function declaration:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">addPersonalInfo</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> address <span style="color: #990000">=</span><span style="color: #FF0000">"123 Main Street"</span><span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// local String variable</span></span>
   age<span style="color: #990000">=</span><span style="color: #993399">25</span><span style="color: #990000">;</span>                              <span style="font-style: italic"><span style="color: #9A1900">// global Number variable</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> isMarried <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>                <span style="font-style: italic"><span style="color: #9A1900">// local boolean variable</span></span>
       isMarried <span style="color: #990000">=</span> <span style="color: #FF0000">"don't remember"</span><span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">// now it's of String type</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The variables <span class="monospaced">address</span> and <span class="monospaced">isMarried</span> are visible only inside the function <span class="monospaced">addPersonalInfo()</span>. The variable <span class="monospaced">age</span> becomes global because of omission of the keyword <span class="monospaced">var</span>. In Chapter 3, you&#8217;ll see an example of how to limit the scope of the variables to avoid polluting the global name space.</p></div>
<div class="paragraph"><p>The variable <span class="monospaced">isMarried</span> changes its type from <span class="monospaced">Boolean</span> to <span class="monospaced">String</span> during the execution of the above script, and JavaScript engine won&#8217;t complain assuming that the programmer knows what she’s doing. So be ready for the run-time surprises and allocate a lot more time for testing than with programs written in  compiled languages.</p></div>
<div class="paragraph"><p>Yet another moving part is the JavaScript engine where your code will run. Unless you are developing for strictly controlled enterprise environment you can&#8217;t assume that the end-user will have the same runtime as yours. You must test your code in multiple Web browsers.</p></div>
</div>
<div class="sect2">
<h3 id="_which_ide_to_use">Which IDE to Use</h3>
<div class="paragraph"><p>Selecting an Integrated Development Environment (IDE) that supports JavaScript is a matter of your personal preference. Since there is no compilation stage and most of your debugging will be done using the Web browser tools, picking a text editor that supports syntax highlighting is all that most developers need. For example, there is an excellent commercial text editor <a href="http://www.sublimetext.com">Sublime Text 2</a>. Among many programming languages this editor understands the keywords of HTML, CSS, and JavaScript, and it offers not only syntax highlighting, context sensitive help, and auto-complete too.</p></div>
<div class="paragraph"><p>If you are coming from the Java background, the chances are that you are familiar with free and open sourced Eclipse IDE. In this case install the Eclipse plugin <a href="https://www.ebayopensource.org/index.php/VJET/HomePage">VJET by eBay</a>.</p></div>
<div class="paragraph"><p>Oracle&#8217;s IDE <a href="http://wiki.netbeans.org/HTML5">NetBeans 7.3</a> and above support HTML5 and JavaScript development and includes JavaScript debugger that allows your code to connect to the Web browser, while debugging inside the IDE. If you prefer Microsoft technologies, they offer excellent JavaScript support in Visual Studio 2012.</p></div>
<div class="paragraph"><p>In this book we&#8217;ll use an Eclipse-based <a href="http://aptana.com">Aptana Studio 3 IDE</a>. Aptana Studio is available free of charge.  Aptana Studio comes with embedded Web Server so you can test your JavaScript code without the need to start any additional software. In this chapter we’ll use Aptana Studio IDE to
illustrate the features of JavaScript, and in the next chapter you&#8217;ll be working with a number of Aptana projects that will lead you through the development of the first version of our Save Sick Child Web application.</p></div>
<div class="paragraph"><p>For the real world development we recommend using commercial <a href="http://www.jetbrains.com/webstorm">IDE WebStorm</a> from JetBrains. In addition to smart context sensitive help, auto-complete, and syntax
highlighting it offers HTML5 templates, and the code coverage feature that identifies the code fragment that haven&#8217;t been tested. All of the editors and IDEs listed here are either available for free or are priced in the area of $60 USD. Try them all and pick the one that best fits your coding habits.</p></div>
</div>
<div class="sect2">
<h3 id="_getting_familiar_with_aptana_ide">Getting Familiar with Aptana IDE</h3>
<div class="paragraph"><p>Download and install Aptana Studio 3 from <a href="http://aptana.com">http://aptana.com</a>. Start Aptana and close the start page it displays by clicking on the little X on the tab. Then customize the color theme of this IDE by clicking the rainbow-colored circle on its toolbar. We usually select the theme called Eclipse. After the first start of Aptana you’ll see the message on the left side that reads &#8220;There are no projects in your workspace. To get started, please create or import an existing one.&#8221;</p></div>
<div class="paragraph"><p>If you want to start playing with the code samples that come with this book, click on the button Import Project, select the General | Archive file. Find the zip file you&#8217;d like to use, e.g. chapter2.zip, and press Finish. The project from the selected zip file will be imported into the Aptana&#8217;s <em>workspace</em>, which is nothing more than a folder on the disk where the source code will reside. When you work in Aptana IDE you see a set of <em>views</em> (panels). This set is called <em>perspective</em>. For Web projects Aptana uses Web perspective, which is indicated at the top right corner. Pressing the icon with a little pus sign at the top right allows to open another perspective with its own set of views.</p></div>
<div class="paragraph"><p>Let&#8217;s get started with creating a project from scratch by pressing the button Create Project on the left. You could have also created a new Web Project using the File menu. On the next window you&#8217;ll need to select a wizard, and we&#8217;ll be always working with Web Projects throughout this book. The next window will offer you to select a project template - let&#8217;s stick to the simplest one - Default Project. Name it  MyFirstProject.</p></div>
<div class="paragraph"><p>To add an HTML file to this project select the menu File | New From Template | HTML | HTML5 Template. Aptana will offer you new_file.html the name of this file - no need to change it for now. Just press finish and you&#8217;ll see a window similar to the one shown on <a href="#FIG2-2">[FIG2-2]</a>.</p></div>
<div class="imageblock" id="FIG2-2">
<div class="content">
<img src="images/fig_02_02.jpg" alt="images/fig_02_02.jpg">
</div>
<div class="title">Figure 2. Aptana IDE with one HTML5 file</div>
</div>
<div class="paragraph"><p>Right-click on the new_file.html and select the menu Run as JavaScript Web project. Don&#8217;t get upset that there is no JavaScript code there yet - we&#8217;ll add it pretty soon. Aptana starts its built-in Web server that by default runs on the port 8020 (it&#8217;s configurable in Aptana Preferences). The Web browser opens up and displays the page that looks like the one in <a href="#FIG2-3">[FIG2-3]</a>. Aptana has used its default template to generate HTML file. The template can be changed to your liking, and you can read about it in Aptana&#8217;s documentation at <a href="http://bitly.com/LRqRdU">http://bitly.com/LRqRdU</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you have your index.html open in Aptana&#8217;s editor, you can simply press the green triangle on the toolbar and run this file in the Web browser.</td>
</tr></table>
</div>
<div class="imageblock" id="FIG2-3">
<div class="content">
<img src="images/fig_02_03.jpg" alt="images/fig_02_03.jpg">
</div>
<div class="title">Figure 3. Running MyFirstProject</div>
</div>
<div class="paragraph"><p>To configure the Web Browser that Aptana should open by default, open its Preferences window and select the Web browser of your choice under the General section. Many examples in this chapter use the Firefox with installed add-on Firebug, so start with making Firefox your default browser.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">you can find various HTML5 boilerplate projects on the Web that can be used as a starting point of your project. You don&#8217;t have to select the Aptana&#8217;s HTML5 boilerplate if it doesn&#8217;t fit your needs. For example, you can download a bare minimum boilerplate <a href="http://projects.craftedpixelz.co.uk/shibui/">Shibui</a>
or more comprehensive <a href="http://html5boilerplate.com/">HTML5 Boilerplate</a>. Just download and unzip such a boilerplate project into your Aptana&#8217;s workspace and start adding your code, styles, and other resources.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_adding_javascript_to_html">Adding JavaScript to HTML</h3>
<div class="paragraph"><p>If your JavaScript is a part of HTML document, typically, you&#8217;ll be adding your <span class="monospaced">&lt;script&gt;</span> tags at the end of HTML file. The reason is simple - your JavaScript code may be manipulating with HTML elements, and you want them to exist by the time the script runs. The other way to ensure that the code is not running unless the Web page has loaded is by catching window&#8217;s <span class="monospaced">load</span> event, and you&#8217;ll see such example later in this chapter in the section on browser&#8217;s events. Some JavaScript frameworks may have their own approach to dealing with HTML content and in Chapter 7 you&#8217;ll see that the main HTML file of the Web application written with Ext JS framework has <span class="monospaced">&lt;script&gt;</span> tags followed by the empty <span class="monospaced">&lt;body&gt;</span> tags. But let&#8217;s keep things simple for now.</p></div>
<div class="paragraph"><p>Add the following fragment at the very end (right above the closing <span class="monospaced">&lt;/body&gt;</span> tag) of the new_file.html from <a href="#FIG2-2">[FIG2-2]</a>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello from JavaScript"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Run the new_file.html in Aptana and you&#8217;ll see the following output in your Web browser:</p></div>
<div class="imageblock" id="FIG2-4">
<div class="content">
<img src="images/fig_02_04.jpg" alt="images/fig_02_04.jpg">
</div>
<div class="title">Figure 4. Running MyFirstProject with JavaScript at the bottom</div>
</div>
<div class="paragraph"><p>Note that the <span class="monospaced">Alert</span> popup box is shown on top of the Web page that already rendered all of its HTML components. Now move the above code up to the end of the <span class="monospaced">&lt;head&gt;</span> section and re-run new_file.html. The picture is different now - the Alert box is shown before the HTML rendering is complete.</p></div>
<div class="imageblock" id="FIG2-5">
<div class="content">
<img src="images/fig_02_05.jpg" alt="images/fig_02_05.jpg">
</div>
<div class="title">Figure 5. Running MyFirstProject with JavaScript at the top</div>
</div>
<div class="paragraph"><p>In this simple example this doesn&#8217;t cause any malfunctioning of the code, but if our JavaScript would need to manipulate with HTML elements, we&#8217;d run into issues of accessing non-existent components. Beside simple <span class="monospaced">Alert</span> box, JavaScript has <span class="monospaced">Confirm</span> and <span class="monospaced">Prompt</span> boxes, which allow asking OK/Cancel type of questions or request some input from the user.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">In a real life you won&#8217;t be deploying your projects under Aptana&#8217;s internal Web server. When you code is tested you can FTP it to a remote server of your choice, e.g. Apache Web Server or IIS. Right-click on your Aptana project and select the menu option Publish. This will allow you to configure the FTP connection to your remote server and publish your working code there as you wish.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_javascript_in_web_browsers">Debugging JavaScript in Web Browsers</h3>
<div class="paragraph"><p>The best way to learn any program is to run it step by step through a debugger. While some people appreciate using debuggers offered by Aptana, NetBeans, or Visual Studio, we prefer to debug using great tools offered by the major Web browsers:</p></div>
<div class="ulist"><ul>
<li>
<p>
Firefox: FireBug add-on
</p>
</li>
<li>
<p>
Chrome: Developer Tools
</p>
</li>
<li>
<p>
Internet Explorer: F12 Developer Tools
</p>
</li>
<li>
<p>
Safari: the menu Develop
</p>
</li>
<li>
<p>
Opera: Dragonfly
</p>
</li>
</ul></div>
<div class="paragraph"><p>We&#8217;ll be doing most of the debugging in FireBug or Chrome Developer Tools. Both of them provide valuable information about your code and are easy to use. To get FireBug go to <a href="http://www.getfirebug.com">www.getfirebug.com</a> and press the red button Install Firebug and follow the instructions. In Firefox, open the Firebug panel from the menu View.</p></div>
<div class="imageblock" id="FIG2-6">
<div class="content">
<img src="images/fig_02_06.jpg" alt="images/fig_02_06.jpg">
</div>
<div class="title">Figure 6. FireBug Console</div>
</div>
<div class="paragraph"><p>Select the Console option on the Firebug toolbar and enter <span class="monospaced">alert("Hello from JavaScript")</span> after the &gt;&gt;&gt; sign and you&#8217;ll see the Alert box. To enter multi-line JavaScript code press the little circle with a caret at the bottom right corner and FireBug will open a panel on the right, where you can enter and run your JavaScript code.</p></div>
<div class="paragraph"><p>This was probably the last example where we used the <span class="monospaced">Alert()</span> popup box for debugging purposes. All JavaScript debuggers support the <span class="monospaced">console.log()</span> for printing debug information.  Consider the following example that illustrate strict equality operator ===. Yes, it&#8217;s three equal signs in a row. This operator evaluates to true if the values are equal and the data types are the same.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> age<span style="color: #990000">=</span><span style="color: #993399">25</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ageStr<span style="color: #990000">=</span><span style="color: #FF0000">"25"</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>age<span style="color: #990000">==</span>ageStr<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
  console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The values of age and ageStr are equal"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>age<span style="color: #990000">===</span>ageStr<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
 console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The values of age and ageStr are strictly equal"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #FF0000">{</span>
 console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">"The values of age and ageStr are not strictly equal"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Running this code in the FireBug console produces the following output:</p></div>
<div class="imageblock" id="FIG2-7">
<div class="content">
<img src="images/fig_02_07.jpg" alt="images/fig_02_07.jpg">
</div>
<div class="title">Figure 7. Using console.log() for the debug output</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">You can also use <span class="monospaced">console.info()</span>, <span class="monospaced">console.debug()</span>, and <span class="monospaced">console.error()</span> so the debuggers may  highlight the output with different colors or mark with different icons.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">For more information about debugging JavaScript refer to the code samples illustrated in <a href="#FIG2-8">[FIG2-8]</a> and <a href="#FIG2-9">[FIG2-9]</a>.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_functions_gentle_introduction">JavaScript Functions. Gentle Introduction</h3>
<div class="paragraph"><p>Now comes the chicken or the egg dilemma. What should be explained first - functions or objects? Understanding of objects is needed for some of the function code samples and visa versa. We&#8217;ll start with simple function use cases, but will be switching to objects as needed.</p></div>
<div class="paragraph"><p>Many of the readers can have experience with object-oriented languages like Java or C#, where classes can include <em>methods</em> implementing required functionality. Then these methods can be invoked with or without instantiation of the objects. If a JavaScript object includes functions they are called <em>methods</em>. But JavaScript functions don&#8217;t have to belong to an object. You can just declare a function and invoke it. Just like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//Function declaration</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">calcTax</span></span> <span style="color: #990000">(</span>income<span style="color: #990000">,</span> dependents<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tax<span style="color: #990000">;</span>
   <span style="font-style: italic"><span style="color: #9A1900">// Do stuff here</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> tax<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">//Function invocation</span></span>
<span style="font-weight: bold"><span style="color: #000000">calcTax</span></span><span style="color: #990000">(</span><span style="color: #993399">50000</span><span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTax <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">calcTax</span></span><span style="color: #990000">(</span><span style="color: #993399">50000</span><span style="color: #990000">,</span><span style="color: #993399">2</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Please note that the data types of the function parameters <span class="monospaced">income</span> and <span class="monospaced">dependents</span> are not specified. We can only guess that they are numbers based on their names. If a software developer won&#8217;t bother giving meaningful names to function parameters, the code becomes difficult to read. After the function <span class="monospaced">calcTax()</span> is invoked and complete, the variable <span class="monospaced">myTax</span> will have the value returned by the function.
In the above code sample the JavaScript engine will not evaluate the function <span class="monospaced">calcTax()</span> until it&#8217;s actually invoked.</p></div>
<div class="paragraph"><p>Another important thing to notice is that our function has a name <span class="monospaced">calcTax</span>. But this is not always the case - JavaScript allows functions to be <em>anonymous</em>. If you see the line of code where the keyword <span class="monospaced">function</span> is preceded by any other character this is not a function declaration, but a function expression. Consider the following variation of the tax calculation sample:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">//Function expression</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> doTax<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>income<span style="color: #990000">,</span> dependents<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">//do stuff here</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> tax<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">//Function invocation</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTax<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #000000">doTax</span></span><span style="color: #990000">(</span><span style="color: #993399">50000</span><span style="color: #990000">,</span><span style="color: #993399">2</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>In the code above the <span class="monospaced">function</span> keyword is being used in the expression - we assign the anonymous function to the variable <span class="monospaced">doTax</span>. After this assignment just the text of the function is assigned to the variable <span class="monospaced">doTax</span> - the anonymous function is not being invoked just yet. It&#8217;s important to understand that even though the code of this anonymous function ends with <span class="monospaced">return tax;</span> actually, the tax calculation and return of its value is not happening until the <span class="monospaced">doTax()</span> is invoked. Only then the function is evaluated and the variable <span class="monospaced">myTax</span> will get whatever value this function returns.</p></div>
<div class="paragraph"><p>Yet another example of a function expression is when it&#8217;s placed inside the <em>grouping operator</em> - parentheses as shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">calcTax</span></span> <span style="color: #990000">(</span>income<span style="color: #990000">,</span> dependents<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
   <span style="font-style: italic"><span style="color: #9A1900">// Do stuff here</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Another interesting concept of JavaScript is self-executing functions. Adding an extra pair of parentheses will cause the function expression located in the first set of parentheses to be executed right away.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">calcTax</span></span> <span style="color: #990000">(</span>income<span style="color: #990000">,</span> dependents<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
   <span style="font-style: italic"><span style="color: #9A1900">// Do stuff here</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
<div class="paragraph"><p>The first set of parentheses hides its internal code from the outside world creating a scope or a closed ecosystem, where the function&#8217;s code will operate. Try to add a line invoking this function after the last line in the above code sample, e.g. <span class="monospaced">calcTax(50000,2)</span>, and you&#8217;ll get an error - "calcTax is not defined". There is a way to expose some of the internal content of such a <em>closure</em> and you&#8217;ll see how to do it later in this chapter.</p></div>
</div>
<div class="sect2">
<h3 id="_javascript_objects_gentle_introduction">JavaScript Objects. Gentle Introduction</h3>
<div class="paragraph"><p>JavaScript objects are simply unordered collections of properties. You can assign new or delete existing properties from the objects during the runtime whenever you please. In classical object oriented languages there are <em>classes</em> and there are <em>objects</em>. For example, based on one Java a class you can create  multiple instances of its objects.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">The ECMAScript 6 specification will include classes too, but since it&#8217;s a work in progress we won&#8217;t consider them as something useful in the today&#8217;s world. If you&#8217;d like to experiment with the upcoming features of JavaScript, download the <a href="https://tools.google.com/dlpage/chromesxs">Chrome Canary browser</a>, go to <span class="monospaced">chrome:flags</span> and enable experimental JavaScript.  Chrome Canary should be installed on the computer of any HTML5 developers - you can use today those features that will be officially released in Chrome  Developers Tools in about three months.</td>
</tr></table>
</div>
</div></div>
<div class="paragraph"><p>In JavaScript you can create objects using one of the following methods:</p></div>
<div class="ulist"><ul>
<li>
<p>
Using object literals
</p>
</li>
<li>
<p>
Using <span class="monospaced">new Object()</span> notation
</p>
</li>
<li>
<p>
Using <span class="monospaced">Object.create()</span>
</p>
</li>
<li>
<p>
Using <em>constructor functions</em> and a <span class="monospaced">new</span> operator.
</p>
</li>
</ul></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">In JavaScript everything is an <span class="monospaced">Object</span>. Think of <span class="monospaced">Object</span> as of a root of of the hierarchy of all objects used in your program. All your custom objects are descendants from <span class="monospaced">Object</span>.</td>
</tr></table>
</div>
</div></div>
<div class="sect3">
<h4 id="_object_literals">Object Literals</h4>
<div class="paragraph"><p>The easiest way to create a JavaScript object is by using the object literal notation. The code sample below starts with a creation of an empty object. The second line creates an object with one property <span class="monospaced">salary</span> and assigns the value of 50000 to it. Finally, the instance of one more object pis created and the variable <span class="monospaced">person</span> points at it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> t <span style="color: #990000">=</span> <span style="color: #FF0000">{}</span>             <span style="font-style: italic"><span style="color: #9A1900">// create an instance of an empty object</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>salary<span style="color: #990000">:</span> <span style="color: #993399">50000</span><span style="color: #FF0000">}</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">// an instance with one property</span></span>

<span style="font-style: italic"><span style="color: #9A1900">// Store the data about Julia Roberts</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> person <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> lastName<span style="color: #990000">:</span> ”Roberts”<span style="color: #990000">,</span>
               firstName<span style="color: #990000">:</span> ”Julia”<span style="color: #990000">,</span>
                     age<span style="color: #990000">:</span> <span style="color: #993399">42</span>
             <span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>This object has three properties: <span class="monospaced">lastName</span>, <span class="monospaced">firstName</span>, and <span class="monospaced">age</span>. Note that in object literal notation the values of these properties are specify using colon. You can access the properties of this person using the dot notation, e.g. <span class="monospaced">person.LastName</span>. But JavaScript allows yet another way of accessing the object properties by using square bracket syntax, for example <span class="monospaced">person["lastName"]</span>. In the next code sample you&#8217;ll see that using the square brackets is the only way to access the property.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> person <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
       <span style="color: #FF0000">"last name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Roberts"</span><span style="color: #990000">,</span>
       firstName<span style="color: #990000">:</span> <span style="color: #FF0000">"Julia"</span><span style="color: #990000">,</span>
             age<span style="color: #990000">:</span> <span style="color: #993399">42</span><span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> herName<span style="color: #990000">=</span>person<span style="color: #990000">.</span>lastName<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">error</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello "</span> <span style="color: #990000">+</span> herName<span style="color: #990000">);</span>    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

herName<span style="color: #990000">=</span>person<span style="color: #990000">[</span><span style="color: #FF0000">"last name"</span><span style="color: #990000">];</span>           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>

person<span style="color: #990000">.</span>salutation<span style="color: #990000">=</span><span style="color: #FF0000">"Mrs. "</span><span style="color: #990000">;</span>

console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello "</span><span style="color: #990000">+</span> person<span style="color: #990000">.</span>salutation <span style="color: #990000">+</span> person<span style="color: #990000">[</span><span style="color: #FF0000">"last name"</span><span style="color: #990000">]);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The object person doesn&#8217;t have a property <span class="monospaced">lastName</span>, but no error is thrown
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
This will print "Hello undefined"
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Using and alternative way of referring to an object property
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
This will print "Hello Mrs. Roberts"
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">It&#8217;s a good idea to keep handy a style guide of any programming language, and we know two of such documents for JavaScript. Google has published their version of JavaScript Style Guide at <a href="http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml">http://google-styleguide.googlecode.com/svn/trunk/javascriptguide.xml</a>. A more detailed Airbnb JavaScript Style Guide is available as a github project at <a href="https://github.com/airbnb/javascript">https://github.com/airbnb/javascript</a>. And the github version of the JavaScript style guide is located at <a href="https://github.com/styleguide/javascript">https://github.com/styleguide/javascript</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Objects can contain other objects. If a property of an object literal is also an object, you just need to specify the value of this property in an extra pair of curly braces. For example, you can represent the telephone of a person as an object having two properties: the type and the number. The following code snippet adds a nested object to store a work phone as a <em>nested object</em> inside the person&#8217;s object. Run this code in the FireBug&#8217;s console and it&#8217;ll print "Call Julia at work 212-555-1212".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> lastName<span style="color: #990000">:</span> <span style="color: #FF0000">"Roberts"</span><span style="color: #990000">,</span>
                firstName<span style="color: #990000">:</span> <span style="color: #FF0000">"Julia"</span><span style="color: #990000">,</span>
                age<span style="color: #990000">:</span> <span style="color: #993399">42</span><span style="color: #990000">,</span>
                phone<span style="color: #990000">:</span><span style="color: #FF0000">{</span>
                      type<span style="color: #990000">:</span> <span style="color: #FF0000">"work"</span><span style="color: #990000">,</span>
                      numb<span style="color: #990000">:</span> <span style="color: #FF0000">"212-555-1212"</span>
                 <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Call "</span> <span style="color: #990000">+</span> p<span style="color: #990000">.</span>firstName <span style="color: #990000">+</span> <span style="color: #FF0000">" at "</span> <span style="color: #990000">+</span> p<span style="color: #990000">.</span>phone<span style="color: #990000">.</span>type <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span> <span style="color: #990000">+</span> p<span style="color: #990000">.</span>phone<span style="color: #990000">.</span>numb <span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>What if a person has more then one phone? We can change the name of the property <span class="monospaced">phone</span> to <span class="monospaced">phones</span> and instead store an array of objects. JavaScript arrays are surrounded by square brackets, and they are zero based. The following code snippet will print "Call Julia at home 718-211-8987".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> lastName<span style="color: #990000">:</span> <span style="color: #FF0000">"Roberts"</span><span style="color: #990000">,</span>
                firstName<span style="color: #990000">:</span> <span style="color: #FF0000">"Julia"</span><span style="color: #990000">,</span>
                age<span style="color: #990000">:</span> <span style="color: #993399">42</span><span style="color: #990000">,</span>
                phones<span style="color: #990000">:[</span><span style="color: #FF0000">{</span>
                      type<span style="color: #990000">:</span> <span style="color: #FF0000">"work"</span><span style="color: #990000">,</span>
                      numb<span style="color: #990000">:</span> <span style="color: #FF0000">"212-555-1212"</span>
                 <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">{</span>
                      type<span style="color: #990000">:</span> <span style="color: #FF0000">"home"</span><span style="color: #990000">,</span>
                      numb<span style="color: #990000">:</span> <span style="color: #FF0000">"799-211-8987"</span>

                 <span style="color: #FF0000">}</span><span style="color: #990000">]</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Call "</span> <span style="color: #990000">+</span> p<span style="color: #990000">.</span>firstName <span style="color: #990000">+</span> <span style="color: #FF0000">" at "</span> <span style="color: #990000">+</span> p<span style="color: #990000">.</span>phones<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">].</span>type <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span> <span style="color: #990000">+</span> p<span style="color: #990000">.</span>phones<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">].</span>numb <span style="color: #990000">);</span></tt></pre></div></div>
<div class="sect4">
<h5 id="_methods_in_object_literals">Methods in Object Literals</h5>
<div class="paragraph"><p>Functions defined inside objects are called <em>methods</em>. Defining methods in object literals is similar to defining properties - provide a method name followed by a colon and the function declaration. The code snippet below declares a method <span class="monospaced">makeAppoyntment()</span> to our object literal. Finally, the line <span class="monospaced">p.makeAppointment();</span> invokes this new method, which will print the message on the console that Steven wants to see Julia and will call at so-and-so number.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p <span style="color: #990000">=</span> <span style="color: #FF0000">{</span> lastName<span style="color: #990000">:</span> <span style="color: #FF0000">"Roberts"</span><span style="color: #990000">,</span>
                firstName<span style="color: #990000">:</span> <span style="color: #FF0000">"Julia"</span><span style="color: #990000">,</span>
                age<span style="color: #990000">:</span> <span style="color: #993399">42</span><span style="color: #990000">,</span>
                phones<span style="color: #990000">:[</span><span style="color: #FF0000">{</span>
                      type<span style="color: #990000">:</span> <span style="color: #FF0000">"work"</span><span style="color: #990000">,</span>
                      numb<span style="color: #990000">:</span> <span style="color: #FF0000">"212-555-1212"</span>
                 <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                 <span style="color: #FF0000">{</span>
                      type<span style="color: #990000">:</span> <span style="color: #FF0000">"home"</span><span style="color: #990000">,</span>
                      numb<span style="color: #990000">:</span> <span style="color: #FF0000">"718-211-8987"</span>

                 <span style="color: #FF0000">}</span><span style="color: #990000">],</span>
                makeAppointment<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Steven wants to see  "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>firstName <span style="color: #990000">+</span>
                                 <span style="color: #FF0000">". He'll call at "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>phones<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>numb<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

p<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">makeAppointment</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">Since we already started using arrays, it&#8217;s worth mentioning that arrays can store any objects. You don&#8217;t have to declare the size of the array upfront and can create new arrays as easy as <span class="monospaced">var myArray=[]</span> or <span class="monospaced">var myArray=new Array()</span>. You can even store function declarations as regular strings, but they will be evaluated on the array initialization. For example, during the <span class="monospaced">greetArray</span> initialization the user will see a prompt asking to enter her name, and, when it&#8217;s done, the <span class="monospaced">greetArray</span> will store two strings. The output of the code fragment below can look like  "Hello, Mary".</td>
</tr></table>
</div>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> greetArray<span style="color: #990000">=[</span>
    <span style="color: #FF0000">"Hello"</span><span style="color: #990000">,</span>
    <span style="font-weight: bold"><span style="color: #000000">prompt</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Enter your name"</span><span style="color: #990000">,</span> ”Type your name here<span style="color: #FF0000">")</span>
<span style="color: #FF0000">];</span>

<span style="color: #FF0000">console.log(greetArray.join("</span><span style="color: #990000">,</span><span style="color: #FF0000">"));</span></tt></pre></div></div>
<div class="paragraph"><p>We&#8217;ve briefly covered object literals, and you to start using them. In Chapter 4 you&#8217;ll be learning about JSON - a popular data format used as replacement for XML in the JavaScript world. Then you&#8217;ll see how similar are the syntax of JSON and JavaScript object literals. Now we&#8217;ll spend a little bit of time delving into JavaScript functions, and then - back to objects again.</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_constructor_functions">Constructor Functions</h4>
<div class="paragraph"><p>JavaScript functions are more then just some named pieces of code that implements certain behavior. They also can become objects themselves by a magic of the <span class="monospaced">new</span> operator. To make things even more intriguing, the function calls can have memories, which will be explained in the section about closures.</p></div>
<div class="paragraph"><p>If a function is meant to be instantiated with the <span class="monospaced">new</span> operator it&#8217;s called a <em>constructor function</em>. If you are familiar with Java or C# you understand the concept of a class constructor that is being executed only once during the instantiation of a class. Now imagine that there is only a constructor without any class declaration that still can be instantiated with the <span class="monospaced">new</span> operator as in the following example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>lname<span style="color: #990000">,</span> fname<span style="color: #990000">,</span> age<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>lastName<span style="color: #990000">=</span>lname<span style="color: #990000">;</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>firstName<span style="color: #990000">=</span>fname<span style="color: #990000">;</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>age<span style="color: #990000">=</span>age<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// Creating 2 instances of Person</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>“Roberts”<span style="color: #990000">,</span>“Julia”<span style="color: #990000">,</span> <span style="color: #993399">42</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>“Smith”<span style="color: #990000">,</span> “Steven”<span style="color: #990000">,</span> <span style="color: #993399">34</span><span style="color: #990000">);</span>
</tt></pre></div></div>
<div class="paragraph"><p>This code declares the function <span class="monospaced">Person</span> and after that, it creates two instances of the <span class="monospaced">Person</span> objects referred by the variables <span class="monospaced">p1</span> and <span class="monospaced">p2</span> accordingly. This is what the statement <em>functions are objects</em> means.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">According to common naming conventions the names of the constructor functions are capitalized.</td>
</tr></table>
</div>
<div class="paragraph"><p>Objects can have methods and properties, right? On the other hand, functions are objects. Hence functions can have methods and properties too. If you declare a function <span class="monospaced">marryMe()</span> inside the constructor function <span class="monospaced">Person</span>, <span class="monospaced">marryMe()</span> becomes a method of <span class="monospaced">Person</span>. This is exactly what we&#8217;ll do next. But this time we&#8217;ll create an HTML file that includes the <span class="monospaced">&lt;script&gt;</span> section referring to the JavaScript code sample located in a separate file.</p></div>
<div class="paragraph"><p>If you want to try it hands-on, create a new file in your Aptana project by selecting the menu File | New | File and give it a name marryme.js. Agree with a suggested default JavaScript template, and key in the following content into this file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>lname<span style="color: #990000">,</span> fname<span style="color: #990000">,</span> age<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>lastName<span style="color: #990000">=</span>lname<span style="color: #990000">;</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>firstName<span style="color: #990000">=</span>fname<span style="color: #990000">;</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>age<span style="color: #990000">=</span>age<span style="color: #990000">;</span>

         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>marryMe<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>person<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Will you marry me, "</span> <span style="color: #990000">+</span> person<span style="color: #990000">.</span>firstName<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p1<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Steven"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p2<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Roberts"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Julia"</span><span style="color: #990000">);</span>

p1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">marryMe</span></span><span style="color: #990000">(</span>p2<span style="color: #990000">);</span>
</tt></pre></div></div>
<div class="paragraph"><p>The code above uses the keyword <span class="monospaced">this</span> that refers to the object (a.k.a. context) where the code will execute. If you are familiar with the meaning of <span class="monospaced">this</span> in Java or C#, it&#8217;s similar, but not exactly the same, and we&#8217;ll illustrate it in the section titled "Who&#8217;s this". The method <span class="monospaced">marryMe()</span> of one <span class="monospaced">Person</span> object takes an instance of another <span class="monospaced">Person</span> object and makes an interesting proposition: "Will you marry me, Julia".</p></div>
<div class="paragraph"><p>This time we won&#8217;t run this code in the Firebug&#8217;s console, but rather will include it in the HTML file.
In Aptana, create a new File | New | File, enter marryme.html as the file name and press the button Finish. Don&#8217;t press the button Next as it&#8217;ll offer you to select from one of the HTML templates, but this would generate lots of HTML content, which is not needed for our code sample. Just type in the following in the newly created empty file marryme.html.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Making Proposal<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"marryme.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_debugging_javascript_in_firebug">Debugging JavaScript in Firebug</h3>
<div class="paragraph"><p>In Aptana, right-click on the file marryme.html and select the option Run As | JavaScript Web Application. We continue using Firefox as Aptana&#8217;s default browser, and you&#8217;ll see it open a new Web page that reads "Making Proposals". Open the Firebug using the View menu, refresh the page and switch to the Firebug&#8217;s tab Script. You&#8217;ll see the split panel with the JavaScript code from marryme.js on the left.</p></div>
<div class="imageblock" id="FIG2-8">
<div class="content">
<img src="images/fig_02_08.jpg" alt="images/fig_02_08.jpg">
</div>
<div class="title">Figure 8. Firebug&#8217;s Script panel</div>
</div>
<div class="paragraph"><p>Let&#8217;s set a breakpoint inside the method <span class="monospaced">marryMe()</span> by clicking in the Firebug&#8217;s gray area to the left of the line 7. You&#8217;ll see a red circle that will reveal a yellow triangle as soon as your code execution will hit this line. Refresh the content of the browser to re-run the script with a breakpoint. Now the execution stopped at line 7, the right panel contains the runtime information about the objects and variables used by your program.</p></div>
<div class="imageblock" id="FIG2-9">
<div class="content">
<img src="images/fig_02_09.jpg" alt="images/fig_02_09.jpg">
</div>
<div class="title">Figure 9. Firebug&#8217;s Script panel at a breakpoint</div>
</div>
<div class="paragraph"><p>On the top of the left panel you&#8217;ll see usual for debuggers curved arrows (Step Into, Step Over, Step Out) as well as triangular button to continue code execution. The right panel depicts the information related to <span class="monospaced">this</span> and global <span class="monospaced">Window</span> objects. In <a href="#FIG2-9">[FIG2-9]</a> <span class="monospaced">this</span> represents the instance of the <span class="monospaced">Person</span> object represented by the variable <span class="monospaced">p1</span> (Steven Smith). To see the content of the object, received by the method <span class="monospaced">marryMe()</span> you can add the watch variable by clicking on the text "New watch expression&#8230;" and entering <span class="monospaced">person</span> - the name of the parameter of <span class="monospaced">marryMe()</span>. <a href="#FIG2-10">[FIG2-10]</a> shows the watch variable <span class="monospaced">person</span> (Julia Roberts) that was used during the invocation of the method <span class="monospaced">marryMe()</span>.</p></div>
<div class="imageblock" id="FIG2-10">
<div class="content">
<img src="images/fig_02_10.jpg" alt="images/fig_02_10.jpg">
</div>
<div class="title">Figure 10. Firebug&#8217;s Script panel at a breakpoint</div>
</div>
<div class="paragraph"><p>Now click on the Firebug&#8217;s Net panel, which shows what goes over the network during communication between the Web browser and Web server. Figure 2-11 shows a screen shot of the Net panel where we clicked on the Headers tab for marryme.html and the Response tab of marryme.js. The code 200 for both files means that they arrived successfully to the browser. It also shows the IP address of the Web server they came from, their sizes, and plenty of other useful information.  Both Script and Net panels of Firebug or any other developers tools are your best friends of any Web developer.</p></div>
<div class="imageblock" id="FIG2-11">
<div class="content">
<img src="images/fig_02_11.jpg" alt="images/fig_02_11.jpg">
</div>
<div class="title">Figure 11. Firebug&#8217;s Net panel</div>
</div>
<div class="paragraph"><p>We like Firebug, but testing and debugging should be done in several Web browsers. Besides Firebug,  we&#8217;ll be using excellent Google Chrome developers tools. Their menus and panels are similar and we won&#8217;t be including such mini-tutorials on using such tools - you can easily learn them on your own.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Notes on Arrays</div>
<div class="paragraph"><p>A JavaScript array is a grab bag of any objects. You don&#8217;t have to specify in advance the number of elements to store, and there is more than one way to create and initialize array instances. The following code samples are self-explanatory.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myArray<span style="color: #990000">=[];</span>
    myArray<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]=</span><span style="color: #FF0000">"Mary"</span><span style="color: #990000">;</span>
    myArray<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]=</span><span style="color: #FF0000">"John"</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// prints undefined John</span></span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>myArray<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span> <span style="color: #990000">+</span> myArray<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> states1 <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"NJ"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"NY"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"CT"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"FL"</span><span style="color: #990000">];</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> states <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Array</span></span><span style="color: #990000">(</span><span style="color: #993399">4</span><span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// size is optional</span></span>

states<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]=</span><span style="color: #FF0000">"NJ"</span><span style="color: #990000">;</span>

states<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]=</span><span style="color: #FF0000">"NY"</span><span style="color: #990000">;</span>

states<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]=</span><span style="color: #FF0000">"CT"</span><span style="color: #990000">;</span>

states<span style="color: #990000">[</span><span style="color: #993399">3</span><span style="color: #990000">]=</span><span style="color: #FF0000">"FL"</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// remove one array element</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">delete</span></span> states<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">];</span>


<span style="font-style: italic"><span style="color: #9A1900">// prints undefined CT length=4</span></span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>states<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span> <span style="color: #990000">+</span> states<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">" Array length="</span> <span style="color: #990000">+</span> states<span style="color: #990000">.</span>length<span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// remove one element starting from index 2</span></span>
states<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">splice</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">,</span><span style="color: #993399">1</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// prints undefined  FL length=3</span></span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>states<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">" "</span> <span style="color: #990000">+</span> states<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">" Array length="</span> <span style="color: #990000">+</span> states<span style="color: #990000">.</span>length<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Removing elements with <span class="monospaced">delete</span> creates gaps in the arrays while using the array&#8217;s method <span class="monospaced">splice()</span> allows to remove or replace the specified range of elements closing gaps.</p></div>
<div class="paragraph"><p>The next code sample illustrates an interesting use case when we assign a string and a function text as array elements to <span class="monospaced">mixedArray</span>.  During array initialization the function <span class="monospaced">promt()</span> will be invoked, the user will be prompted to enter name, and after that, two strings will be store in <span class="monospaced">mixedArray</span>, for example "Hello" and "Mary".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mixedArray<span style="color: #990000">=[</span>
    <span style="color: #FF0000">"Hello"</span><span style="color: #990000">,</span>
    <span style="font-weight: bold"><span style="color: #000000">prompt</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Enter your name"</span><span style="color: #990000">,</span> ”Type your name here<span style="color: #FF0000">")</span>
<span style="color: #FF0000">];</span>
</tt></pre></div></div>
</div></div>
</div>
<div class="sect2">
<h3 id="_prototypal_inheritance">Prototypal Inheritance</h3>
<div class="paragraph"><p>JavaScript doesn&#8217;t support classes, at least till the ECMAScript 6 will become a reality. But JavaScript allows you to create objects that inherit properties and methods of other objects. By default, all JavaScript objects are inherited from <span class="monospaced">Object</span>. Each JavaScript construction function has a special property called <span class="monospaced">prototype</span>, which points at this object&#8217;s ancestor. If you want to create an inheritance chain where an instances of constructor function <span class="monospaced">ObjectB</span> extend <span class="monospaced">ObjectA</span> just write one line of code: <span class="monospaced">ObjectB.prototype=ObjectA;</span>.</p></div>
<div class="imageblock" id="FIG2-12">
<div class="content">
<img src="images/fig_02_12.jpg" alt="images/fig_02_12.jpg">
</div>
<div class="title">Figure 12. Prototypal Inheritance</div>
</div>
<div class="paragraph"><p>Consider two constructor functions <span class="monospaced">Employee</span> and <span class="monospaced">Person</span> shown in the code snippet below.They represent two unrelated objects. But assigning the <span class="monospaced">Person</span> object to the <span class="monospaced">prototype</span> property of <span class="monospaced">Employee</span> creates an inheritance chain, and now the object <span class="monospaced">emp</span> will have all properties defined in both <span class="monospaced">Employee</span> and <span class="monospaced">Person</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">=[];</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// All instances of Employee will extend Person</span></span>
Employee<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">();</span>            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> emp<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Mary"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Specialist"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>emp<span style="color: #990000">);</span>      <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Assigning an ancestor of type person
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Instantiating Employee
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Printing the object referred by <span class="monospaced">emp</span> will output [object Object]. It happens because each object has a method <span class="monospaced">toString()</span>, and if you want it to output useful information - override it. You&#8217;ll see how to do it later in this section.
</td></tr>
</table></div>
<div class="paragraph"><p>We want to stress, that the property <span class="monospaced">prototype</span> exists on constructor functions. After creating specific instances of such objects you may see that these instances have another property called <span class="monospaced">proto</span>. At the time of this writing this property is not a standard yet and won&#8217;t be supported in some older browsers, bit ECMAScript 6 will make it official. To illustrate the difference between <span class="monospaced">prototype</span> and <span class="monospaced">proto</span> let&#8217;s add the following piece of code to the above sample:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-style: italic"><span style="color: #9A1900">//Create an instance of Person and add property dependents</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">();</span>
p<span style="color: #990000">.</span>dependents<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>                                 <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>


<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> emp2<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Joe"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Father"</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">//This employee will have property dependents</span></span>

emp2<span style="color: #990000">.</span>__proto__<span style="color: #990000">=</span>p<span style="color: #990000">;</span>                               <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The number of Employee's dependents "</span> <span style="color: #990000">+</span> emp2<span style="color: #990000">.</span>dependents<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Creating an instance of <span class="monospaced">Person</span> and adding an extra property dependents just for this instance
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Assigning this instance to the <span class="monospaced">__proto__</span> property of one instance
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The code will properly print 1 as a number of dependents of the <span class="monospaced">Employee</span> instance represented by the variable <span class="monospaced">emp2</span>.  The variable <span class="monospaced">emp</span> from the previous code snippet won&#8217;t have the property <span class="monospaced">dependents</span>.
</td></tr>
</table></div>
<div class="paragraph"><p>To try it hands-on, open the file WhoIsYourDaddy.html in Aptana. Just for a change, this time we&#8217;ll use Google Chrome Developer Tools by opening the menu View | Developer | Developer Tools. Set the breakpoint at the last line of the JavaScript, refresh the Web page content, and add the watch expressions for the variables <span class="monospaced">p</span>, <span class="monospaced">emp</span>, and <span class="monospaced">emp2</span>. When the JavaScript code engine runs into <span class="monospaced">emp2.dependents</span> it tries to find this property in property on the <span class="monospaced">Employee</span> object. If not found, the engine checks all the objects in the prototypal chain (in our case it&#8217;ll find it in the object <span class="monospaced">p</span>) all the way up to the <span class="monospaced">Object</span> if need be.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you need to do some programmatic manipulations with only those properties that are defined on the specific object (not in its ancestors) do the check with the method <span class="monospaced">hasOwnProperty()</span>.</td>
</tr></table>
</div>
<div class="imageblock" id="FIG2-13">
<div class="content">
<img src="images/fig_02_13.jpg" alt="images/fig_02_13.jpg">
</div>
<div class="title">Figure 13. The instance-specific <span class="monospaced">__proto__</span> variable</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">You can find a tutorial on using Google Chrome Developer Tools at <a href="https://developers.google.com/chrome-developer-tools/">https://developers.google.com/chrome-developer-tools/</a>. The cheatsheet of Chrome developer Tools is located at <a href="http://anti-code.com/devtools-cheatsheet/">http://anti-code.com/devtools-cheatsheet/</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Please not the difference in the content of the variables <span class="monospaced">__proto__</span> of the instances represented by <span class="monospaced">emp</span> and <span class="monospaced">emp2</span>. These two employees are inherited from two <em>differnet</em> objects <span class="monospaced">Person</span>. Isn&#8217;t it scary? Not really.</p></div>
<div class="sect3">
<h4 id="_where_to_declare_methods">Where to Declare Methods</h4>
<div class="paragraph"><p>If you take a closer look at the screenshot from <a href="#FIG2-13">[FIG2-13]</a> you&#8217;ll see that the <span class="monospaced">Person</span> and <span class="monospaced">Employee</span> objects have redundant properties <span class="monospaced">name</span> and <span class="monospaced">title</span>. We&#8217;ll deal with this redundancy in the section titled "Call and Apply". But first let&#8217;s introduce and cure the redundancy in method declarations when the prototypal inheritance is used.</p></div>
<div class="paragraph"><p>Let&#8217;s add a method to <span class="monospaced">addSubordinate()</span> to the ancestor object <span class="monospaced">Person</span> that will populate its array <span class="monospaced">subordinates</span>. Who knows, maybe an object <span class="monospaced">Contractor</span> (descendant of a <span class="monospaced">Person</span>) will need to be added in the future, so the ancestor&#8217;s method <span class="monospaced">addSubordinate()</span> can be reused. First, we&#8217;ll do it  the wrong way to illustrate the redundancy problem, and then we&#8217;ll do it right. Consider the following code:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// Constructor function Person</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">=[];</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Declaring method inside the constructor function</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>addSubordinate<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>person<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>person<span style="color: #990000">)</span>
        <span style="color: #FF0000">}</span>


<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Constructor function Employee</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Changing the inheritance of Employee</span></span>
Employee<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">();</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mgr <span style="color: #990000">=</span>  <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Alex"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Director"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> emp1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Mary"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Specialist"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> emp2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Joe"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"VP"</span><span style="color: #990000">);</span>

mgr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addSubordinate</span></span><span style="color: #990000">(</span>emp1<span style="color: #990000">);</span>
mgr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addSubordinate</span></span><span style="color: #990000">(</span>emp2<span style="color: #990000">);</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mgr.subordinates.length is "</span> <span style="color: #990000">+</span> mgr<span style="color: #990000">.</span>subordinates<span style="color: #990000">.</span>length<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The method <span class="monospaced">addSubordinate()</span> here is declared inside the constructor function <span class="monospaced">Person</span>, which becomes an ancestor of the <span class="monospaced">Employee</span>. After instantiation of two <span class="monospaced">Employee</span> objects the method <span class="monospaced">addSubordinate()</span> is duplicated for each instance.</p></div>
<div class="paragraph"><p>Let&#8217;s use Google Chrome Developer Tools profiler to see the sizes of the objects allocated on the Heap memory. But first we&#8217;ll set up two breakpoints - one before, and one after creating our instances as shown on <a href="#FIG2-14">[FIG2-14]</a>.</p></div>
<div class="imageblock" id="FIG2-14">
<div class="content">
<img src="images/fig_02_14.jpg" alt="images/fig_02_14.jpg">
</div>
<div class="title">Figure 14. Preparing Breakpoints Take 1.</div>
</div>
<div class="paragraph"><p>When the execution of the code will stop at the first breakpoint, we&#8217;ll switch to the Profiler tab and take the first Heap snapshot.  Upon reaching the second breakpoint we&#8217;ll take another Heap snapshot. The dropdown at the status bar allows to view the objects allocated between the snapshots 1 and 2. <a href="#FIG2-15">[FIG2-15]</a> depicts this view of the profiler. Note that the total size (the Shallow Size column) for the <span class="monospaced">Person</span> instances is 132 bytes. <span class="monospaced">Employee</span> instances weigh 104 bytes.</p></div>
<div class="imageblock" id="FIG2-15">
<div class="content">
<img src="images/fig_02_15.jpg" alt="images/fig_02_15.jpg">
</div>
<div class="title">Figure 15. Objects allocated between snapshots 1 and 2</div>
</div>
<div class="paragraph"><p>Now we&#8217;ll change the code to declare the method not inside the <span class="monospaced">Person</span> constructor function, but on it&#8217;s prototype - and this is the right way to declare methods in functions to avoid code duplication.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// Constructor function Person</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">=[];</span>

<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">//Declaring method on the object prototype</span></span>
Person<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>addSubordinate<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>subordinate<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
   <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>subordinate<span style="color: #990000">);</span>
   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> subordinate<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Constructor function Employee</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Changing the inheritance of Employee</span></span>
Employee<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">();</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mgr <span style="color: #990000">=</span>  <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Alex"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Director"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> emp1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Mary"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Specialist"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> emp2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Employee</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Joe"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"VP"</span><span style="color: #990000">);</span>

mgr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addSubordinate</span></span><span style="color: #990000">(</span>emp1<span style="color: #990000">);</span>
mgr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addSubordinate</span></span><span style="color: #990000">(</span>emp2<span style="color: #990000">);</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"mgr.subordinates.length is "</span> <span style="color: #990000">+</span> mgr<span style="color: #990000">.</span>subordinates<span style="color: #990000">.</span>length<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Similarly, we&#8217;ll set up two breakpoints before and after object instantiation as shown in &lt;&lt;&gt;FIG2-16&gt;.</p></div>
<div class="imageblock" id="FIG2-16">
<div class="content">
<img src="images/fig_02_16.jpg" alt="images/fig_02_16.jpg">
</div>
<div class="title">Figure 16. Preparing Breakpoints Take 2.</div>
</div>
<div class="paragraph"><p>Let&#8217;s take two more profiler snapshots upon reaching each of the breakpoint. While the weight of the <span class="monospaced">Employee</span> instances remained the same (104 bytes), the <span class="monospaced">Person</span> instances became lighter: 112 bytes. While 20 bytes may not seem like a big deal, if you&#8217;ll need to create hundreds or thousands of object instances it adds up.</p></div>
<div class="imageblock" id="FIG2-17">
<div class="content">
<img src="images/fig_02_17.jpg" alt="images/fig_02_17.jpg">
</div>
<div class="title">Figure 17. Objects allocated between snapshots 3 and 4</div>
</div>
<div class="paragraph"><p>So if you need to declare a method on the object that will play a role of the ancestor, do it on the prototype level. The only exception to this rule is the case when such method needs to use some object specific variable that&#8217;s different for each instance - in case declare methods inside the constructors (see the section on closures for details).</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">All modern Web browsers support the function <span class="monospaced">Object.create()</span>, which creates a new object based on another prototype object. For example, <span class="monospaced">var objectB=Object.create(objectA);</span>.  What if you must support an older browser and need such "create by example" functionality? Of course, you can always create a custom arbitrarily named function with the similar functionality as the latest implementation of <span class="monospaced">Object.create()</span>. But the future-proof approach is to create the missing methods with the same signatures and on the same objects as the latest ECMAScript specification prescribes. In case of <span class="monospaced">Object.create()</span> you can use the implementation <a href="http://javascript.crockford.com/prototypal.html">offered by Douglas Crockford</a>:</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span> Object<span style="color: #990000">.</span>create <span style="color: #990000">!==</span> <span style="color: #FF0000">'function'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    Object<span style="color: #990000">.</span>create <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>o<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">F</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{}</span>
        F<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span> <span style="color: #990000">=</span> o<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">F</span></span><span style="color: #990000">();</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>
newObject <span style="color: #990000">=</span> Object<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>oldObject<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Such approach of custom implementation of missing pieces according to the latest ECMAScript specifications or W3C drafts is known as <em>polyfills</em>. People who can&#8217;t wait till the browser vendors will implement the newest functionality create cross-browser polyfills and some of them submit their source code to the public domain. You can find a number of polyfills in the git repository of the <a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills">Modernizr project</a>. The Web site <a href="http://caniuse.com">http://caniuse.com/</a> contains the current information about browser&#8217;s support of the latest HTML5, JavaScript, and CSS features.</p></div>
</div></div>
</div>
<div class="sect3">
<h4 id="_method_overriding">Method overriding</h4>
<div class="paragraph"><p>Since JavaScript allows declaring methods on an object as well as on its prototype, overriding a method becomes really simple. The following code sample declares the method <span class="monospaced">addSubordinate()</span> on the prototype of the <span class="monospaced">Person</span> object, but then the object <span class="monospaced">p1</span> overrides this method.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> title<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name<span style="color: #990000">=</span>name<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">=</span>title<span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">=[];</span>
<span style="color: #FF0000">}</span>

Person<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>addSubordinate<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>person<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

   <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>person<span style="color: #990000">);</span>
   console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"I'm in addSubordinate on prototype "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p1<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Joe"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"President"</span><span style="color: #990000">);</span>

    p1<span style="color: #990000">.</span>addSubordinate<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>person<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>subordinates<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">push</span></span><span style="color: #990000">(</span>person<span style="color: #990000">);</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"I'm in addSubordinate in object "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Mary"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Manager"</span><span style="color: #990000">)</span>

    p1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addSubordinate</span></span><span style="color: #990000">(</span>p2<span style="color: #990000">);</span>
</tt></pre></div></div>
<div class="paragraph"><p>Running the above code prints only one line: "I&#8217;m in addSubordinate in object [object Object]". This proves that the method <span class="monospaced">addSubordinate()</span> on the prototype level is overridden. We can also improve this example a little bit and override the method <span class="monospaced">toString()</span> on the <span class="monospaced">Person</span>. Just add the following fragment to the prior to instantiating <span class="monospaced">p1</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Person<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>toString<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">"name:"</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name <span style="color: #990000">+</span><span style="color: #FF0000">" title:"</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>title<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now the code prints "I&#8217;m in addSubordinate in object name:Joe, title:President". Overriding the method <span class="monospaced">toString()</span> on objects is a common practice as it gives a textual representation of your objects.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_scope_or_who_8217_s_this">Scope or who&#8217;s this?</h3>
<div class="paragraph"><p>You are about to read one of the most confusing sections in this book. The confusion is caused by some inconsistencies in JavaScript design and implementations by various browsers. Do you know what will happen if you&#8217;ll remove the keywords <span class="monospaced">this</span> from the <span class="monospaced">toString()</span> method  from previous section? You&#8217;ll get an error - the variable <span class="monospaced">title</span> is not defined. Without the keyword <span class="monospaced">this</span> the JavaScript engine tries to find the variable <span class="monospaced">title</span> in the global namespace. Declaring and initializing the variable <span class="monospaced">title</span> outside of the <span class="monospaced">Person</span> declaration get rid of this error, but this is not what we want to do. Misunderstanding of the current scope can lead to difficult to debug errors.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/caution.png" alt="Caution">
</td>
<td class="content">Interestingly enough replacing <span class="monospaced">this.name</span> with <span class="monospaced">name</span> doesn&#8217;t generate an error, but rather initializes the variable <span class="monospaced">name</span> with an empty string. Although <span class="monospaced">name</span> is not an officially reserved JavaScript keyword, there are articles in the blogosphere that don&#8217;t recommend using the word <span class="monospaced">name</span> as a variable name. Keep <a href="http://www.javascripter.net/faq/reserved.htm">this list of reserved words</a> handy to avoid running into an unpredictable behavior.</td>
</tr></table>
</div>
<div class="paragraph"><p>Let&#8217;s consider several examples that will illustrate the meaning of <span class="monospaced">this</span> variable in JavaScript. The code sample below defines an object <span class="monospaced">myTaxObject</span> and calls its method <span class="monospaced">doTaxes()</span>. Notice two variables with the same name <span class="monospaced">taxDeduction</span> - one of them has global scope and another belongs to <span class="monospaced">myTaxObject</span>. This little program was written for mafia and will apply some under the table deduction for the people who belong to Cosa Nostra.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxDeduction<span style="color: #990000">=</span><span style="color: #993399">300</span><span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// global variable</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTaxObject <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

    taxDeduction<span style="color: #990000">:</span> <span style="color: #993399">400</span><span style="color: #990000">,</span>    <span style="font-style: italic"><span style="color: #9A1900">// object property</span></span>

    doTaxes<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction <span style="color: #990000">+=</span> <span style="color: #993399">100</span><span style="color: #990000">;</span>

         <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mafiaSpecial<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
           console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">"Will deduct "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">();</span>  <span style="font-style: italic"><span style="color: #9A1900">// invoking as a function</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

myTaxObject<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">();</span>  <span style="font-style: italic"><span style="color: #9A1900">//invoking method doTaxes</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>This code fragment illustrates the use of <em>nested functions</em>. The object method <span class="monospaced">doTaxes()</span> has a nested function <span class="monospaced">mafiaSpecial()</span>, which is not visible from outside of the <span class="monospaced">myTaxObject</span>, but it can be certainly invoked inside <span class="monospaced">doTaxes()</span>. What number do you think this code will print after the words "Will deduct "? Will it print three, four, or five hundred? Run this code in Firebug, Chrome Developer Tools or any other way and you&#8217;ll see that it&#8217;ll print 300!</p></div>
<div class="paragraph"><p>But this doesn&#8217;t sound right, does it? The problem is that in JavaScript the context where the function executes depends on the way it was invoked. In this case the function <span class="monospaced">mafiaSpecial()</span> was invoked as a function (not a method) without specifying the object it should apply to, and JavaScript makes it operate in the global object, hence the global variable <span class="monospaced">taxDeduction</span> having the value of 300 is being used. So in expression <span class="monospaced">this.taxDeduction</span>  the variable <span class="monospaced">this</span> means global unless the code is operated in the strict mode.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">ECMAScript 5 introduced a restricted version of JavaScript called <em>strict mode</em>, which among other things places stricter requirements to variable declarations and scope identification. Adding "use strict" as the first statement of the method <span class="monospaced">doTax()</span> will make the context <em>undefined</em>, and it&#8217;ll print the error "this is undefined" and not 300. You can read about the strict mode at <a href="http://mzl.la/N4z1QI">Mozilla&#8217;s developers site</a>.</td>
</tr></table>
</div>
</div></div>
<div class="paragraph"><p>Let&#8217;s make a slight change to this example and take to control what <span class="monospaced">this</span> represents. When the object <span class="monospaced">myTaxObject</span> was instantiated its own <span class="monospaced">this</span> reference was created. The following code fragment stores this reference in  additional variable <span class="monospaced">thisOfMyTaxObject</span> changes the game and the expression <span class="monospaced">thisOfMyTaxObject.taxDeduction</span> evaluates to 500.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxDeduction<span style="color: #990000">=</span><span style="color: #993399">300</span><span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// global variable</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTaxObject <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

    taxDeduction<span style="color: #990000">:</span> <span style="color: #993399">400</span><span style="color: #990000">,</span>    <span style="font-style: italic"><span style="color: #9A1900">// object property</span></span>

    doTaxes<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> thisOfMyTaxObject<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">;</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction <span style="color: #990000">+=</span> <span style="color: #993399">100</span><span style="color: #990000">;</span>

         <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mafiaSpecial<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
           console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">"Will deduct "</span> <span style="color: #990000">+</span> thisOfMyTaxObject<span style="color: #990000">.</span>taxDeduction<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">();</span>  <span style="font-style: italic"><span style="color: #9A1900">// invoking as a function</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

myTaxObject<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">();</span>  <span style="font-style: italic"><span style="color: #9A1900">//invoking method doTaxes</span></span></tt></pre></div></div>
<div class="paragraph"><p>You&#8217;ll see a different way of running a function in the context of the specified object using special functions <span class="monospaced">call()</span> and <span class="monospaced">apply()</span>. But for now consider one more attempt to invoke <span class="monospaced">mafiaSpecial()`shown in the following example that uses `this.mafiaSpecial()</span> notation.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxDeduction<span style="color: #990000">=</span><span style="color: #993399">300</span><span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// global variable</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTaxObject <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

    taxDeduction<span style="color: #990000">:</span> <span style="color: #993399">400</span><span style="color: #990000">,</span>    <span style="font-style: italic"><span style="color: #9A1900">// object property</span></span>

    doTaxes<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction <span style="color: #990000">+=</span> <span style="color: #993399">100</span><span style="color: #990000">;</span>

         <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mafiaSpecial<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
           console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">"Will deduct "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">();</span>  <span style="font-style: italic"><span style="color: #9A1900">// trying to apply object's scope</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

myTaxObject<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">();</span>  <span style="font-style: italic"><span style="color: #9A1900">//invoking method doTaxes</span></span></tt></pre></div></div>
<div class="paragraph"><p>Run the above code and it&#8217;ll give you the error "TypeError: this.mafiaSpecial is not a function" and rightly so. Take a closer look at the object <span class="monospaced">myTaxObject</span> represented by the variable <span class="monospaced">this</span>. The <span class="monospaced">myTaxObject</span> has only two properties: <span class="monospaced">taxDeduction</span> and <span class="monospaced">doTaxes</span>. The function <span class="monospaced">mafiaSpecial</span> is hidden inside the method <span class="monospaced">doTaxes</span> and can&#8217;t be accessed via <span class="monospaced">this</span>.</p></div>
<div class="sect3">
<h4 id="_call_and_apply">Call and Apply</h4>
<div class="paragraph"><p>Visualize the International Space Station, and add to the picture an image of a approaching space shuttle. After attaching to the docking bay of the station the shuttle&#8217;s crew performs some functions on the station (a.k.a. object) and then flies to another object or back to Earth. What is has to do with JavaScript? It can serve as an analogy for creating a JavaScript function that can operate in the scope of any arbitrary object. For this purpose JavaScript offers two special functions: <span class="monospaced">call()</span> or <span class="monospaced">apply()</span>. Both <span class="monospaced">call()</span> and <span class="monospaced">apply()</span> can invoke any function on any object. The only difference between them is that <span class="monospaced">apply()</span> passes required parameters to a function as an array, while <span class="monospaced">call()</span> uses a comma-separated list.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Every function in JavaScript is a <span class="monospaced">Function</span> object. Both <span class="monospaced">call()</span> and <span class="monospaced">apply()</span> are defined in the <span class="monospaced">Function</span> object.</td>
</tr></table>
</div>
<div class="paragraph"><p>For example, a function <span class="monospaced">calcStudentDeduction(income,numOfStudents)</span> can be invoked in a context of a given object using either call() or apply(). Note that with <span class="monospaced">call()</span> parameters have to be listed explicitly, while with <span class="monospaced">apply</span> parameters are given as an array:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>calcStudentDeduction<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">call</span></span><span style="color: #990000">(</span>myTaxObject<span style="color: #990000">,</span> <span style="color: #993399">50000</span><span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">);</span>

calcStudentDeduction<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">apply</span></span><span style="color: #990000">(</span>myTaxObject<span style="color: #990000">,</span> <span style="color: #990000">[</span><span style="color: #993399">50000</span><span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">]);</span></tt></pre></div></div>
<div class="paragraph"><p>In the above example the instance of &#8216;myTaxObject` can be referred as <span class="monospaced">this</span> from within the function <span class="monospaced">calcStudentDeduction()</span> even though this is a function and not a method. The last example from the previous section can be re-written to invoke <span class="monospaced">mafiaSpecial()</span>. The following code will ensure that <span class="monospaced">mafiaSpecial()</span> has <span class="monospaced">this</span> pointing to `myTaxObject&#8217; and will print on the console "Will deduct 500".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxDeduction<span style="color: #990000">=</span><span style="color: #993399">300</span><span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// global variable</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTaxObject <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

    taxDeduction<span style="color: #990000">:</span> <span style="color: #993399">400</span><span style="color: #990000">,</span>

    doTaxes<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
         <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction <span style="color: #990000">+=</span> <span style="color: #993399">100</span><span style="color: #990000">;</span>

         <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mafiaSpecial<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
           console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">"Will deduct "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>

         mafiaSpecial<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">call</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// passing context to a function</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

myTaxObject<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">();</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_callbacks">Callbacks</h4>
<div class="paragraph"><p>Can you live without using <span class="monospaced">call()</span> and <span class="monospaced">apply()</span>?  Sure you can, but in JavaScript can easily create <em>callbacks</em> - you can pass the code of one function as a parameter to another function for execution in the latter function&#8217;s context. Most likely you&#8217;ve seen how event handlers are declared. If a user clicks on this button here&#8217;s the name of the handler function to call:
<span class="monospaced">myButton.addEventListener("click", myFunctionHandler)</span></p></div>
<div class="paragraph"><p>It&#8217;s important to understand that you don&#8217;t not immediately call the function <span class="monospaced">myFunctionHandler</span> here - you are just registering it. If and only if the user will click on <span class="monospaced">myButton</span> then the callback <span class="monospaced">myFunctionHandler</span> has to be invoked in the context of the <span class="monospaced">myButton</span> object. The functions <span class="monospaced">call()</span> and <span class="monospaced">apply()</span> exist exactly for this purpose.</p></div>
<div class="paragraph"><p>Let&#8217;s consider an example when you need to write a function that will take two arguments - and array with preliminary tax data and a callback function to be applied to each element of this array. The following code sample creates <span class="monospaced">myTaxObject</span> that has two properties: <span class="monospaced">taxDeduction</span> and the <span class="monospaced">applyDeduction</span>. The latter is a method with two parameters: array and a callback to be applied to this array.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTaxObject <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

    taxDeduction<span style="color: #990000">:</span> <span style="color: #993399">400</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">// state-specific  deduction</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">// this function takes an array and callback as parameters</span></span>
    applyDeduction<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>someArray<span style="color: #990000">,</span> someCallBackFunction<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> someArray<span style="color: #990000">.</span>length<span style="color: #990000">;</span> i<span style="color: #990000">++)</span><span style="color: #FF0000">{</span>

            <span style="font-style: italic"><span style="color: #9A1900">// Invoke the callback</span></span>
           someCallBackFunction<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">call</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> someArray<span style="color: #990000">[</span>i<span style="color: #990000">]);</span>
        <span style="color: #FF0000">}</span>

    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// array</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> preliminaryTaxes<span style="color: #990000">=[</span><span style="color: #993399">1000</span><span style="color: #990000">,</span> <span style="color: #993399">2000</span><span style="color: #990000">,</span> <span style="color: #993399">3000</span><span style="color: #990000">];</span>

<span style="font-style: italic"><span style="color: #9A1900">// tax handler function</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxHandler<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>currentTax<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                   console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello from callback. Your final tax is "</span> <span style="color: #990000">+</span>
                   <span style="color: #990000">(</span>currentTax <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>taxDeduction<span style="color: #990000">));</span>
                <span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// invoking applyDeduction passing an array and callback</span></span>
myTaxObject<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">applyDeduction</span></span><span style="color: #990000">(</span>preliminaryTaxes<span style="color: #990000">,</span> taxHandler<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The above code invokes <span class="monospaced">applyDeduction()</span> passing it the array <span class="monospaced">preliminaryTaxes</span> and the callback function <span class="monospaced">taxHandler</span> that takes the <span class="monospaced">currentTax</span> and subtracts <span class="monospaced">this.taxDeduction</span>. By the time this callback will be applied to each element of the array the value of <span class="monospaced">this</span> will be known and this code will print the following:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Hello from callback. Your final tax is 600
Hello from callback. Your final tax is 1600
Hello from callback. Your final tax is 2600</tt></pre></div></div>
<div class="paragraph"><p>You may be wondering, why passing the function to another object if we could take an array, subtract 400 from each of its elements and be done with it? The solution with callbacks gives you an ability to make the decision on what function to call during the runtime and call it only when a certain event happens. Callbacks allow you to do asynchronous processing. For example, you make an asynchronous  request to a server and register the callback to be invoked if a result comes back. The code is not blocked and doesn&#8217;t wait until the server response is ready. Here&#8217;s an example from AJAX: <span class="monospaced">request.onreadystatechange=myHandler</span>. You register <span class="monospaced">myHandler</span> callback but not immediately call it. JavaScript functions are objects, so get used to the fact that you can pass them around as you&#8217;d be passing any objects.</p></div>
</div>
<div class="sect3">
<h4 id="_hoisting">Hoisting</h4>
<div class="paragraph"><p>A variable scope depends on where it was declared.  You already had a chance to see that a variable declared inside a function with the keyword <span class="monospaced">var</span> is visible only inside this function. Some programming languages allow to narrow down the scope even further. For example, in Java declaring a variable inside any block of code surrounded with curly braces makes it visible only inside such a block. In JavaScript it works differently. No matter where in the function you declared the variable its declaration will be <em>hoisted</em> to the top of the function, and you can use this variable anywhere inside the function.</p></div>
<div class="paragraph"><p>The following code snippet will print 5 even though the variable b has been declared inside the if-statement. It&#8217;s declaration has been hoisted to the top:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">test</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>a<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> b <span style="color: #990000">=</span> <span style="color: #993399">5</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>b<span style="color: #990000">);</span>

<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="paragraph"><p>Let&#8217;s make a slight change to the above code to separate the variable declaration and initialization. The following code has to <span class="monospaced">console.log(b)</span> statements. The first one will output <span class="monospaced">undefined</span> and the second will print 5 just as in the previous example.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">test</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>

    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>b<span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// b is visible, but not initialized</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>a<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> b<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    b<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">;</span>

    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>b<span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// b is visible and initialized</span></span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="paragraph"><p>Due to hoisting, JavaScript doesn&#8217;t complain when the first <span class="monospaced">console.log(b)</span> is invoked. It knows about the variable <span class="monospaced">b</span>, but its value is <span class="monospaced">undefined</span> just yet. By the time the second <span class="monospaced">console.log(b)</span> is called, the variable b was initialized with the value of 5. Just remember that hoisting just applies to variable declaration and doesn&#8217;t interferes with your code when it comes to initialization.
JavaScript function declarations are hoisted too, and this is illustrated in the following code sample.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">test</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>a<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> b<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    b<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #000000">printB</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">printB</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>b<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="paragraph"><p>This code will print 5. We can call the function printB() here because its declaration was hoisted to the top. But the situation changes if instead of function declaration we&#8217;ll use the function expression. The following code will give you an error "PrintB is not a function". Notice that it the error doesn&#8217;t complain about <span class="monospaced">printB</span> being undefined cause the variable declaration was hoisted, but since the function expression wasn&#8217;t the JavaScript engine doesn&#8217;t know yet that <span class="monospaced">printB</span> will become a function really soon. Anyway, moving the invocation line <span class="monospaced">printB()</span> to the bottom of the function <span class="monospaced">test()</span> cures this issue. Function expressions are not being hoisted.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">test</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>a<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> b<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    b<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #000000">printB</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> printB <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>b<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">test</span></span><span style="color: #990000">();</span></tt></pre></div></div>
<div class="paragraph"><p>All code samples in this section first declare the function <span class="monospaced">test()</span> and then invoke it. This function <span class="monospaced">test()</span> is being called once and there is no reason to give it a name. Using so called <em>self-invoked</em> function notation allows to declare and automatically invoke the function (note the extra parentheses at the end of the following code).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> a<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>a<span style="color: #990000">&gt;</span><span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> b<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>

    b<span style="color: #990000">=</span><span style="color: #993399">5</span><span style="color: #990000">;</span>

    <span style="font-weight: bold"><span style="color: #000000">printB</span></span><span style="color: #990000">();</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> printB <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>b<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_function_properties">Function properties</h4>
<div class="paragraph"><p>Functions as any other objects can have properties. You can attach any properties to a Function object and their values can be used by all instances of this object. Static variables in programming languages with the classical inheritance is the closest analogy to function properties in JavaScript.</p></div>
<div class="paragraph"><p>Let&#8217;s consider an example of a constructor function <span class="monospaced">Tax</span>. An accounting program can create multiple instances if <span class="monospaced">Tax</span> - one per person. Say this program will be used in a Florida neighborhood with predominantly Spanish speaking people. The following code illustrates the case when the method <span class="monospaced">doTax()</span> can be called with or without parameters.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Tax</span></span><span style="color: #990000">(</span>income<span style="color: #990000">,</span> dependents<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>income<span style="color: #990000">=</span>income<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">// instance variable</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>dependents<span style="color: #990000">=</span>dependents<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">// instance variable</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>doTax <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">calcTax</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> language<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
           <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(!(</span>state <span style="color: #990000">&amp;&amp;</span> language<span style="color: #990000">))</span><span style="color: #FF0000">{</span>     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
              console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Income: "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>income <span style="color: #990000">+</span> <span style="color: #FF0000">" Dependents: "</span><span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>dependents
              <span style="color: #990000">+</span> <span style="color: #FF0000">" State: "</span> <span style="color: #990000">+</span> Tax<span style="color: #990000">.</span>defaults<span style="color: #990000">.</span>state <span style="color: #990000">+</span> <span style="color: #FF0000">" language:"</span> <span style="color: #990000">+</span> Tax<span style="color: #990000">.</span>defaults<span style="color: #990000">.</span>language<span style="color: #990000">);</span>
           <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #FF0000">{</span>                       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
              console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Income: "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>income <span style="color: #990000">+</span> <span style="color: #FF0000">" Dependents: "</span><span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>dependents
              <span style="color: #990000">+</span> <span style="color: #FF0000">" State: "</span> <span style="color: #990000">+</span> state <span style="color: #990000">+</span> <span style="color: #FF0000">" language:"</span> <span style="color: #990000">+</span> language<span style="color: #990000">);</span>
           <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

Tax<span style="color: #990000">.</span>defaults<span style="color: #990000">=</span><span style="color: #FF0000">{</span>                           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
     state<span style="color: #990000">:</span><span style="color: #FF0000">"FL"</span><span style="color: #990000">,</span>
     language<span style="color: #990000">:</span><span style="color: #FF0000">"Spanish"</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// Creating 2 Tax objects</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> t1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tax</span></span><span style="color: #990000">(</span><span style="color: #993399">50000</span><span style="color: #990000">,</span> <span style="color: #993399">3</span><span style="color: #990000">);</span>
    t1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTax</span></span><span style="color: #990000">();</span>                          <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> t2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tax</span></span><span style="color: #990000">(</span><span style="color: #993399">68000</span><span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">);</span>
    t2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTax</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"NY"</span><span style="color: #990000">,</span><span style="color: #FF0000">"English"</span><span style="color: #990000">);</span>            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
No state and language were given to the method <span class="monospaced">doTax()</span>
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The state and language were provided as <span class="monospaced">doTax()</span> parameters
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Assigning the object with two properties as a <span class="monospaced">defaults</span> property on <span class="monospaced">Tax</span>. The property <span class="monospaced">default</span> is not instance specific, which makes it static.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Invoking <span class="monospaced">doTax()</span> without parameters - use <span class="monospaced">defaults</span>
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Invoking <span class="monospaced">doTax()</span> with parameters
</td></tr>
</table></div>
<div class="paragraph"><p>This program will produce the following output:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Income<span style="color: #990000">:</span> <span style="color: #993399">50000</span> Dependents<span style="color: #990000">:</span> <span style="color: #993399">3</span> State<span style="color: #990000">:</span> FL language<span style="color: #990000">:</span>Spanish
Income<span style="color: #990000">:</span> <span style="color: #993399">68000</span> Dependents<span style="color: #990000">:</span> <span style="color: #993399">1</span> State<span style="color: #990000">:</span> NY language<span style="color: #990000">:</span>English</tt></pre></div></div>
<div class="paragraph"><p>You can add as many properties to the constructor function as needed. For example, to count the number of instances of the <span class="monospaced">Tax</span> object just add one more property <span class="monospaced">Tax.counter=0;</span>. Now add to the <span class="monospaced">Tax</span> function something like <span class="monospaced">console.log(Tax.counter++);</span> and you&#8217;ll see that the counter increments on each instance creation.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If multiple instances of a function object need to access certain HTML elements of the DOM,  add references to these elements as function properties so objects can reuse them instead of traversing the DOM (it&#8217;s slow) from each instance.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_closures">Closures</h3>
<div class="paragraph"><p>Imagine a function that contains a private variable, and a nested function. Is it possible to invoke the nested function from the outside of the outer one? And if it&#8217;s possible, what this inner function knows about its surroundings?</p></div>
<div class="paragraph"><p>Larry Ullman, a Web developer and computer books author offers the following definition: "Closure is a function call with memory". We can offer you our version: "Closure is a function call with strings attached". Now it&#8217;s turn for the explanation of these mysterious definitions, and we&#8217;ll do it by example. Consider the following code that is yet another example of implementing tax collection functionality.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span><span style="color: #FF0000">{</span>                <span style="font-style: italic"><span style="color: #9A1900">// this is an anonymous function expression</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxDeduction <span style="color: #990000">=</span> <span style="color: #993399">500</span><span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// private context to remember</span></span>

      <span style="font-style: italic"><span style="color: #9A1900">//exposed closure</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>doTaxes<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>income<span style="color: #990000">,</span> customerName<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> yourTax<span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>customerName <span style="color: #990000">!=</span> <span style="color: #FF0000">"Tony Soprano"</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
          yourTax <span style="color: #990000">=</span>   income<span style="color: #990000">*</span><span style="color: #993399">0.05</span> <span style="color: #990000">-</span> taxDeduction<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #FF0000">{</span>
          yourTax <span style="color: #990000">=</span>   <span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">(</span>income<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>

         console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">"   Dear "</span> <span style="color: #990000">+</span> customerName <span style="color: #990000">+</span> <span style="color: #FF0000">", your tax is "</span><span style="color: #990000">+</span> yourTax<span style="color: #990000">);</span>
         <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> yourTax<span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>

      <span style="font-style: italic"><span style="color: #9A1900">//private function</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">(</span>income<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> income<span style="color: #990000">*</span><span style="color: #993399">0.05</span> <span style="color: #990000">-</span> taxDeduction<span style="color: #990000">*</span><span style="color: #993399">2</span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span><span style="color: #990000">)();</span>    <span style="font-style: italic"><span style="color: #9A1900">// Self-invoked function</span></span>

<span style="font-style: italic"><span style="color: #9A1900">// The closure remembers its context with taxDeduction=500</span></span>
<span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">(</span><span style="color: #993399">100000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"John Smith"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">(</span><span style="color: #993399">100000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"Tony Soprano"</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">();</span>        <span style="font-style: italic"><span style="color: #9A1900">// throws an error - this function is private</span></span></tt></pre></div></div>
<div class="paragraph"><p>First, a self-invoking function will create an anonymous instance of an object in the global scope. It contains a private variable <span class="monospaced">taxDeduction</span>, a public method <span class="monospaced">doTaxes()</span>, and a private method <span class="monospaced">mafiaSpecial()</span>. Just by the virtue of declaring <span class="monospaced">doTaxes</span> on <span class="monospaced">this</span> object, this method becomes exposed to the current scope, which is global in this example.</p></div>
<div class="paragraph"><p>After that we call the method <span class="monospaced">doTaxes()</span> twice. Note that the function <span class="monospaced">doTaxes()</span> uses the variable <span class="monospaced">taxDeduction</span> that was never declared there. But when <span class="monospaced">doTaxes</span> was initially declared, the variable <span class="monospaced">taxDeduction</span> with a value of 500 was already there. So the internal function "remembers" the context (the neighborhood) where it was declared and can use it for its calculations.</p></div>
<div class="paragraph"><p>The algorithm of tax calculations makes <span class="monospaced">doTaxes()</span> calls the function <span class="monospaced">mafiaSpecial()</span> if the customer&#8217;s name is "Tony Soprano". The function <span class="monospaced">mafiaSpecial()</span> is not visible from outside, but for insiders like <span class="monospaced">doTaxes()</span> it&#8217;s available. Here&#8217;s what the above code example will print on the console:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Dear John Smith, your tax is 4500
Dear Tony Soprano, your tax is 4000
Uncaught ReferenceError: mafiaSpecial is not defined</tt></pre></div></div>
<div class="paragraph"><p>The <a href="#FIG2-18">[FIG2-18]</a> shows the screenshot taken when <span class="monospaced">doTaxes()</span> hit the breakpoint inside <span class="monospaced">doTaxes</span> - note the right panel that shows what&#8217;s visible in the Closure scope.</p></div>
<div class="imageblock" id="FIG2-18">
<div class="content">
<img src="images/fig_02_18.jpg" alt="images/fig_02_18.jpg">
</div>
<div class="title">Figure 18. Closure view in Chrome&#8217;s Developer Tools.</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">JavaScript doesn&#8217;t give you an explicit way to mark an variable as private. By using closures you can get the same level of data hiding that you get from private variables in other languages. In the example above the variable <span class="monospaced">taxDeduction</span> is local for the object enclosed in the outermost parentheses and can&#8217;t be accessed from outside. But <span class="monospaced">taxDeduction</span> can be visible from the object&#8217;s functions <span class="monospaced">doTaxws</span> and <span class="monospaced">mafiaSpecial</span>.</td>
</tr></table>
</div>
<div class="paragraph"><p><a href="#FIG2-19">[FIG2-19]</a> gives yet another visual representation of our above code sample. The self-invoked anonymous function is shown as a cloud that exposes only one thing to the rest of the world: the closure <span class="monospaced">doTaxes</span>.</p></div>
<div class="imageblock" id="FIG2-19">
<div class="content">
<img src="images/fig_02_19.jpg" alt="images/fig_02_19.jpg">
</div>
<div class="title">Figure 19. Closure doTaxes</div>
</div>
<div class="paragraph"><p>Let&#8217;s consider a couple of more cases of returning a closure to the outside world so it can be invoked later. If the previous code sample was exposing the closure by using <span class="monospaced">this.taxes</span> notation, the next two examples will simply return the code of the closure using the <span class="monospaced">return</span> statement. The code below declares a constructor function <span class="monospaced">Person</span>, adds a function <span class="monospaced">doTaxes()</span> to its prototype, and finally creates two instances of the <span class="monospaced">Person</span> calling the method <span class="monospaced">doTaxes()</span> on each of them.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// Constructor function</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span>name<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name <span style="color: #990000">=</span> name<span style="color: #990000">;</span>

<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Declaring a method that returns closure</span></span>
Person<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">.</span>doTaxes<span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxDeduction <span style="color: #990000">=</span> <span style="color: #993399">500</span><span style="color: #990000">;</span>

      <span style="font-style: italic"><span style="color: #9A1900">//private function</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">(</span>income<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> income<span style="color: #990000">*</span><span style="color: #993399">0.05</span> <span style="color: #990000">-</span> taxDeduction<span style="color: #990000">*</span><span style="color: #993399">2</span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>

      <span style="font-style: italic"><span style="color: #9A1900">//the code of this function is returned to the caller</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>income<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> yourTax<span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name <span style="color: #990000">!=</span> <span style="color: #FF0000">"Tony Soprano"</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
          yourTax <span style="color: #990000">=</span>   income<span style="color: #990000">*</span><span style="color: #993399">0.05</span> <span style="color: #990000">-</span> taxDeduction<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #FF0000">{</span>
          yourTax <span style="color: #990000">=</span>   <span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">(</span>income<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>

         console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span> <span style="color: #FF0000">"My dear "</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>name <span style="color: #990000">+</span> <span style="color: #FF0000">", your tax is "</span><span style="color: #990000">+</span> yourTax<span style="color: #990000">);</span>
         <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> yourTax<span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">();</span>     <span style="font-style: italic"><span style="color: #9A1900">// important parentheses!</span></span>

<span style="font-style: italic"><span style="color: #9A1900">//Using closure</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"John Smith"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> result1 <span style="color: #990000">=</span> p1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">(</span><span style="color: #993399">100000</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Person</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Tony Soprano"</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> result2 <span style="color: #990000">=</span> p2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">(</span><span style="color: #993399">100000</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The calculated taxes in this example are the same as in the previous one: John Smith has to pay $4500, while Tony Soprano only $4000. But we used different technique for exposing the closure. We want to make sure that you didn&#8217;t overlooked the parentheses at the very end of the function expression for <span class="monospaced">doTaxes</span>. These parenthesis force the anonymous function to self-invoke itself, it&#8217;ll run into a <span class="monospaced">return</span> statement and will assign the code of the anonymous inner function that takes parameter <span class="monospaced">income</span> to the property <span class="monospaced">doTaxes</span>. So when the line <span class="monospaced">var result1 = p1.doTaxes(100000);</span> calls the closure the variable <span class="monospaced">result1</span> will have the value 4500. Remove these important parentheses, and the value of <span class="monospaced">result1</span> is not the tax amount, but the the code of the closure itself - the invocation of the closure is not happening.</p></div>
<div class="paragraph"><p>The following code fragment is yet another example of returning the closure that remembers its context.First, the closure is returned to the caller of <span class="monospaced">prepareTaxes()</span>, and when the closure will be invoked it&#8217;ll remember the values defined in its outer context. After looking at this code you can say that there is nothing declared in the closure&#8217;s outside context! There is - by the time when the closure is created the value of the <span class="monospaced">studentDeductionAmount</span> will be known.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">prepareTaxes</span></span><span style="color: #990000">(</span>studentDeductionAmount<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>income<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> income<span style="color: #990000">*</span><span style="color: #993399">0.05</span> <span style="color: #990000">-</span> studentDeductionAmount<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> doTaxes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">prepareTaxes</span></span><span style="color: #990000">(</span><span style="color: #993399">300</span><span style="color: #990000">);</span>         <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> yourTaxIs <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">doTaxes</span></span><span style="color: #990000">(</span><span style="color: #993399">10000</span><span style="color: #990000">);</span>          <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"You tax is "</span> <span style="color: #990000">+</span> yourTaxIs<span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
When the function prepareTaxes is called, it immediately hits the <span class="monospaced">return</span> statement and returns the code of the closure to the caller.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
After this line is executed, the variable <span class="monospaced">doTaxes</span> has the code of the closure, which remembers that <span class="monospaced">studentDeductionAmount</span> is equal to 300.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
This is actual invocation of the closure
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
the console output is "your tax is 200"
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Check the quality of your code with the help of the JavaScript code quality tool <a href="http://www.jslint.com/">JSLint</a>.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_closures_as_callbacks">Closures as callbacks</h4>
<div class="paragraph"><p>Let&#8217;s revisit the code from the section Callbacks above. That code has shown how to pass an arbitrary function to another one and invoke it there using <span class="monospaced">call()</span>. But if that version of the function <span class="monospaced">taxHandler</span> was not aware of the context it was created in, the version below will. If in classical object-oriented languages you&#8217;d need to pass a method that knows about it&#8217;s context, you&#8217;d need to create an instance of an object that contains the method and the required object-level properties, and then you&#8217;d be passing this wrapper-object to another object for processing. But since the closure remembers its context anyway, we can just pass a closure instead of object. Compare the code below with the code from the Callbacks section.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myTaxObject <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

    <span style="font-style: italic"><span style="color: #9A1900">// this function takes an array and callback as parameters</span></span>
    applyDeduction<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>someArray<span style="color: #990000">,</span> someCallBackFunction<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> someArray<span style="color: #990000">.</span>length<span style="color: #990000">;</span> i<span style="color: #990000">++)</span><span style="color: #FF0000">{</span>

            <span style="font-style: italic"><span style="color: #9A1900">// Invoke the callback</span></span>
           someCallBackFunction<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">call</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">,</span> someArray<span style="color: #990000">[</span>i<span style="color: #990000">]);</span>
        <span style="color: #FF0000">}</span>

    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// array</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> preliminaryTaxes<span style="color: #990000">=[</span><span style="color: #993399">1000</span><span style="color: #990000">,</span> <span style="color: #993399">2000</span><span style="color: #990000">,</span> <span style="color: #993399">3000</span><span style="color: #990000">];</span>


<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> taxHandler <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>taxDeduction<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

<span style="font-style: italic"><span style="color: #9A1900">// tax handler closure</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>currentTax<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                   console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hello from callback. Your final tax is "</span> <span style="color: #990000">+</span>
                   <span style="color: #990000">(</span>currentTax <span style="color: #990000">-</span> taxDeduction<span style="color: #990000">));</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>


<span style="font-style: italic"><span style="color: #9A1900">// invoking applyDeduction passing an array and callback-closure</span></span>
myTaxObject<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">applyDeduction</span></span><span style="color: #990000">(</span>preliminaryTaxes<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">taxHandler</span></span><span style="color: #990000">(</span><span style="color: #993399">200</span><span style="color: #990000">));</span></tt></pre></div></div>
<div class="paragraph"><p>The last line of the above example calls <span class="monospaced">taxHandler(200)</span>, which creates a closure that&#8217;s being passed as a callback to the method <span class="monospaced">applyDeduction()</span>. Even though this closure is executed in the context of <span class="monospaced">myTaxObject</span>, it remembers that tax deduction is 200.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_mixins">Mixins</h3>
<div class="paragraph"><p>The need to extend capabilities of objects can be fulfilled by inheritance, but this is not the only way of adding behavior to objects. In this section you&#8217;ll see an example of something that would not be possible in the object-oriented languages like Java or C#, which don&#8217;t support multiple inheritance. JavaScript allows taking a piece of code and <em>mix it into any object</em> regardless of what its inheritance chain is. <em>Mixin</em> is a code fragment that an object can borrow if need be.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// Defining a function expession</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> Tax <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>income<span style="color: #990000">,</span> state<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>income<span style="color: #990000">=</span>income<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>state<span style="color: #990000">=</span>state<span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span>calcTax<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tax<span style="color: #990000">=</span>income<span style="color: #990000">*</span><span style="color: #993399">0.05</span><span style="color: #990000">;</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Your calculated tax is "</span> <span style="color: #990000">+</span> tax<span style="color: #990000">)</span>
                <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> tax<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span>


<span style="font-style: italic"><span style="color: #9A1900">// Defining a mixin</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> TaxMixin <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{}</span><span style="color: #990000">;</span>

TaxMixin<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span> <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>

  mafiaSpecial<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>originalTax<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Mafia special:"</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span>originalTax <span style="color: #990000">-</span> <span style="color: #993399">1000</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  drugCartelSpecial<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>originalTax<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
     console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Drug Cartel special:"</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span>originalTax <span style="color: #990000">-</span> <span style="color: #993399">3000</span><span style="color: #990000">));</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// this function can blend TaxMixin into tax</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">blend</span></span><span style="color: #990000">(</span> mainDish<span style="color: #990000">,</span> spices <span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> methodName <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> spices<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span> <span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      mainDish<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">[</span>methodName<span style="color: #990000">]</span> <span style="color: #990000">=</span> spices<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">prototype</span></span><span style="color: #990000">[</span>methodName<span style="color: #990000">];</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Blend the spices with the main dish</span></span>
<span style="font-weight: bold"><span style="color: #000000">blend</span></span><span style="color: #990000">(</span> Tax<span style="color: #990000">,</span> TaxMixin <span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Create an instant of Tax</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> t <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Tax</span></span><span style="color: #990000">(</span><span style="color: #993399">50000</span><span style="color: #990000">,</span> <span style="color: #FF0000">"NY"</span><span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> rawTax <span style="color: #990000">=</span> t<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">calcTax</span></span><span style="color: #990000">();</span>

<span style="font-style: italic"><span style="color: #9A1900">// invoke a freshly blended method</span></span>
t<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">mafiaSpecial</span></span><span style="color: #990000">(</span>rawTax<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The function <span class="monospaced">blend()</span> loops through the code of the <span class="monospaced">TaxMixin</span> and copies all its properties into <span class="monospaced">Tax</span>. Mixins can be useful is you want to provide a specific feature to a number of different object without changing their inheritance. The other use case is if you want to prepare a bunch of small code fragments (spices) and add any combination of them to the various objects (dishes) as needed. Mixins give you a lot of flexibility in what you can achieve with the minimum code, but they may decrease the readability of your code.</p></div>
<div class="paragraph"><p>If you&#8217;ve read this far, you should have a good understanding of the syntax of the JavaScript language.Studying the code samples provided in this chapter has one extra benefit: now you can apply for a job as a tax accountant in a mafia near you.</p></div>
</div>
<div class="sect2">
<h3 id="_javascript_in_the_web_browser">JavaScript in the Web Browser</h3>
<div class="paragraph"><p>After learning all these facts and techniques about the language you might be eager to see "the real-world use of JavaScript". Slowly but surely a Web browser becomes the leading platform for development of the user interface.  The vast majority today&#8217;s JavaScript programs primarily manipulate HTML elements of Web pages. In this section we&#8217;ll be doing exactly this – applying JavaScript code to modify the content or style of HTML elements.</p></div>
<div class="paragraph"><p>DOM stands for Document Object Model. It&#8217;s an object representing the hierarchy of HTML elements of a  Web page. Every element of the HTML document is loaded into DOM. Each DOM element has a reference to its children and siblings. When DOM was invented, the Web pages were simple and static. DOM was not meant to be an object actively accessed by the code. This is the reason that on some of the heavily populated Web pages manipulating of DOM elements can be slow. Most likely DOM is the main target for anyone who&#8217;s trying to optimize the performance of a Web page.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If your Web page is slow, analyze it with <a href="http://yslow.org/">YSlow</a>, the tool built based on the Yahoo! rules for high performance Web sites. Also, you can minimize and obfuscate your JavaScript code with the help of  <a href="http://javascriptcompressor.com/">JavaScript Compressor</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>When a Web Browser is receiving the content it keeps performing the following activities:</p></div>
<div class="ulist"><ul>
<li>
<p>
Adding arriving HTML elements to DOM and laying out the content of the Web pages
</p>
</li>
<li>
<p>
Rendering of the UI
</p>
</li>
<li>
<p>
Running JavaScript that was included in the HTML
</p>
</li>
<li>
<p>
Processing events
</p>
</li>
</ul></div>
<div class="paragraph"><p>The amount of time spent on each of these activities varies depending the content of the page.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you are interested in learning how the browsers work in detail, read an excellent writeup titled "How Browsers Work: Behind The Scenes of Modern Web Browsers" at <a href="http://bit.ly/how-browsers-work">http://bit.ly/how-browsers-work</a>
[<a href="http://bit.ly/how-browsers-work">http://bit.ly/how-browsers-work</a>].</td>
</tr></table>
</div>
<div class="paragraph"><p>Let&#8217;s consider the operations your application needs to be able to perform inside the Web page:</p></div>
<div class="ulist"><ul>
<li>
<p>
Programmatically finding the required element by id, type, or a CSS class
</p>
</li>
<li>
<p>
Changing styles of the elements (show, hide, apply fonts and colors et al.)
</p>
</li>
<li>
<p>
Processing events that may happen to HTML elements (<span class="monospaced">click</span>, <span class="monospaced">mouseover</span> and the like)
</p>
</li>
<li>
<p>
Dynamically adding or removing HTML elements from the page or changing their contents
</p>
</li>
<li>
<p>
Communicating with the server side, e.g. submitting forms or making AJAX requests for some data from the server
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now you&#8217;ll see some code samples illustrating the use of JavaScript for the listed above operations. Even if you’ll be using one of the popular JavaScript frameworks, your program will be performing similar operations applying the syntax prescribed by your framework of choice. So let&#8217;s learn how it can be done.</p></div>
<div class="sect3">
<h4 id="_working_with_dom">Working with DOM</h4>
<div class="paragraph"><p>If you want to change the appearance of an HTML page, you need to manipulate with the DOM elements. Older Web applications were preparing the HTML content on the server side. For example, a server-side Java servlet would compose and send to the client HTML whenever the application logic required to change the appearance of the UI. The current trend is different - the client&#8217;s code takes care of the UI rendering, and only the data go back and forth between the client and the server. You&#8217;ll see how this works in more detail in Chapter 4 that explains the use of AJAX and JSON.</p></div>
<div class="paragraph"><p>Earlier in this chapter we were talking about the global namespace where all JavaScript objects live unless they were declared with <span class="monospaced">var</span> inside the functions. If the JavaScript code is running in a Web browser, this global namespace is represented by a special variable <span class="monospaced">window</span>. It&#8217;s an implicit variable and you don&#8217;t have to use it in your code, but whenever we say that a variable is global, we mean that it&#8217;s exists on the <span class="monospaced">window</span> object. For example, the code below will print "123 Main Street" twice:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> address <span style="color: #990000">=</span><span style="color: #FF0000">"123 Main Street"</span><span style="color: #990000">;</span>

console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>address<span style="color: #990000">);</span>
console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>window<span style="color: #990000">.</span>address<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">window</span> object has a number of useful properties like <span class="monospaced">cookie</span>, <span class="monospaced">location</span>, <span class="monospaced">parent</span>, <span class="monospaced">document</span> and others.  The variable <span class="monospaced">document</span> points at the root of the DOM hierarchy. Pretty often your  JavaScript code would find an element in the DOM first, and then it could read or modify its content.
<a href="#FIG2-20">[FIG2-20]</a> is a snapshot from Firebug showing the fragment of a DOM of a simple Web page mixins.html.</p></div>
<div class="imageblock" id="FIG2-20">
<div class="content">
<img src="images/fig_02_20.jpg" alt="images/fig_02_20.jpg">
</div>
<div class="title">Figure 20. Firebug&#8217;s representation of DOM</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Single Page Applications</div>
<div class="paragraph"><p>Have you ever seen a monitor of a trader working for a Wall Street firm? Actually, they usually have three or four large monitors, but let&#8217;s just look at one of them. Imagine a busy screen with lots and lots constantly changing data grouped in dedicated areas of the window. This screen shows the constantly changing prices from financial markets, the trader can place orders to buy or sell products, and notifications on completed trades are also coming to the same screen. If this is would be a Web application it would live in the same Web page. No menus to open another windows.</p></div>
<div class="paragraph"><p>The price of Apple share was $590.45 just a second ago and now it&#8217;s $590.60. How can this be done technically? Here&#8217;s one of the possibilities: every second an AJAX is being made to the remote server providing current stock prices and the JavaScript code finds in the DOM the HTML element responsible for rendering the price and then modifies its value with the latest price.</p></div>
<div class="paragraph"><p>Have you seen a Web page showing an input box of Google&#8217;s Gmail? It looks like a table with a list of rows representing the sender, subject, and the date of when each email arrived. All of a sudden you see a new row in bold on top of the list - the new email came in. How was this done technically? A new object(s) was created and inserted into a DOM tree. No page changes, no needs for the user to refresh the browser&#8217;s page - an undercover AJAX call gets the data and JavaScript changes the DOM. The content of DOM changed - the user sees an updated value.</p></div>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Below are some of the methods that exist on the `document` object:</pre>
</div></div>
<div class="paragraph"><p><span class="monospaced">document.write(text)</span> – adds the specifies text to the DOM. Careless using of the method <span class="monospaced">write()</span> can result in unpredictable results if after changing the DOM the HTML content is still arriving.</p></div>
<div class="paragraph"><p><span class="monospaced">document.getElementById(id)</span> – get a reference to the HTML element by its unique identifier</p></div>
<div class="paragraph"><p><span class="monospaced">document.getElementsByTagName(tname)</span> - get a reference to one or more elements by tag names, e.g.get a reference to all <span class="monospaced">&lt;div&gt;</span> elements.</p></div>
<div class="paragraph"><p><span class="monospaced">document.getElementsByName(name)</span> -  get a reference to all elements that have requested value in their <span class="monospaced">name</span> attribute.</p></div>
<div class="paragraph"><p><span class="monospaced">document.getElementsByClassName(className)</span> – get a reference to all elements to use specified CSS class.</p></div>
<div class="paragraph"><p><span class="monospaced">document.querySelector(cssSelector)</span> – Find the first element that matches provided CSS selector. string.</p></div>
<div class="paragraph"><p><span class="monospaced">document.querySelectorAll(cssSelector)</span> – Find all elements that match provided CSS selector string.</p></div>
<div class="paragraph"><p>The next code sample contains the HTML <span class="monospaced">&lt;span&gt;</span> element that has an id <span class="monospaced">emp</span>. Initially it contains ellipsis, but when the user enters the name in the input text field, the JavaScript code will find the reference to this <span class="monospaced">&lt;span&gt;</span> element and will replace the ellipsis with the content of the input text field.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;!</span>DOCTYPE html<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>meta charset<span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span> <span style="color: #990000">/&gt;</span>
        <span style="color: #990000">&lt;/</span>head<span style="color: #990000">&gt;</span>

        <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>h2<span style="color: #990000">&gt;</span>Selecting DOM elements<span style="color: #990000">&lt;/</span>h2<span style="color: #990000">&gt;</span>

        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>
                The employee of the month is <span style="color: #990000">&lt;</span>span id<span style="color: #990000">=</span><span style="color: #FF0000">"emp"</span><span style="color: #990000">&gt;...&lt;/</span>span<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>br<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>input type<span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> value<span style="color: #990000">=</span><span style="color: #FF0000">"Change the span value"</span>
               onclick<span style="color: #990000">=</span><span style="color: #FF0000">"setEmployeeOfTheMonth()"</span><span style="color: #990000">/&gt;</span>
        Enter your name  <span style="color: #990000">&lt;</span>input type<span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"theName"</span> <span style="color: #990000">/&gt;</span>
        <span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>

        <span style="color: #990000">&lt;</span>script<span style="color: #990000">&gt;</span>
           <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">setEmployeeOfTheMonth</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

                   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mySpan <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"emp"</span><span style="color: #990000">);</span>

                   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> empName<span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementsByTagName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"input"</span><span style="color: #990000">)[</span><span style="color: #993399">1</span><span style="color: #990000">];</span>

                   mySpan<span style="color: #990000">.</span>firstChild<span style="color: #990000">.</span>nodeValue<span style="color: #990000">=</span> empName<span style="color: #990000">.</span>value<span style="color: #990000">;</span>

                <span style="color: #FF0000">}</span>
        <span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>

        <span style="color: #990000">&lt;/</span>body<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>html<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Note the input field of type <span class="monospaced">button</span>, which includes the <span class="monospaced">onclick</span> property that corresponds to the <span class="monospaced">click</span> event. When the user clicks on the button, the browser dispatched <span class="monospaced">click</span> event, and calls the JavaScript function <span class="monospaced">setEmployeeOfTheMonth()</span>. The latter queries the DOM and finds the reference to the  <span class="monospaced">emp</span> by calling the method <span class="monospaced">getElementBuId()</span>. After that, the method <span class="monospaced">getElementByTagName()</span> is called trying to find all the references to the HTML <span class="monospaced">&lt;input&gt;</span> elements. This methods returns an array cause there could be more than one element with the same tag name on a page, which explains the use of array notation. The first <span class="monospaced">&lt;input&gt;</span> element is a button and the second is the text field we&#8217;re interested in. Remember that arrays in JavaScript have zero-based indexes. <a href="#FIG2-21">[FIG2-21]</a> shows the Web page after the user entered the name <em>Mary</em> and pressed the button.</p></div>
<div class="imageblock" id="FIG2-21">
<div class="content">
<img src="images/fig_02_21.jpg" alt="images/fig_02_21.jpg">
</div>
<div class="title">Figure 21. Changing the content of the HTML &lt;span&gt; element</div>
</div>
<div class="paragraph"><p>While manipulating the content of your Web page you may you may need to traverse the DOM tree. The code example below shows you an HTML document that includes JavaScript that walks the DOM and prints the name of each node. If a node has children, the recursive function <span class="monospaced">walkTheDOM()</span> will visit each child.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>WalkTheDom.html<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>

     <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>
        Enter your name: <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span>
                                <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"customerName"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"custName"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>

     <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Walk the DOM"</span>
                          <span style="color: #009900">onclick</span><span style="color: #990000">=</span><span style="color: #FF0000">"walkTheDOM(document.body, processNode)"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>

     <span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">walkTheDOM</span></span><span style="color: #990000">(</span>node<span style="color: #990000">,</span> processNode<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

                   <span style="font-weight: bold"><span style="color: #000000">processNode</span></span><span style="color: #990000">(</span>node<span style="color: #990000">)</span>
                    node <span style="color: #990000">=</span> node<span style="color: #990000">.</span>firstChild<span style="color: #990000">;</span>

                              <span style="font-weight: bold"><span style="color: #0000FF">while</span></span><span style="color: #990000">(</span>node<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                                 <span style="font-style: italic"><span style="color: #9A1900">// call wakTheDOM recursively for each child</span></span>
                                 <span style="font-weight: bold"><span style="color: #000000">walkTheDOM</span></span><span style="color: #990000">(</span>node<span style="color: #990000">,</span>processNode<span style="color: #990000">);</span>
                                 node <span style="color: #990000">=</span> node<span style="color: #990000">.</span>nextSibling<span style="color: #990000">;</span>
                              <span style="color: #FF0000">}</span>
            <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processNode</span></span><span style="color: #990000">(</span>node<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
            <span style="font-style: italic"><span style="color: #9A1900">// the real code for node processing goes here</span></span>

                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The current node name is "</span><span style="color: #990000">+</span>  node<span style="color: #990000">.</span>nodeName<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Our function <span class="monospaced">processNode()</span> just prints the name of the current node, but you could implement any code that your Web application requires.  Run this code in different browsers and check the output on the JavaScript console. <a href="#FIG2-22">[FIG2-22]</a> depicts two snapshots taken in the F12 Developer Tools in Internet Explorer (left) and FIrebug running in Firefox (right).</p></div>
<div class="imageblock" id="FIG2-22">
<div class="content">
<img src="images/fig_02_22.jpg" alt="images/fig_02_22.jpg">
</div>
<div class="title">Figure 22. Traversing the DOM in Firefox</div>
</div>
<div class="paragraph"><p>While some of the output is self-explanatory, there is a number of <span class="monospaced">#text</span> nodes that you won&#8217;t find in the code sample above. Unfortunately, Web browsers treat whitespaces differently, and inserts different number of text nodes in the DOM representing whitespaces found in the HTML document. So you&#8217;ll be better off using one of the JavaScript frameworks for traversing the DOM cross-browser way. For example, JQuery framework&#8217;s API for DOM traversing is listed at <a href="http://bit.ly/WXj2r2">http://bit.ly/WXj2r2</a>.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Styling Web Pages with CSS</div>
<div class="paragraph"><p>CSS stands for Cascading Style Sheets. During the last 15 years several CSS specifications reached the level of Recommendation by W3C: CSS Level 1, 2, and 2.1. The latest CSS Level 3 (a.k.a. CSS3) adds new features to CSS 2.1 module by module, which are listed at
<a href="http://www.w3.org/Style/CSS/current-work">http://www.w3.org/Style/CSS/current-work</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">You can find CSS tutorial as well as tons of other learning resources at <a href="http://www.webplatform.org/">webplatform.org</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>You can include CSS into a Web page either by linking to separate files using the HTML tag <span class="monospaced">&lt;link&gt;</span> or by in-lining the styles with the tag <span class="monospaced">&lt;style&gt;</span>. For example, if CSS is located in the file <span class="monospaced">mystyles.css</span> in
the folder css add the following tag to HTML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text/css"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"css/mystyles.css"</span> <span style="color: #009900">media</span><span style="color: #990000">=</span><span style="color: #FF0000">"all"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;link&gt;</span> tag allows specifying the media where specific css file has to be used. For example, you can have one CSS file for smartphones and another one for tablets. We’ll discuss this in detail in the section on media queries in Chapter 11.</p></div>
<div class="paragraph"><p>You should put this tag in the section of your HTML before any JavaScript code to make sure that they
stiles are loaded before the content of the Web page.</p></div>
<div class="paragraph"><p>Placing the <span class="monospaced">@import</span> attribute inside the <span class="monospaced">&lt;style&gt;</span> tag allows to include styles located elsewhere:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;style&gt;</span></span>
   @import url <span style="color: #990000">(</span>css<span style="color: #990000">/</span>contactus<span style="color: #993399">.css</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/style&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>What’s the best way of including CSS in HTML? Keeping CSS in multiple files separately from HTML and JavaScript makes the code more readable and reusable. On the other hand, if your Web site has
consists of many files, the Web browser will have to make multiple round trips to your server just to load all resources required by the HTML document, which can worsen the responsiveness of your Web application.</p></div>
</div></div>
<div class="paragraph"><p>HTML documents are often prettyfied by using CSS class selectors, and you can switch them  programmatically with JavaScript.  Imagine that a <span class="monospaced">&lt;style&gt;</span> section has the following definition of two class selectors <span class="monospaced">badStyle</span> and <span class="monospaced">niceStile</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>   <span style="color: #990000">&lt;</span>style<span style="color: #990000">&gt;</span>
         <span style="color: #993399">.badStyle</span><span style="color: #FF0000">{</span>
        <span style="color: #0000FF">font-family:</span> <span style="font-style: italic"><span style="color: #009900">Verdana</span></span>;
        <span style="color: #0000FF">font-size:</span><span style="font-style: italic"><span style="color: #009900">small</span></span>;
        <span style="color: #0000FF">color:</span><span style="font-style: italic"><span style="color: #009900">navy</span></span>;
        <span style="color: #0000FF">background-color:</span><span style="font-style: italic"><span style="color: #009900">red</span></span>;
    <span style="color: #FF0000">}</span>

    <span style="color: #993399">.niceStyle</span><span style="color: #FF0000">{</span>
        <span style="color: #0000FF">font-family:</span> <span style="font-style: italic"><span style="color: #009900">Verdana</span></span>;
        <span style="color: #0000FF">font-size:</span><span style="font-style: italic"><span style="color: #009900">large</span></span>;
        <span style="color: #0000FF">font-style:</span><span style="font-style: italic"><span style="color: #009900">italic</span></span>;
        <span style="color: #0000FF">color:</span><span style="font-style: italic"><span style="color: #009900">gray</span></span>;
        <span style="color: #0000FF">background-color:</span><span style="font-style: italic"><span style="color: #009900">green</span></span>;
    <span style="color: #FF0000">}</span>
  <span style="color: #990000">&lt;/</span>style<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>Any of these class selectors can be used by one or more HTML elements, for example</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"header"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"badStyle"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>This is my header<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Imagine that some important event has happened and the appearance the <span class="monospaced">&lt;div&gt;</span> styled as <span class="monospaced">badStyle</span> should programmatically change to &lt;niceStyle&gt;. In this case we need to find the <span class="monospaced">badStyle</span> element(s) first and change their style. The method <span class="monospaced">getElementsByClassName()</span> returns a set of elements that have the specified class name, and since our HTML has only one such element, the JavaScript will use the element zero from such set:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>          document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementsByClassName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"badStyle"</span><span style="color: #990000">)[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>className<span style="color: #990000">=</span><span style="color: #FF0000">"niceStyle"</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The next example will illustrate adding a new element to the DOM. On click of a button the code below dynamically creates an instance of type <span class="monospaced">img</span> and then assigns the location of the image to its <span class="monospaced">src</span> element. In a similar way we could have assigned values to any other attributes of the <span class="monospaced">img</span> element like <span class="monospaced">width</span>, <span class="monospaced">height</span>, or <span class="monospaced">alt</span>. The method <span class="monospaced">appendChild()</span> is applied to the &lt;body&gt; container, but it could be any other container that exists on the DOM.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;!</span>DOCTYPE html<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>meta charset<span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span> <span style="color: #990000">/&gt;</span>
        <span style="color: #990000">&lt;/</span>head<span style="color: #990000">&gt;</span>

    <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
     <span style="color: #990000">&lt;</span>h2<span style="color: #990000">&gt;</span>Employee of the month<span style="color: #990000">&lt;/</span>h2<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>p<span style="color: #990000">&gt;</span>
             <span style="color: #990000">&lt;</span>input type<span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> value<span style="color: #990000">=</span><span style="color: #FF0000">"Show me"</span>
                    onclick<span style="color: #990000">=</span><span style="color: #FF0000">"setEmployeeOfTheMonth()"</span><span style="color: #990000">/&gt;</span>
        <span style="color: #990000">&lt;/</span>p<span style="color: #990000">&gt;</span>

     <span style="color: #990000">&lt;</span>script<span style="color: #990000">&gt;</span>

         <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">setEmployeeOfTheMonth</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

           <span style="font-style: italic"><span style="color: #9A1900">// Create an image and add it to the &lt;body&gt; element</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> empImage<span style="color: #990000">=</span>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"img"</span><span style="color: #990000">);</span>
                   empImage<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'src'</span><span style="color: #990000">,</span><span style="color: #FF0000">'resources/images/employee.jpg'</span><span style="color: #990000">);</span>
                   document<span style="color: #990000">.</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>empImage<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>

     <span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;/</span>body<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>html<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Some HTML elements like <span class="monospaced">&lt;div&gt;</span> or &lt;span&gt; have contain other elements (children), and if you need to change their content use their property <span class="monospaced">innerHTML</span>. For example, to delete the entire content of the document body just do this: <span class="monospaced">document.body.innerHTML=""</span>.</td>
</tr></table>
</div>
<div class="paragraph"><p>If you run this example and click on the button "Show me" you&#8217;ll see an image of the employee of the month added to the <span class="monospaced">&lt;body&gt;</span> section of the HTML document as shown on <a href="#FIG2-23">[FIG2-23]</a>.</p></div>
<div class="imageblock" id="FIG2-23">
<div class="content">
<img src="images/fig_02_23.jpg" alt="images/fig_02_23.jpg">
</div>
<div class="title">Figure 23. After clicking the button "Show me"</div>
</div>
</div>
<div class="sect3">
<h4 id="_dom_events">DOM Events</h4>
<div class="paragraph"><p>Web browser will  notify your application when some changes or interactions occur. In such cases the browser will dispatch an appropriate event, for example <span class="monospaced">load</span>, <span class="monospaced">unload</span>, <span class="monospaced">mousemove</span>, <span class="monospaced">click</span>, <span class="monospaced">keydown</span> etc. When the Web page finished loading the browser will dispatch the <span class="monospaced">load</span> event. When the user will click on the button on a Web page the <span class="monospaced">click</span> event will be dispatched. A Web developer needs to provide JavaScript code that will react on the events important to the application. The browser events will occur regardless of if you provided the code to handle them or not. It&#8217;s important to understand some terms related to event processing.</p></div>
<div class="paragraph"><p>An <em>event handler (a.k.a. event listener)</em> is a JavaScript code you want to be called as a response to this event. The last code sample from the previous section was processing the <span class="monospaced">click</span> event on the button "Show me" as follows: <span class="monospaced">onclick="setEmployeeOfTheMonth()"</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Each HTML element has a certain number of predefined <em>event attributes</em>, which start with the prefix <span class="monospaced">on</span> followed by the name of the event. For example <span class="monospaced">onclick</span> is an event attribute that you can use for specifying the handler for the <span class="monospaced">click</span> event. You can find out what event attributes are available in the online document titled <a href="http://www.w3.org/TR/DOM-Level-3-Events//">Document Object Model Events</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>The preferred way of adding event listener was introduced in the DOM Level 2 specification back in 2000. You should find the HTML element in the DOM, and then assign the event listener to it by calling the method <span class="monospaced">addEventListener()</span>.  For example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> setEmployeeOfTheMonth<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The advantage of using of such programmatic assignment of event listeners is that this can be done for all controls in a in a central place, for example in a JavaScript function that runs immediately after the Web page completes loading. Another advantage is that you can programmatically remove the event listener if it&#8217;s not needed any longer by invoking <span class="monospaced">removeEventListener()</span>. The following example is a re-write of the last example from the previous section.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
     <span style="font-weight: bold"><span style="color: #0000FF">&lt;h2&gt;</span></span>Employee of the month<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h2&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>
             <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Show me"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"myButton"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span> <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- <img src="images/icons/callouts/1.png" alt="1"> --&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>

     <span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>
         window<span style="color: #990000">.</span>onload<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>         <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
                document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>
                                                      setEmployeeOfTheMonth<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">setEmployeeOfTheMonth</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

           <span style="font-style: italic"><span style="color: #9A1900">// Create an image and add it to the &lt;body&gt; element</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> empImage<span style="color: #990000">=</span>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"img"</span><span style="color: #990000">);</span>
                   empImage<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'src'</span><span style="color: #990000">,</span><span style="color: #FF0000">'resources/images/employee.jpg'</span><span style="color: #990000">);</span>
                   document<span style="color: #990000">.</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>empImage<span style="color: #990000">);</span>

                 document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>
                                                 setEmployeeOfTheMonth<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
                <span style="color: #FF0000">}</span>

     <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Compare this button with the one from the previous section: the event handler is removed, but it has an ID now.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
When the Web page completes loading, a <span class="monospaced">load</span> event is dispatched and the function attached to the event attribute <span class="monospaced">onload</span> assigns the event handler for the button <em>click</em> event. Note that we are passing the callback <span class="monospaced">setEmployeeOfTheMonth</span> as the second argument of the <span class="monospaced">addEventListener()</span>
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Removing the event listener after the image of the employee of the month has been added. Without this line each click on the button would add to the Web page yet another copy of the same image.
</td></tr>
</table></div>
<div class="paragraph"><p>Each event goes through three different phases: <em>Capture, Target, and Bubble</em>. It&#8217;s easier to explain this concept by example. Imagine that a button is located inside the <span class="monospaced">&lt;div&gt;</span>, which is located inside the <span class="monospaced">&lt;body&gt;</span> container. When you click on the button, the event travels to the button through all enclosing containers, and this is the capture phase. You can intercept the event at one of these containers even before it reached the button if need be. For example, your application logic may need to prevent the button from being clicked if certain condition occurs.</p></div>
<div class="paragraph"><p>Then event reaches the button, and it&#8217;s a target phase. After the event is handled by the button&#8217;s <span class="monospaced">click</span> handler, the event bubbles up through the enclosing containers, and this is the bubble phase. you can create listeners and handle this event after the button finished its processing at the target phase. The next code sample is based on the previous one, but it demonstrates the event processing in all three phases.</p></div>
<div class="paragraph"><p>Note that if your event handler function is declared with the event parameter, it&#8217;ll receive the <span class="monospaced">Event</span> object, which contains a number of useful parameters. For more information refer to the "Document Object Model Events" online.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;!</span>DOCTYPE html<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>html<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>head<span style="color: #990000">&gt;</span>
                <span style="color: #990000">&lt;</span>meta charset<span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span> <span style="color: #990000">/&gt;</span>
        <span style="color: #990000">&lt;/</span>head<span style="color: #990000">&gt;</span>

    <span style="color: #990000">&lt;</span>body<span style="color: #990000">&gt;</span>
     <span style="color: #990000">&lt;</span>h2<span style="color: #990000">&gt;</span>Employee of the month<span style="color: #990000">&lt;/</span>h2<span style="color: #990000">&gt;</span>
        <span style="color: #990000">&lt;</span>div id<span style="color: #990000">=</span><span style="color: #FF0000">"myDiv"</span><span style="color: #990000">&gt;</span>
             <span style="color: #990000">&lt;</span>input type<span style="color: #990000">=</span><span style="color: #FF0000">"button"</span> value<span style="color: #990000">=</span><span style="color: #FF0000">"Show me"</span> id<span style="color: #990000">=</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">/&gt;</span>
        <span style="color: #990000">&lt;/</span>div<span style="color: #990000">&gt;</span>

     <span style="color: #990000">&lt;</span>script<span style="color: #990000">&gt;</span>
         window<span style="color: #990000">.</span>onload<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>
                                                          setEmployeeOfTheMonth<span style="color: #990000">);</span>

                document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myDiv"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>
                                                          processDivBefore<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
                document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>
                                                          processDivAfter<span style="color: #990000">);</span>

         <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">setEmployeeOfTheMonth</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

           console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Got the click event in target phase"</span><span style="color: #990000">);</span>

           <span style="font-style: italic"><span style="color: #9A1900">// Create an image and add it to the &lt;body&gt; element</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> empImage<span style="color: #990000">=</span>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"img"</span><span style="color: #990000">);</span>
                   empImage<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'src'</span><span style="color: #990000">,</span><span style="color: #FF0000">'resources/images/employee.jpg'</span><span style="color: #990000">);</span>
                   document<span style="color: #990000">.</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>empImage<span style="color: #990000">);</span>

                 document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"myButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span>
                                                              setEmployeeOfTheMonth<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processDivBefore</span></span><span style="color: #990000">(</span>evt<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Intercepted the click event in capture phase"</span><span style="color: #990000">);</span>

                <span style="font-style: italic"><span style="color: #9A1900">// Cancel the click event so the button won't get it</span></span>

                <span style="font-style: italic"><span style="color: #9A1900">// if (evt.preventDefault) evt.preventDefault();        <img src="images/icons/callouts/2.png" alt="2"></span></span>
                <span style="font-style: italic"><span style="color: #9A1900">// if (evt.stopPropagation) evt.stopPropagation();</span></span>
         <span style="color: #FF0000">}</span>

         <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">processDivAfter</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Got the click event in bubble phase"</span><span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span>
     <span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span>
    <span style="color: #990000">&lt;/</span>body<span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;/</span>html<span style="color: #990000">&gt;</span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
We&#8217;ve added two event handler on the <span class="monospaced">&lt;div&gt;</span> level. The first one intercepts the event on the capture phase. When the third argument of <span class="monospaced">addEventListener()</span> is true, this handler will kick in during capture phase.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
If you uncomment these two lines, the default behavior if the <span class="monospaced">click</span> event will be cancelled and it won&#8217;t reach the button at all. Unfortunately, browsers may have different method implementing <em>prevent default</em> functionality hence additional if-statements are needed.
</td></tr>
</table></div>
<div class="paragraph"><p>Running the above example will cause the following output in the JavaScript console:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Intercepted the click event in capture phase
Got the click event in target phase
Got the click event in bubble phase</tt></pre></div></div>
<div class="paragraph"><p>You can see another example of using intercepting the event during the capture phase in the Donate Section of Chapter 2.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">The Microsoft&#8217;s Web browsers Internet Explorer 8 and below didn&#8217;t implement the W3C DOM Level 3 event model -  they handled events differently. You can read more on the subject at this MSDN article <a href="http://blogs.msdn.com/b/ie/archive/2010/03/26/dom-level-3-events-support-in-ie9.aspx">http://bit.ly/anZZgZ</a>.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_2">Summary</h3>
<div class="paragraph"><p>This chapter was covering the JavaScript language constructs that any professional Web developer should know. A smaller portion of this chapter was illustrating how to combine JavaScript, HTML, and CSS. There are lots of online resources and books that cover just the HTML markup and CSS, and you&#8217;ll definitely need to spend more time mastering details of the Web tools like Firebug or Google Developer Tools.
Starting from the next chapter we&#8217;ll be working on the Save Sick Child application, which will help you in better understanding of how these ingredients of HTML5 work together and compliment each other.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mocking_up_the_application_save_sick_child">Mocking Up the Application Save Sick Child</h2>
<div class="sectionbody">
<div class="paragraph"><p>The time has come to start working on our Web application Save Sick Child. It&#8217;s going to be a Web application that will supports donations to sick children, show some video, integrate the Google maps, and will feature an online auction. The goal is to gradually build all the functionality of the Web site while explaining each step of the way and giving you the reasons why we are building it the way we do. By the end of this chapter the Web design and the first prototype of the Save Sick Child will be ready.</p></div>
<div class="paragraph"><p>The proliferation of mobile devices and Web applications require new skills for development of what was known as boring-looking enterprise applications. In the past, design of the user interface of most of the enterprise applications was done by developers to the best of their artistic abilities: a couple of buttons here, and a grid there on a gray background.  The business users were happy cause they did not see any better. The application allowed to process business data – what else to wish for?  Enterprise business users used to be happy with any UI as long as the application helped them to take care of their business.</p></div>
<div class="paragraph"><p>But today&#8217;s business users are spoiled by nice looking consumers applications, and more often than not new development starts with inviting a Web designer who should create a prototype of the future application.  For example, we’ve seen some excellent (from the UI perspective) functional specifications for boring financial applications made by professional designers.  Business users slowly but surely becoming more demanding in the area of the UI design solutions. The trend is clear: developer’s art does not cut it anymore.  You need to hire a professional Web designer for your next Web application. The software developers are not overly familiar with the tools that Web designers are using. This chapter will illustrate the process of design and prototyping of the UI of a Web application.</p></div>
<div class="paragraph"><p>Our Web designer, let&#8217;s call him Jerry, is ready to start working on the <em>mockup</em> (a.k.a. <em>wireframes</em>) - a set of images depicting various views of the future Save Sick Child application. We expect him to deliver images with comments that would briefly explain what should change in a view if a user will take  certain actions, e.g. clicks on the button. You can also think of a UI of an application as a set of states, and the user’s action result in your application transitioning from one state to the other. As nerds and mathematicians say, the UI of your application is a <a href="http://en.wikipedia.org/wiki/State_machine">finite state machine</a>", which at any given point of time is in one of the finite number of states, for example, in the view state Donate Form or Auction.</p></div>
<div class="sect2">
<h3 id="_mobile_first">Mobile First?</h3>
<div class="paragraph"><p>While starting working on the design of a new Web application keep in mind that most likely some users will access it from mobile devices. Will the proposed UI look good on the mobile devices with smaller screens? Some people suggest using so-called "Mobile First" approach. For example, take the geographical location services. The users of iOS and Android devices are used to the fact that they can find the closest restaurant or a gas station based on their current location. Do you know that location feature can be available on the desktops too? Google maps API is just one of the services that can find the location of the user&#8217;s desktop based on its IP address, Wi-Fi router&#8217;s ID or proximity to the cell towers.Zeroing in on your device may not be as precise as with the smartphone&#8217;s GPS, but it may be good enough. So why not plan for adding this feature to all versions of your Web application?  Finding the closest charity event or a sick sick child can be done knowing an approximate location of your desktop computer.</p></div>
<div class="paragraph"><p>Let&#8217;s consider pointing devices. At the time of this writing, vast majority of the desktop users work with pixel-perfect mouse pointers or track pads. SmartPhone or tablet users work with fingers. One finger touch can cover a square with 100 pixels. The CNN site shows lots of news links located very close to each other on the screen. A finger may cover more than one link, and Android devices offer you a larger popup allowing you to select the link you really wanted to touch. Having the "Mobile first" state of mind doesn&#8217;t mean that CNN would need to keep the larger distance between the links for all the users. But this means that they should foresee the issues or innovate using the features offered by modern mobile devices.</p></div>
<div class="paragraph"><p>In Chapter 11 we&#8217;ll discuss the <em>responsive design</em> techniques that allow to create the UI for Web applications that automatically re-allocate the screen content based on the screen size of the user&#8217;s device. Although this chapter is about the desktop version of the Sick Child Web application, its screen will consist of several rectangular areas that can be allocated differently (or even hidden) on smartphones or tablets.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Consider reading Chapter 11 now to understand what you will need to deal with to developing Web applications that look good on desktop monitors as well as on mobile screens. Understanding of the responsive design principles will help you in communications with your Web designer.</td>
</tr></table>
</div>
<div class="paragraph"><p>One of the constraints that the mobile users have is the relatively slow speed of the mobile Internet. This means that even though your desktop users will use fast LAN connection lines, your Web application has to be modularized and only the minimal number modules has to be loaded initially. Often mobile providers charge the user based on the amount of consumed data too.</p></div>
<div class="paragraph"><p>The chances are slim that the desktop users will lose the Internet connection for a long period of time. On the other hand, the mobile users may stay in the area with no or spotty connection. In this case the "Mobile First" thinking can lead to introducing an offline mode with limited functionality.</p></div>
<div class="paragraph"><p>Thinking upfront of the minimal content to be displayed on a small mobile screens may force you to change the design of the desktop Web pages too. In our sample Save Sick Child application we need to make sure that there is a space for the Donate button even on the smallest devices.</p></div>
</div>
<div class="sect2">
<h3 id="_introducing_balsamiq_mockups">Introducing Balsamiq Mockups</h3>
<div class="paragraph"><p>Visualize a project owner talking to Jerry in a cafeteria, and Jerry is drawing sketches of the future Web site on a napkin. Well, in the 21st Century he’ll use an electronic napkin so to speak - an excellent prototyping tool called <a href="http://balsamiq.com">Balsamiq Mockups</a>. This easy to use program gives you a working area where you create a mockup of your future Web application by dragging and dropping the required UI components from the toolbar onto the image of the Web page (see <a href="#FIG3-1">[FIG3-1]</a>).</p></div>
<div class="imageblock" id="FIG3-1">
<div class="content">
<img src="images/fig_03_01.jpg" alt="image">
</div>
<div class="title">Figure 24. The working area of Balsamiq Mockups</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you can&#8217;t find the required image in Balsamiq&#8217;s library, add your own by dragging and dropping it onto the top toolbar. For example, the mockup in Chapter 11 uses our images of the iPhone that we&#8217;ve added to Balsamiq assets.</td>
</tr></table>
</div>
<div class="paragraph"><p>When the prototype is done, it can be saved as an image and sent to the project owner. Another option is to export the Balsamiq project into XML, and if both the project owner and Web designer have Balsamiq installed, they can work on the prototype in collaboration. For example, the designer exports the current states of the project, the owner imports it and makes corrections or comments, then exports it again and sends it back to the designer.</p></div>
</div>
<div class="sect2">
<h3 id="_the_project_owner_talks_to_a_web_designer">The Project Owner Talks to a Web Designer</h3>
<div class="paragraph"><p>During the first meeting Jerry talks to the project owner discussing the required functionality and then creates the UI to be implemented by Web developers. The artifacts produced by the designer vary depending on the qualifications of the designer. This can be a set of images representing different states of the UI with little <em>callouts</em> explaining the navigation of the application. If the Web designer is familiar with HTML and CSS, developers may get a working prototype in the form of HTML and CSS files, and this is exactly what Jerry will create by the end of this chapter.</p></div>
<div class="paragraph"><p>Our project owner said to Jerry: <em>"The Save Sick Child Web site should allow people to make donations to sick children. The users should be able to find these children by specifying a geographical area on the map. The site should be integrated with a payment system, include a video player and display statistics about the donors and recipients. The site should include an online auction with proceeds going to charity. We&#8217;ll start working on the desktop version of this site first, but your future mockup should include three versions of the UI supporting desktops, tablets, and smartphones"</em>.</p></div>
<div class="paragraph"><p>After the meeting Jerry launched Balsamiq and started to work. He decided that the main window will consist of four areas laid out vertically:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The header with the logo and several navigation buttons
</p>
</li>
<li>
<p>
The main area with the Donate support plus the video player
</p>
</li>
<li>
<p>
The area with the Find Local Kid, statistics, and charts.
</p>
</li>
<li>
<p>
The footer with several house-holding links plus the icons for Twitter and FaceBook.
</p>
</li>
</ol></div>
</div>
<div class="sect2">
<h3 id="_first_mockups">First Mockups</h3>
<div class="paragraph"><p>The first deliverable of our Web designer (see <a href="#FIG3-2">[FIG3-2]</a> and <a href="#FIG3-3">[FIG3-3]</a>) depicted two states of the UI: before and after clicking the button Donate Now. The Web designer suggested that on the button click the Video Player would turn into a small button revealing the donation form.</p></div>
<div class="imageblock" id="FIG3-2">
<div class="content">
<img src="images/fig_03_02.png" alt="images/fig_03_02.png">
</div>
<div class="title">Figure 25. The main view before clicking Donate Now</div>
</div>
<div class="imageblock" id="FIG3-3">
<div class="content">
<img src="images/fig_03_03.png" alt="images/fig_03_03.png">
</div>
<div class="title">Figure 26. The main view after clicking Donate Now</div>
</div>
<div class="paragraph"><p>The project owner suggested that turning the video into a Donate button may not be a the best idea. We shouldn’t forget that the main goal of this application is collecting donation, so they decided to keep the user&#8217;s attention on the Donate area and move the video player to the lower portion of the window.</p></div>
<div class="paragraph"><p>After that they went over the mockups of the authorization routine. The view states in this process can be :
1. Not Logged On
2. The Login Form
3. Wrong ID/Password
4. Forgot Password
5. Successfully Logged On</p></div>
<div class="paragraph"><p>The Web designer has created mockups of some of these states as shown on  <a href="#FIG3-4">[FIG3-4]</a> and <a href="#FIG3-5">[FIG3-5]</a>.</p></div>
<div class="imageblock" id="FIG3-4">
<div class="content">
<img src="images/fig_03_04.png" alt="images/fig_03_04.png">
</div>
<div class="title">Figure 27. The user haven&#8217;t clicked on the Login button</div>
</div>
<div class="paragraph"><p>The latter shows different UI states should the user decide to log in. The project owner reviewed the mokups and return them back to Jerry with some comments. The project owner wanted to make sure that the user doesn&#8217;t have to log on to the application to access the Web site. The process of making donations has to be as easy as possible, and forcing the donor to log on may scare some people away, so the project owner left his comment as shown on <a href="#FIG3-5">[FIG3-5]</a>.</p></div>
<div class="imageblock" id="FIG3-5">
<div class="content">
<img src="images/fig_03_05.png" alt="images/fig_03_05.png">
</div>
<div class="title">Figure 28. The user haven&#8217;t clicked on the Login button</div>
</div>
</div>
<div class="sect2">
<h3 id="_from_mockups_to_a_prototype">From Mockups to a Prototype</h3>
<div class="paragraph"><p>We are lucky - Jerry knows HTML and CSS. He&#8217;s ready to turn the still mockups into the first working prototype. It&#8217;ll use only hard-coded data but the layout of the site will be done in CSS and we’ll use HTML5 markup.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">Authors of this book assume that the users of our Save Sick Child site work with the modern versions of Web browsers (two year old or younger). The real world Web developers need to deal with finding workarounds to the unsupported CSS or HTML5 features in the old browsers, but modern IDE generate HTML5 boilerplate code that include large CSS files providing different solutions to older browsers. JavaScript frameworks implement workaround for features unsupported by old browsers too, so we don&#8217;t want to clutter the text providing several versions of the code just to make book samples work in outdated browsers.</td>
</tr></table>
</div>
</div></div>
<div class="paragraph"><p>This chapter will include lots of code samples illustrating how the UI is gradually being built.  We&#8217;ve created a number of Aptana Studio projects and each of them can be run independently. Create a new workspace in Aptana Studio (File | Switch Workspace) and import all these projects from ch3.zip in one shot (File | Import | General | Exiting projects into Workspace ). After that you&#8217;ll be able to run each of these examples by right-clicking on the index.html and selecting Run as | JavaScript Web Application.</p></div>
<div class="sect3">
<h4 id="_basic_page_layout_and_login">Basic Page Layout and Login</h4>
<div class="paragraph"><p>In this section you&#8217;ll see several Aptana projects that show how the static mockup will turn into a working prototype with the help of HTML, CSS, and JavaScript. Jerry, the designer, decided to have four separate areas on the page hence he created the HTML file index.html that has the tag <span class="monospaced">&lt;header&gt;</span> with the navigation tag <span class="monospaced">&lt;nav&gt;</span>, two <span class="monospaced">&lt;div&gt;</span> tags for the middle sections of the page and a <span class="monospaced">&lt;footer&gt;</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Save Sick Child | Home Page<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"css/styles.css"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;header&gt;</span></span>
                 <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Save Sick Child<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
                 <span style="font-weight: bold"><span style="color: #0000FF">&lt;nav&gt;</span></span>
                  <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void()"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Who we are<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void()"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>What we do<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void()"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Way to give<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                          <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void()"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>How we work<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
                 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/nav&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/header&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span> <span style="color: #009900">role</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;section&gt;</span></span>
                          Donate section and Video Player go here
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;section&gt;</span></span>
                          Locate sick child, stats and tab folder go here
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;footer&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-project-name-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;b&gt;</span></span>project 01<span style="font-weight: bold"><span style="color: #0000FF">&lt;/b&gt;</span></span>: This is the page footer
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/footer&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that the above HTML includes the CSS file shown below using the <span class="monospaced">&lt;link&gt;</span> tag. Since there is no content yet for the navigation links to open, we use the syntax <span class="monospaced">href="javascript:void()</span> that allows to create a live link that doesn&#8217;t load any page, which is fine on the prototyping stage.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* Navigation menu */</span></span>
nav <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">float:</span> <span style="font-style: italic"><span style="color: #009900">right</span></span>
<span style="color: #FF0000">}</span>
nav ul li <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">list-style:</span> <span style="font-style: italic"><span style="color: #009900">none</span></span>;
        <span style="color: #0000FF">float:</span> <span style="font-style: italic"><span style="color: #009900">left</span></span>;
<span style="color: #FF0000">}</span>
nav ul li a <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">display:</span> <span style="font-style: italic"><span style="color: #009900">block</span></span>;
        <span style="color: #0000FF">padding:</span> <span style="font-style: italic"><span style="color: #009900">7px</span></span> <span style="font-style: italic"><span style="color: #009900">12px</span></span>;
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">/* Main content</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> #main-container is a wrapper for all page content</span></span>
<span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<span style="color: #993399">#main</span><span style="color: #990000">-</span>container <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">width:</span> <span style="font-style: italic"><span style="color: #009900">980px</span></span>;
        <span style="color: #0000FF">margin:</span> <span style="font-style: italic"><span style="color: #009900">0</span></span> <span style="font-style: italic"><span style="color: #009900">auto</span></span>;
<span style="color: #FF0000">}</span>
div<span style="color: #993399">#main</span> <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">clear:</span> <span style="font-style: italic"><span style="color: #009900">both</span></span>;
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">/* Footer */</span></span>
footer <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">/* Set background color just to make the footer standout*/</span></span>
        <span style="color: #0000FF">background:</span> <span style="color: #FF0000">#eee</span>;
        <span style="color: #0000FF">height:</span> <span style="font-style: italic"><span style="color: #009900">20px</span></span>;
<span style="color: #FF0000">}</span>
footer <span style="color: #993399">#temp</span><span style="color: #990000">-</span>project<span style="color: #990000">-</span>name<span style="color: #990000">-</span>container <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">float:</span> <span style="font-style: italic"><span style="color: #009900">left</span></span>;
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The above CSS controls not only the styles of the page content, but also that sets the page layout. The <span class="monospaced">&lt;nav&gt;</span> section should be pushed to the right. If an unordered list is placed inside the <span class="monospaced">&lt;nav&gt;</span>, it should be left aligned. The width of the HTML container with ID <span class="monospaced">main-container</span> should be 980 pixels, and it has to be automatically centered. The footer will be 20 pixels high and should have a gray background. The first version of our Web page is shown on <a href="#FIG3-6">[FIG3-6]</a></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">In Chapter 11 you&#8217;ll see how to create Web pages with more flexible layouts that don&#8217;t require specifying absolute sizes in pixels.</td>
</tr></table>
</div>
<div class="imageblock" id="FIG3-6">
<div class="content">
<img src="images/fig_03_06.png" alt="images/fig_03_06.png">
</div>
<div class="title">Figure 29. Working prototype. Take 1: Getting Started.</div>
</div>
<div class="paragraph"><p>The next version of our prototype is a lot more interesting and it will contain a lot more code. First of all, the CSS file will become fancier, the layout of the four page sections will properly divide the screen real estate. We&#8217;ll add a Logo and a nicely styled Login button to the top of the page. This version of the code will also introduce some JavaScript supporting user&#8217;s authorization. Run the Aptana project project-02-login, and you&#8217;ll see a window similar to <a href="#FIG3-7">[FIG3-7]</a>.</p></div>
<div class="imageblock" id="FIG3-7">
<div class="content">
<img src="images/fig_03_07.png" alt="images/fig_03_07.png">
</div>
<div class="title">Figure 30. Working prototype. Take2: Login.</div>
</div>
<div class="paragraph"><p>The new Aptana project created by Jerry has several directories to keep JavaScript, images, CSS, and fonts separately. We&#8217;ll talk about special icon fonts later in this section, but first things first - let&#8217;s take a close look at the HTML code.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">http-equiv</span><span style="color: #990000">=</span><span style="color: #FF0000">"X-UA-Compatible"</span> <span style="color: #009900">content</span><span style="color: #990000">=</span><span style="color: #FF0000">"IE=edge,chrome=1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Save Sick Child<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/css/styles.css"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
         <span style="font-weight: bold"><span style="color: #0000FF">&lt;header&gt;</span></span>
<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- <img src="images/icons/callouts/1.png" alt="1"> --&gt;</span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"logo"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Save Sick Child<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/h1&gt;</span></span>

           <span style="font-weight: bold"><span style="color: #0000FF">&lt;nav</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"top-nav"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
                  <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"login"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                   <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"authorized"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-user authorized-icon"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"user-authorized"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>admin<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"profile-link"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0);"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>profile<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span> |
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"logout-link"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0);"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>logout<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

                   <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"login-form"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-user login-form-icons"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"username"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"username"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span>
                                <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"username"</span> <span style="color: #009900">autocomplete</span><span style="color: #990000">=</span><span style="color: #FF0000">"off"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #000080">&amp;nbsp;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-locked login-form-icons"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span>
                                <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span> <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"password"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
                   <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"login-submit"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>login <span style="font-weight: bold"><span style="color: #000080">&amp;nbsp;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-enter"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>

<span style="font-style: italic"><span style="color: #9A1900">&lt;!-- <img src="images/icons/callouts/2.png" alt="2"> --&gt;</span></span>
                        <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- &lt;a id="login-link" class="show-form"</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                                   href="javascript:void(0)"&gt;login</span></span>
<span style="font-style: italic"><span style="color: #9A1900">                                   &amp;nbsp;&lt;span class="icon-enter"&gt;&lt;/span&gt; &lt;/a&gt; --&gt;</span></span>

                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"login-link"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"show-form"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>login
                                      <span style="font-weight: bold"><span style="color: #000080">&amp;nbsp;</span></span> <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-enter"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/div&gt;</span></span>

                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"clearfix"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/div&gt;</span></span>
                 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                 <span style="font-weight: bold"><span style="color: #0000FF">&lt;li</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"top-menu-items"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Who We Are<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>What We Do<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Where We Work<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Way To Give<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
                 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">&lt;/nav&gt;</span></span>
         <span style="font-weight: bold"><span style="color: #0000FF">&lt;/header&gt;</span></span>

         <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span> <span style="color: #009900">role</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-top-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
                        Main content. Top section.
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-bottom-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        Main content. Bottom section.
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
         <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
         <span style="font-weight: bold"><span style="color: #0000FF">&lt;footer&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-project-name-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;b&gt;</span></span>This is the footer<span style="font-weight: bold"><span style="color: #0000FF">&lt;/b&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
         <span style="font-weight: bold"><span style="color: #0000FF">&lt;/footer&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/js/main.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Usually, the logos on multi-page Web sites are clickable - they bring up the home page. That&#8217;s why Jerry placed the anchor tag there. But we are planning to build a single-page application (SPA) so having a clickable logo won&#8217;t be needed.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Run this project in Aptana and click on the button Login, and you&#8217;ll see that it reacts. But looking at the login-related <span class="monospaced">&lt;a&gt;</span> tags in the code above you&#8217;ll find nothing but <span class="monospaced">href="javascript:void(0)"</span>. So why the button reacts? Read the code in the main.js shown below, and you&#8217;ll find there line <span class="monospaced">loginLink.addEventListener('click', showLoginForm, false);</span> that invokes the callback <span class="monospaced">showLoginForm()</span>. That why the Login button reacts. This seems confusing cause the anchor component was used here just for styling purposes. In this example a better solution  would be to replace the anchor tag <span class="monospaced">&lt;a id="login-link" class="show-form" href="javascript:void(0)"&gt;</span> with another component that doesn&#8217;t make the code confusing, for example <span class="monospaced">&lt;div id="login-link" class="show-form"&gt;</span>.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">Single Page Web Applications (SPA) are the ones that don&#8217;t require loading multiple pages as a result of the user&#8217;s action. The user enters the URL in the browser, which brings the Web page that remains open on the screen until the user stop working with this application. The portion of the user&#8217;s screen may change using the AJAX techniques (see Chapter 4), but the page doesn&#8217;t gets reloaded. This allows building so-called fat client applications that can remember its state.</td>
</tr></table>
</div>
<div class="paragraph"><p>Now let&#8217;s examine the JavaScript code located in main.js. This code will self-invoke the anonymous function, which creates an object - encapsulated namespace ssc (short for Save Sick Child). This avoids polluting the global namespace. If we wanted to expose anything from this closure to the global namespace we could have done is as described in Chapter 2 in the section Closures, but in our example the code in main.js is completely sealed.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">// global namespace ssc</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ssc <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// Encapsulated variables</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">// Find login section elements                   //  <img src="images/icons/callouts/1.png" alt="1"></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> loginLink <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"login-link"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> loginForm <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"login-form"</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> loginSubmit <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'login-submit'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> logoutLink <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'logout-link'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> profileLink <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'profile-link'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> authorizedSection <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"authorized"</span><span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userName <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'username'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userPassword <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'password'</span><span style="color: #990000">);</span>

        <span style="font-style: italic"><span style="color: #9A1900">// Register event listeners                       // <img src="images/icons/callouts/2.png" alt="2"></span></span>

        loginLink<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showLoginForm<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
        loginSubmit<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> logIn<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
        logoutLink<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> logOut<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
        profileLink<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> getProfile<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showLoginForm</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                loginLink<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"none"</span><span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
                loginForm<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
                loginSubmit<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showAuthorizedSection</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                authorizedSection<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
                loginForm<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"none"</span><span style="color: #990000">;</span>
                loginSubmit<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"none"</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">logIn</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">//check credentials</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userNameValue <span style="color: #990000">=</span> userName<span style="color: #990000">.</span>value<span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userNameValueLength <span style="color: #990000">=</span> userName<span style="color: #990000">.</span>value<span style="color: #990000">.</span>length<span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userPasswordValue <span style="color: #990000">=</span> userPassword<span style="color: #990000">.</span>value<span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userPasswordLength <span style="color: #990000">=</span> userPassword<span style="color: #990000">.</span>value<span style="color: #990000">.</span>length<span style="color: #990000">;</span>

                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValueLength <span style="color: #990000">==</span> <span style="color: #993399">0</span> <span style="color: #990000">||</span> userPasswordLength <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValueLength <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"username can't be empty"</span><span style="color: #990000">);</span>
                        <span style="color: #FF0000">}</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userPasswordLength <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"password can't be empty"</span><span style="color: #990000">);</span>
                        <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValue <span style="color: #990000">!=</span> <span style="color: #FF0000">'admin'</span> <span style="color: #990000">||</span>
                                          userPasswordValue <span style="color: #990000">!=</span> <span style="color: #FF0000">'1234'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'username or password is invalid'</span><span style="color: #990000">);</span>

                <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValue <span style="color: #990000">==</span> <span style="color: #FF0000">'admin'</span> <span style="color: #990000">&amp;&amp;</span>
                                          userPasswordValue <span style="color: #990000">==</span> <span style="color: #FF0000">'1234'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

                        <span style="font-weight: bold"><span style="color: #000000">showAuthorizedSection</span></span><span style="color: #990000">();</span>                     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">logOut</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                userName<span style="color: #990000">.</span>value <span style="color: #990000">=</span> <span style="color: #FF0000">''</span><span style="color: #990000">;</span>
                userPassword<span style="color: #990000">.</span>value <span style="color: #990000">=</span> <span style="color: #FF0000">''</span><span style="color: #990000">;</span>
                authorizedSection<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"none"</span><span style="color: #990000">;</span>
                loginLink<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">getProfile</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Profile link clicked'</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
First query the DOM to get references to login-related HTML elements.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Register event listeners for the clickable login elements.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
To make a DOM element invisible set its <span class="monospaced">style.display="none"</span>. Hide the login button and show the login form having two input fields for entering the user id and the password.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
If the user is <em>admin</em> and the password is <em>1234</em>, hide the <span class="monospaced">loginForm</span> and make the top corner of the page look as in <a href="#FIG3-8">[FIG3-8]</a>
</td></tr>
</table></div>
<div class="imageblock" id="FIG3-8">
<div class="content">
<img src="images/fig_03_08.png" alt="images/fig_03_08.png">
</div>
<div class="title">Figure 31. After successful login</div>
</div>
<div class="paragraph"><p>In the beginning of Chapter 2 we&#8217;ve recommended to put the <span class="monospaced">&lt;script&gt;</span> tag with your JavaScript at the end of your HTML file, which we did in our index.html above. If you move the line <span class="monospaced">&lt;script src="js/main.js"&gt;&lt;/script&gt;</span> to the top of the <span class="monospaced">&lt;body&gt;</span> section and re-run index.html the screen will look as in <a href="#FIG3-7">[FIG3-7]</a>, but clicking on the Login won&#8217;t display the login form as it should. Why? Because registering of the event listeners in the script main.js failed cause the DOM components  (<span class="monospaced">login-link</span>, <span class="monospaced">login-form</span> and others) were not created yet by the time this script was running. Open the Firebug or other debugging tool and you&#8217;ll see an error on the console that will look similar to the following:</p></div>
<div class="paragraph"><p><em>"TypeError: loginLink is null
loginLink.addEventListener(<em>click</em>, showLoginForm, false);"</em></p></div>
<div class="paragraph"><p>Of course, in many cases your JavaScript code could have tested if the DOM elements exist before using them, but in this particular sample it&#8217;s just easier to to put the script at the end of the HTML file. Another solution would be to load the JavaScript code located in main.js in a separate handler function that would run only when the window&#8217;s <span class="monospaced">load</span> event is dispatched by the browser indicated that the DOM is ready: <span class="monospaced">window.onload = function() {...}</span>. You&#8217;ll see how to do this in the next version of main.js.</p></div>
<div class="paragraph"><p>After reviewing the HTML and JavaScript code let&#8217;s spend a little more time with the CSS that supports the pages shown in <a href="#FIG3-7">[FIG3-7]</a>. The difference between the screen shots shown in <a href="#FIG3-6">[FIG3-6]</a> and <a href="#FIG3-7">[FIG3-7]</a> is substantial. First, the top left image is nowere to be found in index.html. Open the styles.css file and you&#8217;ll see the line <span class="monospaced">background: url(../img/logo.png) no-repeat;</span> in the <span class="monospaced">header h1#logo</span> section.</p></div>
<div class="paragraph"><p>The page layout is also specified in the file styles.css. In this version the sizes of each section is specified in pixels (px), which won&#8217;t make you page fluid and easily resizable.  For example, the HTML element with <span class="monospaced">id="main-top-section"</span> is styled like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #993399">#main</span><span style="color: #990000">-</span>top<span style="color: #990000">-</span>section <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">width:</span> <span style="font-style: italic"><span style="color: #009900">100%</span></span>;
        <span style="color: #0000FF">height:</span> <span style="font-style: italic"><span style="color: #009900">320px</span></span>;
        <span style="color: #0000FF">margin-top:</span> <span style="font-style: italic"><span style="color: #009900">18px</span></span>;
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Jerry styled the main to section to take the entire width of the browser&#8217;s window and to be 320 pixels tall. If you&#8217;ll keep in mind the "Mobile First" mantra, this may not be the best approach cause 320 pixels mean difference size (in inches) on the displays with different screen density. For example, 320 pixels on the iPhone 5 with retina display will look a lot smaller than 320 pixels on the iPhone 4. You may consider switching from <span class="monospaced">px</span> to <span class="monospaced">em</span> units: 1em is equal to the current font height, 2em means twice the size et al. You can read more about creating scalable style sheets with <em>em</em> units at <a href="http://www.w3.org/WAI/GL/css2em.htm">http://www.w3.org/WAI/GL/css2em.htm</a>.</p></div>
<div class="paragraph"><p>What looks a Login button on <a href="#FIG3-7">[FIG3-7]</a> is not a button, but a styled <span class="monospaced">div</span> element. Initially it was a clickable anchor <span class="monospaced">&lt;a&gt;</span>, and we&#8217;ve explained this change right after the listing shown index.html above. The CSS fragment supporting the Login button looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>li#login input {
        width: 122px;
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 2px;
        -moz-border-radius: 2px;
        -webkit-border-radius: 2px;
}</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">border-radius</span> element makes the corners rounded of the HTML element it applied to.  But why we repeat it three times with additional prefixes <span class="monospaced">-moz-</span> and <span class="monospaced">-webkit-</span>? These are so called <em>CSS vendor prefixes</em>, which allow the Web browser vendors to implement experimental CSS properties that haven&#8217;t been standardized yet. For example, <span class="monospaced">-webkit-</span> is the prefix for all WebKit-based browsers: Chrome, Safari, Android, iOS. Microsoft uses <span class="monospaced">-ms-</span> for Internet Explorer, Opera uses <span class="monospaced">-o-</span>.  These prefixes are temporary measures, which make the CSS files heavier than they need to be. The time will come when the CSS3 standard properties will be implemented by all browser vendors and you won&#8217;t need to use these prefixes.</p></div>
<div class="paragraph"><p>As a matter of fact, unless yo uwant this code to work in the very old versions of Firefox, you can remove the line <span class="monospaced">-moz-border-radius: 2px;</span> from our styles.css because Mozilla has implemented the property <span class="monospaced">border-radius</span> in most of their browser . You can find a list of CSS properties with the corresponding vendor prefixes in <a href="http://peter.sh/experiments/vendor-prefixed-css-property-overview/">this list</a> maintained by Peter Beverloo.</p></div>
</div>
<div class="sect3">
<h4 id="_the_footer_section">The Footer section</h4>
<div class="paragraph"><p>The footer section comes next. Run the Aptana&#8217;s project called project-03-footer and you&#8217;ll see a new version of the Save Sick Child page with the bottom portion that looks as in <a href="#FIG3-9">[FIG3-9]</a>. The footer section shows several icons linking to Facebook, Google Plus, Twitter, RSS feed, and e-mail.</p></div>
<div class="imageblock" id="FIG3-9">
<div class="content">
<img src="images/fig_03_09.png" alt="images/fig_03_09.png">
</div>
<div class="title">Figure 32. The footer section</div>
</div>
<div class="paragraph"><p>The HTML section of our first prototype is shown below. At this point it has a number of <span class="monospaced">&lt;a&gt;</span> tags, which have the dummy references <span class="monospaced">href="javascript:void(0)"</span> that don&#8217;t redirect the user to any of these social sites.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;footer&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-project-name-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;b&gt;</span></span>project 03<span style="font-weight: bold"><span style="color: #0000FF">&lt;/b&gt;</span></span>: Footer Section | Using Icon Fonts
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"social-icons"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span> <span style="color: #009900">title</span><span style="color: #990000">=</span><span style="color: #FF0000">"Our Facebook page"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">aria-hidden</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-facebook"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/a&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span> <span style="color: #009900">title</span><span style="color: #990000">=</span><span style="color: #FF0000">"Our Google Plus page"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">aria-hidden</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-gplus"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/a&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span> <span style="color: #009900">title</span><span style="color: #990000">=</span><span style="color: #FF0000">"Our Twitter"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">aria-hidden</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-twitter"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/a&gt;</span></span> <span style="font-weight: bold"><span style="color: #000080">&amp;nbsp;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span> <span style="color: #009900">title</span><span style="color: #990000">=</span><span style="color: #FF0000">"RSS feed"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">aria-hidden</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-feed"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/a&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span> <span style="color: #009900">title</span><span style="color: #990000">=</span><span style="color: #FF0000">"Email us"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">aria-hidden</span><span style="color: #990000">=</span><span style="color: #FF0000">"true"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-mail"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/a&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/footer&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Each of the above anchors is styled using vector graphics icon fonts that we&#8217;ve selected and downloaded from <a href="http://icomoon.io/app">http://icomoon.io/app</a>. Vector graphics images are being re-drawn using vectors (strokes) as opposed to raster graphics, which is are pre-drawn in certain resolution images. The raster graphics can give you these boxy pixelated images if the size of the image needs to be increased. We use the vector images for our footer section that are treated as fonts. They will look as good as originals on any screen size, besides you can change their properties (e.g. color) as easy as you&#8217;d do with any other font.  The images that you see on <a href="#FIG3-9">[FIG3-9]</a> are are located in the fonts directory of the project-03-footer. The IcoMoon web application will generate the fonts for you based on your selection and you&#8217;ll get a sample html file, fonts, and CSS to be used with your application. Our icon fonts section in styles.css will look as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* Icon Fonts */</span></span>
@font<span style="color: #990000">-</span>face <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">font-family:</span> '<span style="font-style: italic"><span style="color: #009900">icomoon</span></span>';
        <span style="color: #0000FF">src:</span><span style="font-style: italic"><span style="color: #009900">url</span></span>('<span style="font-style: italic"><span style="color: #009900">..</span></span>/<span style="font-style: italic"><span style="color: #009900">fonts</span></span>/<span style="font-style: italic"><span style="color: #009900">icomoon.eot</span></span>');
        <span style="color: #0000FF">src:</span><span style="font-style: italic"><span style="color: #009900">url</span></span>('<span style="font-style: italic"><span style="color: #009900">..</span></span>/<span style="font-style: italic"><span style="color: #009900">fonts</span></span>/<span style="font-style: italic"><span style="color: #009900">icomoon.eot</span></span>?<span style="color: #FF0000">#iefix</span>') <span style="font-style: italic"><span style="color: #009900">format</span></span>('<span style="font-style: italic"><span style="color: #009900">embedded-opentype</span></span>'),
                <span style="font-style: italic"><span style="color: #009900">url</span></span>('<span style="font-style: italic"><span style="color: #009900">..</span></span>/<span style="font-style: italic"><span style="color: #009900">fonts</span></span>/<span style="font-style: italic"><span style="color: #009900">icomoon.svg</span></span><span style="color: #FF0000">#icomoon</span>') <span style="font-style: italic"><span style="color: #009900">format</span></span>('<span style="font-style: italic"><span style="color: #009900">svg</span></span>'),
                <span style="font-style: italic"><span style="color: #009900">url</span></span>('<span style="font-style: italic"><span style="color: #009900">..</span></span>/<span style="font-style: italic"><span style="color: #009900">fonts</span></span>/<span style="font-style: italic"><span style="color: #009900">icomoon.woff</span></span>') <span style="font-style: italic"><span style="color: #009900">format</span></span>('<span style="font-style: italic"><span style="color: #009900">woff</span></span>'),
                <span style="font-style: italic"><span style="color: #009900">url</span></span>('<span style="font-style: italic"><span style="color: #009900">..</span></span>/<span style="font-style: italic"><span style="color: #009900">fonts</span></span>/<span style="font-style: italic"><span style="color: #009900">icomoon.ttf</span></span>') <span style="font-style: italic"><span style="color: #009900">format</span></span>('<span style="font-style: italic"><span style="color: #009900">truetype</span></span>');
        <span style="color: #0000FF">font-weight:</span> <span style="font-style: italic"><span style="color: #009900">normal</span></span>;
        <span style="color: #0000FF">font-style:</span> <span style="font-style: italic"><span style="color: #009900">normal</span></span>;
<span style="color: #FF0000">}</span>
</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_the_donate_section">The Donate Section</h4>
<div class="paragraph"><p>The section with the Donate button and the donation form will be located  in the top portion of page right below the navigation area. Initially, the page will open up with the background image of a sick but smiley boy on the right and a large Donate button on the left. The image shown on <a href="#FIG3-10">[FIG3-10]</a> is taken from a large collection of photos at <a href="http://www.istockphoto.com/">iStockphoto</a> Web site. We haven&#8217;t paid for it just yet hence it shows the iStockPhoto watermark. We are going to purchase this photo as well as the top left logo, to be perfectly legitimate. We&#8217;re also using two more background images here: one with the flowers, and the other with the sun and clouds, and you can find the references to these images in the styles.css file. Run the Aptana&#8217;s project-04-donation and you&#8217;ll see the new version of or Save Sick Child page that will look as on <a href="#FIG3-10">[FIG3-10]</a>.</p></div>
<div class="imageblock" id="FIG3-10">
<div class="content">
<img src="images/fig_03_10.png" alt="images/fig_03_10.png">
</div>
<div class="title">Figure 33. The initial view of the Donate section</div>
</div>
<div class="paragraph"><p>Lorem Ipsum is a dummy text widely used in printing, typesetting, and Web design. It&#8217;s used as a placeholder to indicate the text areas that should be filled with a real content later on. You can read about it at <a href="http://www.lipsum.com/">http://www.lipsum.com</a>. This is how the HTML fragment supporting <a href="#FIG3-10">[FIG3-10]</a> looks like (no CSS is shown for brevity).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-address"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-address"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                Lorem ipsum dolor sit amet, consectetur e magna aliqua.
                Nostrud exercitation ullamco laboris nisi ut aliquip ex
                ea commodo consequat.
                Duis aute irure dolor in reprehenderit in voluptate velit
                esse cillum dolore eu fugiat nulla pariatur.
                Excepteur sint occaecat cupidatat non proident.
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;button</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-button"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-botton"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-botton-header"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Donate Now<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-2nd-line"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Children can't wait<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Clicking the button Donate should reveal the form where the user should be able to enter her name, address and the donation amount. We are building a single-page application, so instead of opening a popup window we&#8217;ll just change the content on the left revealing the form, and move the button Donate to the right. <a href="#FIG3-11">[FIG3-11]</a> shows how the top portion of our page will look like after the user clicks the Donate button.</p></div>
<div class="imageblock" id="FIG3-11">
<div class="content">
<img src="images/fig_03_11.png" alt="images/fig_03_11.png">
</div>
<div class="title">Figure 34. After clicking on Donate button</div>
</div>
<div class="paragraph"><p>The HTML of the donation form shown on <a href="#FIG3-11">[FIG3-11]</a> is shown below. When the user clicks on the Donate button the content of the form should be sent to PayPal or any other payment processing system.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-form-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Make a donation today<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"_xclick"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"https://www.paypal.com/cgi-bin/webscr"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-form-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Please select or enter
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span> donation amount<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "amount"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000"> "d10"</span> <span style="color: #009900">value</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "10"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "d10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>10<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "amount"</span> <span style="color: #009900">id</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "d20"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "d20"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>20<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "amount"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"d50"</span> <span style="color: #009900">checked</span><span style="color: #990000">=</span><span style="color: #FF0000">"checked"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"50"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"d50"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>50<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "amount"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"d100"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"100"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"d100"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>100<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "amount"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"d200"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"200"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"d200"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>200<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Other amount<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"customAmount"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"amount"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span>
               <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span>  <span style="color: #009900">autocomplete</span><span style="color: #990000">=</span><span style="color: #FF0000">"off"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-form-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Donor information<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"full_name"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"full_name"</span>
               <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"full name *"</span> <span style="color: #009900">required</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"email_addr"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"email_addr"</span>
               <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"email *"</span> <span style="color: #009900">required</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"street_address"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"street_address"</span>
               <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"address"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"city"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"scty"</span> <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"city"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"zip"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"zip"</span> <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"zip/postal code"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"state"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">selected</span><span style="color: #990000">=</span><span style="color: #FF0000">"selected"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> - State - <span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"AL"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Alabama<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"WY"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Wyoming<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"country"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">selected</span><span style="color: #990000">=</span><span style="color: #FF0000">"selected"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> - Country - <span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"United States"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>United States<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Zimbabwe"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Zimbabwe<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-form-section make-payment"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>We accept Paypal payments<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>
                Your payment will processed securely by <span style="font-weight: bold"><span style="color: #0000FF">&lt;b&gt;</span></span>PayPal<span style="font-weight: bold"><span style="color: #0000FF">&lt;/b&gt;</span></span>.
                PayPal employ industry-leading encryption and fraud prevention tools.
                Your financial information is never divulged to us.
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;button</span></span>  <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-button donate-button-submit"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-botton-header"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Donate Now<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-2nd-line"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Children can't wait<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-later-link"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0);"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>I'll donate later
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"icon-cancel"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/span&gt;&lt;/a&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The JavaScript code supporting the UI transformations related to the button Donate is shown below. It&#8217;s the code snippet from the main.js from Aptana&#8217;s project-04-donation. The click on the Donate button invokes the event handler <span class="monospaced">showDonationForm()</span>, which simply hides the <span class="monospaced">&lt;div id="donation-address"&gt;</span> with Lorem Ipsum and displays the donation form: ` &lt;form name="_xclick" action="https://www.paypal.com/cgi-bin/webscr" method="post"&gt;"&gt;<span class="monospaced">. After clicking on the submit button the data from the form `_xclick</span> will be validated and sent to paypal.com. If the user clicks on "I&#8217;ll donate later", the code hides the form and shows the Lorem Ipsum from the <span class="monospaced">&lt;div id="donation-address"&gt;</span> again.</p></div>
<div class="paragraph"><p>Two <span class="monospaced">select</span> dropdowns in the code above contain hard-coded values of all states and countries. For brevity, we&#8217;ve listed just a couple of entries in each. In Chapter 4 we&#8217;ll populate these dropdowns using the external data in JSON format.</p></div>
<div class="paragraph"><p>The next code fragment is an extract of JavaScript file main.js provide by Jerry. This code contains function handlers  that process user clicks in the Donate section.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateBotton <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donate-botton'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donationAddress <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donation-address'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customAmount <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'customAmount'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateForm <span style="color: #990000">=</span> document<span style="color: #990000">.</span>forms<span style="color: #990000">[</span><span style="color: #FF0000">'_xclick'</span><span style="color: #990000">];</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateLaterLink <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donate-later-link'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> checkedInd <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showDonationForm</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                donationAddress<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"none"</span><span style="color: #990000">;</span>
                donateFormContainer<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Register the event listeners</span></span>
        donateBotton<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showDonationForm<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
        customAmount<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'focus'</span><span style="color: #990000">,</span> onCustomAmountFocus<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
        donateLaterLink<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> donateLater<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
        customAmount<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'blur'</span><span style="color: #990000">,</span> onCustomAmountBlur<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>

        <span style="font-style: italic"><span style="color: #9A1900">// Uncheck selected radio buttons if the custom amount was chosen</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">onCustomAmountFocus</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> donateForm<span style="color: #990000">.</span>length<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>type <span style="color: #990000">==</span> <span style="color: #FF0000">'radio'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                                donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>onclick <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                                        customAmount<span style="color: #990000">.</span>value <span style="color: #990000">=</span> <span style="color: #FF0000">''</span><span style="color: #990000">;</span>
                                <span style="color: #FF0000">}</span>
                        <span style="color: #FF0000">}</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>type <span style="color: #990000">==</span> <span style="color: #FF0000">'radio'</span> <span style="color: #990000">&amp;&amp;</span> donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>checked<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                                checkedInd <span style="color: #990000">=</span> i<span style="color: #990000">;</span>
                                donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>checked <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
                        <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">onCustomAmountBlur</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> value <span style="color: #990000">=</span> customAmount<span style="color: #990000">.</span>value<span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>value <span style="color: #990000">==</span> <span style="color: #FF0000">''</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                    <span style="font-style: italic"><span style="color: #9A1900">// The user haven't entered other amount</span></span>
                        donateForm<span style="color: #990000">[</span>checkedInd<span style="color: #990000">].</span>checked <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">donateLater</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                donationAddress<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"block"</span><span style="color: #990000">;</span>
                donateFormContainer<span style="color: #990000">.</span>style<span style="color: #990000">.</span>display <span style="color: #990000">=</span> <span style="color: #FF0000">"none"</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">The code above contains an example of an inefficient code that in a loop assigns a click event handler to each radio button should the user click any radio button after visiting the Other Amount field. This was a Jerry&#8217;s understanding of how to reset the value of the <span class="monospaced">customAmount</span> variable. Jerry was not familiar with the capture phase of the events that can intercept the click event on the radio buttons container&#8217;s level and simply reset the value of <span class="monospaced">customAmount</span> regardless of which specific radio button is clicked.</td>
</tr></table>
</div>
<div class="paragraph"><p>Let&#8217;s improve this code a little bit. The idea is to intercept the click event during the capture phase (see the DOM Events section in Chapter 2) and if the <span class="monospaced">Event.target</span> is any radio button, perform <span class="monospaced">customAmount.value = '';</span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateFormContainer <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donate-form-container'</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Intercept any click on the donate form in a capturing phase</span></span>
donateFormContainer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> resetCustomAmount<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">resetCustomAmount</span></span><span style="color: #990000">(</span>event<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

    <span style="font-style: italic"><span style="color: #9A1900">// reset the customAmount</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>event<span style="color: #990000">.</span>target<span style="color: #990000">.</span>type<span style="color: #990000">==</span><span style="color: #FF0000">"radio"</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
                customAmount<span style="color: #990000">.</span>value <span style="color: #990000">=</span> <span style="color: #FF0000">''</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The code of the <span class="monospaced">onCustomAmountFocus()</span> doesn&#8217;t need to assign function handlers to the radio buttons any longer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">onCustomAmountFocus</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> donateForm<span style="color: #990000">.</span>length<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>type <span style="color: #990000">==</span> <span style="color: #FF0000">'radio'</span> <span style="color: #990000">&amp;&amp;</span> donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>checked<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        checkedInd <span style="color: #990000">=</span> i<span style="color: #990000">;</span>
                        donateForm<span style="color: #990000">[</span>i<span style="color: #990000">].</span>checked <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_video">Adding Video</h3>
<div class="paragraph"><p>In this section we&#8217;ll add a video player to our Save Sick Child application. The goal is to play a short animation encouraging kids to fight the disease. We&#8217;ve hired a professional animation artist Yuri who has started working on the animation. Meanwhile let&#8217;s take care of embedding the video player showing any sample video file.</p></div>
<div class="sect3">
<h4 id="_adding_the_html5_video_element">Adding the HTML5 Video Element</h4>
<div class="paragraph"><p>Let&#8217;s run the Aptana&#8217;s project called project-05-html5-video to see it working, and after that we&#8217;ll review the code. The new version of the Sick Save Child should look as in &lt;&lt;FIG3-12&gt;. The users will see an embedded video player on the right that can play the video located in the assets/media folder of the Aptana&#8217;s project project-05-html5-video.</p></div>
<div class="imageblock" id="FIG3-12">
<div class="content">
<img src="images/fig_03_12.png" alt="images/fig_03_12.png">
</div>
<div class="title">Figure 35. The video player is embeded</div>
</div>
<div class="paragraph"><p>Let&#8217;s see how our index.html has changed since its previous version. The bottom part of the main section includes the <span class="monospaced">&lt;video&gt;</span> tag. In the past, the videos in Web pages were played predominantly by the browser&#8217;s Flash Player plugin (even older popular plugins included RealPlayer, MediaPlayer, and QuickTime). For example, you could have used the HTML tag `&lt;embed src="myvideo.swf" height="300" width="300"&gt;`and if the user&#8217;s browser supports Flash Player, that&#8217;s all you needed for basic video play. While there were plenty of open source video players, creation of the enterprise-grade video player for Flash videos became an important skill for some software developers. For example, HBO, an American cable network offers an advanced multi-featured video player embedded into <a href="http://www.hbogo.com">www.hbogo.com</a> for their subscribers.</p></div>
<div class="paragraph"><p>In today&#8217;s world most of the modern mobile Web browsers don&#8217;t support Flash Player, and the video content providers prefer broadcasting videos in formats that are supported by all the browsers and can be embedded into Web page using the standard HTML5 element <span class="monospaced">&lt;video&gt;</span> (see its current working draft is published at <a href="http://www.w3.org/TR/html5/the-video-element.html">http://www.w3.org/TR/html5/the-video-element.html</a>).</p></div>
<div class="paragraph"><p>The following code fragment illustrates how we&#8217;ve embedded the video into the bottom portion of our Web page (index.html). It includes two <span class="monospaced">&lt;source&gt;</span> elements, which allows to provide alternative media resources. If the Web browser supports playing video specified in the first <span class="monospaced">&lt;source&gt;</span> element, it&#8217;ll ignore the other versions of the media. For example, the code below offers two versions of the video file: intro.mp4 (in H.264/MPEG-4 format natively supported by Safari and Internet Explorer) and intro.webm (WebM format for Firefox, Chrome, and Opera).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-bottom-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"video-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;video</span></span> <span style="color: #009900">controls</span> <span style="color: #009900">poster</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/media/intro.jpg"</span>
               <span style="color: #009900">width</span><span style="color: #990000">=</span><span style="color: #FF0000">"390px"</span> <span style="color: #009900">height</span><span style="color: #990000">=</span><span style="color: #FF0000">"240"</span> <span style="color: #009900">preload</span><span style="color: #990000">=</span><span style="color: #FF0000">"metadata"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/media/intro.mp4"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"video/mp4"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/media/intro.webm"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"video/webm"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Sorry, your browser doesn't support video<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/video&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Video header goes here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h5&gt;&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0);"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>More videos<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/h5&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The boolean property <span class="monospaced">controls</span> asks the Web browser to display the video player with controls (the play/pause buttons, the full screen mode, et al.) If you wouldn&#8217;t use the property <span class="monospaced">controls</span> your JavaScript could would have to control the playback. The <span class="monospaced">poster</span> property of the <span class="monospaced">&lt;video&gt;</span> tag specifies the image to display as a placeholder for the video - this is the image you see on <a href="#FIG3-12">[FIG3-12]</a>. In our case the <span class="monospaced">preload</span> valus is <span class="monospaced">metadata</span>, which means that we want the Web browser to preload just the first frame of the video its metadata. Should we used <span class="monospaced">preload="auto"</span>, the video would start loading in the background as soon as the Web page was loaded unless the user&#8217;s browser doesn&#8217;t allow it (e.g. Safari on iOS) for saving the bandwidth.</p></div>
<div class="paragraph"><p>All major Web browsers released in 2011 and later include their own embedded video players that support the <span class="monospaced">&lt;video&gt;</span> element. It&#8217;s great that your code doesn&#8217;t depend on the support of the Flash Player, but now video players look different depending on which browser the user has.</p></div>
<div class="paragraph"><p>If neither .mp4 nor .webm files can be played, the content in the <span class="monospaced">&lt;p&gt;</span>  tag displays the fallback message "Sorry, your browser doesn&#8217;t support video". If you need to support older Web browsers that don&#8217;t support HTML5 video, but support Flash Player, you can replace this <span class="monospaced">&lt;p&gt;</span> tag with the <span class="monospaced">&lt;object&gt;</span> and <span class="monospaced">&lt;embed&gt;</span> tags that embed another media file that Flash Player understands. Finally, if you believe that some users may have the browsers that support neither the <span class="monospaced">&lt;video&gt;</span> tag nor Flash Player, just add the links to the files listed in the <span class="monospaced">&lt;source&gt;</span> tags right after the closing <span class="monospaced">&lt;/video&gt;</span> tag.</p></div>
</div>
<div class="sect3">
<h4 id="_embedding_youtube_videos">Embedding YouTube Videos</h4>
<div class="paragraph"><p>Another way to include videos in your Web application is by uploading them to YouTube first and then embedding if into your Web page. This provides a number of benefits:</p></div>
<div class="ulist"><ul>
<li>
<p>
The videos are hosted on Google&#8217;s servers and use their bandwidth.
</p>
</li>
<li>
<p>
The users can either watch the video as a part of your application&#8217;s Web page or, by clicking on the YouTube logo on the status bar of the video player you can continue watching the video from its original YouTube URL.
</p>
</li>
<li>
<p>
YouTube is streaming videos in the compressed form and the user can watch it as the bytes come in - it doesn&#8217;t require a video to be fully preloaded to the user&#8217;s device.
</p>
</li>
<li>
<p>
YouTube stores videos in several formats and automatically selects the best one based on the user&#8217;s Web browser (user agent).
</p>
</li>
<li>
<p>
The HTML code to embed a YouTube video is generated for you by pressing the Share and then Embed link by the video itself.
</p>
</li>
<li>
<p>
You can enrich your Web application by incorporating extensive video libraries by using the <a href="https://developers.google.com/youtube/v3/">YouTube Data API</a>. You can create fine tuned searches retrieving channels, playlists, videos, manage subscriptions, and authorize user requests.
</p>
</li>
<li>
<p>
Your users can save the YouTube videos on their local drive using free Web Browsers add-ons like DownloadHelper extension for Firefox or a RealDownloader.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Youtube offers <a href="https://www.youtube.com/html5"> an Opt-In Trial of HTML5 video</a>, which allows playing most of the videos using HTML 5 video (even those recorded for Flash Player).</td>
</tr></table>
</div>
<div class="paragraph"><p>Embedding a YouTube video into your HTML page is simple. Find the page with the video on YouTube and press the links Share and Embed located right under the video. Then select the size of your video player and HTTPS encryption if needed. When this is done, copy the generated <span class="monospaced">iFrame</span> section into your page.</p></div>
<div class="paragraph"><p>Open the file index.html in the Aptana&#8217;s project-06-YouTube-video and you&#8217;ll see there a code that replaces the <span class="monospaced">&lt;video&gt;</span> tag of the previous project. It should look like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-bottom-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"video-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"video-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;iframe</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.youtube.com/embed/VGZcerOhCuo?wmode=transparent&amp;hd=1&amp;vq=hd720"</span>
                <span style="color: #009900">frameborder</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">width</span><span style="color: #990000">=</span><span style="color: #FF0000">"390"</span> <span style="color: #009900">height</span><span style="color: #990000">=</span><span style="color: #FF0000">"240"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/iframe&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Video header goes here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h5&gt;&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0);"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>More videos<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/h5&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that the initial size of our video player is 390x240 pixels. The <span class="monospaced">&lt;iframe&gt;</span> wraps the URL of the video, which in this example ends with parameters  <span class="monospaced">hd=1</span> and <span class="monospaced">vq=hd720</span>. This is how you can force YouTube to load video in HD quality. Run the project-06-YouTube-video and if shows you a Web page that looks as in <a href="#FIG3-13">[FIG3-13]</a>.</p></div>
<div class="imageblock" id="FIG3-13">
<div class="content">
<img src="images/fig_03_13.jpg" alt="images/fig_03_13.jpg">
</div>
<div class="title">Figure 36. The YouTube player is embeded</div>
</div>
<div class="paragraph"><p>Now let&#8217;s do yet another experiment. Enter the URL of our video directly in your Web browser, turn on the Firegug or Developer Tools. We did it in Firebug under Mac OS and selected the Net tab. Then HTML Response looked as in <a href="#FIG3-14">[FIG3-14]</a>. YouTube recognized that this Web browser is capable of playing Flash content (FLASH_UPGRADE) and picked the QuickTime as a fallback (QUICKTIME_FALLBACK).</p></div>
<div class="imageblock" id="FIG3-14">
<div class="content">
<img src="images/fig_03_14.jpg" alt="images/fig_03_14.jpg">
</div>
<div class="title">Figure 37. HTTP Response object from YouTube</div>
</div>
<div class="paragraph"><p>Our brief introduction to embedding videos in HTML is over. Let' keep adding new features to the Save Sick Child Web application. This time we&#8217;ll get familiar with the HTML5 Geolocation API.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_geolocation_support">Adding Geolocation Support</h3>
<div class="paragraph"><p>HTML5 includes the Geolocation API that allows programmatically figure out the latitude and longitude of the user&#8217;s device. Most of the people are accustomed to the non-Web GPS applications in cars or mobile devices that display maps and calculate distances based on the current coordinates of the user&#8217;s device or motor vehicle. But why do we need the Geolocation API in a desktop Web application?</p></div>
<div class="paragraph"><p>The goal of this section is to demonstrate a very practical feature - finding registered sick children based on the user&#8217;s location. This way the users of the Save Sick Child can find the needy children in a particular geographical area. In this chapter you&#8217;ll just learn the basics of HTML5 GeoLocation API, but we&#8217;ll continue improving the location feature of the Save Sick Child in the next chapter.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">The World Wide Web Consortium has published proposed recommendation of the <a href="http://www.w3.org/TR/geolocation-API/">Geolocation API Specification</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Does your old desktop computer have a GPS hardware? Most likely it doesn&#8217;t. But its location can be calculated with varying degree of accuracy. If your desktop computer is connected to the network it has an IP address or your local Wi-Fi router may have an SSID given by the router vendor or your Internet provider so the location of your desktop computer is not a secret, unless you change the SSID of your Wi-Fi router. Highly populated areas have more Wi-Fi routers and cell towers so the accuracy increases. In any case, properly designed applications must to always ask the user&#8217;s permission to use the current location of her computer or other connected device.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">The GPS signals are not always available. There are various location services that help identifying the position of your device. For example, Google, Apple, Microsoft, Skyhook and other companies use publicly broadcast Wi-Fi data from the wireless access point. Google Location Server uses Media Access Control (MAC) address to identify any device connected to the network.</td>
</tr></table>
</div>
<div class="paragraph"><p>Every Web Browser has a global object <span class="monospaced">window</span>, which includes the <span class="monospaced">navigator</span> object containing the information about the user&#8217;s browser. If the browser&#8217;s <span class="monospaced">navigator</span> object includes the property <span class="monospaced">geolocation</span>, geolocation services are available. While the Geolocation API allows you to get just a coordinate of your device and report the accuracy of this location, most applications use this information with some user-friendly UI, for example, the mapping software. In this section our goal is to demonstrate the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
How to use Geolocation API
</p>
</li>
<li>
<p>
How to integrate the Geolocation API with Google Maps.
</p>
</li>
<li>
<p>
How to detect id the Web browser supports geolocation services
</p>
</li>
</ol></div>
<div class="sect3">
<h4 id="_geolocation_basics">Geolocation Basics</h4>
<div class="paragraph"><p>The new Aptana project is called project-07-basic-geolocation, where we simply assume that the Web browser supports the Geolocation. The Save Sick Child page will get a new container in the middle of the bottom main section, where we are planning to display the map of the current user location. But for now we&#8217;ll show there just the coordinates: latitude, longitude, and the accuracy. Initially, the map container is empty, but we&#8217;ll populate it from the JavaScript code as soon as the position of the computer is located.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"map-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        ​
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The following code snippet from main.js makes a call to the <span class="monospaced">navigator.geolocation</span> object to get the current position of the user&#8217;s computer.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mapContainer <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'map-container'</span><span style="color: #990000">);</span>      <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">successGeoData</span></span><span style="color: #990000">(</span>position<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> successMessage <span style="color: #990000">=</span> <span style="color: #FF0000">"We found your position!"</span><span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
        successMessage <span style="color: #990000">+=</span> <span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000"> Latitude = '</span> <span style="color: #990000">+</span> position<span style="color: #990000">.</span>coords<span style="color: #990000">.</span>latitude<span style="color: #990000">;</span>
        successMessage <span style="color: #990000">+=</span> <span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000"> Longitude = '</span> <span style="color: #990000">+</span> position<span style="color: #990000">.</span>coords<span style="color: #990000">.</span>longitude<span style="color: #990000">;</span>
        successMessage <span style="color: #990000">+=</span> <span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000"> Accuracy = '</span> <span style="color: #990000">+</span> position<span style="color: #990000">.</span>coords<span style="color: #990000">.</span>accuracy <span style="color: #990000">+</span>
                                                              <span style="color: #FF0000">' meters'</span><span style="color: #990000">;</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>successMessage<span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> successMessageHTML <span style="color: #990000">=</span> successMessage<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">replace</span></span><span style="color: #990000">(</span><span style="color: #FF6600">/\n/g</span><span style="color: #990000">,</span> <span style="color: #FF0000">'&lt;br /&gt;'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> currentContent <span style="color: #990000">=</span> mapContainer<span style="color: #990000">.</span>innerHTML<span style="color: #990000">;</span>
        mapContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> currentContent <span style="color: #990000">+</span> <span style="color: #FF0000">"&lt;br /&gt;"</span>
                                           <span style="color: #990000">+</span> successMessageHTML<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>

<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">failGeoData</span></span><span style="color: #990000">(</span>error<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                                       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'error code = '</span> <span style="color: #990000">+</span> error<span style="color: #990000">.</span>code<span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span><span style="color: #990000">(</span>error<span style="color: #990000">.</span>code<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> error<span style="color: #990000">.</span>POSITION_UNAVALABLE<span style="color: #990000">:</span>
                        errorMessage <span style="color: #990000">=</span> <span style="color: #FF0000">"Can't get the location"</span><span style="color: #990000">;</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> error<span style="color: #990000">.</span>PERMISSION_DENIED<span style="color: #990000">:</span>
                        errorMessage <span style="color: #990000">=</span> <span style="color: #FF0000">"The user doesn't want to share location"</span><span style="color: #990000">;</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> error<span style="color: #990000">.</span>TIMEOUT<span style="color: #990000">:</span>
                        errorMessage <span style="color: #990000">=</span> <span style="color: #FF0000">"Timeout -  Finding location takes too long"</span><span style="color: #990000">;</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> error<span style="color: #990000">.</span>UNKNOWN_ERROR<span style="color: #990000">:</span>
                        errorMessage <span style="color: #990000">=</span> <span style="color: #FF0000">"Unknown error: "</span> <span style="color: #990000">+</span> error<span style="color: #990000">.</span>code<span style="color: #990000">;</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>errorMessage<span style="color: #990000">);</span>
        mapContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> errorMessage<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>navigator<span style="color: #990000">.</span>geolocation<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> startMessage <span style="color: #990000">=</span> <span style="color: #FF0000">'Your browser supports geolocation API :)'</span><span style="color: #990000">;</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>startMessage<span style="color: #990000">);</span>
        mapContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> startMessage<span style="color: #990000">;</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Checking your position...'</span><span style="color: #990000">);</span>
        mapContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> startMessage <span style="color: #990000">+</span> <span style="color: #FF0000">'&lt;br /&gt;Checking your position...'</span><span style="color: #990000">;</span>

        navigator<span style="color: #990000">.</span>geolocation<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getCurrentPosition</span></span><span style="color: #990000">(</span>successGeoData<span style="color: #990000">,</span>
           failGeoData<span style="color: #990000">,</span>                                            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
           <span style="color: #FF0000">{</span>maximumAge <span style="color: #990000">:</span> <span style="color: #993399">60000</span><span style="color: #990000">,</span>
                enableHighAccuracy <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>                             <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/6.png" alt="6"></span></span>
                timeout <span style="color: #990000">:</span> <span style="color: #993399">5000</span>
           <span style="color: #FF0000">}</span>
        <span style="color: #990000">);</span>

<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        mapContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span><span style="color: #FF0000">'Your browser does not support geolocation'</span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Get a reference to the DOM element <span class="monospaced">map-container</span> to be used for showing the results.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The function handler to be called in case of the successful discovery of the computer&#8217;s coordinates. If this function will be called it&#8217;ll get a <span class="monospaced">position</span> object as an argument.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Display the retrieved data on the Web page (see <a href="#FIG3-15">[FIG3-15]</a>).
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
This is the error handler callback.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Invoke the method <span class="monospaced">getCurrentPosition()</span> passing it two callback function as arguments (for success and failure) and an object with optional parameters for this invocation.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
Optional parameters: accept the cached value if not older than 60 seconds, retrieve the best possible results and don&#8217;t wait for results for more that 5 seconds. You may not always want the best possible results to lower the response time and the power consumption.
</td></tr>
</table></div>
<div class="paragraph"><p>If you run the project-07-basic-geolocation, the Browser will ask you a question similar to "Would you like to share your location with 127.0.01?"  Allow this sharing and you&#8217;ll see a Web page, which will include the information about your computer&#8217;s location similar to <a href="#FIG3-15">[FIG3-15]</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you don&#8217;t see the question asking permission to share location, check the privacy settings of your Web browser - most likely you&#8217;ve allowed using your location some time in the past.</td>
</tr></table>
</div>
<div class="imageblock" id="FIG3-15">
<div class="content">
<img src="images/fig_03_15.jpg" alt="images/fig_03_15.jpg">
</div>
<div class="title">Figure 38. The latitude and longitude are displayed</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you want to monitor the position as it changes (the device is moving) use <span class="monospaced">geolocation.watchPosition()</span>, which implements internal timer and checks the position. To stop monitoring position use <span class="monospaced">geolocation.clearWatch()</span>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_integrating_with_google_maps">Integrating with Google Maps</h4>
<div class="paragraph"><p>Knowing the device coordinates is very important, but let&#8217;s make the location information more presentable by feeding the device coordinates to <a href="https://developers.google.com/maps/">Google Maps API</a>. In this version of Save Sick Child we&#8217;ll replace the gray rectangle from &lt;&lt;&gt;FIG3-15&gt; with the Google maps container. We want the user to see a familiar map fragment with a pin pointing at the location of her Web browser. To follow our "Show and Tell" style let&#8217;s see it working first. Run Aptana&#8217;s project-08-geolocation-maps and you&#8217;ll see a map with your current location as shown on  <a href="#FIG3-16">[FIG3-16]</a>.</p></div>
<div class="imageblock" id="FIG3-16">
<div class="content">
<img src="images/fig_03_16.jpg" alt="images/fig_03_16.jpg">
</div>
<div class="title">Figure 39. Showing your current location</div>
</div>
<div class="paragraph"><p>Now comes the "Tell" part. First of all, take a look at the bottom of the index.html file. It loads Google&#8217;s JavaScript library with their Map API (<span class="monospaced">sensor=false</span> means that we are not using a sensor like GPS locator):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://maps.googleapis.com/maps/api/js?sensor=false"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>In the past Google required developed to obtain an API key and include it in the above URL. Although some Google&#8217;s tutorials still mentions the API key, it&#8217;s not a must.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">An alternative way of adding the <span class="monospaced">&lt;script&gt;</span> section to HTML page is by creating a script element. This gives you a flexibility of postponing the decision of which JavaScript to load. For example,</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myScript<span style="color: #990000">=</span>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"script"</span><span style="color: #990000">);</span>
myScript<span style="color: #990000">.</span>src<span style="color: #990000">=</span><span style="color: #FF0000">"http://......somelibrary.js"</span><span style="color: #990000">;</span>
document<span style="color: #990000">.</span>body<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChile</span></span><span style="color: #990000">(</span>myScript<span style="color: #990000">);</span></tt></pre></div></div>
</div></div>
<div class="paragraph"><p>Our main.js will invoke the function for Google&#8217;s library as needed. The code that find the location of your device is almost the same as in the section Geolocation Basics. We&#8217;ve replaced the call to with <span class="monospaced">geolocation.watchPosition()</span> so this program can modify the position if your computer, tablet, or a mobile phone is moving. We store the returned value of the <span class="monospaced">watchPosition()</span> in the variable <span class="monospaced">watcherID</span> in case if you decide to stop watching the position of the device by calling <span class="monospaced">clearWatch(watcherID)</span>.  Also, we lowered the value of the <span class="monospaced">maximumAge</span> option so the program will update the UI more frequently, which is important if you are running this program while in motion.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationUI <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'location-ui'</span><span style="color: #990000">);</span>
 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationMap <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'location-map'</span><span style="color: #990000">);</span>
 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> watcherID<span style="color: #990000">;</span>

 <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">successGeoData</span></span><span style="color: #990000">(</span>position<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> successMessage <span style="color: #990000">=</span> <span style="color: #FF0000">"We found your position!"</span><span style="color: #990000">;</span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> latitude <span style="color: #990000">=</span> position<span style="color: #990000">.</span>coords<span style="color: #990000">.</span>latitude<span style="color: #990000">;</span>

   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> longitude <span style="color: #990000">=</span> position<span style="color: #990000">.</span>coords<span style="color: #990000">.</span>longitude<span style="color: #990000">;</span>
   successMessage <span style="color: #990000">+=</span> <span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000"> Latitude = '</span> <span style="color: #990000">+</span> latitude<span style="color: #990000">;</span>
   successMessage <span style="color: #990000">+=</span> <span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000"> Longitude = '</span> <span style="color: #990000">+</span> longitude<span style="color: #990000">;</span>
   successMessage <span style="color: #990000">+=</span> <span style="color: #FF0000">'</span><span style="color: #CC33CC">\n</span><span style="color: #FF0000"> Accuracy = '</span> <span style="color: #990000">+</span> position<span style="color: #990000">.</span>coords<span style="color: #990000">.</span>accuracy
                                      <span style="color: #990000">+</span> <span style="color: #FF0000">' meters'</span><span style="color: #990000">;</span>
   console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>successMessage<span style="color: #990000">);</span>

   <span style="font-style: italic"><span style="color: #9A1900">// Turn the geolocation position into a LatLng object.</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationCoordinates <span style="color: #990000">=</span>
          <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">LatLng</span></span><span style="color: #990000">(</span>latitude<span style="color: #990000">,</span> longitude<span style="color: #990000">);</span>      <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mapOptions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
        center <span style="color: #990000">:</span> locationCoordinates<span style="color: #990000">,</span>
        zoom <span style="color: #990000">:</span> <span style="color: #993399">12</span><span style="color: #990000">,</span>
        mapTypeId <span style="color: #990000">:</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>MapTypeId<span style="color: #990000">.</span>ROADMAP<span style="color: #990000">,</span>         <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/2.png" alt="2"></span></span>
        mapTypeControlOptions <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
          style <span style="color: #990000">:</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>MapTypeControlStyle<span style="color: #990000">.</span>DROPDOWN_MENU<span style="color: #990000">,</span>
          position <span style="color: #990000">:</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>ControlPosition<span style="color: #990000">.</span>TOP_RIGHT
        <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

   <span style="font-style: italic"><span style="color: #9A1900">// Create the map</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> map <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Map</span></span><span style="color: #990000">(</span>locationMap<span style="color: #990000">,</span> mapOptions<span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>

   <span style="font-style: italic"><span style="color: #9A1900">// set the marker and info window</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> contentString <span style="color: #990000">=</span> <span style="color: #FF0000">'&lt;div id="info-window-content"&gt;'</span> <span style="color: #990000">+</span>
        <span style="color: #FF0000">'We have located you using HTML5 Geolocation.&lt;/div&gt;'</span><span style="color: #990000">;</span>

   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> infowindow <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">InfoWindow</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
        content <span style="color: #990000">:</span> contentString<span style="color: #990000">,</span>
        maxWidth <span style="color: #990000">:</span> <span style="color: #993399">160</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> marker <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Marker</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>                   <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/5.png" alt="5"></span></span>
        position <span style="color: #990000">:</span> locationCoordinates<span style="color: #990000">,</span>
        map <span style="color: #990000">:</span> map<span style="color: #990000">,</span>
        title <span style="color: #990000">:</span> <span style="color: #FF0000">"Your current location"</span>

   <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

       google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addListener</span></span><span style="color: #990000">(</span>marker<span style="color: #990000">,</span> <span style="color: #FF0000">'click'</span><span style="color: #990000">,</span>      <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/6.png" alt="6"></span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>infowindow<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>map<span style="color: #990000">,</span> marker<span style="color: #990000">);</span>

       <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

       <span style="font-style: italic"><span style="color: #9A1900">// When the map is loaded show the message and</span></span>
       <span style="font-style: italic"><span style="color: #9A1900">// remove event handler after the first "idle" event</span></span>
       google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addListenerOnce</span></span><span style="color: #990000">(</span>map<span style="color: #990000">,</span> <span style="color: #FF0000">'idle'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
        locationUI<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> <span style="color: #FF0000">"Your current location"</span><span style="color: #990000">;</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">)</span>

 <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">// error handler</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">failGeoData</span></span><span style="color: #990000">(</span>error<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
         <span style="font-weight: bold"><span style="color: #000000">clearWatch</span></span><span style="color: #990000">(</span>watcherID<span style="color: #990000">);</span>
        <span style="font-style: italic"><span style="color: #9A1900">//the error processing code is omitted for brevity</span></span>
 <span style="color: #FF0000">}</span>

 <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>navigator<span style="color: #990000">.</span>geolocation<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> startMessage <span style="color: #990000">=</span>
            <span style="color: #FF0000">'Browser supports geolocation API. Checking your location...'</span><span style="color: #990000">;</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>startMessage<span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> currentContent <span style="color: #990000">=</span> locationUI<span style="color: #990000">.</span>innerHTML<span style="color: #990000">;</span>
        locationUI<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> currentContent <span style="color: #990000">+</span><span style="color: #FF0000">' '</span><span style="color: #990000">+</span>startMessage<span style="color: #990000">;</span>

        watcherID <span style="color: #990000">=</span> navigator<span style="color: #990000">.</span>geolocation<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">watchPosition</span></span><span style="color: #990000">(</span>successGeoData<span style="color: #990000">,</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/7.png" alt="7"></span></span>
            failGeoData<span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
                maximumAge <span style="color: #990000">:</span> <span style="color: #993399">1000</span><span style="color: #990000">,</span>
                enableHighAccuracy <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                timeout <span style="color: #990000">:</span> <span style="color: #993399">5000</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

 <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'browser does not support geolocation :('</span><span style="color: #990000">);</span>
 <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)();</span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Google API represents a point in geographical coordinates (latitude and longitude) as a <span class="monospaced">LatLng</span> object, which we instantiate here.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The object`google.maps.MapOptions` is an object that allows you to specify various parameters of the map to be created. In particular, the map type can be one of the following: <span class="monospaced">HYBRID, ROADMAP, SATTELITE, TERRAIN</span>. We&#8217;ve chosen the <span class="monospaced">ROADMAP</span>, which displays a normal street map.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The function constructor <span class="monospaced">google.maps.Map</span> takes two arguments: the HTML container where the map has to be rendered and the <span class="monospaced">MapOption</span> as parameters of the map.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Create an overlay box that will show the content describing the location (e.g. a restaurant name) on the map. You can do it programmatically by calling <span class="monospaced">InfoWindow.open()</span>.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Place a marker on the specified position on the map.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
Show the overlay box when the use clicks  on the marker on the map.
</td></tr>
<tr><td><img src="images/icons/callouts/7.png" alt="7"></td><td>
Invoke the method <span class="monospaced">watchPosition()</span> to find the current position of the user&#8217;s computer.
</td></tr>
</table></div>
<div class="paragraph"><p>This is a pretty basic example of the integrating GeoLocation with the mapping software. Google Maps API consists of dozens JavaScript objects and supports various events that allow you to build interactive and engaging Web pages that include maps. Refer to the <a href="https://developers.google.com/maps/documentation/javascript/reference#MapOptions">Google Maps JavaScript API Reference</a> for the complete list of available parameters (properties) of all objects used in project-08-geolocation-maps and more. In Chapter 4 you&#8217;ll see a more advanced example of using Google maps - we&#8217;ll read the JSON data stream containing coordinates of sick children so the donors can find them based on the specified postal code.</p></div>
</div>
<div class="sect3">
<h4 id="_browser_features_detection_with_modernizr">Browser Features Detection With Modernizr</h4>
<div class="paragraph"><p>Now we&#8217;ll learn how to use the detection features offered by a JavaScript library called <a href="http://modernizr.com/">Modernizr</a>. This is a must have feature detection library that helps your application to figure out if the user&#8217;s browser supports certain HTML5/CSS3 features. Review the code of index.html from the Aptana&#8217;s project-08-1-modernizr-geolocation-maps. Note that the index.html includes two <span class="monospaced">&lt;script&gt;</span> sections - the Modernizr&#8217;s JavaScript gets loaded first, while our own main.js is loaded at the end of the <span class="monospaced">&lt;body&gt;</span> section.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"no-js"</span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Save Sick Child | Home Page<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/css/styles.css"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"js/libs/modernizr-2.5.3.min.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
       !--  Most of the HTML markup is omitted for brevity  --!

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"js/main.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span>
</tt></pre></div></div>
<div class="paragraph"><p>Modernizr is an open source JavaScript library that helps your script to figure out if the required HTML or CSS features are supported by the user&#8217;s browser. Instead of maintaining complex cross-browser feature matrix to see if, say <span class="monospaced">border-radius</span> is supported in the user&#8217;s version of Firefox, the Modernizer queries the <span class="monospaced">&lt;html&gt;</span> elements to see what&#8217;s supported and what&#8217;s not.</p></div>
<div class="paragraph"><p>Note the following fragment on the top of index.html: <span class="monospaced">&lt;html class="no-js" lang="en"&gt;</span>.  For Modernizr to work, your HTML root element has to include the class named <span class="monospaced">"no-js"</span>. On page load, the Modernizr will replace the <span class="monospaced">no-js</span> class with its extended version that lists all detected features, and those that are not supported will get a prefix <span class="monospaced">no-</span>. Run index.html from project-08-1-modernizr-geolocation-maps in Firefox and you&#8217;ll see in Firebug that the values of the <span class="monospaced">class</span> property of the <span class="monospaced">html</span> element are different now, and you can see from <a href="#FIG3-17">[FIG3-17]</a>  that our version of Firefox doesn&#8217;t support touch events (<span class="monospaced">no-touch</span>), flexbox (<span class="monospaced">no-flexbox</span>), et al.</p></div>
<div class="imageblock" id="FIG3-17">
<div class="content">
<img src="images/fig_03_17.png" alt="images/fig_03_17.png">
</div>
<div class="title">Figure 40. Modernizr changed the HTML&#8217;s class property</div>
</div>
<div class="paragraph"><p>For example, there is a new way to do page layouts using co called CSS Flexible Box Layout Module. This feature is not widely supported yet, and as you can see from <a href="#FIG3-17">[FIG3-17]</a>, our Web browser doesn&#8217;t support it at the time of this writing. If the CSS file of your application will implement two class selectors <span class="monospaced">.flexbox</span> and <span class="monospaced">.no-flexbox</span> then the browsers that support flexible boxes will use the former and the older browsers - the latter.</p></div>
<div class="paragraph"><p>When Modernizr loads it creates a new JavaScript object <span class="monospaced">window.Modernizr</span> with lots of boolean properties indicating if a certain feature is or is not supported (see <a href="#FIG3-18">[FIG3-18]</a>).</p></div>
<div class="imageblock" id="FIG3-18">
<div class="content">
<img src="images/fig_03_18.png" alt="images/fig_03_18.png">
</div>
<div class="title">Figure 41. window.Modernizr object</div>
</div>
<div class="paragraph"><p>Hence your JavaScript code can test if certain features are supported or not.</p></div>
<div class="paragraph"><p>What if the Modernizer detects that a certain feature is not supported yet by a user&#8217;s older browser? You can include polyfills in your code that replicate the required functionality. You can write such a polyfill on your own or pick one from the collection that is located at <a href="https://github.com/Modernizr/Modernizr/wiki/HTML5-Cross-Browser-Polyfills">Modernizr&#8217;s Github repository</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Addy Osmani published <a href="http://www.dzone.com/links/r/javafx_for_tablets_amp_mobile.html">The Developer&#8217;s Guide To Writing Cross-Browser JavaScript Polyfills</a></td>
</tr></table>
</div>
<div class="paragraph"><p>The Development version of Modernizr weighs 42Kb and can detect lots of features. But you can make it smaller by configuring the detection of only selected features. Just visit <a href="http://modernizr.com/">Modernizr</a> and press the red Production button that will allow to configure the build specifically for your application. For example, if you&#8217;re just interested to detect the HTML5 video support, the size of the generated Modernizr library will be reduced to under 2Kb.</p></div>
<div class="paragraph"><p>Let&#8217;s review the relevant code from project-08-1-modernizr-geolocation-maps that illustrate the use of Modernizr. In particular, Modernizr allows you to load one or the other JavaScript code based on the result of some tests.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph"><p>NOTE:
Actually, the Modernizr loader internally utilizes a tiny (under 2Kb) resource loader library <a href="http://yepnopejs.com/">yepnope.js</a>, which can load both JavaScript and CSS. This library is integrated in Modernizr, but we just wanted to give a proper recognition to yepnope.js, which can be used as an independent resource loader too.</p></div>
</div></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

  Modernizr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>

        test<span style="color: #990000">:</span> Modernizr<span style="color: #990000">.</span>geolocation<span style="color: #990000">,</span>

        yep<span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">'js/get-native-geo-data.js'</span><span style="color: #990000">,</span><span style="color: #FF0000">'https://www.google.com/jsapi'</span><span style="color: #990000">],</span>

        nope<span style="color: #990000">:</span> <span style="color: #990000">[</span><span style="color: #FF0000">'js/get-geo-data-by-ip.js'</span><span style="color: #990000">,</span><span style="color: #FF0000">'https://www.google.com/jsapi'</span><span style="color: #990000">],</span>

        complete <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                google<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"maps"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"3"</span><span style="color: #990000">,</span>
                            <span style="color: #FF0000">{</span>other_params<span style="color: #990000">:</span> <span style="color: #FF0000">"sensor=false"</span><span style="color: #990000">,</span> <span style="color: #FF0000">'callback'</span><span style="color: #990000">:</span>init<span style="color: #FF0000">}</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
<div class="paragraph"><p>The code above invokes the function <span class="monospaced">load()</span>, which can take different arguments, but our example uses as an argument a specially prepared object with five properties: <span class="monospaced">test, yep, nope, complete</span>. The <span class="monospaced">load()</span> function will test the value of <span class="monospaced">Modernizr.geolocation</span> and if it&#8217;s true, it&#8217;ll load the scripts listed in the <span class="monospaced">yep</span> property. Otherwise it&#8217;ll load the code listed in the <span class="monospaced">nope</span> array. The code in the get-native-geo-data.js gets the user&#8217;s location the same way as it was done earlier in the section Integrating with Google Maps.</p></div>
<div class="paragraph"><p>Now let&#8217;s consider the "nope" case. The code of the get-geo-data-by-ip.js has to offer an alternative way of getting the location for the browsers that don&#8217;t support HTML5 Geolocation API. We found the GeoIP JavaScript API offered by <a href="http://www.maxmind.com/">MaxMind, Inc.</a>. Their service returns country, region, city, latitude and longitude, which can serve as a good illustration of how a workaround of a non-supported feature can be implemented. The code in get-geo-data-by-ip.js is very simple for now.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">init</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationMap <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'location-map'</span><span style="color: #990000">);</span>
 locationMap<span style="color: #990000">.</span>innerHTML<span style="color: #990000">=</span><span style="color: #FF0000">"Your browser does not support HTML5 geolocation API."</span><span style="color: #990000">;</span>

 <span style="font-style: italic"><span style="color: #9A1900">// The code to get the location by IP from http://j.maxmind.com/app/geoip.js</span></span>
 <span style="font-style: italic"><span style="color: #9A1900">// will go here. Then we'll pass the latitude and longitude values to</span></span>
 <span style="font-style: italic"><span style="color: #9A1900">// Google Map API for drawing the map.</span></span>

<span style="color: #FF0000">}</span>
</tt></pre></div></div>
<div class="paragraph"><p>Most likely your browser supports HTML5 geolocation API, and you&#8217;ll see the map created by the script get-native-geo-data.js. But if you want to test a non-supported geolocation (the nope branch)  either try this code in the older browser or change the test condition to look like this: <span class="monospaced">Modernizr.fakegeolocation,</span>.</p></div>
<div class="paragraph"><p>Google has several JavaScript APIs, for example, Maps, Search, Feeds, Earths et al. Any of these APIs can be loaded by  <a href="https://developers.google.com/loader/">Google AJAX Loader</a> <span class="monospaced">google.load()</span>. This is more generic way of loading any APIs comparing to loading maps from <a href="http://maps.googleapis.com/maps/api">http://maps.googleapis.com/maps/api</a> in the previous section on integrating geolocation and maps. The process of loading of the Google code with Google AJAX Loader consists of two steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Load Google&#8217;s  common loader script from <a href="https://www.google.com/jsapi">https://www.google.com/jsapi</a>
</p>
</li>
<li>
<p>
Load the concrete module API specifying its name, version and optional parameters. In our example we are loading the maps API of version 3 passing an object with two properties: <span class="monospaced">sensor=false</span> and the name of the callback function to invoke right after the mapping API completes loading: <span class="monospaced">'callback':init</span>.
</p>
</li>
</ol></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you want to test your Web page in the specific old version of a particular Web browser, you can find their distributions at oldapps.com. For example, you can find all the old version of Firefox for <a href="http://mac.oldapps.com/firefox.php">Mac OS</a> and for <a href="http://www.oldapps.com/firefox.php">Windows</a>.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_search_and_multi_markers_with_google_maps">Search and Multi-Markers With Google Maps</h4>
<div class="paragraph"><p>We&#8217;ve prepared for you a couple of more examples just to showcase the features of Google Maps API. The working examples will be included in the code accompanying the book, and we&#8217;ll provide very brief explanations below.</p></div>
<div class="paragraph"><p>The Aptana&#8217;s project-09-map-and-search is an example of address search using Google Maps API. <a href="#FIG3-19">[FIG3-19]</a> shows a fragment of the Save Sick Child page after we&#8217;ve entered the address "26 Broadway ny ny" in the search field. You can do a search by city or a zip code too. This can be a useful feature if you&#8217;d want to allow the users search for sick children living in a particular geographical area so their donation would be directed to specific people.</p></div>
<div class="imageblock" id="FIG3-19">
<div class="content">
<img src="images/fig_03_19.png" alt="images/fig_03_19.png">
</div>
<div class="title">Figure 42. Searching by Address</div>
</div>
<div class="paragraph"><p>Our implementation of the search is shown in the code fragment from main.js. It uses geocoding, which is a process of converting an address into geographic coordinates (latitude and longitude). If the address is found, the code places a marker on the map.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> geocoder <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Geocoder</span></span><span style="color: #990000">();</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">getMapByAddress</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> newaddress <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'newaddress'</span><span style="color: #990000">).</span>value<span style="color: #990000">;</span>

 geocoder<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">geocode</span></span><span style="color: #990000">(</span>                                    <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/1.png" alt="1"></span></span>
  <span style="color: #FF0000">{</span><span style="color: #FF0000">'address'</span> <span style="color: #990000">:</span> newaddress<span style="color: #990000">,</span>
  <span style="color: #FF0000">'country'</span> <span style="color: #990000">:</span> <span style="color: #FF0000">'USA'</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>results<span style="color: #990000">,</span> status<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                       <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/2.png" alt="2"></span></span>
   console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'status = '</span> <span style="color: #990000">+</span> status<span style="color: #990000">);</span>

   <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>status <span style="color: #990000">==</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>GeocoderStatus<span style="color: #990000">.</span>OK<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> latitude <span style="color: #990000">=</span> results<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>geometry<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">lat</span></span><span style="color: #990000">();</span>          <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> longitude <span style="color: #990000">=</span> results<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>geometry<span style="color: #990000">.</span>location<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">lng</span></span><span style="color: #990000">();</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> formattedAddress <span style="color: #990000">=</span> results<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>formatted_address<span style="color: #990000">;</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'latitude = '</span> <span style="color: #990000">+</span> latitude <span style="color: #990000">+</span>
                    <span style="color: #FF0000">' longitude = '</span> <span style="color: #990000">+</span>  longitude<span style="color: #990000">);</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'formatted_address = '</span> <span style="color: #990000">+</span> formattedAddress<span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> message <span style="color: #990000">=</span> <span style="color: #FF0000">'&lt;b&gt;Address&lt;/b&gt;: '</span> <span style="color: #990000">+</span> formattedAddress<span style="color: #990000">;</span>
        foundInfo<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> message<span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationCoordinates <span style="color: #990000">=</span>
              <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">LatLng</span></span><span style="color: #990000">(</span>latitude<span style="color: #990000">,</span> longitude<span style="color: #990000">);</span>         <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
        <span style="font-weight: bold"><span style="color: #000000">showMap</span></span><span style="color: #990000">(</span>locationCoordinates<span style="color: #990000">,</span> locationMap<span style="color: #990000">);</span>

   <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>status <span style="color: #990000">==</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>GeocoderStatus<span style="color: #990000">.</span>ZERO_RESULTS<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'geocode was successful but returned no results. '</span> <span style="color: #990000">+</span>
         <span style="color: #FF0000">'This may occur if the geocode was passed a non-existent '</span> <span style="color: #990000">+</span>
         <span style="color: #FF0000">'address or a latlng in a remote location.'</span><span style="color: #990000">);</span>

   <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>status <span style="color: #990000">==</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>GeocoderStatus<span style="color: #990000">.</span>OVER_QUERY_LIMIT<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'You are over our quota of requests.'</span><span style="color: #990000">);</span>

   <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>status <span style="color: #990000">==</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>GeocoderStatus<span style="color: #990000">.</span>REQUEST_DENIED<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Your request was denied, '</span> <span style="color: #990000">+</span>
        <span style="color: #FF0000">'enerally because of lack of a sensor parameter.'</span><span style="color: #990000">);</span>

   <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>status <span style="color: #990000">==</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>GeocoderStatus<span style="color: #990000">.</span>INVALID_REQUEST<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Invalid request. '</span> <span style="color: #990000">+</span>
             <span style="color: #FF0000">'The query (address or latlng) is missing.'</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
 <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Initiate request to the <span class="monospaced">Gecoder</span> object providing the <span class="monospaced">GeocodeRequest</span> object with the address and a function to process the results. Since the request to the Google server is asynchronous, the function is a callback.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
When the callback will be invoked, it&#8217;ll get an array with results.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Get the latitude and longitude from the result.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Prepare the LatLng object and give it to the mapping API for rendering.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Process errors.
</td></tr>
</table></div>
<div class="paragraph"><p>The Geocoding API is simple and free to use until your application reaches a certain number of requests. Refer to <a href="https://developers.google.com/maps/documentation/javascript/geocoding">Google Geocoding API documentation</a> for more details.</p></div>
<div class="paragraph"><p>Jerry has yet another cool idea: show multiple markers on the map reflecting several donation campaigns and charity events that are going on at various locations. If we display  this information on the Save Sick Child page more people may participate with their donations or other ways. We&#8217;ve just learned how to do an address search on the map, and if the application has an access to the data about charity events, we can display them as the markers on the map. Run the project-10-maps-multi-markers and you&#8217;ll see a map with multiple markers as in <a href="#FIG3-20">[FIG3-20]</a></p></div>
<div class="imageblock" id="FIG3-20">
<div class="content">
<img src="images/fig_03_20.png" alt="images/fig_03_20.png">
</div>
<div class="title">Figure 43. Multiple markers on the map</div>
</div>
<div class="paragraph"><p>The JavaScript fragment below displays the map with multiple markers. In this example the data is hard-coded in the array <span class="monospaced">charityEvents</span>, but in the next chapter we&#8217;ll modify this example and will get the data from a file in a JSON form. The for-loop creates a marker for each of the event listed in the array <span class="monospaced">charityEvents</span>. Each element of this array is also an array containing the name of the city and state, the latitude and longitude, and the title of the charity event. You can have any other attributes of the charity events stored in such an array and display them when the user clicks on a particular marker in an overlay by calling <span class="monospaced">InfoWindow.open()</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationUI <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'location-ui'</span><span style="color: #990000">);</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> locationMap <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'location-map'</span><span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> charityEvents <span style="color: #990000">=</span> <span style="color: #990000">[[</span><span style="color: #FF0000">'Chicago, Il'</span><span style="color: #990000">,</span> <span style="color: #993399">41.87</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">87.62</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Giving Hand'</span><span style="color: #990000">],</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">'New York, NY'</span><span style="color: #990000">,</span> <span style="color: #993399">40.71</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">74.00</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Lawyers for Children'</span><span style="color: #990000">],</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">'Dallas, TX'</span><span style="color: #990000">,</span> <span style="color: #993399">32.80</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">96.76</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Mothers of Asthmatics '</span><span style="color: #990000">],</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">'Miami, FL'</span><span style="color: #990000">,</span> <span style="color: #993399">25.78</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">80.22</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Friends of Blind Kids'</span><span style="color: #990000">],</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">'Miami, FL'</span><span style="color: #990000">,</span> <span style="color: #993399">25.78</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">80.22</span><span style="color: #990000">,</span> <span style="color: #FF0000">'A Place Called Home'</span><span style="color: #990000">],</span>
    <span style="color: #990000">[</span><span style="color: #FF0000">'Fargo, ND'</span><span style="color: #990000">,</span> <span style="color: #993399">46.87</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">96.78</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Marathon for Survivors'</span><span style="color: #990000">]</span>
  <span style="color: #990000">];</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> mapOptions <span style="color: #990000">=</span> <span style="color: #FF0000">{</span>
                center <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">LatLng</span></span><span style="color: #990000">(</span><span style="color: #993399">46.87</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">96.78</span><span style="color: #990000">),</span>
                zoom <span style="color: #990000">:</span> <span style="color: #993399">3</span><span style="color: #990000">,</span>
                mapTypeId <span style="color: #990000">:</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>MapTypeId<span style="color: #990000">.</span>ROADMAP<span style="color: #990000">,</span>
                mapTypeControlOptions <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        style <span style="color: #990000">:</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>MapTypeControlStyle<span style="color: #990000">.</span>DROPDOWN_MENU<span style="color: #990000">,</span>
                        position <span style="color: #990000">:</span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>ControlPosition<span style="color: #990000">.</span>TOP_RIGHT
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> map <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Map</span></span><span style="color: #990000">(</span>locationMap<span style="color: #990000">,</span> mapOptions<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> infowindow <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">InfoWindow</span></span><span style="color: #990000">();</span>

  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> marker<span style="color: #990000">,</span> i<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> charityEvents<span style="color: #990000">.</span>length<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
        marker <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Marker</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
                position <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">LatLng</span></span><span style="color: #990000">(</span>charityEvents<span style="color: #990000">[</span>i<span style="color: #990000">][</span><span style="color: #993399">1</span><span style="color: #990000">],</span>
                                                  charityEvents<span style="color: #990000">[</span>i<span style="color: #990000">][</span><span style="color: #993399">2</span><span style="color: #990000">]),</span>
                map <span style="color: #990000">:</span> map
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

        google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addListener</span></span><span style="color: #990000">(</span>marker<span style="color: #990000">,</span> <span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>marker<span style="color: #990000">,</span> i<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> content <span style="color: #990000">=</span> charityEvents<span style="color: #990000">[</span>i<span style="color: #990000">][</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #FF0000">'&lt;br/&gt;'</span> <span style="color: #990000">+</span> charityEvents<span style="color: #990000">[</span>i<span style="color: #990000">][</span><span style="color: #993399">3</span><span style="color: #990000">];</span>
                 infowindow<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setContent</span></span><span style="color: #990000">(</span>content<span style="color: #990000">);</span>
                 infowindow<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span>map<span style="color: #990000">,</span> marker<span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">)(</span>marker<span style="color: #990000">,</span> i<span style="color: #990000">));</span>

        google<span style="color: #990000">.</span>maps<span style="color: #990000">.</span>event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addListenerOnce</span></span><span style="color: #990000">(</span>map<span style="color: #990000">,</span> <span style="color: #FF0000">'idle'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                locationUI<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> <span style="color: #FF0000">"Donation campaigns and charity events."</span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">)</span>
  <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span><span style="color: #990000">)();</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_3">Summary</h3>
<div class="paragraph"><p>This chapter has described the process of mocking the future Web site on by our Web Designer Jerry, who went a lot further than creating a number of images with short descriptions. Jerry created a working prototype of the Save Sick Child page. Keep in mind that Jerry and his fellow Web designers like to create beautiful Web pages. But us, Web developers need to worry about other things like making Web pages responsive and light weight. The first thing you need to do after receiving the prototype of your Web application from Jerry is run it through Google Developer Tools or Firebug and measure the total size of the resources being downloaded from the server. If it loads 1Mb or more worth of images, ask Jerry to review the resources and minimize the size. If the first page makes 100 calls to the server just to download all required resources - ask Jerry to group them.  But optimizing the main (or the only) page of your application is not only Jerry&#8217;s task. The chances are that you don&#8217;t need to download all the JavaScript code at once - we&#8217;ll discuss modularization of large applications in Chapter 7.</p></div>
<div class="paragraph"><p>The next phase of improving this prototype is to remove the hard-coded data from the code and place them into external files. The next chapter will cover the JSON data format and how to fill our single-page application with the data using a set of techniques called AJAX.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_ajax_and_json">Using AJAX and JSON</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter is about bringing the external data to HTML Web pages. In the previous chapters we&#8217;ve been using only hard-coded data - our goal was to see how to layout the Web page and how to change the layout in case some events have happened, e.g. the user clicked on the menu button. Now we&#8217;ll make sure that our single-page application Save Sick Child can request the data from the external sources and send them the data too. This comes down to two questions:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
How an HTML Web page can exchange the data with external data sources?
</p>
</li>
<li>
<p>
What format to use for presenting the application data?
</p>
</li>
</ol></div>
<div class="paragraph"><p>While there could be different answers to these questions, we&#8217;ll be using AJAX techniques as an answer to the first question and JSON data format as an answer to the second one. We&#8217;ll start this chapter with explaining why AJAX and JSON are appropriate choice for the Save Sick Child Web application and many others.</p></div>
<div class="sect2">
<h3 id="_why_ajax">Why AJAX</h3>
<div class="paragraph"><p>If a user points her Web browser to one URL and then changes it to another, the new request will be sent to the new URL, and the new page will arrive and will be rendered by the browser. The URL may have been changed not because the user decided to go to visit a different Web site, but simply because the user selected a menu item that resulted in bringing a new Web page from the same domain. This was pretty much the only way Web sites were designed in the 90th.</p></div>
<div class="paragraph"><p>Back in 1999, Microsoft decided to create a Web version of Outlook - their popular eMail application. Their goal was to be able to modify the Input folder as the new emails arrive, but without refreshing the entire content of the Web page. They created an ActiveX control called <span class="monospaced">XMLHTTP</span> that lived inside Internet Explorer 5 and could make requests to the remote servers receiving data without the need to refresh the entire Web page. Such a Web Outlook client would would make periodic requests to the mail server, and if the new mail arrived the application would insert the new row on the top of the Inbox by direct change of the DOM object from JavaScript.</p></div>
<div class="paragraph"><p>In early 2000th, other Web browsers adopted this model and implemented their own versions of <span class="monospaced">XMLHTTPRequest</span>. Its Working Draft 6 is <a href="http://www.w3.org/TR/XMLHttpRequest/">published by W3C</a>.  Google created their famous email client GMail and Map Web applications.  In 2005 Jesse James Garrett wrote an article titled "AJAX: A New Approach to Web Applications". The Web developer community liked the term AJAX, which stand for Asynchronous JavaScript and XML, and this gave a birth to the new breed of Web applications that could update the content of just the portion of a Web page without re-retrieving the entire page. Interestingly enough, the last letter in the AJAX acronym stands for XML, while realistically presenting the data in the XML form is not required, and is seldom used as a data format in the client-server exchanges. JSON is used a lot more often to represent the data, but apparently AJAJ didn&#8217;t sound as good as AJAX.</p></div>
<div class="paragraph"><p>Visit the <a href="http://www.google.com/finance">Google Finance</a> or <a href="http://finance.yahoo.com/">Yahoo! Finance</a> Web pages when the stock market is open, and you&#8217;ll see how the price quotes or other financial indicators are changing while the most of the content remains the same. This gives an illusion of the server pushing the data to your Web client. But most likely, it not a data push but rather periodic <em>polling</em> of the server&#8217;s data using AJAX. In the modern Web applications we expect to see more of the real server side data push using HTML5 WebSockets API, which is described in details in Chapter 9 of this book.</p></div>
</div>
<div class="sect2">
<h3 id="_why_json">Why JSON</h3>
<div class="paragraph"><p><a href="http://www.json.org/js.html">JSON</a> stands for JavaScript Object Notation. It&#8217;s a more compact than XML way to represent the data. Besides, all modern Web Browsers understand and can parse JSON data. After learning the JavaScript object literals in Chapter 2, you&#8217;ll see that the presenting the data in JSON notation is almost the same as writing JavaScript object literals.</p></div>
<div class="paragraph"><p><a href="#FIG4-1">[FIG4-1]</a> depicts a high level view of a typical Web application. All of the code samples from Chapter 2 and Chapter 3 were where written in HTML, JavaScript and CSS. in this chapter will add to the mix the <span class="monospaced">XMLHttpRequest</span> object that will send and receive the JSON content wrapped into <span class="monospaced">HTTPRequest</span> and <span class="monospaced">HTTPResponse</span> objects.</p></div>
<div class="imageblock" id="FIG4-1">
<div class="content">
<img src="images/fig_04_01.png" alt="images/fig_04_01.png">
</div>
<div class="title">Figure 44. Anatomy of a Web application</div>
</div>
<div class="paragraph"><p>Back in the 90th, if a Web application would need some JavaScript code or data from the server, Web developers would wrap it into an HTML <span class="monospaced">&lt;iFrame&gt;</span> element and send it to the client, which would use the the <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/eval"><span class="monospaced">eval()</span></a> function to execute it. Today, there is no need to do this if you just want to send the data - format it as a JSON object and use the JSON parser.</p></div>
<div class="paragraph"><p>When a Web page is loaded the user doesn&#8217;t know (and doesn&#8217;t have to know) that the page content was brought from several servers that can be located thousands miles apart. More often than not, when the user enters the URL requesting an HTML document, the server side code can engage several servers to bring all the data requested by the user. Some of the data are retrieved by making calls to one or more Web Services. The legacy Web services were build using SOAP + XML, but  majority of today&#8217;s Web services are build using lighter <a href="http://en.wikipedia.org/wiki/Representational_state_transfer"><em>RESTful architecture</em></a>, and JSON has become a de facto standard data exchange format of the REST Web services.</p></div>
</div>
<div class="sect2">
<h3 id="_how_ajax_works">How AJAX Works</h3>
<div class="paragraph"><p>Imagine a single-page application that needs some data to refreshed in real time. For example, our Save Sick Child application includes an online auction where people can bid and purchase some goods as a part of a charity event. If John from New York placed a bid on certain auction item, and some time later Mary from Chicago placed the higher bid on the same item, we want to make sure that John knows about it immediately, in real time.  This means that the server-side software that received Mary&#8217;s bid has to push this data to all users who expressed their interest in the same item.</p></div>
<div class="paragraph"><p>But the server has to send and the browser has to modify only the new price while the rest of the content of the Web page should remain the same. You can implement behavior using AJAX. But first, the bad news:
you can&#8217;t implement the real-time server side push with AJAX. You can only emulate this behavior by using polling techniques, when the <span class="monospaced">XMLHttpRequest</span> object sits inside your JavaScript code and periodically sends HTTP requests to the server asking if there were any changes in bids since the last request.</p></div>
<div class="paragraph"><p>If, for instance, the last request was made at 10:20:00AM, the new bid was placed at 10:20:02AM, and the application makes a new request (and updates the browser&#8217;s window) at 10:20:25AM, this means that the user will be notified about the price change with a three second delay. AJAX is still request-response based way of getting the server&#8217;s data, and strictly speaking, doesn&#8217;t offer a real real-time updates. Some people use the term <em>near real time</em> notifications.</p></div>
<div class="paragraph"><p>Another bad news is that AJAX uses HTTP protocol for the data communication, which means that a substantial overhead in the form of <span class="monospaced">HTTPResponse</span> header will be added to the new price, and it can be as large as several hundred bytes. This is still better than sending the entire page to the Web browser, but HTTP adds a hefty overhead.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">We&#8217;ll implement such an auction in Chapter 9 using a lot more efficient protocol called WebSockets, which supports a real-time data push and adds only several extra bytes to the data load.</td>
</tr></table>
</div>
</div></div>
<div class="sect3">
<h4 id="_retrieving_data_from_the_server">Retrieving Data From the Server</h4>
<div class="paragraph"><p>Let&#8217;s try to implement AJAX techniques by implementing a data retrieval. The process of making an AJAX request is well defined and consists of the following steps:</p></div>
<div class="ulist"><ul>
<li>
<p>
Create an instance of XMLHttpRequest object.
</p>
</li>
<li>
<p>
Initialize the request to your data source by invoking the method <span class="monospaced">open()</span>.
</p>
</li>
<li>
<p>
Assign the a handler to the <span class="monospaced">onreadystatechange</span> attribute to process server&#8217;s response.
</p>
</li>
<li>
<p>
Make a request to the data source by calling <span class="monospaced">send()</span>.
</p>
</li>
<li>
<p>
In your handler function process the response when it arrives from the server.
</p>
</li>
<li>
<p>
Modify the DOM elements based on the received data, if need be.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In most of the books on AJAX you&#8217;ll see browser-specific ways of instantiating the <span class="monospaced">XMLHttpRequest</span> object (a.k.a. XHR). Most likely you&#8217;ll be developing your application using some JavaScript framework and all browser specifics in instantiating of the <span class="monospaced">XMLHttpRequest</span> will be hidden from you. Chapters 6 and 7 include such examples, but let&#8217;s stick to the standard JavaScript way implemented by all modern browsers:</p></div>
<div class="paragraph"><p><span class="monospaced">var xhr = new XMLHttpRequest();</span></p></div>
<div class="paragraph"><p>The next step is to initialize a request by invoking the method <span class="monospaced">open()</span>. You need to provide the HTTP method (<span class="monospaced">GET</span>, <span class="monospaced">POST</span> et al.), the URL of the data source. Optionally, you can provide three more arguments: a Boolean variable indicating if you want this request to be processed asynchronously (which is the default), and the user id and password if the authentication is required. Keep in mind, that the following method does not request the data yet.</p></div>
<div class="paragraph"><p><span class="monospaced">xhr.open('GET', dataUrl);</span></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Always use HTTPS ptotocol if you need to send the user id and password. Using secure HTTP should be your preferred protocol in general (read more in Chapter 10).</td>
</tr></table>
</div>
<div class="paragraph"><p>XHR has an attribute <span class="monospaced">readyState</span>, and as soon as it changes the callback function assigned to the <span class="monospaced">onreadystatechange</span> will be invoked. This callback should contain your application specific code to analyze the response and process it accordingly. Assigning such a callback is pretty simple:</p></div>
<div class="paragraph"><p><span class="monospaced">xhr.onreadystatechange = function(){...}</span></p></div>
<div class="paragraph"><p>Inside such a callback function you&#8217;ll be analyzing the value of the XHR&#8217;s attribute <span class="monospaced">readyState</span>, which can have one of the following values:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 1. States of the Request</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >Value </th>
<th class="tableblock halign-left valign-top" > State </th>
<th class="tableblock halign-left valign-top" > Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">UNSENT</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">the XHR has been constructed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OPENED</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">open() was successfully invoked</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">HEADERS_RECEIVED</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">All HTTP headers has been received</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LOADING</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">The response body is being received</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DONE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">the data transfer has been completed</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Finally, send the AJAX request for data. The method <span class="monospaced">send()</span> can be called with or without parameters depending on if you need to send the data to the server or not. In its simplest fore the method <span class="monospaced">send()</span> can be invoked as follows:</p></div>
<div class="paragraph"><p>` xhr.send();`</p></div>
<div class="paragraph"><p>The complete cycle of the <span class="monospaced">readyState</span> transitions is depicted in <a href="#FIG4-2">[FIG4-2]</a></p></div>
<div class="imageblock" id="FIG4-2">
<div class="content">
<img src="images/fig_04_02.png" alt="images/fig_04_02.png">
</div>
<div class="title">Figure 45. Transitions of the readyState attribute</div>
</div>
<div class="paragraph"><p>Let&#8217;s spend a bit more time discussing the completion of the this cycle when server&#8217;s response is received and the XHR&#8217;s <span class="monospaced">readyState</span> is equal to 4. This means that we&#8217;ve got something back, which can be either the data we&#8217;ve expected or the error message. We need to handle both scenarios in the function assigned to the <span class="monospaced">onreadystatechange</span> attribute. This is a common way to do it in JavaScript without using frameworks:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>xhr<span style="color: #990000">.</span>onreadystatechange <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>

 <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

   <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">((</span>xhr<span style="color: #990000">.</span>status <span style="color: #990000">&gt;=</span><span style="color: #993399">200</span> <span style="color: #990000">&amp;&amp;</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">&lt;</span><span style="color: #993399">300</span><span style="color: #990000">)</span> <span style="color: #990000">||</span> xhr<span style="color: #990000">.</span>status<span style="color: #990000">===</span><span style="color: #993399">304</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

       <span style="font-style: italic"><span style="color: #9A1900">// We got the data. Get the value from one of the response attributes</span></span>
       <span style="font-style: italic"><span style="color: #9A1900">// e.g. xhr.responseText and process the data accordingly.</span></span>

   <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// We got an error. Process the error code and</span></span>
      <span style="font-style: italic"><span style="color: #9A1900">// display the content of the statusText attribute.</span></span>
   <span style="color: #FF0000">}</span>

  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>First the code should check the <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP status code</a> received from server. W3C splits the HTTP codes into groups. The codes numbered as 1xx are informational, 2xx are successful codes, 3xx are about redirections, 4xx represent bad requests (like infamous 404 for Not Found), and 5xx for server errors. That&#8217;s why the above code fragment checks for all 2xx codes and 304 - the data was not modified and taken from cache.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">If your application needs to post the data to the server, you need to open the connection to the server with the <span class="monospaced">POST</span> parameter. You&#8217;ll also need to set the HTTP header attribute <span class="monospaced">Content-type</span> to either <span class="monospaced">multipart/form-data</span> for large-size binary data or to  <span class="monospaced">application/x-www-form-urlencoded</span> (for forms and small-size alphanumeric data).  Then prepare the data object and invoke the method <span class="monospaced">send()</span>:</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> data<span style="color: #990000">=</span><span style="color: #FF0000">"This is some data"</span><span style="color: #990000">;</span>
xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'POST'</span><span style="color: #990000">,</span> dataUrl<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setRequestHeader</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Content-type'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'application/x-www-form-urlencoded'</span><span style="color: #990000">);</span>

<span style="color: #990000">...</span>
xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span>data<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_ajax_good_and_bad">AJAX: Good and Bad</h4>
<div class="paragraph"><p>AJAX techniques have their pros and cons. You saw how easy it was to create a Web page that didn&#8217;t have to refresh itself, but provided the users with the means of communicating with the server. This certainly improves the user experience. The fact that AJAX allows you to lower the amount of data that goes over the wire is important too. Another important advantage of AJAX that it works in a standard HTML/JavaScript environment and is supported by all Web browsers. The JavaScript frameworks hides all the differences in instantiating <span class="monospaced">XMLHttpRequest</span> and simplify making HTTP requests and processing responses. Since the entire page is not reloaded, you can create "fat clients" that keep certain data preloaded once and reused in your JavaScript in different use cases. With AJAX you can lazy load some content as needed rather than loading everything at once. Taken for granted auto-completion feature would not be possible in HTML/JavaScript application without the AJAX.</p></div>
<div class="paragraph"><p>On the bad side, with AJAX the user loses the functionality of the browser&#8217;s Back button, which reloads the previous Web page while the user could expect to see the previous state of the same page. Since the AJAX brings most of the content dynamically, the search engines wouldn&#8217;t rank your Web pages as high as it would do if the content was statically embedded in the HTML. Increasing the amount of AJAX interactions means that your application will have to send more of the JavaScript code to the Web browser, which increases the complexity of programming and decreases the scalability of your application.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Using HTML5 History API (see Chapter 1) will help you in teaching the old dog (the browser&#8217;s Back button) new tricks.</td>
</tr></table>
</div>
<div class="paragraph"><p>AJAX applications are subject to <em>the same origin policy</em> (the same protocol, port, and host) allowing <span class="monospaced">XMLHttpRequest</span> make HTTP requests only to the domains where the Web application was loaded from.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">W3C has published a working draft of <a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS?redirectlocale=en-US&amp;redirectslug=HTTP_access_control">Cross-Origin Resource Sharing</a> (CORS) - a mechanism to enable client-side cross-origin requests.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_populating_states_and_countries_from_html_files">Populating States and Countries from HTML Files</h4>
<div class="paragraph"><p>To see the first example where we are using AJAX in our Save Sick Child application run the Aptana&#8217;s project-04-1-donation-ajax-html, where we&#8217;ve removed the hard-coded data about countries and states from HTML and saved them in two separate files: data/us-states.html and data/countries.html. In this project the file index.html has two empty comboboxes (<span class="monospaced">&lt;select&gt;</span> elements):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>  <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"state"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"state"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">selected</span><span style="color: #990000">=</span><span style="color: #FF0000">"selected"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> - State - <span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- AJAX will load the rest of content --&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;select</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"country"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"counriesList"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span> <span style="color: #009900">selected</span><span style="color: #990000">=</span><span style="color: #FF0000">"selected"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span> - Country - <span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">&lt;!-- AJAX will load the rest of content --&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/select&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The resulting Save Sick Child page will look the same as the last sample from the previous chapter, but the Countries and States dropdowns are now populated be the data located in these files. Later in this chapter in the section on JSON we&#8217;ll replace this HTML file with its JSON version. These are the first three lines (out of 241) from the file countries.html:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"United States"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>United States<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"United Kingdom"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>United Kingdom<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;option</span></span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Afghanistan"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Afghanistan<span style="font-weight: bold"><span style="color: #0000FF">&lt;/option&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The JavaScript code that reads countries and states from file and populates the dropdowns comes next. The content of these files is assigned to the <span class="monospaced">innerHTML</span> attribute of the given HTML <span class="monospaced">&lt;select&gt;</span> element.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">,</span> target<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> xhr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'GET'</span><span style="color: #990000">,</span> dataUrl<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>
  xhr<span style="color: #990000">.</span>onreadystatechange <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
           <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">((</span>xhr<span style="color: #990000">.</span>status <span style="color: #990000">&gt;=</span><span style="color: #993399">200</span> <span style="color: #990000">&amp;&amp;</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">&lt;</span><span style="color: #993399">300</span><span style="color: #990000">)</span> <span style="color: #990000">||</span>
                                 xhr<span style="color: #990000">.</span>status<span style="color: #990000">===</span><span style="color: #993399">304</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>

                        target<span style="color: #990000">.</span>innerHTML <span style="color: #990000">+=</span> xhr<span style="color: #990000">.</span>responseText<span style="color: #990000">;</span>
          <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>

                        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>statusText<span style="color: #990000">);</span>
          <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Load the countries and states using XHR</span></span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/us-states.html'</span><span style="color: #990000">,</span> statesList<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/countries.html'</span><span style="color: #990000">,</span> counriesList<span style="color: #990000">);</span></tt></pre></div></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">The above code has an issue, which may not be so obvious, but can irritate users. The problem is that it doesn&#8217;t handle errors. Yes, we print the error message on the developer&#8217;s console, but the end user will never see them. If for some reason the data about countries or states won&#8217;t arrive, the dropdowns will be empty, the donation form won&#8217;t be valid and the users will become angry that they can&#8217;t make a donation without knowing why. Proper error handling and reports are very important for any application so never ignore it. You should display a user-friendly error messages on the Web page. For example the above <span class="monospaced">else</span> statement can display the received message in the page footer</td>
</tr></table>
</div>
<div class="paragraph"><p>else {
        console.log(xhr.statusText);</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>        // Show the error message on the Web page
      footerContainer.innerHTML += '&lt;p class="error"&gt;Error getting ' +
                    target.name + ": "+ xhr.statusText + ",code: "+
                     xhr.status + "&lt;/p&gt;";
}</pre>
</div></div>
<div class="paragraph"><p>This code uses the CSS selector <span class="monospaced">error</span> that will show the error message on the red background. you can find it in the file styles.css in Aptana&#8217;s project-04-3-donation-error-ajax-html. It looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>footer p<span style="color: #993399">.error</span> <span style="color: #FF0000">{</span>
        <span style="color: #0000FF">background:</span><span style="color: #FF0000">#d53630</span>;
        <span style="color: #0000FF">text-align:</span><span style="font-style: italic"><span style="color: #009900">left</span></span>;
        <span style="color: #0000FF">padding:</span> <span style="font-style: italic"><span style="color: #009900">0.9em</span></span>;
        <span style="color: #0000FF">color:</span> <span style="color: #FF0000">#fff</span>;
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div></div>
<div class="paragraph"><p>The following code fragment shows how to add the received data to a certain area on the Web page.
This code creates an HTML paragraph <span class="monospaced">&lt;p&gt;</span> with the text returned by the server and then adds this paragraph to the <span class="monospaced">&lt;div&gt;</span> with the ID <span class="monospaced">main</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">((</span>xhr<span style="color: #990000">.</span>status <span style="color: #990000">&gt;=</span><span style="color: #993399">200</span> <span style="color: #990000">&amp;&amp;</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">&lt;</span><span style="color: #993399">300</span><span style="color: #990000">)</span> <span style="color: #990000">||</span> xhr<span style="color: #990000">.</span>status<span style="color: #990000">===</span><span style="color: #993399">304</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> p <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"p"</span><span style="color: #990000">);</span>

      p<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createTextNode</span></span><span style="color: #990000">(</span>myRequest<span style="color: #990000">.</span>responseText<span style="color: #990000">));</span>

      document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"main"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>p<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_using_json">Using JSON</h3>
<div class="paragraph"><p>In any client-server application one of the important decisions to be made is about the format of the data that go over the network. We are talking about the application-specific data. Someone has to decide how to represent the data about an Auction Item, Customer, Donation et al. The easiest way to represent text data is Comma Separated Format (CSV), but it&#8217;s not easily readable by humans, hard to validate,  and recreation of JavaScript objects from CSV feed would require additional information about the headers of the data.</p></div>
<div class="paragraph"><p>Sending the data in XML form addresses the readability and validation issues, but it&#8217;s very verbose. Every data element has to be surrounded by an opening and closing tag describing the data. Converting the XML data to/from JavaScript object requires special parsers, and you&#8217;d need to use one of the JavaScript libraries for cross-browser compatibility.</p></div>
<div class="paragraph"><p>In today&#8217;s Web, JSON became the most popular data format. It&#8217;s not as verbose as XML, and JSON&#8217;s notation is almost the same as JavaScript object literals. It&#8217;s easily readable by humans, and every ECMAScript 5 compliant browser includes a native JSON object: <span class="monospaced">window.JSON</span>. Even though the JSON formatted data look like JavaScript object literals, JSON is language independent. Here&#8217;s an example of the data in the JSON format:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
 <span style="color: #FF0000">"fname"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Alex"</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">"lname"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Smith"</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span><span style="color: #993399">30</span><span style="color: #990000">,</span>
 <span style="color: #FF0000">"address"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
     <span style="color: #FF0000">"street"</span><span style="color: #990000">:</span><span style="color: #FF0000">"123 Main St."</span><span style="color: #990000">,</span>
     <span style="color: #FF0000">"city"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"New York"</span><span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Anyone who knows JavaScript understands that this is an object that represents a person, which has a nested object that represents an address. Note the difference with JavaScript literals: the names of the properties are always strings, and every string must be taken into quotes. Representing the same object in XML would need a lot more characters (e.g. <span class="monospaced">&lt;fname&gt;Alex&lt;/fname&gt;</span> etc).</p></div>
<div class="paragraph"><p>There are some other important differences between JSON and XML. The structure of the XML document can be defined using DTD or XML Schema, which simplifies the data validation, but requires additional programming and schema maintenance. On the other hand, JSON data have data types, for example the age attribute in the above example is not only a <span class="monospaced">Number</span>, but will be further evaluated by the JavaScript engine and will be stored as an integer. JSON also supports arrays while XML doesn&#8217;t.</p></div>
<div class="paragraph"><p>For parsing JSON in JavaScript you use the method <span class="monospaced">JSON.parse()</span>, which takes a string and returns JavaScript object, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customer<span style="color: #990000">=</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'{"fname":"Alex","lname":"Smith"}'</span><span style="color: #990000">);</span>

console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>“Your name is ” <span style="color: #990000">+</span> customer<span style="color: #990000">.</span>fname <span style="color: #990000">+</span> “ “ <span style="color: #990000">+</span> customer<span style="color: #990000">.</span>lname<span style="color: #990000">);</span>
</tt></pre></div></div>
<div class="paragraph"><p>For a reverse operation - turning an object into JSON string - do <span class="monospaced">JSON.stringify(custormer)</span>. The older browsers didn&#8217;t have the <span class="monospaced">JSON</span> object, and there is an alternative way of parsing JSON is with the help of the script json2.js, which creates the JSON property on the global object. The json2.js is freely available on <a href="http://bit.ly/aUMLnL">Github</a>. In Chapter 3 you&#8217;ve learned about feature detection with Modernizr, and you can automate the loading of this script if needed.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>Modernizr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
    test<span style="color: #990000">:</span> window<span style="color: #990000">.</span>JSON<span style="color: #990000">,</span>
    nope<span style="color: #990000">:</span> <span style="color: #FF0000">'json2.js'</span><span style="color: #990000">,</span>
    complete<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customer <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'{"fname":"Alex","lname":"Smith"}'</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Usually, JSON-related articles and blogs are quick to remind you about the evil nature of the JavaScript function <span class="monospaced">eval()</span> that can take an arbitrary JavaScript code and execute it. The <span class="monospaced">JSON.parse()</span> is pictured as a protection against the malicious JavaScript that can be injected into your application&#8217;s code and then executed by <span class="monospaced">eval()</span> by the Web browser. The main argument is that <span class="monospaced">JSON.parse()</span> will not be processing the incoming code unless it contains valid JSON data.</p></div>
<div class="paragraph"><p>Protecting your application code from being infected by means of <span class="monospaced">eval()</span> can be done outside of your application code. Replacing HTTP with secure HTTPS protocol helps a lot in this regard. Some Web applications  eliminate the possibility of cross-origin scripting by routing all requests to third-party data sources via proxying such requests through your trusted servers. But proxying all requests through your server may present scalability issues - imagine if thousands of concurrent users will be routed through your server - so do some serious load testing before making this architectural decision.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">There are several JSON tools useful for developers. To make sure that your JSON data is valid and properly formatted use using <a href="http://jsonlint.com/">JSONLint</a>. If you paste an ugly one-line JSON data JSLint will reformat it into a readable form. There is also an add-on JSONView, available both for <a href="https://addons.mozilla.org/en-US/firefox/addon/jsonview/">Firefox</a> and for <a href="https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc">Chrome</a> browsers.  With JSONView the JSON objects are displayed in a pretty formatted collapsible format. If there are errors in the JSON document they will be reported. At the time of this writing Chrome&#8217;s version of JSONView does a better job in  reporting errors.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_populating_states_and_countries_from_json_files">Populating States and Countries from JSON Files</h4>
<div class="paragraph"><p>Earlier in this chapter you&#8217;ve seen an example of populating states and countries in the donate form from HTML files. Now you&#8217;ll see how to retrieve the JSON data by making an AJAX call. Running Aptana&#8217;s project project-04-2-donation-ajax-json reads the countries and states from the files countries.json and us_states.json respectively. The beginning of the file countries.json is shown below:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
<span style="color: #FF0000">"countrieslist"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Afghanistan"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"code"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AF"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Åland Islands"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"code"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AX"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Albania"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"code"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AL"</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span></tt></pre></div></div>
<div class="paragraph"><p>The JavaScript code that populates the countries and states comboboxes comes next. Note the difference in creating the <span class="monospaced">&lt;option&gt;</span> tags from JSON vs. HTML.  In case of HTML, the received data were added to the <span class="monospaced">&lt;select&gt;</span> element as is: <span class="monospaced">target.innerHTML += xhr.responseText;</span> In JSON files the data were not wrapped in to the <span class="monospaced">&lt;option&gt;</span> tags,  hence it&#8217;s done programmatically.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">,</span> rootElement<span style="color: #990000">,</span> target<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> xhr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">overrideMimeType</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"application/json"</span><span style="color: #990000">);</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'GET'</span><span style="color: #990000">,</span> dataUrl<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>

  xhr<span style="color: #990000">.</span>onreadystatechange <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>status <span style="color: #990000">==</span> <span style="color: #993399">200</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        <span style="font-style: italic"><span style="color: #9A1900">//parse jsoon data</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> jsonData <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>responseText<span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> optionsHTML <span style="color: #990000">=</span> <span style="color: #FF0000">''</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i<span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> jsonData<span style="color: #990000">[</span>rootElement<span style="color: #990000">].</span>length<span style="color: #990000">;</span> i<span style="color: #990000">++)</span><span style="color: #FF0000">{</span>
          optionsHTML<span style="color: #990000">+=</span><span style="color: #FF0000">'&lt;option value="'</span><span style="color: #990000">+</span>jsonData<span style="color: #990000">[</span>rootElement<span style="color: #990000">][</span>i<span style="color: #990000">].</span>code<span style="color: #990000">+</span><span style="color: #FF0000">'"&gt;'</span>
                     <span style="color: #990000">+</span> jsonData<span style="color: #990000">[</span>rootElement<span style="color: #990000">][</span>i<span style="color: #990000">].</span>name<span style="color: #990000">+</span><span style="color: #FF0000">'&lt;/option&gt;'</span>
        <span style="color: #FF0000">}</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> targetCurrentHtml <span style="color: #990000">=</span> target<span style="color: #990000">.</span>innerHTML<span style="color: #990000">;</span>
        target<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> targetCurrentHtml <span style="color: #990000">+</span> optionsHTML<span style="color: #990000">;</span>

      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>statusText<span style="color: #990000">);</span>

        <span style="font-style: italic"><span style="color: #9A1900">// Show the error on the Web page</span></span>
        tempContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">+=</span> <span style="color: #FF0000">'&lt;p class="error"&gt;Error getting '</span> <span style="color: #990000">+</span>
          target<span style="color: #990000">.</span>name <span style="color: #990000">+</span> <span style="color: #FF0000">": "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>statusText <span style="color: #990000">+</span> <span style="color: #FF0000">",code: "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">+</span> <span style="color: #FF0000">"&lt;/p&gt;"</span><span style="color: #990000">;</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/us-states.json'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'usstateslist'</span><span style="color: #990000">,</span> statesList<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/countries.json'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'countrieslist'</span><span style="color: #990000">,</span> counriesList<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_arrays_in_json">Arrays in JSON</h4>
<div class="paragraph"><p>JSON supports arrays, and the next example shows you how the information about a customer can be presented in JSON format. A customer can have more than one phone, which are stored in an array.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">&lt;</span>script <span style="color: #990000">&gt;</span>
   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customerJson <span style="color: #990000">=</span> <span style="color: #FF0000">'{"fname":"Alex",</span>
<span style="color: #FF0000">                        "lname":"Smith",</span>
<span style="color: #FF0000">                        "phones":[</span>
<span style="color: #FF0000">                            "212-555-1212",</span>
<span style="color: #FF0000">                            "565-493-0909"</span>
<span style="color: #FF0000">                        ]</span>
<span style="color: #FF0000">                       }'</span><span style="color: #990000">;</span>

   <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customer<span style="color: #990000">=</span>JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>customerJson<span style="color: #990000">);</span>

   console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Parsed customer data: fname="</span> <span style="color: #990000">+</span> customer<span style="color: #990000">.</span>fname <span style="color: #990000">+</span>
                      <span style="color: #FF0000">" lname="</span> <span style="color: #990000">+</span> customer<span style="color: #990000">.</span>lname <span style="color: #990000">+</span>
                      <span style="color: #FF0000">" home phone="</span> <span style="color: #990000">+</span> customer<span style="color: #990000">.</span>phones<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">+</span>
                      <span style="color: #FF0000">" cell phone="</span> <span style="color: #990000">+</span> customer<span style="color: #990000">.</span>phones<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]);</span>
<span style="color: #990000">&lt;/</span>script<span style="color: #990000">&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>The code above creates an instance of the JavaScript object referenced by the variable <span class="monospaced">customer</span>. In this example the <span class="monospaced">phones</span> array just holds two strings. But you can store object in JSON array the same way as you&#8217;d do it in JavaScript object literal - just don&#8217;t forget to put every property name in quotes.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customerJson <span style="color: #990000">=</span> <span style="color: #FF0000">'{"fname":"Alex",</span>
<span style="color: #FF0000">                     "lname":"Smith",</span>
<span style="color: #FF0000">                   "phones":[</span>
<span style="color: #FF0000">                        {"type":"home", "number":"212-555-1212"},</span>
<span style="color: #FF0000">                         {"type":"work","number":"565-493-0909"}]</span>
<span style="color: #FF0000">                    }'</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_loading_charity_events_using_ajax_and_json">Loading Charity Events using AJAX and JSON</h4>
<div class="paragraph"><p>The last example in Chapter 3 was about displaying various charity events on the Google map using multiple markers. But the data about these events were hard-coded in HTML file. After getting familiar with AJAX and JSON it should not be too difficult to create a separate file with the information about charities in JSON format and load them using <span class="monospaced">XMLHTTPRequest</span> object.</p></div>
<div class="paragraph"><p>The next version of Save Sick Child is a modified version of the application that displayed Google map with multiple markers from Chapter 3. But this time we&#8217;ll load the information about the charity events from the file campaigndata.json shown next.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"campaigns"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"header"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Nationwide Charity Events"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"timestamp"</span><span style="color: #990000">:</span><span style="color: #FF0000">"12/15/2012"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"items"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Lawyers for Children"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Lawyers offering free services for sick children"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"New York,NY"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Mothers of Asthmatics"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Mothers of Asthmatics - nationwide Asthma network"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Dallas,TX"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Friends of Blind Kids"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Semi-annual charity events for blind kids"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Miami,FL"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"A Place Called Home"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Adoption of sick children"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Miami,FL"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"title"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Marathon for Survivors"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Annual marathon for cancer survivors"</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Fargo, ND"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Run the Aptana&#8217;s project-11-maps-json-data and you&#8217;ll see the map with the markers for each of the events loaded from the file campaigndata.json (see <a href="#FIG4-03">[FIG4-03]</a>). Click on the marker to see an overlay with the event details.</p></div>
<div class="imageblock" id="FIG4-03">
<div class="content">
<img src="images/fig_04_03.png" alt="images/fig_04_03.png">
</div>
<div class="title">Figure 46. Markers built from JSON data</div>
</div>
<div class="paragraph"><p>Note that this JSON file contains the object <span class="monospaced">campaigns</span>, which includes the array of objects <span class="monospaced">items</span> representing charity events. <span class="monospaced">XMLHttpRequest</span> object loads the data and the <span class="monospaced">JSON</span> parses it assigning the <span class="monospaced">campaigns</span> object to the variable <span class="monospaced">campaignsData</span> that is used in showCampaignsInfo() with Google Maps API (we&#8217;ve omitted the mapping part for brevity).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showCampaignsInfo</span></span><span style="color: #990000">(</span>campaigns<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>

        campaignsCount <span style="color: #990000">=</span> campaigns<span style="color: #990000">.</span>items<span style="color: #990000">.</span>length<span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> message <span style="color: #990000">=</span> <span style="color: #FF0000">"&lt;h3&gt;"</span> <span style="color: #990000">+</span> campaigns<span style="color: #990000">.</span>header <span style="color: #990000">+</span> <span style="color: #FF0000">"&lt;/h3&gt;"</span> <span style="color: #990000">+</span>
                              <span style="color: #FF0000">"On "</span> <span style="color: #990000">+</span> campaigns<span style="color: #990000">.</span>timestamp <span style="color: #990000">+</span>
                        <span style="color: #FF0000">" we run "</span> <span style="color: #990000">+</span> campaignsCount <span style="color: #990000">+</span> <span style="color: #FF0000">" campaigns."</span><span style="color: #990000">;</span>

    locationUI<span style="color: #990000">.</span>innerHTML <span style="color: #990000">=</span> message <span style="color: #990000">+</span> locationUI<span style="color: #990000">.</span>innerHTML<span style="color: #990000">;</span>
        resizeMapLink<span style="color: #990000">.</span>style<span style="color: #990000">.</span>visibility <span style="color: #990000">=</span> <span style="color: #FF0000">"visible"</span><span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #000000">createCampaignsMap</span></span><span style="color: #990000">(</span>campaigns<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
 <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> xhr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>
 xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'GET'</span><span style="color: #990000">,</span> dataUrl<span style="color: #990000">);</span>

 xhr<span style="color: #990000">.</span>onreadystatechange <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>xhr<span style="color: #990000">.</span>status <span style="color: #990000">&gt;=</span> <span style="color: #993399">200</span> <span style="color: #990000">&amp;&amp;</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">&lt;</span> <span style="color: #993399">300</span><span style="color: #990000">)</span> <span style="color: #990000">||</span>
                                    xhr<span style="color: #990000">.</span>status <span style="color: #990000">===</span> <span style="color: #993399">304</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> jsonData <span style="color: #990000">=</span> xhr<span style="color: #990000">.</span>responseText<span style="color: #990000">;</span>

                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> campaignsData <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>jsonData<span style="color: #990000">).</span>campaigns<span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #000000">showCampaignsInfo</span></span><span style="color: #990000">(</span>campaignsData<span style="color: #990000">);</span>
         <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>statusText<span style="color: #990000">);</span>

           tempContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">+=</span> <span style="color: #FF0000">'&lt;p class="error"&gt;Error getting '</span> <span style="color: #990000">+</span>
                 target<span style="color: #990000">.</span>name <span style="color: #990000">+</span> <span style="color: #FF0000">": "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>statusText <span style="color: #990000">+</span>
                 <span style="color: #FF0000">",code: "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">+</span> <span style="color: #FF0000">"&lt;/p&gt;"</span><span style="color: #990000">;</span>
         <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
 <span style="color: #FF0000">}</span>
 xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> dataUrl <span style="color: #990000">=</span> <span style="color: #FF0000">'data/campaignsdata.json'</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">);</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Some older Web browsers may bring up a File Download popup window when the content type of the server&#8217;s response is set to "application/json". Try to use the MIME type "text/html" instead, if you ran into this issue.</td>
</tr></table>
</div>
<div class="paragraph"><p>Large-scale Web applications could be integrated with some content management systems (CMS), which can be supplying content such as charity events, sales promotions, et al.  CMS servers can be introduced into the architecture of a Web application to separate the work on preparing the content from the application delivering it as shown in <a href="#FIG4-4">[FIG4-4]</a> depicting a diagram of a with a Web application integrated with the CMS server.</p></div>
<div class="imageblock" id="FIG4-4">
<div class="content">
<img src="images/fig_04_04.png" alt="images/fig_04_04.png">
</div>
<div class="title">Figure 47. CMS in the picture</div>
</div>
<div class="paragraph"><p>The content contributors and editors prepare the information on the charities and donation campaigns using a separate application, not the Save Sick Child page. The CMS server and the Web application server www.savesickchild.org may be located in the same or separate data centers. The server-side code of the Save Sick Child is making a call to a CMS server whenever the site visitor is requesting the information about charity events. If you get to pick a CMS for your future Web application make sure it offers data feed in JSON format.</p></div>
<div class="paragraph"><p>Some time ago one of the authors of this book was helping Mercedes Benz USA in development of their consumer facing Web application where people could search, review and configure their next car. <a href="#FIG4-5">[FIG4-5]</a> shows a snapshot taken from the mbusa.com. Three rectangular areas at the bottom were created by the Web designers to display today&#8217;s deals and promotions. The up-to-date content for these areas was retrieved from a CMS server when the user visited mbusa.com.</p></div>
<div class="imageblock" id="FIG4-5">
<div class="content">
<img src="images/fig_04_05.png" alt="images/fig_04_05.png">
</div>
<div class="title">Figure 48. Current Mercedes deals from CMS</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_json_in_java">JSON in Java</h3>
<div class="paragraph"><p>If a Web browser receives JSON stream from the server the application needs to turn it into JavaScript objects. If a Web client needs to send the JavaScriot objects to the server they can be converted into JSON string. Similar tasks have to be performed on the server side. Our Save Sick Child application uses Java application server. There is a number of third-party Java libraries that can consume and generate JSON content.</p></div>
<div class="paragraph"><p>There are several Java libraries to convert Java objects into their JSON representation and back, for example <a href="http://code.google.com/p/google-gson/">Google’s Gson</a>, <a href="http://jackson.codehaus.org/">Jackson</a>, <a href="http://code.google.com/p/json-simple/">json-simple</a>.</p></div>
<div class="paragraph"><p>Google&#8217;s Gson is probably the simplest one for use. It provides methods <span class="monospaced">toJson()</span> and <span class="monospaced">fromJson()</span> to convert Java objects to JSON and back. Gson allows pre-existing un-modifiable objects to be converted to and from JSON and Supports Java Generics. Gson works well with complex objects with deep inheritance hierarchies.</p></div>
<div class="paragraph"><p>Let&#8217;s say JavaScript sends to Java the following JSON string:</p></div>
<div class="paragraph"><p><span class="monospaced">{"fname": "Alex", "lname":"Smith","skillLevel": 11}</span></p></div>
<div class="paragraph"><p>The Java code can turn it into an instance of the Customer object by calling the method <span class="monospaced">Gson.fromJson()</span>. Similarly, Java code can create a JSON string from an object instance. Both of these operations are illustrated below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">public</span></span> Customer <span style="font-weight: bold"><span style="color: #000000">createCustomerFromJson</span></span><span style="color: #990000">(</span>String jsonString<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

    Gson myGson <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Gson</span></span><span style="color: #990000">();</span>
    Customer cust <span style="color: #990000">=</span> myGson<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fromJson</span></span><span style="color: #990000">(</span>jsonString<span style="color: #990000">,</span> Customer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">);</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> cust<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">public</span></span> String <span style="font-weight: bold"><span style="color: #000000">createJsonFromCustomer</span></span><span style="color: #990000">(</span>Customer cust<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

        Gson gson <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">Gson</span></span><span style="color: #990000">();</span>

        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> gson<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toJson</span></span><span style="color: #990000">(</span>cust<span style="color: #990000">,</span> Customer<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #0000FF">class</span></span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Of course, the declaration of the Java class <span class="monospaced">Customer</span> must exist in the in the classpath and don&#8217;t forget to include gson.jar to your Java project.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">JSON data format is often used in non-JavaScript applications. For example, a Java server can exchange the JSON-formatted data with a .Net server.</td>
</tr></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">The upcoming Java EE 7 specification includes JSR 353, which defines a standardized way for parsing and generating JSON. JSR 353 defines the Java API from JSON Processing (JSON-P) that shouldn&#8217;t be confused with another acronym <a href="http://json-p.org/">JSONP or JSON-P</a>, which is JSON with Padding (we&#8217;ll discuss it at the end of this chapter).</td>
</tr></table>
</div>
</div></div>
</div>
<div class="sect2">
<h3 id="_compressing_json">Compressing JSON</h3>
<div class="paragraph"><p>JSON format is more compact than XML and is readable by the human beings. But when you are ready to deploy your application in production, you still want to compress the data so less bytes will travel over the wire to the user&#8217;s browser. The server-side libraries that generate JSON will make the data sent to the client compact by removing the tab and the new line characters.</p></div>
<div class="paragraph"><p>If you want to turn the pretty-print JSON into a more compact one-line format just use such Web sites as <a href="http://javascriptcompressor.com/">JavaScript Compressor</a> or <a href="http://www.freeformatter.com/json-formatter.html/">JSON Formatter</a>. For example, after running the 12Kb file countries.json through this compressor, its size was decreased to 9Kb. JSONLint can also compress JSON if you provide this URL: <a href="http://jsonlint.com?reformat=compress">http://jsonlint.com?reformat=compress</a>.</p></div>
<div class="paragraph"><p>Similarly to most of the content that is being sent to browsers by the Web servers, the JSON data should be compressed. <a href="http://en.wikipedia.org/wiki/Gzip">GZip</a> and <a href="http://en.wikipedia.org/wiki/DEFLATE">Deflate</a> are the two main compression methods used in today&#8217;s Web. Both use the same compression algorithm <em>deflate</em>, but while with Deflate the compressed data are being streamed to the client, the GZip first compresses the entire file, calculates the size and adds some additional headers to the compressed data. So GZip may need some extra time and memory, but you are more protected from getting incomplete JSON, JavaScript or other content. Both Gzip and Deflate are easily configurable by major Web servers, but it&#8217;s hard to say which one is better for your application - set up some tests with each of them and decide which one works faster or take less system resources, but don&#8217;t compromise on reliability of the compressed content.</p></div>
<div class="paragraph"><p>We prefer using GZip, which stands for GNU zip compression. On the server side you&#8217;d need to configure the gzip filters on your Web server. You need to refer to your Web server&#8217;s documentation to find out how to configure gzipping, which is done by the MIME type. For example, you can request to gzip everything except images (you might want to do this if you&#8217;re not sure if all browsers can properly uncompress certain MIME types).</p></div>
<div class="paragraph"><p>For example, applying the GZip filter to the 9Kb countries.json will reduce its size to 3Kb, which means serious bandwidth savings especially in the Web applications with lots of concurrent users. This is even more important for the mobile Web clients, which may be operating in the areas with slower connections. The Web clients can set the HTTP request attribute <span class="monospaced">Accept-Encoding: gzip</span> inviting the server to return gzipped content, and the Web server may compress the response if it does support it or unzipped content otherwise. If the server supports gzip, the HTTP response will have the attribute <span class="monospaced">Content-Encoding: gzip</span>, and the browser will know to unzip the response data before use.</p></div>
<div class="paragraph"><p>Gzip is being used for compressing all types of content: HTML, CSS, JavaScript and more. If your server sends JSON content to the client setting the content type to <span class="monospaced">application/json</span> don&#8217;t forget to include this MIME type in your server configuration for Gzip.</p></div>
<div class="paragraph"><p>Web browsers support the gzipping too, and your application can set <span class="monospaced">Content-Ecoding: gzip</span> in HTTP request while sending the data from the Web client to the server. But Web clients usually don&#8217;t send massive amounts of data to the server so the benefits of the compression on the client side may not be as big.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_charts_to_save_sick_child">Adding Charts to Save Sick Child</h3>
<div class="paragraph"><p>Let&#8217;s consider yet another use case for JSON in Save Sick Child. We want to display charts with statistics about the donations.  By now, our application look not exactly as the original mockup from <a href="#FIG3-2">[FIG3-2]</a>, but it&#8217;s pretty close. There is an empty space in the left to the maps, and the charts showing donation statistics can fit right in. Now we need to decide how to draw the charts using nothing, but HTML5 elements. Note that we are not talking about displaying static images using the <span class="monospaced">&lt;img&gt;</span> element - the goal is to draw the images dynamically in the client&#8217;s code. You can accomplish this goal using HTML5 elements <span class="monospaced">&lt;canvas&gt;</span> or <span class="monospaced">&lt;svg&gt;</span>.</p></div>
<div class="paragraph"><p>The <a href="http://www.w3.org/wiki/HTML/Elements/canvas"><span class="monospaced">&lt;canvas&gt;</span></a> element provides a bitmap canvas, where your  scripts which can draw graphs, game graphics, or other visual images on the fly without using any plugins like Flash Player or Silverlight. To put it simple, the <span class="monospaced">&lt;canvas&gt;</span> defines a rectangular area that consists of pixels, where your code can draw. Keep in mind that the DOM object can&#8217;t peek inside the canvas and access specific pixels. So if you are planning to create an area with dynamically changed graphics you might want to consider using <span class="monospaced">&lt;svg&gt;</span>.</p></div>
<div class="paragraph"><p>The <a href="http://www.w3.org/TR/SVG11/"><span class="monospaced">&lt;svg&gt;</span> element</a> supports Scalable Vector Graphics (SVG), which is the XML-based language for describing two-dimensional graphics. Your code has to provide commands to draw the lines, text, images et al.</p></div>
<div class="paragraph"><p>Let&#8217;s review some code fragments from the Aptana&#8217;s project-12-canvas-pie-chart-json. The HTML section defines <span class="monospaced">&lt;canvas&gt;</span> of 260x240 pixels. If the user&#8217;s browser doesn&#8217;t support <span class="monospaced">&lt;canvas&gt;</span>, the user won&#8217;t see the chart, but will see the text "Your browser does not support HTML5 Canvas" instead. You need to give an ID to your canvas element so your JavaScript code can access it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"charts-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;canvas</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"canvas"</span> <span style="color: #009900">width</span><span style="color: #990000">=</span><span style="color: #FF0000">"260"</span> <span style="color: #009900">height</span><span style="color: #990000">=</span><span style="color: #FF0000">"240"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        Your browser does not support HTML5 Canvas
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/canvas&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Donation Stats<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span> Lorem ipsum dolor sit amet, consectetur<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Run the project-12-canvas-pie-chart-json, and you&#8217;ll see the chart with donation statistics by city as in <a href="#FIG4-6">[FIG4-6]</a>. We haven&#8217;t style our <span class="monospaced">&lt;canvas&gt;</span> element, but we could&#8217;ve added a background color, the border and other bells and whistles if required.</p></div>
<div class="imageblock" id="FIG4-6">
<div class="content">
<img src="images/fig_04_06.png" alt="images/fig_04_06.png">
</div>
<div class="title">Figure 49. Adding a chart</div>
</div>
<div class="paragraph"><p>The data to be used for drawing a pie chart in our canvas are stored in the file data/chartdata.json, but in a real-world the server side code can generate it based on the up-to-the-second donation data and send it to the client. For example, you could do it as was explained in the section Json in Java above. This is the content of our file chartdata.json:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
  <span style="color: #FF0000">"ChartData"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"items"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">48</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Chicago, IL"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">60</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"New York, NY"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">90</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Dallas, TX"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">22</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Miami, FL"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">14</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Fargo, ND"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">44</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Long Beach, NY"</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
      <span style="color: #FF0000">{</span>
        <span style="color: #FF0000">"donors"</span><span style="color: #990000">:</span> <span style="color: #993399">24</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">"location"</span><span style="color: #990000">:</span><span style="color: #FF0000">"Lynbrook, NY"</span>
      <span style="color: #FF0000">}</span>
    <span style="color: #990000">]</span>
  <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Loading of the the charddata.json is done using AJAX techniques as explained earlier. Although in our example we&#8217;re loading the chart immediately when the Save Sick Chile loads, the following code could be invoked only when the user requests to see the charts by clicking on some menu item on the page.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">,</span> canvas<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> xhr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">XMLHttpRequest</span></span><span style="color: #990000">();</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'GET'</span><span style="color: #990000">,</span> dataUrl<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>

  xhr<span style="color: #990000">.</span>onreadystatechange <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">((</span>xhr<span style="color: #990000">.</span>status <span style="color: #990000">&gt;=</span> <span style="color: #993399">200</span> <span style="color: #990000">&amp;&amp;</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">&lt;</span> <span style="color: #993399">300</span><span style="color: #990000">)</span> <span style="color: #990000">||</span>
                                      xhr<span style="color: #990000">.</span>status <span style="color: #990000">===</span> <span style="color: #993399">304</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> jsonData <span style="color: #990000">=</span> xhr<span style="color: #990000">.</span>responseText<span style="color: #990000">;</span>

                        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> chartData <span style="color: #990000">=</span> JSON<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parse</span></span><span style="color: #990000">(</span>jsonData<span style="color: #990000">).</span>ChartData<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

                        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> data <span style="color: #990000">=</span> <span style="color: #990000">[];</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> labels <span style="color: #990000">=</span> <span style="color: #990000">[];</span>

                        <span style="font-weight: bold"><span style="color: #000000">drawPieChart</span></span><span style="color: #990000">(</span>canvas<span style="color: #990000">,</span> chartData<span style="color: #990000">,</span> <span style="color: #993399">50</span><span style="color: #990000">,</span> <span style="color: #993399">50</span><span style="color: #990000">,</span> <span style="color: #993399">49</span><span style="color: #990000">);</span>       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

                <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
                        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>xhr<span style="color: #990000">.</span>statusText<span style="color: #990000">);</span>
                        tempContainer<span style="color: #990000">.</span>innerHTML <span style="color: #990000">+=</span> <span style="color: #FF0000">'&lt;p class="error"&gt;Error getting '</span> <span style="color: #990000">+</span>
                               target<span style="color: #990000">.</span>name <span style="color: #990000">+</span> <span style="color: #FF0000">": "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>statusText <span style="color: #990000">+</span>
                               <span style="color: #FF0000">",code: "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">+</span> <span style="color: #FF0000">"&lt;/p&gt;"</span><span style="color: #990000">;</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  xhr<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/chartdata.json'</span><span style="color: #990000">,</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"canvas"</span><span style="color: #990000">));</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Parse JSON and create the ChartData Javascript object.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Pass the data to the <span class="monospaced">drawPieChart()</span> function that will draw the pie in the <span class="monospaced">canvas</span> element with the center coordinates x=50 and y=50 pixels. The top left corner of the canvas has coordinates (0,0). The radius of the pie will be 49 pixels. The code of the function that draws the pie on the canvas goes next.
</td></tr>
</table></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">drawPieChart</span></span> <span style="color: #990000">(</span>canvas<span style="color: #990000">,</span> chartData<span style="color: #990000">,</span> centerX<span style="color: #990000">,</span> centerY<span style="color: #990000">,</span> pieRadius<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ctx<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// The context of canvas</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> previousStop <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// The end position of the slice</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> totalDonors <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> totalCities <span style="color: #990000">=</span> chartData<span style="color: #990000">.</span>items<span style="color: #990000">.</span>length<span style="color: #990000">;</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Count total donors</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> totalCities<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
                        totalDonors <span style="color: #990000">+=</span> chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
        <span style="color: #FF0000">}</span>

        ctx <span style="color: #990000">=</span> canvas<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getContext</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"2d"</span><span style="color: #990000">);</span>                        <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
        ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">clearRect</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> canvas<span style="color: #990000">.</span>width<span style="color: #990000">,</span> canvas<span style="color: #990000">.</span>heigh<span style="color: #990000">);</span>

    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> colorScheme <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"#2F69BF"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#A2BF2F"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#BF5A2F"</span><span style="color: #990000">,</span>   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
            <span style="color: #FF0000">"#BFA22F"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#772FBF"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#2F94BF"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#c3d4db"</span><span style="color: #990000">];</span>

        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> totalCities<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>               <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>

                <span style="font-style: italic"><span style="color: #9A1900">//draw the sector</span></span>
                ctx<span style="color: #990000">.</span>fillStyle <span style="color: #990000">=</span> colorScheme<span style="color: #990000">[</span>i<span style="color: #990000">];</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">beginPath</span></span><span style="color: #990000">();</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">moveTo</span></span><span style="color: #990000">(</span>centerX<span style="color: #990000">,</span> centerY<span style="color: #990000">);</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">arc</span></span><span style="color: #990000">(</span>centerX<span style="color: #990000">,</span> centerY<span style="color: #990000">,</span> pieRadius<span style="color: #990000">,</span> previousStop<span style="color: #990000">,</span> previousStop <span style="color: #990000">+</span>
                        <span style="color: #990000">(</span>Math<span style="color: #990000">.</span>PI <span style="color: #990000">*</span> <span style="color: #993399">2</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span>chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors<span style="color: #990000">/</span>totalDonors<span style="color: #990000">)),</span><span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">lineTo</span></span><span style="color: #990000">(</span>centerX<span style="color: #990000">,</span> centerY<span style="color: #990000">);</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fill</span></span><span style="color: #990000">();</span>

                <span style="font-style: italic"><span style="color: #9A1900">// label's bullet</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> labelY <span style="color: #990000">=</span> <span style="color: #993399">20</span> <span style="color: #990000">*</span> i <span style="color: #990000">+</span> <span style="color: #993399">10</span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> labelX <span style="color: #990000">=</span> pieRadius<span style="color: #990000">*</span><span style="color: #993399">2</span> <span style="color: #990000">+</span> <span style="color: #993399">20</span><span style="color: #990000">;</span>

                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">rect</span></span><span style="color: #990000">(</span>labelX<span style="color: #990000">,</span> labelY<span style="color: #990000">,</span> <span style="color: #993399">10</span><span style="color: #990000">,</span> <span style="color: #993399">10</span><span style="color: #990000">);</span>
                ctx<span style="color: #990000">.</span>fillStyle <span style="color: #990000">=</span> colorScheme<span style="color: #990000">[</span>i<span style="color: #990000">];</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fill</span></span><span style="color: #990000">();</span>

                <span style="font-style: italic"><span style="color: #9A1900">// label's text</span></span>
                ctx<span style="color: #990000">.</span>font <span style="color: #990000">=</span> <span style="color: #FF0000">"italic 12px sans-serif"</span><span style="color: #990000">;</span>
                ctx<span style="color: #990000">.</span>fillStyle <span style="color: #990000">=</span> <span style="color: #FF0000">"#222"</span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> txt <span style="color: #990000">=</span> chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>location <span style="color: #990000">+</span> <span style="color: #FF0000">" | "</span> <span style="color: #990000">+</span>
                                              chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors<span style="color: #990000">;</span>
                ctx<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fillText</span></span> <span style="color: #990000">(</span>txt<span style="color: #990000">,</span> labelX <span style="color: #990000">+</span> <span style="color: #993399">18</span><span style="color: #990000">,</span> labelY <span style="color: #990000">+</span> <span style="color: #993399">8</span><span style="color: #990000">);</span>

                previousStop <span style="color: #990000">+=</span> Math<span style="color: #990000">.</span>PI <span style="color: #990000">*</span> <span style="color: #993399">2</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span>chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors<span style="color: #990000">/</span>totalDonors<span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Count the total number of donors.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Get the 2D context of the <span class="monospaced">&lt;canvas&gt;</span> element. This is the most crucial element to know for drawing on a canvas.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The color scheme is just a set of colors to be used for painting each slice (sector) of the pie.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
The for-loop paints one sector on each iteration. This code draws lines, arcs, rectangles, and adds text to the canvas. Describing the details of each method of the context object is out of scope of this book, but you can find the details of the context API in the <a href="http://www.w3.org/TR/2dcontext/">W3C documentation</a> available online.
</td></tr>
</table></div>
<div class="paragraph"><p>What if we want to make this chart dynamic and reflect the changes in donations every 5 minutes? If you&#8217;re using <span class="monospaced">&lt;canvas&gt;</span>, you&#8217;ll need to redraw each and every pixel of our canvas with the pie.     With SVG, each element of the drawing would be the DOM element so we could have redraw only those elements that have changed. If with canvas your script draws using pixels, the SVG drawings are done with vectors.</p></div>
<div class="paragraph"><p>To implement the same donation statistics pie with the <span class="monospaced">&lt;svg&gt;</span> element, you&#8217;d need to replace the <span class="monospaced">&lt;canvas&gt;</span> element with the following markup:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"charts-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;svg</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"svg-container"</span> <span style="color: #009900">xmlns</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.w3.org/2000/svg"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/svg&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Donation Stats<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>
                Lorem ipsum dolor sit amet, consectetur
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Running the Aptana&#8217;s project-13-svg-pie-chart-json would show you pretty much the same pie as it uses the file chartdata.json with the same content, but the pie was produced differently. The code of the new version of the <span class="monospaced">drawPieChart()</span> is shown below. We won&#8217;t discuss all the details of the drawing with SVG, but will highlight the a couple of important lines of code that illustrate the difference between drawing on <span class="monospaced">&lt;canvas&gt;</span> vs. <span class="monospaced">&lt;svg&gt;</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">drawPieChart</span></span><span style="color: #990000">(</span>chartContaner<span style="color: #990000">,</span> chartData<span style="color: #990000">,</span> centerX<span style="color: #990000">,</span> centerY<span style="color: #990000">,</span>
                          pieRadius<span style="color: #990000">,</span> chartLegendX<span style="color: #990000">,</span> chartLegendY<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// the XML namespace for svg elements</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> namespace <span style="color: #990000">=</span> <span style="color: #FF0000">"http://www.w3.org/2000/svg"</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> colorScheme <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"#2F69BF"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#A2BF2F"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#BF5A2F"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#BFA22F"</span><span style="color: #990000">,</span>
                      <span style="color: #FF0000">"#772FBF"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#2F94BF"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"#c3d4db"</span><span style="color: #990000">];</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> totalCities <span style="color: #990000">=</span> chartData<span style="color: #990000">.</span>items<span style="color: #990000">.</span>length<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> totalDonors <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>

     <span style="font-style: italic"><span style="color: #9A1900">// Count total donors</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> totalCities<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
                totalDonors <span style="color: #990000">+=</span> chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors<span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>

        <span style="font-style: italic"><span style="color: #9A1900">// Draw pie sectors</span></span>
        startAngle <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> totalCities<span style="color: #990000">;</span> i<span style="color: #990000">++)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">// End of the sector = starting angle + sector size</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> endAngle <span style="color: #990000">=</span> startAngle <span style="color: #990000">+</span> chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors <span style="color: #990000">/</span> totalDonors <span style="color: #990000">*</span> Math<span style="color: #990000">.</span>PI <span style="color: #990000">*</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> x1 <span style="color: #990000">=</span> centerX <span style="color: #990000">+</span> pieRadius <span style="color: #990000">*</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sin</span></span><span style="color: #990000">(</span>startAngle<span style="color: #990000">);</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> y1 <span style="color: #990000">=</span> centerY <span style="color: #990000">-</span> pieRadius <span style="color: #990000">*</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">cos</span></span><span style="color: #990000">(</span>startAngle<span style="color: #990000">);</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> x2 <span style="color: #990000">=</span> centerX <span style="color: #990000">+</span> pieRadius <span style="color: #990000">*</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sin</span></span><span style="color: #990000">(</span>endAngle<span style="color: #990000">);</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> y2 <span style="color: #990000">=</span> centerY <span style="color: #990000">-</span> pieRadius <span style="color: #990000">*</span> Math<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">cos</span></span><span style="color: #990000">(</span>endAngle<span style="color: #990000">);</span>

                <span style="font-style: italic"><span style="color: #9A1900">// This is a flag for angles larger than than a half circle</span></span>
                <span style="font-style: italic"><span style="color: #9A1900">// It is required by the SVG arc drawing component</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> big <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>endAngle <span style="color: #990000">-</span> startAngle <span style="color: #990000">&gt;</span> Math<span style="color: #990000">.</span>PI<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        big <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
                <span style="color: #FF0000">}</span>

                <span style="font-style: italic"><span style="color: #9A1900">//Create the &lt;svg:path&gt; element</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> path <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElementNS</span></span><span style="color: #990000">(</span>namespace<span style="color: #990000">,</span> <span style="color: #FF0000">"path"</span><span style="color: #990000">);</span>   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

        <span style="font-style: italic"><span style="color: #9A1900">// Start at circle center</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> pathDetails <span style="color: #990000">=</span> <span style="color: #FF0000">"M "</span> <span style="color: #990000">+</span> centerX <span style="color: #990000">+</span> <span style="color: #FF0000">","</span> <span style="color: #990000">+</span> centerY <span style="color: #990000">+</span>       <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/2.png" alt="2"></span></span>
                <span style="font-style: italic"><span style="color: #9A1900">// Draw line to (x1,y1)</span></span>
                <span style="color: #FF0000">" L "</span> <span style="color: #990000">+</span> x1 <span style="color: #990000">+</span> <span style="color: #FF0000">","</span> <span style="color: #990000">+</span> y1 <span style="color: #990000">+</span>
                <span style="font-style: italic"><span style="color: #9A1900">// Draw an arc of radius</span></span>
                <span style="color: #FF0000">" A "</span> <span style="color: #990000">+</span> pieRadius <span style="color: #990000">+</span> <span style="color: #FF0000">","</span> <span style="color: #990000">+</span> pieRadius <span style="color: #990000">+</span>
                <span style="font-style: italic"><span style="color: #9A1900">// Arc's details</span></span>
                <span style="color: #FF0000">" 0 "</span> <span style="color: #990000">+</span> big <span style="color: #990000">+</span> <span style="color: #FF0000">" 1 "</span> <span style="color: #990000">+</span>
                <span style="font-style: italic"><span style="color: #9A1900">// Arc goes to to (x2,y2)</span></span>
                x2 <span style="color: #990000">+</span> <span style="color: #FF0000">","</span> <span style="color: #990000">+</span> y2 <span style="color: #990000">+</span>
                <span style="color: #FF0000">" Z"</span><span style="color: #990000">;</span>
                <span style="font-style: italic"><span style="color: #9A1900">// Close the path at (centerX, centerY)</span></span>

                <span style="font-style: italic"><span style="color: #9A1900">// Attributes for the &lt;svg:path&gt; element</span></span>
                path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"d"</span><span style="color: #990000">,</span> pathDetails<span style="color: #990000">);</span>
                <span style="font-style: italic"><span style="color: #9A1900">// Sector fill color</span></span>
                path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fill"</span><span style="color: #990000">,</span> colorScheme<span style="color: #990000">[</span>i<span style="color: #990000">]);</span>

                chartContaner<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>path<span style="color: #990000">);</span>                    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>

                <span style="font-style: italic"><span style="color: #9A1900">// The next sector begins where this one ends</span></span>
                startAngle <span style="color: #990000">=</span> endAngle<span style="color: #990000">;</span>

                <span style="font-style: italic"><span style="color: #9A1900">// label's bullet</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> labelBullet <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElementNS</span></span><span style="color: #990000">(</span>namespace<span style="color: #990000">,</span> <span style="color: #FF0000">"rect"</span><span style="color: #990000">);</span>
                <span style="font-style: italic"><span style="color: #9A1900">// Bullet's position</span></span>
                labelBullet<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"x"</span><span style="color: #990000">,</span> chartLegendX<span style="color: #990000">);</span>
                labelBullet<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"y"</span><span style="color: #990000">,</span> chartLegendY <span style="color: #990000">+</span> <span style="color: #993399">20</span> <span style="color: #990000">*</span> i<span style="color: #990000">);</span>

    <span style="font-style: italic"><span style="color: #9A1900">// Bullet's size</span></span>
                labelBullet<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"width"</span><span style="color: #990000">,</span> <span style="color: #993399">10</span><span style="color: #990000">);</span>
                labelBullet<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"height"</span><span style="color: #990000">,</span> <span style="color: #993399">10</span><span style="color: #990000">);</span>
                labelBullet<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"fill"</span><span style="color: #990000">,</span> colorScheme<span style="color: #990000">[</span>i<span style="color: #990000">]);</span>

                chartContaner<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>labelBullet<span style="color: #990000">);</span>             <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>

                <span style="font-style: italic"><span style="color: #9A1900">// Add the label text</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> labelText <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElementNS</span></span><span style="color: #990000">(</span>namespace<span style="color: #990000">,</span> <span style="color: #FF0000">"text"</span><span style="color: #990000">);</span>

    <span style="font-style: italic"><span style="color: #9A1900">// label position = bullet's width(10px) + padding(8px)</span></span>
                labelText<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"x"</span><span style="color: #990000">,</span> chartLegendX <span style="color: #990000">+</span> <span style="color: #993399">18</span><span style="color: #990000">);</span>
                labelText<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setAttribute</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"y"</span><span style="color: #990000">,</span> chartLegendY <span style="color: #990000">+</span> <span style="color: #993399">20</span> <span style="color: #990000">*</span> i <span style="color: #990000">+</span> <span style="color: #993399">10</span><span style="color: #990000">);</span>
                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> txt <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createTextNode</span></span><span style="color: #990000">(</span>chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>location <span style="color: #990000">+</span>
                <span style="color: #FF0000">" | "</span><span style="color: #990000">+</span>chartData<span style="color: #990000">.</span>items<span style="color: #990000">[</span>i<span style="color: #990000">].</span>donors<span style="color: #990000">);</span>

                labelText<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>txt<span style="color: #990000">);</span>
                chartContaner<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>labelText<span style="color: #990000">);</span>               <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/3.png" alt="3"></span></span>
        <span style="color: #FF0000">}</span>

<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Create the <span class="monospaced">&lt;svg:path&gt;</span> HTML element, which is the most important SVG element for drawing basic shapes.. It includes a series of commands that produce the required drawing. For example, <em>M 10 10</em> means <em>movo to the coordinate 10,10</em> and <em>L 20 30</em> means <em>draw the line to the coordinate 20,30</em>.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Fill the details of the <span class="monospaced">&lt;svg:path&gt;</span> element to draw the pie sector.
Run the Aptana&#8217;s project-13-svg-pie-chart-json to see the Save Sick Child page, then right-click on the pie chart and select Inspect Element (this is the name of the menu item in Firefox). <a href="#FIG4-7">[FIG4-7]</a> shows the resulting content of our <span class="monospaced">&lt;svg&gt;</span> element. As you can see, it&#8217;s not pixel based but a set of XML-like commands that drew the content of the chart. If you&#8217;ll run the previous version of our application (project-12-canvas-pie-chart-json) and right-click on the chart, you will be able to save it as an image, but won&#8217;t see the internals of the <span class="monospaced">&lt;canvas&gt;</span> element.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Adding the internal elements of the chart container to the DOM - path, bullets and text. These elements can be modified if needed without redrawing the entire content of the container.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">in our code example we have written the path commands manually to process the data dynamically. But Web designers often use tools (<a href="http://www.adobe.com/products/illustrator.html">Adobe Illustrator</a>, <a href="http://inkscape.org/">Incscape</a> et al.) to draw and then export images into an SVG format. In this case all paths will be encoded as <span class="monospaced">&lt;svg:path&gt;</span> automatically.</td>
</tr></table>
</div>
<div class="imageblock" id="FIG4-7">
<div class="content">
<img src="images/fig_04_07.png" alt="images/fig_04_07.png">
</div>
<div class="title">Figure 50. The chart content in SVG</div>
</div>
<div class="paragraph"><p>Since the SVG is XML-based, its very easy to generate the code shown in <a href="#FIG4-7">[FIG4-7]</a> on the server, and lots of Web applications send ready to display SVG graphics to the users' Web browsers. But in our example we are generating the SVG output in the JavaScript from JSON received from the server, which provides a cleaner separation between the client and the server-side code. The final decision on what to send to the Web browser (ready to render SVG or raw JSON) has to be made after considering various factors such as available bandwidth, the size of data, the number of users, the existing load on the server resources.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">SVG supports animations and transformation effects, while canvas doesn&#8217;t.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_jsonp">What is JSONP</h3>
<div class="paragraph"><p>JSONP is a technique used in to relax the cross-origin restrictions in cases when a Web page was loaded from the domain abc.com and needs JSON-formatted data from another domain xyz.com.  With JSONP, instead of sending plain JSON data, the server wraps them up into a JavaScript function and then sends it to the Web browser for execution as a callback. The Web page that was originated from abc.com may send the request <span class="monospaced">http://xyz.com?callback=myDataHandler</span> technically requesting the server xyz.com to invoke the JavaScript callback named <span class="monospaced">myDataHandler</span>. This URL is a regular HTTP GET request, which may have other parameters too so you can send some data to the server too.</p></div>
<div class="paragraph"><p>The server will send to the browser the JavaScript function that may look as follow:</p></div>
<div class="paragraph"><p><span class="monospaced">function myDataHandler({"fname": "Alex", "lname":"Smith","skillLevel": 11});</span></p></div>
<div class="paragraph"><p>The Web browser will invoke the callback <span class="monospaced">myDataHandler()</span>, which must exist in the Web page. The Web browser will pass the received JSON object as an argument to this callback:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">myDataHandler</span></span><span style="color: #990000">(</span>data<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
  <span style="font-style: italic"><span style="color: #9A1900">// process the content of the argument data - the JSON object</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// received from xyz.com</span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>If all you need is just to retrieve the data from a different domain on page just add the following tag to your HTML page:</p></div>
<div class="paragraph"><p><span class="monospaced">&lt;script src="http://xyz.com?callback=myDataHandler"&gt;</span></p></div>
<div class="paragraph"><p>But what if you need to dynamically make such requests periodically (e.g. get all twits with a hashtag <span class="monospaced">#savisickchild</span> by sending an HTTP GET using Twitter API at <span class="monospaced">http://search.twitter.com/search.json?q=savesickchild&amp;rpp=5&amp;include_entities=true&amp;with_twitter_user_id=true&amp;result_type=mixed</span>)? You may also need to make requests to a different server when the user selected a certain option on your Web page. You can achieve this by dynamically adding a <span class="monospaced">&lt;script&gt;</span> tag to the DOM object from your JavaScript code. Whenever the browser sees the new <span class="monospaced">&lt;script&gt;</span> element it executes it. Such script injection can be done like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myScriptTag <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"script"</span><span style="color: #990000">);</span>
myScriptTag<span style="color: #990000">.</span>src <span style="color: #990000">=</span> <span style="color: #FF0000">"http://xyz.com?callback=myDataHandler"</span><span style="color: #990000">;</span>
document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementsByTagName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"body"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>myScriptTag<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Your JavaScript can build the URL for the <span class="monospaced">myScriptTag.src</span> dynamically and pass parameters to the server based on some user&#8217;s actions, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>myScriptTag<span style="color: #990000">.</span>src <span style="color: #990000">=</span> <span style="color: #FF0000">"http://xyz.com?city=Boston&amp;callback=myDataHandler"</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>Of course, this technique presents a danger if there is a chance that the JavaScript code sent by xyz.com is intercepted and replaced by a malicious code. But it&#8217;s not more dangerous that receiving any JavaScript from non-trusted  server. Besides, your handler function could always make sure that the received data is a valid object with expected properties, and only after that handle the data.</p></div>
<div class="paragraph"><p>If you decide to use JSONP don&#8217;t forget about error handling. Most likely you&#8217;ll be using one of the JavaScript frameworks and they usually offer a standard mechanism for JSONP error handling, dealing with poorly formatted JSON responses, and recovery in cases of network failure. One of such libraries is called <a href="https://github.com/jaubourg/jquery-jsonp">jQuery-JSONP</a>.</p></div>
<div class="sect3">
<h4 id="_beer_and_jsonp">Beer and JSONP</h4>
<div class="paragraph"><p>In this section you&#8217;ll see a small code example illustrating the data retrieval from publicly publicly available <a href="http://openbeerdatabase.com/">Open Beer DataBase</a>, which exists to help software developers test their code that makes REST Web service calls and works with JSON and JSONP data. Our Save Sick Child page won&#8217;t display beer bottles, but we want to show that in addition to the retrieval of the donations and charts data from one domain we can get the data from a third-party domain openbeerdatabase.com.</p></div>
<div class="paragraph"><p>First, enter the URL <span class="monospaced">http://api.openbeerdatabase.com/v1/breweries.json</span> in the address bar of your Web browser, and it&#8217;ll return the following JSON data (only 2 out of 7 breweries are shown for brevity):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
   <span style="color: #FF0000">"page"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"pages"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"total"</span><span style="color: #990000">:</span> <span style="color: #993399">7</span><span style="color: #990000">,</span>
   <span style="color: #FF0000">"breweries"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>
       <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"(512) Brewing Company"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"url"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://512brewing.com"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"created_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2010-12-07T02:53:38Z"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"updated_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2010-12-07T02:53:38Z"</span>
       <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
       <span style="color: #FF0000">{</span>
           <span style="color: #FF0000">"id"</span><span style="color: #990000">:</span> <span style="color: #993399">2</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"21st Amendment Brewing"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"url"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"http://21st-amendment.com"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"created_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2010-12-07T02:53:38Z"</span><span style="color: #990000">,</span>
           <span style="color: #FF0000">"updated_at"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"2010-12-07T02:53:38Z"</span>
       <span style="color: #FF0000">}</span>
   <span style="color: #990000">]</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Now let&#8217;s request the same data, but in a JSONP format by adding to the URL a parameter with a callback name <span class="monospaced">myDataHandler</span>. Entering in the browser <span class="monospaced">http://api.openbeerdatabase.com/v1/breweries.json?callback=processBeer</span> will return the following (it&#8217;s a short version):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">processBeer</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"page"</span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">,</span><span style="color: #FF0000">"pages"</span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">,</span><span style="color: #FF0000">"total"</span><span style="color: #990000">:</span><span style="color: #993399">7</span><span style="color: #990000">,</span><span style="color: #FF0000">"breweries"</span><span style="color: #990000">:[</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #993399">1</span><span style="color: #990000">,</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"(512) Brewing Company"</span><span style="color: #990000">,</span><span style="color: #FF0000">"url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://512brewing.com"</span><span style="color: #990000">,</span><span style="color: #FF0000">"created_at"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2010-12-07T02:53:38Z"</span><span style="color: #990000">,</span><span style="color: #FF0000">"updated_at"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2010-12-07T02:53:38Z"</span><span style="color: #FF0000">}</span><span style="color: #990000">,</span><span style="color: #FF0000">{</span><span style="color: #FF0000">"id"</span><span style="color: #990000">:</span><span style="color: #993399">2</span><span style="color: #990000">,</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span><span style="color: #FF0000">"21st Amendment Brewing"</span><span style="color: #990000">,</span><span style="color: #FF0000">"url"</span><span style="color: #990000">:</span><span style="color: #FF0000">"http://21st-amendment.com"</span><span style="color: #990000">,</span><span style="color: #FF0000">"created_at"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2010-12-07T02:53:38Z"</span><span style="color: #990000">,</span><span style="color: #FF0000">"updated_at"</span><span style="color: #990000">:</span><span style="color: #FF0000">"2010-12-07T02:53:38Z"</span><span style="color: #FF0000">}</span><span style="color: #990000">]</span><span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Since we haven&#8217;t declared the function <span class="monospaced">processBeer()</span> yet, it won&#8217;t be invoked. Let&#8217;s fix it now. The function will check first if the received data contains the information about the breweries. If it does, the name of the very first brewery will be printed on the JavaScript console. Otherwise the console output will read "Retrieved data has no breweries info".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> processBeer<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>data<span style="color: #990000">)</span><span style="color: #FF0000">{</span>

   <span style="font-style: italic"><span style="color: #9A1900">// Uncomment the next line to emulate malicious data</span></span>
   <span style="font-style: italic"><span style="color: #9A1900">// data="function evilFunction(){alert(' Bad function');}";</span></span>

     <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>data<span style="color: #990000">.</span>breweries <span style="color: #990000">==</span> undefined<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
      console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Retrieved data has no breweries info."</span><span style="color: #990000">);</span>
     <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #FF0000">{</span>
      console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"In the processBeer callback. The first brewery is "</span>
                  <span style="color: #990000">+</span> data<span style="color: #990000">.</span>breweries<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">].</span>name<span style="color: #990000">);</span>
     <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> myScriptTag <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">createElement</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"script"</span><span style="color: #990000">);</span>
  myScriptTag<span style="color: #990000">.</span>src <span style="color: #990000">=</span> <span style="color: #FF0000">"http://api.openbeerdatabase.com/v1/breweries.json?callback=processBeer"</span><span style="color: #990000">;</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> bd <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementsByTagName</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)[</span><span style="color: #993399">0</span><span style="color: #990000">];</span>
bd<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">appendChild</span></span><span style="color: #990000">(</span>myScriptTag<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p><a href="#FIG4-8">[FIG4-8]</a> is a screen snapshot taken in the Firebug when it reached the breakpoint placed inside the processBeer callback on the <span class="monospaced">console.log(in the processBeer callback")</span>. You can see the content of the <span class="monospaced">data</span> argument - the beer has arrived.</p></div>
<div class="imageblock" id="FIG4-8">
<div class="content">
<img src="images/fig_04_08.png" alt="images/fig_04_08.png">
</div>
<div class="title">Figure 51. The beer has arrived</div>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">As a training exercise, try to replace the data retrieval from the beer Web service with adding the data feed from Twitter based on certain hash tags. See if you can find the place in the Save Sick Child Web page to display (and periodically update) this Twitter stream.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_4">Summary</h3>
<div class="paragraph"><p>In this chapter you&#8217;ve learned about using AJAX as a means of communications of your Web browser with the servers. AJAX also deserves a credit for making the JavaScript language popular again by showing a practical way of creating single-page Web applications. Over the years JSON became the standard way of exchanging the data on the Web. The current version of the Save Sick Child application cleanly separates the code from the data, and you know how to update the content of the Web page without the need to re-retrieve the entire page from the server. In the next chapter you&#8217;ll get familiar with the test-driven way of developing Web applications with JavaScript.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_save_sick_child_with_jquery">Save Sick Child with JQuery</h2>
<div class="sectionbody">
<div class="paragraph"><p>Up till now we&#8217;ve been using HTML, JavaScript and CSS to create the Save Sick Child Web application.  In the real world, developers try to be more productive by using JavaScript libraries and MVC frameworks. Libraries do not dictate how to structure the code of your application - they offer you components that allow to write less code. MVC frameworks force you to organize your code in layers implementing the Model-View-Controller design pattern.  There are more than a dozen MVC JavaScript frameworks that are being used by professional developers: <a href="http://backbonejs.org/">Backbone.js</a>, <a href="http://www.sencha.com/products/extjs">ExtJS</a>, AngularJS, <a href="http://emberjs.com/">Ember.js</a>, <a href="http://knockoutjs.com/">Knockout</a> just to name a few. In this chapter we&#8217;ll introduce the JavaScript library called jQuery. Chapter 6 is about the JavaScript framework ExtJS. Their mobile counterparts are called jQuery Mobile and Sencha Touch (see Chapters 12 and 13).</p></div>
<div class="paragraph"><p><a href="http://jquery.com/">jQuery</a> is the most popular JavaScript library. More than 60% of top Web sites use jQuery (visit <a href="http://trends.builtwith.com/javascript/top">http://trends.builtwith.com/javascript/top</a> for the current statistics). jQuery is simple to use and doesn&#8217;t require you to dramatically change the way you program for the Web. jQuery offers you a helping hand with the tasks that most of the Web developers need to deal with, for example, finding and manipulating DOM elements, processing browser&#8217;s events, and dealing with browser incompatibility. Since jQuery is an extensible framework, lots and lots of plugins were created by developers from around the world, and all of them are available for free. If you can&#8217;t find the plugin that fits your need you can create one yourself.</p></div>
<div class="paragraph"><p>Besides jQuery and jQuery Mobile there is a <a href="http://jqueryui.com/">jQuery UI library</a>, which is a set of user interface interactions, effects, widgets, and themes built on top of the jQuery. You can find in jQuery UI such widgets as Datepicker, Accordion, Slider, Tabs, Autocomplete and more. jQuery UI will also help you with adding to your Web page various interactions (e.g. drag and drop)  and effects (e.g. adding CSS classes or animations). jQuery UI is built on top of jQuery Core library and can&#8217;t be used independently. jQuery UI is covered in the <a href="http://shop.oreilly.com/product/0636920023159.do">O&#8217;Reilly book "jQuery UI"</a>.</p></div>
<div class="paragraph"><p>In this chapter we&#8217;ll briefly cover the basics of jQuery library. Our goal is not to provide you with a detailed jQuery primer - there are jQuery books and <a href="http://api.jquery.com/">the online API Documentation</a> that provide a comprehensive explanation of jQuery. But we&#8217;ll give you just enough of the information to  understand how jQuery can be used. In the section Working on Save Sick Child we&#8217;ll review the code of several versions of this application highlighting the benefits of using JQuery library.</p></div>
<div class="sect2">
<h3 id="_jquery_intro">jQuery Intro</h3>
<div class="paragraph"><p>At the time of this writing the current version of jQuery is 1.9.1 You can download one of two distributions of jQuery library. The gzipped minified version of jQuery weighs 33Kb (it&#8217;s 93Kb if unzipped), and this is all you need unless you are planning to develop jQuery plugins, in which case get a larger development version - it&#8217;s about 270Kb. We&#8217;ve downloaded it from jquery.com and included it in the <span class="monospaced">&lt;script&gt;</span> tag in our HTML code samples so you can run them even if the Internet connection is not available.</p></div>
<div class="paragraph"><p>But instead of deploying jQuery framework on your servers as a part of your application, you should use a common Content Delivery Network (CDN) URL in your HTML as shown below. Since jQuery is an extremely popular library, many Web sites use it. If more than one Web page would get it from the same CDN, the Web browser would cache it locally and reuse it rather than downloading a separate copy from different servers for every Web application that uses jQuery. The <a href="http://jquery.com/download/">download page of jquery.com</a> offers three CDN: Google, Microsoft, and MediaTemple. For example, if you don&#8217;t need to use HTTPS protocol with your application the MediaTemple&#8217;s CDN suffice:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://code.jquery.com/jquery-1.9.1.min.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">You can provide a fallback URL by adding one extra line that will load jQuery from an alternative location should your CDN fails:</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span> window<span style="color: #990000">.</span>jQuery <span style="color: #990000">||</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">write</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;script src="http://code.jquery.com/jquery-1.9.1.min.js"&gt;&lt;/script&gt;'</span><span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/warning.png" alt="Warning">
</td>
<td class="content">You may find code samples that use the URL <a href="http://code.jquery.com/jquery-latest.min.js">http://code.jquery.com/jquery-latest.min.js</a> to download the latest version of jQuery. But keep in mind that by doing this you may run into a situation when some of the API of jQuery has been changed or deprecated. For example, jQuery 2.0 <a href="http://blog.jquery.com/2012/07/01/jquery-1-9-and-2-0-tldr-edition/">will not support</a> Internet Explorer 6, 7, and 8 and automatically switching to the latest version may result in malfunctioning of your application. We recommend using the specific version that has been tested with your application.</td>
</tr></table>
</div>
<div class="paragraph"><p>After covering the basics of JQuery Core, we are going to continue reviewing the code of a series of Aptana projects representing same old Save Sick Child application, but this  using jQuery. We won&#8217;t add any new functionality to this application - we want to show that the developers can be more productive in achieving the same result.</p></div>
<div class="paragraph"><p>Some people will say that anyone who knows HTML can easily learn jQuery, but this is not so. Understanding of JavaScript is required. If you&#8217;ve read and understood the content from Chapter 2 - you&#8217;re ready to learn jQuery.  The jQuery programming starts with with invoking the jQuery constructor named <span class="monospaced">jQuery()</span>. But people are using the shorter version of this constructor that&#8217;s represented by a $ sign: <span class="monospaced">$()</span>. This <span class="monospaced">$</span> property is the only object that jQuery will create in the global namespace. Everything else will be encapsulated inside the <span class="monospaced">$</span> object.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">While it&#8217;s easier to write <span class="monospaced">$()</span> than <span class="monospaced">jQuery()</span>, keep in mind that if you decide to use in your application another library in addition to jQuery, with the chances are higher to run into a conflict of having another <span class="monospaced">$</span> than another <span class="monospaced">jQuery</span> in the global name space. To make sure you won&#8217;t find yourself in the "Another day, another $" position, put your code inside a closure, passing it <span class="monospaced">JQuery</span>. The following code allows you to safely use the <span class="monospaced">$</span> object:</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>$<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
   <span style="font-style: italic"><span style="color: #9A1900">// Your code goes here</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">)(</span>jQuery<span style="color: #990000">);</span></tt></pre></div></div>
</div></div>
<div class="paragraph"><p>As you remember, JavaScript functions do not require you to invoke them with exactly the same number of parameters as they were declared with. Hence, when you invoke jQuery constructor you can pass different things to it. You can pass a String as an argument or another function, and jQuery constructor will invoke different code based on the argument type. For example, if you&#8217;ll pass it a String, jQuery will assume that it&#8217;s a CSS selector, and the caller wants to find element(s) in the DOM that match this selector. Basically, you may think of it this way - whenever you want jQuery do something for you, invoke <span class="monospaced">$()</span> passing it your request.</p></div>
<div class="paragraph"><p>You&#8217;ll need to get used to yet another feature of jQuery - method chaining. Each function returns an object, and you don&#8217;t have to declare a variable to hold this object. You can just write something like <span class="monospaced">funcA().funcB();</span> This means that the method <span class="monospaced">funcB()</span> will be called on the object, returned by the <span class="monospaced">funcA()</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/warning.png" alt="Warning">
</td>
<td class="content">While method chaining is often presented as a great feature allowing to do more with less typing,
it may complicate debugging of your code. Imagine that <span class="monospaced">funcA()</span> returned null for whatever reason. The entire chain (the <span class="monospaced">funcB()</span> in our example) that was attached to <span class="monospaced">funcA()</span> won&#8217;t be working properly, and you&#8217;ll need to unchain these methods to find the problem.</td>
</tr></table>
</div>
<div class="paragraph"><p>Also, if you need to get an access to a DOM object more than once, save the reference in a variable and reuse it rather than invoking the same selector method in several chains.</p></div>
<div class="sect3">
<h4 id="_hello_world">Hello World</h4>
<div class="paragraph"><p>The "Hello World" program is always a good start to learn any new software, and we&#8217;ll go this route too. The following code sample uses jQuery to display a Web page that reads "Hello World!".</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">html</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;html</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Hello jQuery<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"js/libs/jquery-1.9.1.min.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;script&gt;</span></span>
                $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>                                    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
                        $<span style="color: #990000">(</span><span style="color: #FF0000">"body"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;h1&gt;Hello World!&lt;/h1&gt;"</span><span style="color: #990000">);</span>   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

                <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/script&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
If the script passes a function as an argument to jQuery, such a function is called when the DOM object is ready - the jQuery&#8217;s <span class="monospaced">ready()</span> function gets invoked . Keep in mind that it&#8217;s not the same as invoking a function handler <span class="monospaced">window.onload</span>, which is called after all windows resources (not just the DOM object) are completely  loaded (read more in the jQuery Events section).
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
If the script passes a String to jQuery, such Strolling is being treated as a CSS selector, and jQuery tries to find the matching collection of HTML elements (it&#8217;ll return the reference to just one <span class="monospaced">&lt;body&gt;</span> in the Hello World script). This line also demonstrates the method chaining - the <span class="monospaced">append()</span> method is called on the object returned by <span class="monospaced">$("body")</span>.
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_selectors_and_filters">Selectors and Filters</h3>
<div class="paragraph"><p>Probably the most frequently used routine in a JavaScript code that&#8217;s part of the HTML page is finding DOM elements and making some manipulations with them, and this is where the jQuery&#8217;s power is. Finding HTML elements based on the CSS selectors is very easy and concise. You can specify one or more selectors in the same query. Below is a code snippet with a number of random samples of selectors. Going through this code and reading comments will help you to understand how to use jQuery selectors.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
$<span style="color: #990000">(</span><span style="color: #FF0000">".donate-button"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// find the elements with the class donate-button</span></span>

$<span style="color: #990000">(</span><span style="color: #FF0000">"#login-link"</span><span style="color: #990000">)</span>  <span style="font-style: italic"><span style="color: #9A1900">// find the elements with id=login-link</span></span>

<span style="font-style: italic"><span style="color: #9A1900">// find elements with id=map-container and id=video-container</span></span>
$<span style="color: #990000">(</span><span style="color: #FF0000">"#map-container #video-container"</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Find an HTML input element that has a value attribute of 200</span></span>
$<span style="color: #990000">(</span><span style="color: #FF0000">'input[value="200"]'</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Find all &lt;p&gt; elements that are nested somewhere inside &lt;div&gt;</span></span>
$<span style="color: #990000">(</span><span style="color: #FF0000">'div p'</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Find all &lt;p&gt; elements that are direct children (located directly inside) &lt;div&gt;</span></span>
$<span style="color: #990000">(</span><span style="color: #FF0000">'div&gt;p'</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Find all &lt;label&gt; elements that are styled with the class donation-heading</span></span>
$<span style="color: #990000">(</span>label<span style="color: #990000">.</span>donation<span style="color: #990000">-</span>heading<span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">// Find an HTML input element that has a value attribute of 200</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// and change the text of its next sibling to "two hundred"</span></span>
$<span style="color: #990000">(</span><span style="color: #FF0000">'input[value="200"]'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">next</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"two hundred"</span><span style="color: #990000">);</span>
</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If jQuery returns a set of elements that match the selector&#8217;s expression, you can access its elements using array notation: <span class="monospaced">var theSecondDiv = $('div')[1]</span>. If you want to iterate through the entire set use jQuery method <a href="http://api.jquery.com/each/"><span class="monospaced">$(selector).each()</span></a>. For example, if you want to perform some function on each paragraph of an HTML document, you can do it a follows: <span class="monospaced">$("p").each(function(){...})</span>.</td>
</tr></table>
</div>
<div class="paragraph"><p>There is a handy online site <a href="http://jsfiddle.net/">JSFiddle</a> for performing quick testing of code fragments of HTML, CSS, JavaScript, and popular frameworks. This Web page has a sidebar of the left and four large panels on the right. Three of these panels are for entering or copy/pasting: HTML, CSS, and JavaScript, and the forth panel is for showing the results of applying this code (see <a href="#FIG5-1">[FIG5-1]</a>).</p></div>
<div class="imageblock" id="FIG5-1">
<div class="content">
<img src="images/fig_05_1.png" alt="images/fig_05_1.png">
</div>
<div class="title">Figure 52. Testing jQuery using JSFiddle</div>
</div>
<div class="paragraph"><p>Copy/paste the fragments from the HTML and CSS written for the Donate section of the Save Sick Child page into the top panels, and press the button Run on JSFiddle&#8217;s toolbar, you&#8217;ll see our donate form where each radiobutton has a label in the form of digits (10, 20, 50, 100, 200). Now select jQuery 1.9.0 from the dropdown at the top left and copy paste the jQuery code fragment you&#8217;d like to test into the JavaScript panel locate under the HTML one. As you see on <a href="#FIG5-1">[FIG5-1]</a>, we&#8217;ve pasted <span class="monospaced">$('input[value="200"]').next().text("two hundred");</span>. After pressing the button Run the jQuery script was executed and the label of the last radiobutton has been replaced from "200" to "two hundred". JSFiddle&#8217;s tutorial is located at <a href="http://doc.jsfiddle.net/tutorial.html">http://doc.jsfiddle.net/tutorial.html</a>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">If you chained a method, e.g. an event handler, to the HTML element returned by a selector, your can use <span class="monospaced">$(this)</span> from inside such a handler to get a reference to this HTML element.</td>
</tr></table>
</div>
<div class="paragraph"><p>If jQuery selector returns a number of HTML elements, you can further narrow down this collection by applying so-called filters.jQuery has such filters as <span class="monospaced">eq()</span>, <span class="monospaced">has()</span>, <span class="monospaced">first()</span> and more.</p></div>
<div class="paragraph"><p>For example, applying the selector <span class="monospaced">$('label');`to the Donate section HTML fragment shown in &lt;&lt;FIG5-1&gt;&gt; would return a set of HTML elements `&lt;label&gt;</span>. Say we want to change the background of the label "20" to be red. This is the third label in the HTML from <a href="#FIG5-1">[FIG5-1]</a>, and the <span class="monospaced">eq(n)</span> filter selects the element at the zero-based index <span class="monospaced">n</span> within the matched set.</p></div>
<div class="paragraph"><p>You can apply this filter using the following syntax: <span class="monospaced">$('label:eq(2)');</span>. But jQuery documentation suggest to use the syntax <span class="monospaced">$('label').eq(2);</span> <a href="http://api.jquery.com/eq-selector/">for better performance</a>.</p></div>
<div class="paragraph"><p>Using method chaining we&#8217;ll apply the filter  <span class="monospaced">eq(2)</span> to the set of lables returned by the selector <span class="monospaced">$('label')</span> and then and then change the styling of the remaining HTML element(s) using the <span class="monospaced">css()</span> method that can do all CSS manipulations. This is how the entire expression will look like:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">'label'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">eq</span></span><span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">css</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'background-color'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'red'</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Test this script in JSFiddle or in the code of one of the Save Sick Child projects from this chapter. The background of the label "20" will become red. If you wanted to change the CSS of the first label in this set, the filter expressions could look as <span class="monospaced">$('label:first')</span> or, for the better performance, you should do it like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">'label'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">":first"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">css</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'background-color'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'red'</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you display data in HTML table, you may want to change the background color of every even or odd row <span class="monospaced">&lt;tr&gt;</span>,  and jQuery offers you the filters <span class="monospaced">even()</span> and <span class="monospaced">odd()</span>, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">'tr'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">":even"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">css</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'background-color'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'grey'</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Visit jQuery API documentation for the complete list of <a href="http://api.jquery.com/category/selectors/">selectors</a> and <a href="http://api.jquery.com/category/traversing/filtering/">traversing filters</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_events">Events</h3>
<div class="paragraph"><p>Adding events processing with jQuery is simple, and your code will be following the same pattern: find the element in DOM using selector or filter, and then attach the appropriate function that handles the event. We&#8217;ll show you a handful of code sample of how to do it, but you can find the description of all methods that deal with events in the <a href="http://api.jquery.com/category/events/">jQuery API documentation</a>.</p></div>
<div class="paragraph"><p>Our Hello World example used a short version of passing the handler function to the <span class="monospaced">ready()</span> function:
<span class="monospaced">$(function());</span></p></div>
<div class="paragraph"><p>This is the same as using the following syntax:</p></div>
<div class="paragraph"><p><span class="monospaced">$(document).ready(function());</span></p></div>
<div class="paragraph"><p>For the Hello World example this was all that mattered - we just needed to have the DOM object to be able to append the <span class="monospaced">&lt;h1&gt;</span> element to it. But this would not be the right solution if the code needs to be executed only after all page resources have been loaded. In such case the code could have been re-written to utilize the DOM&#8217;s <span class="monospaced">window.load</span> event, which in jQuery looks as follows:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span>window<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>
                $<span style="color: #990000">(</span><span style="color: #FF0000">"body"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"&lt;h1&gt;Hello World!&lt;/h1&gt;"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If the user interacts with your Web page using the mouse , the events handlers can be added using a similar procedure. For example, if you want the header in our Hello World example to process click events, find the reference to this header and attach the <span class="monospaced">click()</span> handler to it. Adding the following to the <span class="monospaced">&lt;script&gt;</span> section of Hello World will append the text each time the user clicks on the header.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">"h1"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>event<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
    $<span style="color: #990000">(</span><span style="color: #FF0000">"body"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Hey, you clicked on the header!"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>If you&#8217;d like to process double-clicks - replace the <span class="monospaced">click()</span> invocation with <span class="monospaced">dblclick()</span>. jQuery has handlers for about a dozen mouse events, which are wrapper methods to the corresponding JavaScript events that are dispatched when mouse entering or leaving the area, the mouse pointer goes up/down, or the focus moves in or out of an input field. The shorthand methods <span class="monospaced">click()</span> and <span class="monospaced">dblclick()</span> (and several others) internally use the method <span class="monospaced">on()</span>, which you can and should use in your code too.</p></div>
<div class="sect3">
<h4 id="_binding_events_with_the_method_on">Binding Events With The Method on()</h4>
<div class="paragraph"><p>The event methods can be attached just by passing a handler function as it was done in the above examples, or to process the event or by using the <span class="monospaced">on()</span> method, which allows you to specify the native event name and the event handler as its arguments. In the section Working on Save Sick Child you&#8217;ll see lots of examples, where the <span class="monospaced">on()</span> method is used. The one liner below assigns the function handler named <span class="monospaced">showLoginForm</span> to the <span class="monospaced">click</span> event of the element with the id <span class="monospaced">login-link</span>. The following code snippets includes the commented out pure-JavaScript version of the code (see project-02-login in Chapter 3) that has the same functionality:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-style: italic"><span style="color: #9A1900">// var loginLink = document.getElementById("login-link");</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// loginLink.addEventListener('click', showLoginForm, false);</span></span>

        $<span style="color: #990000">(</span><span style="color: #FF0000">'#login-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showLoginForm<span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">on()</span> method allows you to assign the same handler function to more than one event. For example, to invoke the <span class="monospaced">showLoginForm</span> function when the user clicks or moves the mouse over the HTML element you could written  <span class="monospaced">on('click mouseover', showLoginForm)</span>.</p></div>
<div class="paragraph"><p>The method <span class="monospaced">off()</span> is used for removing the event handler and the event won&#8217;t be processed anymore. For example, if you want to turn off the login link&#8217;s ability to process <span class="monospaced">click</span> event, simply write this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>        $<span style="color: #990000">(</span><span style="color: #FF0000">'#login-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">off</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showLoginForm<span style="color: #990000">);</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_delegated_events">Delegated Events</h4>
<div class="paragraph"><p>The method <span class="monospaced">on()</span> can be called with passing an optional selector as an argument. Since we haven&#8217;t used it in the example from the previous section, the event was triggered only when reached the element with an id <span class="monospaced">login-link</span>. Now imagine an HTML container that has child elements, e.g. a calculator implemented as a <span class="monospaced">&lt;div id="calculator"&gt;</span> containing buttons. The following code would assign a click handler <strong>to each</strong> button stlyled with a class <span class="monospaced">.digitButton</span>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">"div#calculator .digitButton"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>But instead of assigning an event handler to each button, you can assign an event handler to the container and specify additional selector that child elements may be found by. The following code assigns the event handler function <strong>to only one</strong> object - the <span class="monospaced">div#calculator</span> instructing this container to invoke the event handler when any of its children matching <span class="monospaced">.digitButton</span> is clicked.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">"div#calculator"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> <span style="color: #FF0000">".digitButton"</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>When the button is clicked, the event bubbles up and reaches the container&#8217;s level, whose click handler will do the processing. The work on processing clicks for digit buttons is delegated to the container.</p></div>
<div class="paragraph"><p>Another good use case for delegating event processing to a container is a financial application that displays the data in an HTML table containing hundreds of rows. Instead of assigning event hundreds event handlers (one per table row), assign one to the table. There is one extra benefit to using delegation in this case - if the application can dynamically add new rows to this table (say, the order execution data), there is no need to explicitly assign event handlers to them - the container will do the processing for both old and new rows.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">Starting from jQuery 1.7, the method <span class="monospaced">on()</span> is a recommended replacement of the methods <span class="monospaced">bind()</span>, <span class="monospaced">unbind()</span>, <span class="monospaced">delegate()</span>, and <span class="monospaced">undelegate()</span> that are still being used in earlier versions of jQuery.  If you decide to develop your application with jQuery and its mobile version with jQuery Mobile, you need to be aware that the latter may not implement the latest code of the core jQuery.  Using <span class="monospaced">on()</span> is safe though, because at the time of this writing jQuery Mobile 1.2 supports all the features of jQuery 1.8.2. In Chapter 11, you&#8217;ll see how using the responsive design principles can help you to reuse the same code on both desktop and mobile devices.</td>
</tr></table>
</div>
</div></div>
<div class="paragraph"><p>The method <span class="monospaced">on()</span> allows passing the data to the function handler.</p></div>
<div class="paragraph"><p>You are also allowed to assign different handlers to different events in on invocation of <span class="monospaced">on()</span>. The following code snippet from project-11-jQuery-canvas-pie-chart-json assigns handlers to <span class="monospaced">focus</span> and <span class="monospaced">blur</span> events:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">'#customAmount'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        focus <span style="color: #990000">:</span> onCustomAmountFocus<span style="color: #990000">,</span>
        blur <span style="color: #990000">:</span> onCustomAmountBlur
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_ajax_with_jquery">AJAX with jQuery</h3>
<div class="paragraph"><p>Making AJAX requests to the server is also easier with jQuery than with pure JavaScript. All the complexity of <a href="http://api.jquery.com/jQuery.ajax/"><span class="monospaced">$.ajax()</span></a> method is hidden from the developers. This method spares JavaScript developers from writing the code with multiple browser-specific ways of instantiating the <span class="monospaced">XMLHttpRequest</span> object. By invoking <span class="monospaced">ajax()</span> you can exchange the data with the server and load the JavaScript code. In its simplest form, this method takes just the URL of the remote resource to which the request is sent. Such invocation will use global defaults that should have been set in advance by invoking the method <a href="http://api.jquery.com/jQuery.ajaxSetup/"><span class="monospaced">ajaxSetup()</span></a>.</p></div>
<div class="paragraph"><p>But you can combine specifying parameters of the AJAX call and making the <span class="monospaced">ajax()</span> call. Just provide as an argument a configuration object that defines the URL, the function handlers for success and failures, and some other parameters like a function to call right before the AJAX request (<span class="monospaced">beforeSend</span>) or caching instructions for the browser (<span class="monospaced">cache</span>). Spend some time getting familiar with all different configuration parameters that you can use with the jQuery method <span class="monospaced">ajax()</span>. A sample  template for calling jQuery <span class="monospaced">ajax()</span> may look as shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ajax</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
                url<span style="color: #990000">:</span> <span style="color: #FF0000">'myData.json'</span><span style="color: #990000">,</span>
                type<span style="color: #990000">:</span> <span style="color: #FF0000">'GET'</span><span style="color: #990000">,</span>
                dataType<span style="color: #990000">:</span> <span style="color: #FF0000">'json'</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">)</span>
          <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>jqXHR<span style="color: #990000">,</span> textStatus<span style="color: #990000">)</span> <span style="color: #FF0000">{</span><span style="color: #990000">...</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>This example takes a JavaScript object that defines three properties: the URL, the type of the request,  and the expected data type. Using chaining, you can attach the methods <span class="monospaced">done()</span> and <span class="monospaced">fail()</span>, which have to specify the function handlers to be invoked in case of success and failure respectively. Don&#8217;t forget about the asynchronous nature of  AJAX calls, which means that the <span class="monospaced">ajax()</span> method  will be finished before the <span class="monospaced">done()</span> or <span class="monospaced">fail()</span> callbacks will be invoked. You may attach another  <em>promised callback</em> method <span class="monospaced">always()</span> that will be invoked regardless of if the <span class="monospaced">ajax()</span> call succeeds or fails. The <a href="http://api.jquery.com/jQuery.ajax/#jqXHR">jqXHR</a> is a jQuery wrapper for the browser&#8217;s  <span class="monospaced">XMLHttpRequest</span> object.</p></div>
<div class="paragraph"><p>To support chaining of asynchronous callbacks (<span class="monospaced">done()</span>, <span class="monospaced">fail()</span>, <span class="monospaced">always()</span>) that don&#8217;t need to be called right away - they wait for the result - the method <span class="monospaced">ajax()</span> returns so called Deferred object that places these callbacks in a queue to be called later. As a matter of fact, the callback <span class="monospaced">fail()</span> may never be called.</p></div>
<div class="paragraph"><p>If you&#8217;ll specify JSON as a value of the <span class="monospaced">dataType</span> property, the result will be parsed automatically by jQuery - there is no need to call <span class="monospaced">JSON.parse()</span> as it was done in Chapter 4. Even though the jQuery object has a utility  method <span class="monospaced">parseJSON()</span>, you don&#8217;t have to invoke it to process return of the <span class="monospaced">ajax()</span> call.</p></div>
<div class="paragraph"><p>In the above example the type of the AJAX request was <span class="monospaced">GET</span>. But you can use <span class="monospaced">POST</span> too. In this case you&#8217;ll need to prepare valid JSON data to be sent to the server. In this case the configuration object that you provide as an argument to the method <span class="monospaced">ajax()</span> has to include the property <span class="monospaced">data</span> containing valid JSON.</p></div>
<div class="sect3">
<h4 id="_handy_shorthand_methods">Handy Shorthand Methods</h4>
<div class="paragraph"><p>jQuery has several shorthand methods that allow making AJAX calls with the simpler syntax, which we&#8217;ll consider next.</p></div>
<div class="paragraph"><p>The method <a href="http://api.jquery.com/load/"><span class="monospaced">load()</span></a> makes an AJAX call from an HTML element(s) to the specified URL (the first argument) and populates the HTML element with the returned data. You can pass optional second and third arguments: HTTP request parameters and the callback function to process the results. If the second argument is an object, the <span class="monospaced">load()</span> method will make a <span class="monospaced">POST</span> request, otherwise - <span class="monospaced">GET</span>. You&#8217;ll see the code that uses <span class="monospaced">load()</span> to populate states and countries from remote HTML files later in this chapter in the section on bringing the states and countries from remote HTML files. But the next line shows an example of calling <span class="monospaced">load()</span> with two parameters: the URL and the callback:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> $<span style="color: #990000">(</span><span style="color: #FF0000">'#counriesList'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/countries.html'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span> status<span style="color: #990000">,</span> xhr<span style="color: #990000">)</span><span style="color: #FF0000">{</span><span style="color: #990000">...</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">You can use the function <span class="monospaced">load()</span> to load SVG images asynchronously.</td>
</tr></table>
</div>
<div class="paragraph"><p>The global method <a href="http://api.jquery.com/jQuery.get/"><span class="monospaced">get()</span></a> allows you to specifically issue an HTTP <span class="monospaced">GET</span> request. Similarly to the <span class="monospaced">ajax()</span> invocation, you can chain the <span class="monospaced">done(),</span> <span class="monospaced">fail()</span>, and <span class="monospaced">always()</span> methods to <span class="monospaced">get()</span>, for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'ssc/getDonors?city=Miami'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Got the donors"</span><span style="color: #990000">);</span><span style="color: #FF0000">}</span><span style="color: #990000">)</span>
  <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"I'm called after the donors retrieved"</span><span style="color: #990000">);</span><span style="color: #FF0000">}</span>
  <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Request for donors failed"</span><span style="color: #990000">);</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The global method <span class="monospaced">post()</span> makes an HTTP <span class="monospaced">POST</span> request to the server. You must specify at least one argument - the URL on the server, and, optionally, the data to be passed, the callback to be invoked on the request completion, and the type of data expected from the server. Similarly to the <span class="monospaced">ajax()</span> invocation, you can chain the <span class="monospaced">done(),</span> <span class="monospaced">fail()</span>, and <span class="monospaced">always()</span> methods to <span class="monospaced">post()</span>. The following example makes a <span class="monospaced">POST</span> request to the server passing an object with the new donor information.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'ssc/addDonor'</span><span style="color: #990000">,</span> <span style="color: #FF0000">{</span>id<span style="color: #990000">:</span><span style="color: #993399">123</span><span style="color: #990000">,</span> name<span style="color: #990000">:</span><span style="color: #FF0000">"John Smith"</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #990000">;</span></tt></pre></div></div>
<div class="paragraph"><p>The global method <a href="http://api.jquery.com/jQuery.getJSON/"><span class="monospaced">getJSON()</span></a> retrieves and parses the JSON data from the specified URL and passes the JavaScript object to the specified callback. If need be, you can send the data to the server with the request. Callinf <span class="monospaced">getJSON()</span> is like calling <span class="monospaced">ajax()</span> with parameter <span class="monospaced">dataType: "json"</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getJSON</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/us-states-list.json'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-style: italic"><span style="color: #9A1900">// code to populate states combo goes here})</span></span>
          <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span><span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Request for us states failed"</span><span style="color: #990000">);</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The method <a href="http://api.jquery.com/serialize/"><span class="monospaced">serialize()</span></a> is used when you need to submit to the server a filled out HTML <span class="monospaced">&lt;form&gt;</span>. This method presents the form data as a text sting in a standard URL-encoded notation. Typically, the code finds a required form using jQuery selector and then calls <span class="monospaced">serialize()</span> on this object. But you can invoke <span class="monospaced">serialize()</span> not only on the entire form, but on selected form elements too. Belows is a sample code that finds the form and serializes it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">'form'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">submit</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #000000">alert</span></span><span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">serialize</span></span><span style="color: #990000">());</span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Later in this chapter in the section Submitting Donate Form you&#8217;ll see a code that uses <span class="monospaced">serialize()</span> method.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_save_sick_child_with_jquery_2">Save Sick Child With jQuery</h3>
<div class="paragraph"><p>In this section we&#8217;ll review code samples from several Aptana projects that are jQuery re-writes of the corresponding pure-JavaScript projects from Chapters 3 and 4. We are not going to add any new functionality - the goal is to demonstrate how jQuery allows you to achieve the same results with writing less code.</p></div>
<div class="sect3">
<h4 id="_login_and_donate">Login and Donate</h4>
<div class="paragraph"><p>For example, the file main.js from project-02-jQuery-Login is 33% less in size than project-02-login. jQuery is brief. For example, the next code shows how six lines of code in JavaScript can be replaced with one - the jQuery function <span class="monospaced">toggle()</span> will toggle the visibility of <span class="monospaced">login-link</span>, <span class="monospaced">login-form</span>, and <span class="monospaced">login-submit</span>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showLoginForm</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

<span style="font-style: italic"><span style="color: #9A1900">// The JavaScript way</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// var loginLink = document.getElementById("login-link");</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// var loginForm = document.getElementById("login-form");</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// var loginSubmit = document.getElementById('login-submit');</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// loginLink.style.display = "none";</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// loginForm.style.display = "block";</span></span>
<span style="font-style: italic"><span style="color: #9A1900">// loginSubmit.style.display = "block";</span></span>


<span style="font-style: italic"><span style="color: #9A1900">// The jQuery way</span></span>
$<span style="color: #990000">(</span><span style="color: #FF0000">'#login-link, #login-form, #login-submit'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toggle</span></span><span style="color: #990000">();</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>The code of the Donation section also becomes slimmer with jQuery. For example, the following section from the JavaScript version of the application is removed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateBotton <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donate-button'</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donationAddress <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donation-address'</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateFormContainer <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donate-form-container'</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> customAmount <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'customAmount'</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateForm <span style="color: #990000">=</span> document<span style="color: #990000">.</span>forms<span style="color: #990000">[</span><span style="color: #FF0000">'_xclick'</span><span style="color: #990000">];</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donateLaterLink <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'donate-later-link'</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>The jQuery method chaining allows combining (in one line) finding DOM objects and acting upon them. The following is the entire code of the main.js from project-02-01-jQuery-make-donation, which includes the initial version of the code of Login and Donate sections of Save Sick Child.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">/* --------- login section -------------- */</span></span>

$<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showLoginForm</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'#login-link, #login-form, #login-submit'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toggle</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  $<span style="color: #990000">(</span><span style="color: #FF0000">'#login-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showLoginForm<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showAuthorizedSection</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'#authorized, #login-form, #login-submit'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toggle</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">logIn</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userNameValue <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#username'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userNameValueLength <span style="color: #990000">=</span> userNameValue<span style="color: #990000">.</span>length<span style="color: #990000">;</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userPasswordValue <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#password'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">();</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> userPasswordLength <span style="color: #990000">=</span> userPasswordValue<span style="color: #990000">.</span>length<span style="color: #990000">;</span>

        <span style="font-style: italic"><span style="color: #9A1900">//check credentials</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValueLength <span style="color: #990000">==</span> <span style="color: #993399">0</span> <span style="color: #990000">||</span> userPasswordLength <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValueLength <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'username is empty'</span><span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userPasswordLength <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'password is empty'</span><span style="color: #990000">);</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValue <span style="color: #990000">!=</span> <span style="color: #FF0000">'admin'</span> <span style="color: #990000">||</span> userPasswordValue <span style="color: #990000">!=</span> <span style="color: #FF0000">'1234'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'username or password is invalid'</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>userNameValue <span style="color: #990000">==</span> <span style="color: #FF0000">'admin'</span> <span style="color: #990000">&amp;&amp;</span> userPasswordValue <span style="color: #990000">==</span> <span style="color: #FF0000">'1234'</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                <span style="font-weight: bold"><span style="color: #000000">showAuthorizedSection</span></span><span style="color: #990000">();</span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  $<span style="color: #990000">(</span><span style="color: #FF0000">'#login-submit'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> logIn<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">logOut</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'#username, #password'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">)</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'#authorized, #login-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toggle</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>

  $<span style="color: #990000">(</span><span style="color: #FF0000">'#logout-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> logOut<span style="color: #990000">);</span>

  $<span style="color: #990000">(</span><span style="color: #FF0000">'#profile-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Profile link was clicked'</span><span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span>

<span style="font-style: italic"><span style="color: #9A1900">/* --------- make donation module start -------------- */</span></span>
$<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> checkedInd <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// initially checked radiobutton</span></span>


  <span style="font-style: italic"><span style="color: #9A1900">// Show/hide the donation form if the user clicks</span></span>
  <span style="font-style: italic"><span style="color: #9A1900">// on the button Donate or the Donate Later</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showHideDonationForm</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'#donation-address, #donate-form-container'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">toggle</span></span><span style="color: #990000">();</span>
  <span style="color: #FF0000">}</span>
  $<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-button'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showHideDonationForm<span style="color: #990000">);</span>
  $<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-later-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> showHideDonationForm<span style="color: #990000">);</span>
  <span style="font-style: italic"><span style="color: #9A1900">// End of show/hide section</span></span>

  $<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-form-container'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> resetOtherAmount<span style="color: #990000">);</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">resetOtherAmount</span></span><span style="color: #990000">(</span>event<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>event<span style="color: #990000">.</span>target<span style="color: #990000">.</span>type <span style="color: #990000">==</span> <span style="color: #FF0000">"radio"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                $<span style="color: #990000">(</span><span style="color: #FF0000">'#otherAmount'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>

  <span style="font-style: italic"><span style="color: #9A1900">//uncheck selected radio buttons if other amount was chosen</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">onOtherAmountFocus</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> radioButtons <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'form[name="_xclick"] input:radio'</span><span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'#otherAmount'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #990000">==</span> <span style="color: #FF0000">''</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                checkedInd <span style="color: #990000">=</span> radioButtons<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">index</span></span><span style="color: #990000">(</span>radioButtons<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">filter</span></span><span style="color: #990000">(</span><span style="color: #FF0000">':checked'</span><span style="color: #990000">));</span>
        <span style="color: #FF0000">}</span>
        $<span style="color: #990000">(</span><span style="color: #FF0000">'form[name="_xclick"] input:radio'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">prop</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'checked'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
  <span style="color: #FF0000">}</span>

  <span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">onOtherAmountBlur</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>$<span style="color: #990000">(</span><span style="color: #FF0000">'#otherAmount'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">val</span></span><span style="color: #990000">()</span> <span style="color: #990000">==</span> <span style="color: #FF0000">''</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                $<span style="color: #990000">(</span><span style="color: #FF0000">'form[name="_xclick"] input:radio:eq('</span> <span style="color: #990000">+</span> checkedInd <span style="color: #990000">+</span> <span style="color: #FF0000">')'</span><span style="color: #990000">)</span>
                                     <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">prop</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"checked"</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">);</span>     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span>
  $<span style="color: #990000">(</span><span style="color: #FF0000">'#otherAmount'</span><span style="color: #990000">)</span>
      <span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>focus<span style="color: #990000">:</span>onOtherAmountFocus<span style="color: #990000">,</span> blur<span style="color: #990000">:</span>onOtherAmountBlur<span style="color: #FF0000">}</span><span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>

<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
This one liner finds all elements of the form named <span class="monospaced">_xclick</span>, and immediately applies the jQuery filter to remove from this collection any elements except radiobuttons. Then it unchecks all of them by setting the property <span class="monospaced">checked</span> to <span class="monospaced">false</span>.  This has to be done if the user places the focus inside the  "Other amount" field.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
If the user leaves the "Other amount" return the check the previously selected radiobutton again. The <span class="monospaced">eq</span> filter picks the radiobutton whose number is equal to the value of the variable <span class="monospaced">checkedInd</span>.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
A single invocation of the <span class="monospaced">on()</span> method registers two event handlers: one for the <span class="monospaced">focus</span> and one for the <span class="monospaced">blur</span> event.
</td></tr>
</table></div>
<div class="paragraph"><p>jQuery includes <a href="http://api.jquery.com/category/effects/">a number of effects</a> that make the user experience more engaging. Let&#8217;s use one of them called <span class="monospaced">fadeToggle()</span>. In the code above there is a section that toggles visibility of the Donate form. If the user clicks on the Donate button, the form becomes visible (see <a href="#FIG3-11">[FIG3-11]</a>). If the user clicks on the link "I&#8217;ll donate later", the form becomes hidden as in <a href="#FIG3-10">[FIG3-10]</a>. The jQuery method <span class="monospaced">toggle()</span> does its job, but the change happens abruptly. The effect <span class="monospaced">fadeToggle()</span> allows to introduce slower fading which improves the user experience, at least to our taste.</p></div>
<div class="paragraph"><p>If the code would hide/show just one component, the code change would be trivial - replacing <span class="monospaced">toggle()</span> with <span class="monospaced">fadeToggle('slow')</span> would do the trick.  But in our case, the toggle changes visibility of two <span class="monospaced">&lt;div&gt;'s</span>: <span class="monospaced">donation-address</span> and <span class="monospaced">donation-form-container</span>, which should happen in a certain order. The code below is a replacement of the show/hide section in the main.js to introduce the fading effect.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">showHideDonationForm</span></span><span style="color: #990000">(</span>first<span style="color: #990000">,</span> next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        first<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fadeToggle</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'slow'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
                next<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fadeToggle</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'slow'</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donAddress <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#donation-address'</span><span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> donForm <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-form-container'</span><span style="color: #990000">);</span>

$<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-button'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">showHideDonationForm</span></span><span style="color: #990000">(</span>donAddress<span style="color: #990000">,</span> donForm<span style="color: #990000">)</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span>

$<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-later-link'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'click'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">showHideDonationForm</span></span><span style="color: #990000">(</span>donForm<span style="color: #990000">,</span> donAddress<span style="color: #990000">)</span><span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>If you want to see the difference, first run the Aptana&#8217;s project-02-01-jQuery-make-donation and click on the Donate button (no effects), and then run project-04-jQuery-donation-ajax-json, which has the fading effect.</p></div>
</div>
<div class="sect3">
<h4 id="_html_states_and_countries_with_jquery_ajax">HTML States and Countries With jQuery AJAX</h4>
<div class="paragraph"><p>The Aptana project project-03-jQuery-donation-ajax-html illustrates retrieving the HTML data about the states and countries using jQuery method <span class="monospaced">load()</span>. Here&#8217;s the fragment from main.js that makes two <span class="monospaced">load()</span> calls. The second call purposely misspells the name of the file</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">,</span> target<span style="color: #990000">,</span> selectionPrompt<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  target<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">,</span>
              <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span> status<span style="color: #990000">,</span> xhr<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>               <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>status <span style="color: #990000">!=</span> <span style="color: #FF0000">"error"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
           target<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">prepend</span></span><span style="color: #990000">(</span>selectionPrompt<span style="color: #990000">);</span>                       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
           console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Status: '</span> <span style="color: #990000">+</span> status <span style="color: #990000">+</span> <span style="color: #FF0000">' '</span> <span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>statusText<span style="color: #990000">);</span>

           <span style="font-style: italic"><span style="color: #9A1900">// Show the error message on the Web page</span></span>
           <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> tempContainerHTML <span style="color: #990000">=</span> <span style="color: #FF0000">'&lt;p class="error"&gt;Error getting '</span> <span style="color: #990000">+</span> dataUrl <span style="color: #990000">+</span>
           <span style="color: #FF0000">": "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>statusText <span style="color: #990000">+</span> <span style="color: #FF0000">", code: "</span><span style="color: #990000">+</span> xhr<span style="color: #990000">.</span>status <span style="color: #990000">+</span> <span style="color: #FF0000">"&lt;/p&gt;"</span><span style="color: #990000">;</span>

       $<span style="color: #990000">(</span><span style="color: #FF0000">'#temp-project-name-container'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">append</span></span><span style="color: #990000">(</span>tempContainerHTML<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
        <span style="color: #FF0000">}</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> statePrompt <span style="color: #990000">=</span>
         <span style="color: #FF0000">'&lt;option value="" selected="selected"&gt; - State - &lt;/option&gt;'</span><span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/us-states.html'</span><span style="color: #990000">,</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#state'</span><span style="color: #990000">),</span> Prompt<span style="color: #990000">);</span>

<span style="font-weight: bold"><span style="color: #0000FF">var</span></span> countryPrompt <span style="color: #990000">=</span>
         <span style="color: #FF0000">'&lt;option value="" selected="selected"&gt; - Country - &lt;/option&gt;'</span><span style="color: #990000">;</span>

<span style="font-style: italic"><span style="color: #9A1900">// Pass the wrong data URL on purpose</span></span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'da----ta/countries.html'</span><span style="color: #990000">,</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#counriesList'</span><span style="color: #990000">),</span> countryPrompt<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The callback to be invoked right after the <span class="monospaced">load()</span> completes the request.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Using jQuery method <span class="monospaced">prepend()</span> insert the very first element to HTML &lt;select&gt; to prompt the user to select a state or a country.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Display an error message at the bottom of the Web page in the <span class="monospaced">&lt;div&gt;</span> with ID <span class="monospaced">temp-project-name-container</span>.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Pass the misspelled data URL to generate error message.
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_json_states_and_countries_with_jquery_ajax">JSON States and Countries With jQuery AJAX</h4>
<div class="paragraph"><p>The Aptana project named project-04-jQuery-donation-ajax-json demonstrates how to make a jQuery <span class="monospaced">ajax()</span> call to retrieve the JSON data about countries and states and populate the respective comboboxes in the donation form.  The function <span class="monospaced">loadData()</span> in the following code fragment takes three arguments: the data URL, the name of the root element in the JSON file and the target HTML element to be populated with the data retrieved from the AJAX call.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span>dataUrl<span style="color: #990000">,</span> rootElement<span style="color: #990000">,</span> target<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
  $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ajax</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>
        url<span style="color: #990000">:</span> dataUrl<span style="color: #990000">,</span>
        type<span style="color: #990000">:</span> <span style="color: #FF0000">'GET'</span><span style="color: #990000">,</span>
        cache<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">,</span>
        timeout<span style="color: #990000">:</span> <span style="color: #993399">5000</span><span style="color: #990000">,</span>                                         <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
        dataType<span style="color: #990000">:</span> <span style="color: #FF0000">'json'</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">done</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                                            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> optionsHTML <span style="color: #990000">=</span> <span style="color: #FF0000">''</span><span style="color: #990000">;</span>
        $<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">each</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span>rootElement<span style="color: #990000">],</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>index<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                optionsHTML<span style="color: #990000">+=</span><span style="color: #FF0000">'&lt;option value="'</span><span style="color: #990000">+</span>data<span style="color: #990000">[</span>rootElement<span style="color: #990000">][</span>index<span style="color: #990000">].</span>code<span style="color: #990000">+</span><span style="color: #FF0000">'"&gt;'</span> <span style="color: #990000">+</span>
                                       data<span style="color: #990000">[</span>rootElement<span style="color: #990000">][</span>index<span style="color: #990000">].</span>name<span style="color: #990000">+</span><span style="color: #FF0000">'&lt;/option&gt;'</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">);</span>

        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> targetCurrentHTML <span style="color: #990000">=</span> target<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">();</span>                            <span style="font-style: italic"><span style="color: #9A1900">//  <img src="images/icons/callouts/3.png" alt="3"></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> targetNewHTML <span style="color: #990000">=</span> targetCurrentHTML <span style="color: #990000">+</span> optionsHTML<span style="color: #990000">;</span>
        target<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">html</span></span><span style="color: #990000">(</span>targetNewHTML<span style="color: #990000">);</span>
  <span style="color: #FF0000">}</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="color: #990000">(</span>jqXHR<span style="color: #990000">,</span> textStatus<span style="color: #990000">,</span> error<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>

        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'AJAX request failed: '</span> <span style="color: #990000">+</span> error <span style="color: #990000">+</span>
                        <span style="color: #FF0000">". Code: "</span> <span style="color: #990000">+</span> jqXHR<span style="color: #990000">.</span>status<span style="color: #990000">);</span>

        <span style="font-style: italic"><span style="color: #9A1900">// The code to display the error in the</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">// browser's window goes here</span></span>
  <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span>

<span style="font-style: italic"><span style="color: #9A1900">// Load the State and Country comboboxes</span></span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/us-states-list.json'</span><span style="color: #990000">,</span>                           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
                         <span style="color: #FF0000">'usstateslist'</span><span style="color: #990000">,</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#state'</span><span style="color: #990000">));</span>
<span style="font-weight: bold"><span style="color: #000000">loadData</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'data/counries-list.json'</span><span style="color: #990000">,</span>                            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/6.png" alt="6"></span></span>
                         <span style="color: #FF0000">'countrieslist'</span><span style="color: #990000">,</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'#counriesList'</span><span style="color: #990000">));</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Set the timeout. If the result of the <span class="monospaced">ajax()</span> call won&#8217;r return within 5 second, the method <span class="monospaced">fail()</span> will be invoked.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The handler function to process the successfully retrieved data
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Get the content of the HTML <span class="monospaced">&lt;select&gt;</span> element to populate with states or countries. The jQuery method <span class="monospaced">html()</span> uses the browser&#8217;s <span class="monospaced">innerHTML</span> property.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
The handler function to process errors, if any
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Calling <span class="monospaced">loadData()</span> to retrieve states and populate the <span class="monospaced">#state</span> combobox. The <span class="monospaced">usstatelist</span> is the name of the root element in the json file us-states-list.json.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
Calling <span class="monospaced">loadData()</span> to retrieve countries and populate the <span class="monospaced">#countriesList</span> combobox
</td></tr>
</table></div>
<div class="paragraph"><p>Compare this code with the pure JavaScript version from Chapter 4 that populates states and countries. If the jQuery code doesn&#8217;t seem to be shorter, keep in mind that to writing a cross-browser version in pure JavaScript would require more than a dozen of additional lines of code that deal with instantiation of <span class="monospaced">XMLHttpRequest</span>.</p></div>
<div class="paragraph"><p>Run the project-04-jQuery-donation-ajax-json and open Google Developer Tools and click on the Network tab. From <a href="#FIG5-2">[FIG5-2]</a> you can see that jQuery made two successful calls retrieving two JSON files with the data on states and countries.</p></div>
<div class="imageblock" id="FIG5-2">
<div class="content">
<img src="images/fig_05_2.png" alt="images/fig_05_2.png">
</div>
<div class="title">Figure 53. Calling ajax() to retrieve states and countries</div>
</div>
<div class="paragraph"><p>Click on the the countries-list on the left (see <a href="#FIG5-3">[FIG5-3]</a>) and you&#8217;ll see the JSON data in the response object.</p></div>
<div class="imageblock" id="FIG5-3">
<div class="content">
<img src="images/fig_05_3.png" alt="images/fig_05_3.png">
</div>
<div class="title">Figure 54. The JSON with countries is successfully retrieved</div>
</div>
<div class="paragraph"><p>Now let&#8217;s create an error situation to test the <span class="monospaced">$.ajax().fail()</span> chain. Just change the name of the first parameter to be <span class="monospaced">data/counries.json</span> in the <span class="monospaced">loadData()</span> invocation. There is no such file and the AJAX call will return the error 404 - see the Watch expressions in <a href="#FIG5-4">[FIG5-4]</a> that depicts the moment when the script execution stopped at the breakpoint in the <span class="monospaced">fail()</span> method.</p></div>
<div class="imageblock" id="FIG5-4">
<div class="content">
<img src="images/fig_05_04.png" alt="images/fig_05_04.png">
</div>
<div class="title">Figure 55. The file counries.json is not found: 404</div>
</div>
</div>
<div class="sect3">
<h4 id="_submitting_donate_form">Submitting Donate Form</h4>
<div class="paragraph"><p>Our Save Sick Child application submits the donation form to Paypal.com. The file index.html from Aptana&#8217;s project project-04-jQuery-donation-ajax-json contains the form with <span class="monospaced">id="donate-form"</span>. The fragment of this form is shown below.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-form"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"_xclick"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"https://www.paypal.com/cgi-bin/webscr"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"cmd"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"_xclick"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"business"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"email-registered-in-paypal@site-url.com"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"item_name"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Donation"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"hidden"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"currency_code"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"USD"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-form-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Please select or enter
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;br/&gt;</span></span>
                        donation amount<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "amount"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"d10"</span> <span style="color: #009900">value</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "10"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span> <span style="color: #990000">=</span><span style="color: #FF0000"> "d10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>10<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
       ...

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-form-section"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Donor information<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"text"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"full_name"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"full_name"</span>
                                         <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"full name *"</span> <span style="color: #009900">required</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"email"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"email_addr"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"email_addr"</span>
                                             <span style="color: #009900">placeholder</span><span style="color: #990000">=</span><span style="color: #FF0000">"email *"</span> <span style="color: #009900">required</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        ...
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-form-section make-payment"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4&gt;</span></span>We accept Paypal payments<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>
                        Your payment will processed securely by <span style="font-weight: bold"><span style="color: #0000FF">&lt;b&gt;</span></span>PayPal<span style="font-weight: bold"><span style="color: #0000FF">&lt;/b&gt;</span></span>.
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
        ...
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;button</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-button donate-button-submit"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/button&gt;</span></span>
        ...
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>If you simply want to submit this form to the URL listed in its <span class="monospaced">action</span> property when the user clicks on the button submit, there is nothing else that has to be done. This already works and Paypal&#8217;s login page opens up in the browser. But if you wanted to seamlessly integrate your page with Paypal or any other third-party service, a preferred way is not to send the user to the third-party Web site, but do it without leaving your Web application.  We won&#8217;t be implementing such integration with Paypal here, but technically it would be possible to pass the user&#8217;s credentials and bank information to charge the donor of Save Sick Child without even opening the Paypal Web page in the browser. To do this, you&#8217;d need to submit the form using AJAX and Paypal API with processing the results of this transaction using the standardAJAX techniques.</p></div>
<div class="paragraph"><p>To post the form to a specified URL using jQuery AJAX we&#8217;ll serialize the data from the form on <span class="monospaced">submit</span> event. The code fragment from main.js finds the form with ID <span class="monospaced">donate-form</span> and chains to it the <span class="monospaced">submit()</span> method passing to it a callback that will prepare the data and make an AJAX call. We are using the method <span class="monospaced">submit()</span> instead of attaching an event handler to process clicks on the button donate for a good reason - the method <span class="monospaced">submit()</span> will be invoked not only on the Submit button click event, but when the user presses the Enter key while the cursor is in one of the form&#8217;s input fields.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$<span style="color: #990000">(</span><span style="color: #FF0000">'#donate-form'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">submit</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
  <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> formData <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">serialize</span></span><span style="color: #990000">();</span>
  console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The Donation form is serialized:"</span> <span style="color: #990000">+</span> formData<span style="color: #990000">);</span>
  <span style="font-style: italic"><span style="color: #9A1900">// Make an AJAX call here and pass the data to the server</span></span>

  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="paragraph"><p>Run project project-04-jQuery-donation-ajax-json and open Firebug. Then fill out the donation form as shown in <a href="#FIG5-5">[FIG5-5]</a>:</p></div>
<div class="imageblock" id="FIG5-5">
<div class="content">
<img src="images/fig_05_05.png" alt="images/fig_05_05.png">
</div>
<div class="title">Figure 56. Donation Form</div>
</div>
<div class="paragraph"><p>Now press the Enter key and you&#8217;ll see the output in the Firebug&#8217;s console with the serialized form data that will look like this:</p></div>
<div class="paragraph"><p><em>"The Donation form is serialized: cmd=_xclick&amp;business=email-registered-in-paypal%40site-url.com&amp;item_name=Donation&amp;currency_code=USD&amp;amount=50&amp;amount=&amp;full_name=Alex+Smith&amp;
email_addr=asmith%40gmail.com&amp;street_address=123+Broadway&amp;scty=New+York&amp;zip=10013&amp;
state=NY&amp;country=US"</em></p></div>
<div class="paragraph"><p>TODO: add the code sample from SSC</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_plugins">Plugins</h3>
<div class="paragraph"><p>jQuery plugins are reusable components that know how to do a certain thing, for example validate a form or display images as a slide show. There are thousands of third-party jQuery plugins available in the <a href="http://plugins.jquery.com/">jQuery Plugin Registry</a>. Below are some of the useful plugins:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.jtable.org/">jTable</a> - AJAX-based tables (grids) for CRUD applications. This is a must have if you use jQuery for enterprise Web development
</p>
</li>
<li>
<p>
<a href="http://jquery.malsup.com/form/">jQuery Form</a> - an HTML form that supports AJAX
</p>
</li>
<li>
<p>
<a href="http://sebnitu.github.com/HorizontalNav/">HorisontalNav</a> - a navigational bar with tabs that uses the full width of its container
</p>
</li>
<li>
<p>
<a href="http://www.egrappler.com/a-stylo-modern-jquery-accordion-akordeon/">EGrappler</a> - a stylish Akordeon (collapsible panel)
</p>
</li>
<li>
<p>
<a href="http://paweldecowski.github.com/jQuery-CreditCardValidator/">http://paweldecowski.github.com/jQuery-CreditCardValidator/</a> [Credit Card Validator] - detects and validates credit card numbers
</p>
</li>
<li>
<p>
<a href="https://github.com/filamentgroup/responsive-carousel/">Responsive Carousel</a> - a slider to display images in a carousel fashion
</p>
</li>
<li>
<p>
<a href="http://www.oesmith.co.uk/morris.js/">morris.js</a> - a plugin for charting
</p>
</li>
<li>
<p>
<a href="http://www.welancers.com/jquery-map-marker-plugin/">Map Marker</a> - puts multiple markers on maps using Google MAP API V3.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">The <a href="https://github.com/tuupola/jquery_lazyload">Lazy Load plugin</a> delays loading of images, which are outside of viewports.</td>
</tr></table>
</div>
<div class="paragraph"><p>The chances are that you will be able to find a plugin written by someone that fits your needs. jQuery plugins are usually freely available and their source code is plain JavaScript, so you can tweak it a litlle too if need be.</p></div>
<div class="sect3">
<h4 id="_validating_the_donate_form_with_plugin">Validating the Donate Form With Plugin</h4>
<div class="paragraph"><p>The Aptana&#8217;s project-14-jQuery-validate illustrates the use of the jQuery <a href="http://docs.jquery.com/Plugins/Validation">validate</a> plugin, which allows you to specify the rules to be checked when the user tries to submit the form. If the value is not valid, your custom message is displayed. We&#8217;ve included this plugin in index.html of project-14-jQuery-validate:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;script</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"js/plugins/jquery.validate.min.js"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/script&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>To validate a form with this plugin, you need to invoke a jQuery selector finding the form and then call the method <span class="monospaced">validate()</span> on this object - this is a simplest way of using this plugin.  But to have more control over the validation process you need to pass the object with validation options:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    $<span style="color: #990000">(</span><span style="color: #FF0000">"#myform"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">validate</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span><span style="font-style: italic"><span style="color: #9A1900">// validation options go here});</span></span></tt></pre></div></div>
<div class="paragraph"><p>The file main.js includes the code to validate the Donation form. The validation options can include many options described in the plugin documentation. Our code sample uses the following options:</p></div>
<div class="ulist"><ul>
<li>
<p>
the <span class="monospaced">highlight</span> and <span class="monospaced">unhighlight</span> callbacks
</p>
</li>
<li>
<p>
the HTML element to be used for displaying errors
</p>
</li>
<li>
<p>
the name of the CSS class to style the error messages
</p>
</li>
<li>
<p>
the validation rules
</p>
</li>
</ul></div>
<div class="paragraph"><p>The code fragment below displays error messages in the HTML element <span class="monospaced">&lt;div id="validationSummary"&gt;&lt;/div&gt;</span>  that&#8217;s placed above the form in index.html. The Validator plugin provides the number of invalid form entries by invoking <span class="monospaced">validator.numberOfInvalids()</span>, and our code displays this number unless it&#8217;s equal to zero.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> validator <span style="color: #990000">=</span> $<span style="color: #990000">(</span><span style="color: #FF0000">'form[name="_xclick"]'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">validate</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>

        highlight <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>target<span style="color: #990000">,</span> errorClass<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
                $<span style="color: #990000">(</span>target<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">addClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"invalidElement"</span><span style="color: #990000">);</span>
                $<span style="color: #990000">(</span><span style="color: #FF0000">"#validationSummary"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span>validator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">numberOfInvalids</span></span><span style="color: #990000">()</span> <span style="color: #990000">+</span>
                                                       <span style="color: #FF0000">" field(s) are invalid"</span><span style="color: #990000">);</span>
                $<span style="color: #990000">(</span><span style="color: #FF0000">"#validationSummary"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">show</span></span><span style="color: #990000">();</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

        unhighlight <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>target<span style="color: #990000">,</span> errorClass<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                 <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
                $<span style="color: #990000">(</span>target<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">removeClass</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"invalidElement"</span><span style="color: #990000">);</span>

                <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> errors <span style="color: #990000">=</span> validator<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">numberOfInvalids</span></span><span style="color: #990000">();</span>
                $<span style="color: #990000">(</span><span style="color: #FF0000">"#validationSummary"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">(</span> errors <span style="color: #990000">+</span> <span style="color: #FF0000">" field(s) are invalid"</span><span style="color: #990000">);</span>

                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>errors <span style="color: #990000">==</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
                        $<span style="color: #990000">(</span><span style="color: #FF0000">"#validationSummary"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">hide</span></span><span style="color: #990000">();</span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

        rules <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>                                                   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
                full_name <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        required <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                        minlength <span style="color: #990000">:</span> <span style="color: #993399">2</span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                email_addr <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                        required <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">,</span>
                        email <span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
                <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                zip <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                         digits<span style="color: #990000">:</span><span style="font-weight: bold"><span style="color: #0000FF">true</span></span>
                <span style="color: #FF0000">}</span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>

                messages <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>                                            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
                         full_name<span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                required<span style="color: #990000">:</span> <span style="color: #FF0000">"Name is required"</span><span style="color: #990000">,</span>
                minlength<span style="color: #990000">:</span> <span style="color: #FF0000">"Name should have at least 2 letters"</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
                        email_addr <span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                                required <span style="color: #990000">:</span> <span style="color: #FF0000">"Email is required"</span><span style="color: #990000">,</span>
                        <span style="color: #FF0000">}</span>
                <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
When the invalid field will be highlighted, this function will be invoked. It changes the styling of the input field and updates the error count to display in the validation summary <span class="monospaced">&lt;div&gt;</span> on top  of the form.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
When the error is fixed, the corrected field will be unhighlighted, and this function will be invoked. It revokes the error styling of the input field and updates the error count. If the error count is zero, the validation summary <span class="monospaced">&lt;div&gt;</span> becomes hidden.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Set the custom validation rules for selected form fields
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Set the custom error messages to be displayed if the user enters invalid data.
</td></tr>
</table></div>
<div class="paragraph"><p><a href="#FIG5-6">[FIG5-6]</a> shows the above code in action. After entering a one-character name and missing an email the user will see the corresponding error messages. These messages won&#8217;t be shown until the user submits the form. But as soon as the user will fix any of them (e.g. enter one more letter in the name) the form will be immediately re-validated and the error messages will be removed as soon as the user fix the error.</p></div>
<div class="imageblock" id="FIG5-6">
<div class="content">
<img src="images/fig_05_06.png" alt="images/fig_05_06.png">
</div>
<div class="title">Figure 57. Validator&#8217;s Error Messages</div>
</div>
</div>
<div class="sect3">
<h4 id="_todo_adding_image_slider">TODO Adding Image Slider</h4>
<div class="paragraph"><p>Before including a jQuery plugin to your application spend some time testing it - check its size and compare its performance with competing plugins.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">If you can&#8217;t find a plugin that fits your needs or have specific custom logic that needs to be used or reused in your application.  Should you decide to write a plugin on your own, refer to the <a href="http://docs.jquery.com/Plugins/Authoring">Plugins/Authoring</a> document.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_5">Summary</h3>
<div class="paragraph"><p>In this chapter you became familiar with the jQuery Core library, which became the de-facto standard library in millions Web applications. Its simplicity and extensibility via the mechanism of plugins made it a must have in almost every Web page. Even if your organization standardizes decides on a more complex and feature-rich JavaScript framework, the chances are that you may find a handy jQuery plugin that fill complement "the main" framework and made it into the code of your application. There is nothing wrong with this and you shouldn&#8217;t be in the position of "either jQuery or XYZ" - they can coexist in your Web application. In Chapter 12 you&#8217;ll learn how to use jQuery Mobile library.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_driven_development_with_javascript">Test-Driven Development with JavaScript</h2>
<div class="sectionbody">
<div class="quoteblock">
<div class="content">To shorten the development cycle of your Web application you need to start testing it on the early stages of the project. It seems obvious, but many enterprise IT organizations haven&#8217;t adopted the agile testing methodologies, which costs them dearly. JavaScript is dynamically typed interpreted language, which means that there is no compiler to help to identifying errors as it&#8217;s done in compiled languages like Java. This means that for JavaScript Web applications a lot more time should be allocated for testing.</div>
<div class="attribution">
<em>http://twitter.com/bphogan/status/194856922208407552</em><br>
&#8212; @bphogan
</div></div>
<div class="paragraph"><p>To switch to a test-driven development, start with accepting the notion of embedding testing into your development process rather than scheduling testing after the development cycle is complete.</p></div>
<div class="paragraph"><p>In this chapter we&#8217;ll give you a brief overview of selected test frameworks for JavaScript: <a href="http://qunitjs.com/">Qunit</a> and <a href="http://pivotal.github.com/jasmine/">Jasmine</a>. We will cover the basic testing techniques such as "Test-driver development" and "Test First". You&#8217;ll learn how to automate the testing process in multiple browsers with <a href="http://vojtajina.github.com/testacular/">Testacular</a> or by running tests in so called <em>headless</em> mode with <a href="http://phantomjs.org/">PhantomJS</a>. You&#8217;ll learn how to mock and stub selected artifacts of the environment (such as <span class="monospaced">XMLHTTPRequiest</span> object or timer) with <a href="http://sinonjs.org/">Sinon.js</a> and how to unit test the DOM manipulation code.</p></div>
<div class="paragraph"><p>The second part of this chapter is dedicated to setting up a new Save Sick Child project in the IDE
with selected test frameworks.</p></div>
<div class="sect2">
<h3 id="_testing_basics">Testing Basics</h3>
<div class="paragraph"><p>The basic types of testing are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Unit
</p>
</li>
<li>
<p>
Integration
</p>
</li>
<li>
<p>
Functional
</p>
</li>
<li>
<p>
Load
</p>
</li>
</ul></div>
<div class="paragraph"><p>The sections that follow examine the differences between these testing strategies and list the tools that will help you in automation of the testing process.</p></div>
<div class="sect3">
<h4 id="_unit_testing">Unit Testing</h4>
<div class="paragraph"><p>TBD</p></div>
</div>
<div class="sect3">
<h4 id="_integration_testing">Integration Testing</h4>
<div class="paragraph"><p>TBD</p></div>
</div>
<div class="sect3">
<h4 id="_functional_testing">Functional Testing</h4>
<div class="paragraph"><p>TBD</p></div>
</div>
<div class="sect3">
<h4 id="_load_testing">Load Testing</h4>
<div class="paragraph"><p>TBD</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_save_sick_chiled_with_tdd">Save Sick Chiled With TDD</h3>
<div class="paragraph"><p>TBD</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_http_to_websocket">Upgrading HTTP to WebSocket</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter is about moving away from the HTTP protocol to more responsive HTML5 WebSocket. It starts with a brief overview of the existing legacy Web networking, and then you&#8217;ll learn why and how to use HTML5&#8217;s Server-Sent Events (SSE) and WebSockets.</p></div>
<div class="paragraph"><p>The new version of our Save Sick Child application will include the online auction utilizing WebSocket, and you&#8217;ll see an example of using Server-Sent Events for broadcasting the up-to-the-minute donation information. The goal is to let you see the advantages of changing the way of client-server communications on the Web. You&#8217;ll clearly see the advantages of WebSocket over a regular HTTP by monitoring the network traffic with such tools as Wireshark and Google Chrome Developer Tools.</p></div>
<div class="paragraph"><p>All the server-side functionality supporting this chapter is written in Java, using Java API for WebSocket <a href="http://java.net/projects/tyrus">reference implementation</a>, which will be the part of upcoming Java EE 7 specification. We are using the <a href="http://dlc.sun.com.edgesuite.net/glassfish/4.0/promoted/">latest available build of the Glassfish Application Server</a>. If you don&#8217;t know Java, just treat this server-side setup as a service that supports WebSocket protocol. For Java developers interested in diving into the server-side, we&#8217;ll provide the source code and brief comments as a part of the code samples that come with this book.</p></div>
<div class="paragraph"><p>We&#8217;ll show and compare the server-side data push done with Server-Sent Events and WebSocket. Also you&#8217;ll see a brief overview of popular existing frameworks that can streamline your WebSocket application development.</p></div>
<div class="sect2">
<h3 id="_near_real_time_applications_with_http">Near Real Time Applications With HTTP</h3>
<div class="paragraph"><p>The HTTP protocol is the lingua franca of today&#8217;s Web  applications, where client-server communications are based on the request-response paradigm. On the low level, Web browsers establish a TCP/IP connection for each HTTP session. Currently there are 3 basic options that developers use for the browser-server communication: polling, long polling, and streaming. These options are hacks on the top of a half-duplex (a one way street) HTTP protocol to simulate real-time behavior. By <em>real-time</em> we mean the ability to react to some event as it happens. Lets discuss each of them.</p></div>
<div class="sect3">
<h4 id="_polling">Polling</h4>
<div class="paragraph"><p>With <em>polling</em>, your client code sends requests to the server after based on some pre-configured interval (e.g. using JavaScript <span class="monospaced">setInterval()</span> function). Some of the server&#8217;s responses will be empty, if the requested data is not ready yet as illustrated in <a href="#FIG9-1">[FIG9-1]</a>. For example, if you&#8217;re running an online auctions and sends the request to see the updated bids, you won&#8217;t receive any data back unless someone placed a new bid. Visualize a child seating on back seat of your car and asking every minute, "Have we arrived yet?" . And you&#8217;re politely replying, "Not just yet" - this is similar to an empty server response. There is no valuable payload for this kid, but she&#8217;s still receiving some "metadata". HTTP polling may result in receiving verbose HTTP response headers bearing no data load, let alone destructing the driver (think the server) from performing other responsibilities.</p></div>
<div class="paragraph" id="FIG9-1"><div class="title">Polling</div><p><span class="image">
<img src="images/fig_09_01.png" alt="image">
</span></p></div>
</div>
<div class="sect3">
<h4 id="_long_polling">Long Polling</h4>
<div class="paragraph"><p><em>Long polling</em> (see <a href="#FIG9-2">[FIG9-2]</a> ) starts similarly to polling: the client sends the HTTP request to the server. But in this case instead of sending an empty response back, the server waits till the data for the client becomes available. If the requested information is not available within the specified time interval, the server sends an empty response to the client, closes, and re-establishes the connection.</p></div>
<div class="paragraph"><p>We&#8217;ll give you one more analogy to compare polling and long polling. Imagine a party at the top floor of a building equipped with a smart elevator that goes up every minute and opens the door just in case if one of the guests wants to go down to smoke a cigarette. If no one enters the elevator, it goes to the ground level and in 60 seconds goes up again. This is the polling scenario. But if this elevator would go up, and waited till someone would actually decide to go down, then we could call it a long polling mode.</p></div>
<div class="paragraph"><p>From the HTTP specification perspective this hack is legit: the long polling mode may seem as if we deal with the slow-responding server. That is why this technique also referred as <em>Hanging GET</em>. If you see an online auction that automatically modifies the prices as people bid on items it looks as if the server pushes the data to you. But the chances are, this functionality was implemented using long polling, which is not a real server-side data push, but its emulation.</p></div>
<div class="paragraph" id="FIG9-2"><div class="title">Long Polling</div><p><span class="image">
<img src="images/fig_09_02.png" alt="image">
</span></p></div>
</div>
<div class="sect3">
<h4 id="_http_streaming">HTTP Streaming</h4>
<div class="paragraph"><p>The client sends the request for data. As soon as the server gets the data ready, it starts streaming (adding more and more data to the response object) without closing the connections. The server pushes the data to the client pretending that the response never ends <a href="#FIG9-3">[FIG9-3]</a>. For example, requesting a video from Youtube.com results in streaming data (frame after frame) without closing the HTTP connection.</p></div>
<div class="paragraph" id="FIG9-3"><div class="title">HTTP Streaming</div><p><span class="image">
<img src="images/fig_09_03.png" alt="image">
</span></p></div>
<div class="paragraph"><p>Polling and streaming can be used as a fall-back for legacy browsers that don&#8217;t support the HTML5 APIs <em>Server-Sent Events</em> and <em>WebSocket</em>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_server_sent_events">Server-Sent Events</h3>
<div class="paragraph"><p>Before diving into the WebSocket protocol lets get familiar with the standardized way of implementing  <a href="http://dev.w3.org/html5/eventsource/">Server-Sent Events</a>. W3C introduces API for Web browsers and the <span class="monospaced">EventSource</span> object. SSE allows browsers to subscribe to the server events arriving in the form of DOM events. The following code snippet shows the JavaScript code that can be used in a Web browser.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> source<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span> <span style="color: #990000">!!</span> window<span style="color: #990000">.</span>EventSource<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    source <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">EventSource</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:8080/donate_web/api/donations/events'</span><span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// notify use that her browser doesn't support SSE</span></span>
<span style="color: #FF0000">}</span>

source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'open'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// Connection was opened.</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>

source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'create'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                 <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// do something with data</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>

source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'update'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>                 <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
    <span style="font-style: italic"><span style="color: #9A1900">// do something with data</span></span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>

source<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'error'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>e<span style="color: #990000">.</span>readyState <span style="color: #990000">==</span> EventSource<span style="color: #990000">.</span>CLOSED<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-style: italic"><span style="color: #9A1900">// Connection was closed.</span></span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Create a new <span class="monospaced">EventSource</span> object. At this point the browser will send the <span class="monospaced">GET</span> request to the specified server-side endpoint to register itself on the server.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Add handlers for the <span class="monospaced">open</span> and <span class="monospaced">error</span> events.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Handle messages in <span class="monospaced">create</span> events.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Handle messages in <span class="monospaced">update</span> events.
</td></tr>
</table></div>
<div class="paragraph"><p>Using SSE is a good technique for the use cases when the client doesn&#8217;t need to send the data to the server. In the above example the server sends two types of custom events <span class="monospaced">create</span> and <span class="monospaced">update</span> to notify subscribed clients about updated donation data so the active clients can monitor the fund-raising process. We can create as many custom events as needed by the application.</p></div>
<div class="paragraph"><p>SSE is still HTTP-based, and it requires the server&#8217;s support of the combination of HTTP 1.1 keep-alive connections and the <span class="monospaced">text/event-stream</span> content type in HTTP response. The overhead is minimal - instead of hundreds of bytes in request and response headers, the server sends only the responses when the data has changed.</p></div>
</div>
<div class="sect2">
<h3 id="_introducing_the_websocket">Introducing The WebSocket</h3>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Reducing kilobytes of data to 2 bytes is more than "a little more byte efficient", and reducing latency from 150ms (TCP round trip to set up the connection plus a packet for the message) to 50ms (just the packet for the message) is far more than marginal. In fact, these two factors alone are enough to make WebSocket seriously interesting to Google.</p></div>
<div class="paragraph"><p>source: <a href="http://ietf.org/mail-archive/web/hybi/current/msg00784.html">http://ietf.org/mail-archive/web/hybi/current/msg00784.html</a></p></div>
</div>
<div class="attribution">
<em>Ian Hickson</em><br>
&#8212; HTML spec editor at Google
</div></div>
<div class="paragraph"><p>WebSocket is a bi-directional full-duplex socket-based protocol. According to <a href="http://tools.ietf.org/html/rfc6455">RFC 6455</a>  - the Internet Engineering Task Force (IETF) standard document - the goal of WebSocket technology is to provide a mechanism for Web applications that need two-way communications with servers. This technology doesn&#8217;t rely on HTTP hacks or on opening multiple connections using <span class="monospaced">XMLHttpRequest</span> or <span class="monospaced">&lt;iframe&gt;</span> and long polling. The idea behind WebSocket is not overly complicated:</p></div>
<div class="ulist"><ul>
<li>
<p>
Establish a socket connection between the client and the server using HTTP for the initial handshake.
</p>
</li>
<li>
<p>
Switch the communication protocol from HTTP to a socket-based protocol.
</p>
</li>
<li>
<p>
Send messages in both directions simultaneously (a.k.a. full duplex mode).
</p>
</li>
<li>
<p>
Send messages independently. This is not a request-response model as both the server and the client can initiate the data transmission which enables the real server-side push.
</p>
</li>
<li>
<p>
Both the server and the client can initiate disconnects too.
</p>
</li>
</ul></div>
<div class="paragraph"><p>You will get a better understanding of each of these statements after reading the section WebSocket API later in this chapter.</p></div>
<div class="paragraph"><p>The WebSocket protocol defines two new <a href="http://en.wikipedia.org/wiki/URI_scheme">URI schemes</a> <span class="monospaced">ws</span> and <span class="monospaced">wss</span> for unencrypted and encrypted connections respectively. The <span class="monospaced">ws</span> (WebSocket) URI scheme is similar to HTTP URI scheme and identifies that a WebSocket connection will be established using TCP/IP protocol without encryption. The`wss` (WebSocket Secure) URI scheme identifies that the traffic over that connection will be protected via Transport Layer Security (TLS). The TLS connection provides such benefits over TCP connection as data confidentiality, integrity, and the endpoint authentication. Apart from the scheme name, WebSocket URI schemes use generic URI syntax.</p></div>
<div class="sect3">
<h4 id="_websocket_interface">WebSocket Interface</h4>
<div class="paragraph"><p>The W3C expert group uses <a href="http://en.wikipedia.org/wiki/Interface_description_language">Interface Description Language</a> to describe what the WebSocket interface should look like. This is how it was defined:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">Constructor</span></span><span style="color: #990000">(</span><span style="color: #008080">DOMString</span> url<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">optional</span></span> <span style="color: #990000">(</span>DOMString <span style="color: #008080">or</span> DOMString<span style="color: #990000">[])</span> protocols<span style="color: #990000">)]</span> <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/1.png" alt="1"></span></span>
<span style="font-weight: bold"><span style="color: #0000FF">interface</span></span> <span style="color: #008080">WebSocket</span> <span style="color: #990000">:</span> EventTarget <span style="color: #FF0000">{</span>
  readonly attribute <span style="color: #008080">DOMString</span> url<span style="color: #990000">;</span>

  <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> unsigned <span style="color: #008080">short</span> CONNECTING <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/2.png" alt="2"></span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> unsigned <span style="color: #008080">short</span> OPEN <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> unsigned <span style="color: #008080">short</span> CLOSING <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
  <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> unsigned <span style="color: #008080">short</span> CLOSED <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
  readonly attribute unsigned <span style="color: #008080">short</span> readyState<span style="color: #990000">;</span>
  readonly attribute unsigned <span style="color: #008080">long</span> bufferedAmount<span style="color: #990000">;</span>

  <span style="font-style: italic"><span style="color: #9A1900">// networking</span></span>
  <span style="color: #990000">[</span>TreatNonCallableAsNull<span style="color: #990000">]</span> <span style="color: #008080">attribute</span> Function<span style="color: #990000">?</span> onopen<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/3.png" alt="3"></span></span>
  <span style="color: #990000">[</span>TreatNonCallableAsNull<span style="color: #990000">]</span> <span style="color: #008080">attribute</span> Function<span style="color: #990000">?</span> onerror<span style="color: #990000">;</span>
  <span style="color: #990000">[</span>TreatNonCallableAsNull<span style="color: #990000">]</span> <span style="color: #008080">attribute</span> Function<span style="color: #990000">?</span> onclose<span style="color: #990000">;</span>
  readonly attribute <span style="color: #008080">DOMString</span> extensions<span style="color: #990000">;</span>
  readonly attribute <span style="color: #008080">DOMString</span> protocol<span style="color: #990000">;</span>                    <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/4.png" alt="4"></span></span>
  <span style="color: #008080">void</span> <span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">([</span>Clamp<span style="color: #990000">]</span> optional unsigned <span style="color: #008080">short</span> code<span style="color: #990000">,</span> optional <span style="color: #008080">DOMString</span> reason<span style="color: #990000">);</span>

  <span style="font-style: italic"><span style="color: #9A1900">// messaging</span></span>
  <span style="color: #990000">[</span>TreatNonCallableAsNull<span style="color: #990000">]</span> <span style="color: #008080">attribute</span> Function<span style="color: #990000">?</span> onmessage<span style="color: #990000">;</span>
           attribute <span style="color: #008080">DOMString</span> binaryType<span style="color: #990000">;</span>
  <span style="color: #008080">void</span> <span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span><span style="color: #008080">DOMString</span> data<span style="color: #990000">);</span>            <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
  <span style="color: #008080">void</span> <span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span><span style="color: #008080">ArrayBufferView</span> data<span style="color: #990000">);</span>
  <span style="color: #008080">void</span> <span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span><span style="color: #008080">Blob</span> data<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The constructor requires an endpoint URI and optional sub-protocols names. A sub-protocol is an application-level protocol layered over the WebSocket Protocol. The client-side application can explicitly indicate which sub-protocols are acceptable for the conversation between the client and server. That string will be send to the server with the initial handshake as <span class="monospaced">Sec-WebSocket-Protocol</span> <span class="monospaced">GET</span> request header field. If the server supports one of the requested protocols it selects at most one of acceptable protocols and echoes that value in the same header parameter <span class="monospaced">Sec-WebSocket-Protocol</span> in the handshake&#8217;s response. Thereby the server indicates that it has selected that protocol. It could be a custom protocol or one of standard application level protocols (see <a href="#Auction_Messages_Specification">[Auction_Messages_Specification]</a>). For example, it&#8217;s possible to transfer the SOAP or XMPP messages over the WebSocket connection. We&#8217;ll discuss the handshake in the <a href="#HANDSHAKE">[HANDSHAKE]</a> section.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
At any given time the WebSocket can be in one of four states.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
These are the callback functions of WebSocket object that will be invoked by the browser once the appropriate network event is dispatched.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
This property contains the name of the sub-protocol used for the conversation. After the successful handshake this property populated by the browser with value from servers response parameter <span class="monospaced">Sec-WebSocket-Protocol</span> as described in &lt;1&gt;.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
The WebSocket object can send text or binary data to the server using on of the overloaded <span class="monospaced">send()</span> methods.
</td></tr>
</table></div>
<div class="sect4">
<h5 id="_the_client_side_api">The Client-Side API</h5>
<div class="paragraph"><p>After introducing the WebSocket interface lets see the code example illustrating how the client&#8217;s JavaScript can use it.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> ws<span style="color: #990000">;</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>window<span style="color: #990000">.</span>WebSocket<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"WebSocket object is supported in your browser"</span><span style="color: #990000">);</span>
    ws <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">WebSocket</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ws://www.websocket.org/echo"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
    ws<span style="color: #990000">.</span>onopen <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"onopen"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
    ws<span style="color: #990000">.</span>onmessage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>e<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"echo from server : "</span> <span style="color: #990000">+</span> e<span style="color: #990000">.</span>data<span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

    ws<span style="color: #990000">.</span>onclose <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
        <span style="font-weight: bold"><span style="color: #000000">output</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"onclose"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    ws<span style="color: #990000">.</span>onerror <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #000000">output</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"onerror"</span><span style="color: #990000">);</span>  <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/6.png" alt="6"></span></span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>

<span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #000000">output</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"WebSocket object is not supported in your browser"</span><span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Not all Web browsers support WebSocket natively as of yet. Check if the <span class="monospaced">WebSocket</span> object is supported by the user&#8217;s browser.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Instantiate the new <span class="monospaced">WebSocket</span> object with passing an endpoint URI as constructor parameter.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Set the event handlers for <span class="monospaced">open</span>, <span class="monospaced">message</span>, <span class="monospaced">close</span> events.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
The <span class="monospaced">MessageEvent</span> is dispatched  when the data is received from the server. This message will be delivered to the function assigned to the WebSocket object&#8217;s <span class="monospaced">onmessage</span> property. The <span class="monospaced">e.data</span> property of the message event will contain the received message.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Handle closing connection (more details in <a href="#CLOSING">[CLOSING]</a> section).
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
Handle errors.
</td></tr>
</table></div>
</div>
<div class="sect4">
<h5 id="HANDSHAKE">WebSocket Handshake</h5>
<div class="paragraph"><p>Any network communications that use WebSocket protocol start with an opening handshake. The handshake upgrades the connection from HTTP to the WebSocket protocol. It&#8217;s an upgrade to a message-based communications. We will discuss messages (a.k.a. frames) later in this chapter. Why upgrade from HTTP instead of starting with the TCP as a protocol in the first place? The reason is that the WebSocket operates on the same ports (80 and 443) as HTTP and HTTPS do. It&#8217;s an important advantage that the browser&#8217;s requests are routed through the same ports because arbitrary socket connections may not be allowed by the enterprise firewalls for security reasons. Also, many corporate networks only allow certain outgoing ports. And HTTP/HTTPS ports are usually included in so called <em>white lists</em>.</p></div>
<div class="paragraph"><p>The protocol upgrade is initiated by the client request, which also transmits a special key with the upgrade request. The server processes this request and sends back a confirmation for the upgrade. This ensures that a WebSocket connection can be established only with an endpoint that support WebSocket. Here is what the handshake can look like in the client&#8217;s request:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    GET HTTP/1.1
    Upgrade: websocket
    Connection: Upgrade
    Host: echo.websocket.org
    Origin: http://www.websocket.org
    Sec-WebSocket-Key: i9ri+AfOgSsKwUlmLjIkGA==
    Sec-WebSocket-Version: 13
    Sec-WebSocket-Protocol: chat</pre>
</div></div>
<div class="paragraph"><p>This client sends the <span class="monospaced">GET</span> request for the protocol upgrade. The <span class="monospaced">Sec-WebSocket-Key</span> is just a set of random bytes. The server takes these bytes and appends to this key a special Global Unique Identifier (GUID) string <span class="monospaced">258EAFA5-E914-47DA-95CA-C5AB0DC85B11</span>, then it creates the Secure Hash Algorithm <span class="monospaced">SHA1</span> hash from it performs the <em>base64</em> encoding. The resulting string of bytes needs to be used by both the server and the client, and this string won&#8217;t be used by the network endpoints that do not understand the WebSocket protocol. Then this value would be copied in the <span class="monospaced">Sec-WebSocket-Accept</span> header field. The server computes the value and sends the response back confirming the protocol upgrade.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    HTTP/1.1 101 Web Socket Protocol Handshake
    Upgrade: WebSocket
    Connection: Upgrade
    Sec-WebSocket-Accept: Qz9Mp4/YtIjPccdpbvFEm17G8bs=
    Sec-WebSocket-Protocol: chat
    Access-Control-Allow-Origin: http://www.websocket.org</pre>
</div></div>
<div class="paragraph"><p>The WebSocket protocol uses the <span class="monospaced">400 Bad Request</span> HTTP error code to signal the unsuccessful upgrade. The handshake can also include a sub-protocol request and the WebSocket version information but you can&#8217;t include arbitrary other headers. We can&#8217;t transmit the authorization information. There are two ways around this. You can either transmit the authorization information as the first request (e.g. unique <span class="monospaced">clientId</span> can be passed as part of the HTTP request header or HTML wrapper) or put it into the URL as a query parameter during the initial handshake. Consider the following example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> clientId <span style="color: #990000">=</span> <span style="color: #FF0000">"Mary1989"</span><span style="color: #990000">;</span>                                   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
ws <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">WebSocket</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ws://www.websocket.org/echo/"</span><span style="color: #990000">+</span>clientID<span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The client the <span class="monospaced">clientId</span> value (can be obtained from some LDAP server).
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The client connects to the WebSocket endpoint with an extra URI parameter which will be stored on server for future interactions.
</td></tr>
</table></div>
<div class="paragraph"><p>Because WebSocket protocol creates a bi-directional (socket-to-socket) connection, the server has access to the conversation session associated with such a connection. This session can be associated with clientId and be stored on server.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">A client can have as any WebSocket connections with the server as needed.  But servers can refuse to accept connections from hosts/IP addresses with an excessive number of existing connections or disconnect resource-hogging connections in case of high data load.</td>
</tr></table>
</div>
</div></div>
</div>
<div class="sect4">
<h5 id="FRAMES">The WebSocket Frame Anatomy</h5>
<div class="paragraph"><p>The WebSocket handshake is the first step to switching to the message framing protocol, which will be layered over TCP. In this section we&#8217;re going to explore how the WebSocket data transfer works. The WebSocket is not a stream based protocol like TCP - it&#8217;s message based. The difference is that with TCP a program sends stream of bytes, which has to have a specific indication that the data transfer ends.
The WebSocket specification makes it easier because it puts a frame around every chunk of data, and the size of the frame is known. JavaScript can easily handle these frames on the client because each frame arrives packaged in the event object. But the server side has to work a little harder as it needs to wrap each piece of data into a frame before sending it to the client. A frame can look like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>+-+-+-+-+-------+-+-------------+-------------------------------+
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
|     Extended payload length continued, if payload len == 127  |
+ - - - - - - - - - - - - - - - +-------------------------------+
|                               |Masking-key, if MASK set to 1  |
+-------------------------------+-------------------------------+
| Masking-key (continued)       |          Payload Data         |
+-------------------------------- - - - - - - - - - - - - - - - +
:                     Payload Data continued ...                :
+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
|                     Payload Data continued ...                |
+---------------------------------------------------------------+</pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">FIN</span> (1 bit)
</p>
<div class="paragraph"><p>This bit indicates if this frame is the final in the message payload. If a message has under 127 bytes it fits into a single frame and this bit will always be set.</p></div>
</li>
<li>
<p>
<span class="monospaced">RSV1</span>, <span class="monospaced">RSV2</span>, <span class="monospaced">RSV3</span> (1 bit each)
</p>
<div class="paragraph"><p>These bits are reserved for future protocol changes and improvements. They must contain zeros as they are not being used at this time.</p></div>
</li>
<li>
<p>
<span class="monospaced">opcode</span> (4 bits)
</p>
<div class="paragraph"><p>The frame type is defined using opcode. Here are the most used opcodes:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">0x00</span> This frame continues the payload.
</p>
</li>
<li>
<p>
<span class="monospaced">0x01</span> This frame includes UTF-8 text data.
</p>
</li>
<li>
<p>
<span class="monospaced">0x02</span> This frame includes the binary data.
</p>
</li>
<li>
<p>
<span class="monospaced">0x08</span> This frame terminates the connection.
</p>
</li>
<li>
<p>
<span class="monospaced">0x09</span> This frame is a Ping.
</p>
</li>
<li>
<p>
<span class="monospaced">0x10</span> This frame is a Pong.
</p>
</li>
</ul></div>
</li>
<li>
<p>
<span class="monospaced">mask</span> (1 bit)
</p>
<div class="paragraph"><p>This indicates if the frame is masked.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">The client must mask all the frames being sent to the server. The server must close the connection upon receiving a frame that is not masked. The server must not mask any frames that it sends to the client.  The client must close a connection if it detects a masked frame. In that case of such error, client or server can send <span class="monospaced">Close</span> frame with 1002 status code - protocol error. All these actions are done automatically by Web browsers and Web server that implements <a href="http://tools.ietf.org/html/rfc6455">WebSocket specification</a>.</td>
</tr></table>
</div>
</div></div>
</li>
<li>
<p>
<span class="monospaced">payload_len</span> (7 bits, 7+16 bits, or 7+64 bits)
</p>
<div class="paragraph"><p>The length of the payload. WebSocket frames come in the following length brackets:</p></div>
<div class="ulist"><ul>
<li>
<p>
0-125 indicate the length of the payload.
</p>
</li>
<li>
<p>
126 means that the following two bytes indicate the length.
</p>
</li>
<li>
<p>
127 means the next 8 bytes indicate the length.
</p>
</li>
</ul></div>
</li>
<li>
<p>
<span class="monospaced">masking-key</span> (32 bits)
</p>
<div class="paragraph"><p>This key is used to <em>XOR</em> the payload with.</p></div>
</li>
<li>
<p>
<span class="monospaced">payload data</span>
</p>
<div class="paragraph"><p>This indicates the actual data. The length of block is defined in the <span class="monospaced">payload_len</span> field.</p></div>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="_the_heartbeats">The Heartbeats</h5>
<div class="paragraph"><p>Properly design distributed application has to have a way to ensure that each tier of the system is operational even if there is no active data exchange between the client and the server. This can be done by implementing so called <em>heartbeats</em> - a small messages that simply ask the other party, "Are you there?". For example, proxy servers and content-filtering hardware can terminate idle connections or the server could simply go down. If a client doesn&#8217;t send any requests, say for 20 seconds, but the server went down, the client will know about it only when it does the next <span class="monospaced">send()</span>. Heartbeats will keep the connection alive to ensure that it won&#8217;t look idling. In the WebSocket jargon heartbeats are implemented with <em>ping and pong</em> . The browser sends the <em>ping</em> opcode <span class="monospaced">0x9</span> at any time to ask the other side to <em>pong</em> back (the opcode <span class="monospaced">0xA</span>).</p></div>
<div class="paragraph"><p>The Web browser can ping the server when required, but a pong may sent at server&#8217;s discretion. If the  endpoint receives a ping frame before responding the the previous one, the endpoint can elect to send just one pong frame for the most recently processed ping. The ping frame may contain the application data (can be up to 125 bytes) and pong must have identical data in its message body.</p></div>
<div class="paragraph"><p>There is no JavaScript API to send pings or receive pong <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/network.html#ping-and-pong-frames">frames</a>. Pings and pongs may or may not be supported by the user&#8217;s browser. <a href="http://www.w3.org/Bugs/Public/show_bug.cgi?id=13104">There is also no API</a> to enable, configure or detect whether the browser supports pings and pongs.</p></div>
</div>
<div class="sect4">
<h5 id="_data_frames">Data Frames</h5>
<div class="paragraph"><p>Since the WebSocket protocol allows the data to be fragmented into multiple frames, the first frame that transmits the data will be prepended with one of the following opcodes indicating the type of data being transmitted:</p></div>
<div class="ulist"><ul>
<li>
<p>
The opcode <span class="monospaced">0x01</span> indicates the UTF-8 encoded text data.
</p>
</li>
<li>
<p>
The opcode <span class="monospaced">0x02</span> indicates the binary data.
</p>
</li>
</ul></div>
<div class="paragraph"><p>When your application transmits JSON over the wire the opcode is set to be <span class="monospaced">0x01</span>. When your code emits binary data it will be represented in a browser specific <span class="monospaced">Blob</span> object or an <span class="monospaced">ArrayBuffer</span> object and sent wrapped into a frame with the opcode <span class="monospaced">0x02</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">You must choose the type for the incoming binary data on the client using <span class="monospaced">webSocket.binaryType = "blob"</span> or <span class="monospaced">webSocket.binaryType = "arraybuffer"</span> before reading the data. It&#8217;s a good idea to check the type of the incoming data because the opcodes are not exposed to the client.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>webSocket<span style="color: #990000">.</span>onmessage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>messageEvent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span> messageEvent<span style="color: #990000">.</span>data <span style="color: #990000">===</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"received text data from the server: "</span> <span style="color: #990000">+</span> messageEvent<span style="color: #990000">.</span>data<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>messageEvent<span style="color: #990000">.</span>data <span style="font-weight: bold"><span style="color: #0000FF">instanceof</span></span> Blob<span style="color: #990000">)</span><span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"Blob data received"</span><span style="color: #990000">)</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="CLOSING">Closing The Connection</h5>
<div class="paragraph"><p>The connection is terminated by sending the frame with the close opcode <span class="monospaced">0x08</span>.</p></div>
<div class="paragraph"><p>There is the pattern to exchange close opcodes first and then let the server to shut down. The client is supposed to give the server some time to close the connection before attempting to do that on its own. The close event can also signal why it has terminated the connection.</p></div>
<div class="paragraph"><p>A <span class="monospaced">CloseEvent</span> is sent to clients using WebSocket when the connection is closed. This is delivered to the listener indicated by the WebSocket object&#8217;s <span class="monospaced">onclose</span> handler. <span class="monospaced">CloseEvent</span> has 3 properties - <span class="monospaced">code, reason, wasClean</span>.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">code</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">This property represents the close code provided by the server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">reason</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A string indicating the reason of why the server closed the connection.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">wasClean</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">The property indicates if the connection was cleanly closed.</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>webSocket<span style="color: #990000">.</span>onclose <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>closeEvent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"reason "</span> <span style="color: #990000">+</span> closeEvent<span style="color: #990000">.</span>reason <span style="color: #990000">+</span> <span style="color: #FF0000">"code "</span> <span style="color: #990000">+</span> closeEvent<span style="color: #990000">.</span>code<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_websocket_frameworks">WebSocket Frameworks</h3>
<div class="paragraph"><p>Working with the vanilla WebSocket API requires you to do some additional "housekeeping" coding on you own. For example, if the client&#8217;s browser doesn&#8217;t support WebSocket natively, you need to make sure that your code falls back to the legacy HTTP protocol. The good news is that there are frameworks that can help you with this task. Such frameworks lower the development time, allowing you to do more with less code. We&#8217;ve included brief reviews of two frameworks that can streamline your Web application development with WebSocket.</p></div>
<div class="paragraph"><p>The frameworks mentioned below try to utilize the best supported transport by the current Web browser and server while sparing the developer from knowing internals of the used mechanism. The developer can concentrate on programming the application logic making calls to frameworks API when the data transfer is needed. The rest will be done by framework.</p></div>
<div class="sect3">
<h4 id="_the_portal">The Portal</h4>
<div class="paragraph"><p>The <a href="https://github.com/flowersinthesand/portal">Portal</a> is a server agnostic JavaScript library. It aims to utilize a WebSocket protocol and provides a unified API for various transports (long polling, HTTP streaming, WebSocket). Currently, once you&#8217;ve decided to use WebSocket API for your next project, you need to remember about those users who still use old browsers like Internet Explorer 9 or older, which don&#8217;t natively support WebSockets. In this case, your application should gracefully fall back to the best available networking alternative. Manually writing code to support all possible browsers and versions requires lots of time especially for testing and maintaining the code for different platforms. The <span class="monospaced">Portal</span> library could help as illustrated in the following brief code sample.</p></div>
<div class="listingblock">
<div class="title">Simple asynchronous web application client with Portal</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>portal<span style="color: #990000">.</span>defaults<span style="color: #990000">.</span>transports <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">"ws"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"sse"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"stream"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"longpoll"</span><span style="color: #990000">];</span>    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

portal<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">open</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"child-auction/auction"</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">on</span></span><span style="color: #990000">(</span><span style="color: #FF0000">{</span>       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
    connecting<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The connection has been tried by '"</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #0000FF">this</span></span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">data</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"transport"</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #FF0000">"'"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    open<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>                          <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The connection has been opened"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    close<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>reason<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The connection has been closed due to '"</span> <span style="color: #990000">+</span> reason <span style="color: #990000">+</span> <span style="color: #FF0000">"'"</span><span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    message<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>data<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">handleIncommingData</span></span><span style="color: #990000">(</span>data<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
    waiting<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>delay<span style="color: #990000">,</span> attempts<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The socket will try to reconnect after "</span> <span style="color: #990000">+</span> delay <span style="color: #990000">+</span> <span style="color: #FF0000">" ms"</span><span style="color: #990000">);</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"The total number of reconnection attempts is "</span> <span style="color: #990000">+</span> attempts<span style="color: #990000">);</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The Portal framework supports different transports and can fall back from WebSocket connection to streaming or long polling. The server also has to support some fall-back strategy, but no additional code required on the client side.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Connecting to the WebSocket endpoint.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The Portal API is event-based similarly to W3C WebSocket API.
</td></tr>
</table></div>
<div class="paragraph"><p>The Portal framework generalizes the client-side programming. With defining an array of transports, you don&#8217;t have to worry about how to handle message sent by server with different transport.
The Portal doesn&#8217;t depend on any JavaScript library.</p></div>
</div>
<div class="sect3">
<h4 id="_atmosphere">Atmosphere</h4>
<div class="paragraph"><p>A Web application that has to be deployed on several different servers (e.g. WebSphere, JBoss, WebLogic)
may need to support different WebSocket APIs. At the time of this writing, there is a plethora of different implementations of the server-side libraries supporting WebSockets, and each of them uses their own proprietary APIs. The upcoming Java EE 7 specification intends to change the situation. But Atmosphere is a framework that allows you to write portable Web applications today.</p></div>
<div class="paragraph"><p><a href="https://github.com/Atmosphere/atmosphere">Atmosphere</a> is a <strong>portable</strong> WebSocket framework supporting Java, Groovy, and Scala. The Atmosphere Framework contains both client and server components for building Asynchronous Web Applications. The Atmosphere transparently supports WebSocket, Server Side Events, long-polling, HTTP streaming, and JSONP.</p></div>
<div class="paragraph"><p>The client side component <a href="https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API">Atmosphere.js</a> uses The Portal framework internally and simplifies the development of Web applications that require a fall back from the WebSocket protocol to long polling or HTTP streaming. The Atmosphere Framework hides the complexity of the asynchronous APIs, which differ from server to server and makes your application portable among them. Treat Atmosphere as a compatibility layer that allows to select best available on server transport for all major Java application servers.</p></div>
<div class="paragraph"><p>The Atmosphere framework supports wide range of Java based server-side technologies via a set of <a href="https://github.com/Atmosphere/atmosphere/wiki/Atmosphere-PlugIns-and-Extensions">extensions and plugins</a>. The Atmosphere <a href="https://github.com/Atmosphere/atmosphere-jsr356">supports</a> upcoming Java API for WebSocket, so you can have best of two worlds - the standard API and application portability.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">WebSockets can be used not only in for the Web, but in any applications that use networking. If you&#8217;re developing native iOS or OSX applications check <a href="https://github.com/square/SocketRocket">the SocketRocket</a> library developed by <a href="http://corner.squareup.com/">Square Engineering Team</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Square uses SocketRocket in their mobile payments application. If you&#8217;re developing native Android applications and want to use WebSocket protocol goodies in Android-powered devices check <a href="https://github.com/AsyncHttpClient/async-http-client">the AsyncHttpClient</a> framework.</p></div>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_when_using_websocket">When Using WebSocket</h3>
<div class="paragraph"><p>Since WebSocket protocol has literally no overhead it should be considered for the following types of applications:</p></div>
<div class="ulist"><ul>
<li>
<p>
Live trading/auctions/sports notifications
</p>
</li>
<li>
<p>
Controlling medical equipment over the web
</p>
</li>
<li>
<p>
Chat applications
</p>
</li>
<li>
<p>
Multi-player online games
</p>
</li>
<li>
<p>
Real-time updates in social streams
</p>
</li>
</ul></div>
<div class="paragraph"><p>For the next version of Save Sick Child application we&#8217;re going to use WebSocket to implement an online auction communication layer. The goal is to let individuals and businesses purchase hand-made crafts and arts made by children. All proceeds will go to help sick children.</p></div>
<div class="paragraph"><p>Having said that WebSocket protocol is a great solution, it has the downside too: the WebSocket specification defines only the protocol for transporting frames, but it doesn&#8217;t include the application-level protocol. Developers need to invent the application-specific text or binary protocols. For example, the auction bid has to be presented in a form agreed upon by all application modules. Let&#8217;s discuss our options from protocol modeling perspective.</p></div>
<div class="paragraph"><p>Selecting a message format for your application&#8217;s data communications is important. The most common text formats are CSV, XML, and JSON. They are easy to generate, parse, and are widely supported by many frameworks in the most development platforms. While XML and JSON allow you to represent the data in a hierarchical and easily readable by humans form, they create a lot of overhead by wrapping up each data element into additional text identifiers. Sending such additional textual information requires extra bandwidth and may need additional string-to-type conversion on both the client and server&#8217;s application code. The binary format is an alternative way of sending data. Let&#8217;s discuss the pros and cons of these message formats.</p></div>
<div class="sect3">
<h4 id="_csv">CSV</h4>
<div class="paragraph"><p>CSV stands for Comma Separated Values although the delimiter can be any character, not only the comma. This depends on the parser design and implementation. Another popular type of delimiter is <span class="monospaced">|</span> - "pipe" .</p></div>
<div class="paragraph"><p>Pros:</p></div>
<div class="ulist"><ul>
<li>
<p>
This format is very compact. The overhead of the separator symbol is minimal.
</p>
</li>
<li>
<p>
It&#8217;s simple to create and parse. The CSV message can be turned into array of values by using the standard JavaScript <span class="monospaced">String.split()</span>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Cons:</p></div>
<div class="ulist"><ul>
<li>
<p>
It&#8217;s not suitable for storing complex data structures and hierarchies. In case of an auction application, we need transfer to client auction items' attributes for each auction. In this case we can&#8217;t simply use <span class="monospaced">String.split()</span> and have to design and implement more complex parser.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_xml">XML</h4>
<div class="paragraph"><p>XML stands for Extensible Markup Language, and it nicely represents any hierarchal data structures.</p></div>
<div class="paragraph"><p>Pros:</p></div>
<div class="ulist"><ul>
<li>
<p>
It&#8217;s a human-readable format.
</p>
</li>
<li>
<p>
Most browsers have build-in XML readers and parsers.
</p>
</li>
<li>
<p>
XML data can be validated against XSD or DTD schema.
</p>
<div class="paragraph"><p>XML schema is very useful language feature as it defines the structure, content and semantic of XML document. Because of its human-readability the XML schema can be used used by people who are not software developers and can be applied for integrating systems written in different programming languages.</p></div>
</li>
</ul></div>
<div class="paragraph"><p>Cons:</p></div>
<div class="ulist"><ul>
<li>
<p>
XML is very verbose. To send a name of a customer you&#8217;d need something like this: <span class="monospaced">&lt;cust_name&gt;Mary&lt;/cust_name&gt;</span>
</p>
</li>
<li>
<p>
The XML validation on the client is a complex task. As for now, there is no platform independent solutions or the API to perform validation programmatically based on XSD or DTD.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The book  <em>XML in a Nutshell, 3rd Edition</em> by Elliotte Rusty Harold and W. Scott Means is a well-written book describing the full spectrum of XML features and tools.</p></div>
</div>
<div class="sect3">
<h4 id="_json">JSON</h4>
<div class="paragraph"><p>As explained in Chapter 4, JSON stands for JavaScript Object Notation, and it&#8217;s a way of representing structured data, which can be encoded and decoded by all Web browsers. JSON is widely accepted by the Web community as a popular way of the data serialization.</p></div>
</div>
<div class="sect3">
<h4 id="_google_protocol_buffers">Google Protocol Buffers</h4>
<div class="paragraph"><p>Google Protocol Buffers is a language and platform-neutral extensible mechanism for structured data serialization. Once defined how you want your data to be structured, you can use special generated source code to easily write and read your structured data to and from a variety of data streams.</p></div>
<div class="paragraph"><p>A developer needs to specify how the serializable information has to be structured by defining the protocol buffer message types in the <span class="monospaced">.proto</span> files. Each protocol buffer message is a small logical record of information, containing a series of the name/value pairs. This protocol buffer message file is language agnostic. The <span class="monospaced">protoc</span> utility compiles <span class="monospaced">proto</span> files and produces language specific artifacts, e.g. <span class="monospaced">.java</span>, <span class="monospaced">.js</span>, etc files.</p></div>
<div class="paragraph"><p>For example, you can create a protocol buffer <span class="monospaced">proto</span> file for our Save Sick Child to represent the information about donors.</p></div>
<div class="listingblock">
<div class="title">Protocol Buffer for Donation message ( <span class="monospaced">donation.proto</span> )</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">package</span></span> savesickchild<span style="color: #990000">;</span>                                      <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>

<span style="color: #008080">option</span> java_package <span style="color: #990000">=</span> <span style="color: #FF0000">"org.savesickchild.web.donation"</span><span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

<span style="color: #008080">message</span> Donor<span style="color: #FF0000">{</span>                                              <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
    required <span style="color: #008080">string</span> fullname <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
    required <span style="color: #008080">string</span> email <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>                              <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
    required <span style="color: #008080">string</span> address <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
    required <span style="color: #008080">string</span> city <span style="color: #990000">=</span> <span style="color: #993399">4</span><span style="color: #990000">;</span>
    required <span style="color: #008080">string</span> state <span style="color: #990000">=</span> <span style="color: #993399">5</span><span style="color: #990000">;</span>
    required <span style="color: #008080">int32</span> zip <span style="color: #990000">=</span> <span style="color: #993399">6</span><span style="color: #990000">;</span>
    required <span style="color: #008080">string</span> country <span style="color: #990000">=</span> <span style="color: #993399">7</span><span style="color: #990000">;</span>

    <span style="color: #008080">message</span> Donation<span style="color: #FF0000">{</span>                                       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
        required <span style="color: #008080">Donor</span> donor <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>                           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/6.png" alt="6"></span></span>
        required <span style="color: #008080">double</span> amount <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
        optional <span style="color: #008080">bool</span> receipt_needed <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The protobuf supports packages to prevent naming conflicts among messages from different projects.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Here we&#8217;re using Java specific protobuf option to define in what package the generated code will reside.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Start defining our custom message with the <span class="monospaced">message</span> keyword.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Each message field can be <span class="monospaced">required</span>, <span class="monospaced">optional</span> or <span class="monospaced">repeated</span>. The <span class="monospaced">required</span> and <span class="monospaced">optional</span> modifiers are self explanatory. During serialization-deserization process the protobuf framework will check the message for existence of fields, and if a required property is missing it will throw a runtime exception. The <span class="monospaced">repeated</span> modifier is used to create dynamically sized arrays.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
The protobuf supports nested messages.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
There are many standard field types available in protobuf:  <span class="monospaced">string</span>, <span class="monospaced">int32</span>, <span class="monospaced">float</span>, <span class="monospaced">double</span>, and <span class="monospaced">bool</span>. You can also define a custom type and use it as a field type.
</td></tr>
</table></div>
<div class="paragraph"><p>After creating the <span class="monospaced">donation.proto</span> file, you can use <span class="monospaced">protoc</span> compiler to generate Java classes according to this file&#8217;s definitions.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>protoc -I<span style="color: #990000">=.</span> --java<span style="color: #009900">_out</span><span style="color: #990000">=</span>src donation<span style="color: #990000">.</span>proto           <span style="font-style: italic"><span style="color: #9A1900"># <img src="images/icons/callouts/1.png" alt="1"></span></span>

<span style="color: #990000">.</span>
├── donation<span style="color: #990000">.</span>proto
└── src
    └── org
        └── savesickchild
            └── web
                └── donation
                    └── Donation<span style="color: #990000">.</span>java               <span style="font-style: italic"><span style="color: #9A1900"># <img src="images/icons/callouts/2.png" alt="2"></span></span>
</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The Java code will be generated in <span class="monospaced">src</span> directory.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
All required code for serialization-deserilization of <span class="monospaced">Donation</span> message will be included in <span class="monospaced">Donation.java</span>. We&#8217;re not going to publish the generated code here, but you can generate this code by yourself from the provided above message declaration.
</td></tr>
</table></div>
<div class="paragraph"><p>Check the availability of the protobuf compiler for your preferred language at the <a href="http://code.google.com/p/protobuf/wiki/ThirdPartyAddOns">protobuf wiki page</a>. To make yourself familiar with protobuf technology check <a href="https://developers.google.com/protocol-buffers/docs">documentation</a> and <a href="https://developers.google.com/protocol-buffers/docs/tutorials">tutorials</a>. Here some protobuf pros and cons protobuf:</p></div>
<div class="paragraph"><p>Pros:</p></div>
<div class="ulist"><ul>
<li>
<p>
The message is encoded into a compact and optimized binary format. You can find the details of the encoding format at <a href="https://developers.google.com/protocol-buffers/docs/encoding">Protocol Buffers documentation website</a>.
</p>
</li>
<li>
<p>
Google supports Protocol Buffers for a wide range of programming languages (Java, C++, Python). The   <a href="http://code.google.com/p/protobuf/wiki/ThirdPartyAddOns">developer&#8217;s community</a> supports it too.
</p>
</li>
<li>
<p>
The use of Protocol Buffers is well documented.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Cons:</p></div>
<div class="ulist"><ul>
<li>
<p>
The binary format is not human readable.
</p>
</li>
<li>
<p>
Although Protobuf is compact, especially when a lot of numeric values are transferred <a href="https://developers.google.com/protocol-buffers/docs/encoding">by an encoding algorithm</a>, the JSON is natively supported by the JavaScript and doesn&#8217;t require any additional parser implementation.
</p>
</li>
<li>
<p>
Protobuf requires the Web browser to support the binary format, but not all of them do it just yet. You can find which browser support raw binary data at <a href="http://caniuse.com/#search=binary">http://caniuse.com/#search=binary</a>.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_websockets_and_proxies">WebSockets and Proxies</h3>
<div class="paragraph"><p>The WebSocket protocol itself is unaware of intermediaries such as proxy servers, firewalls, content filters. The proxy servers are commonly used for content caching, security and enterprise content filtering.</p></div>
<div class="paragraph"><p>HTTP always supported protocol upgrades, but many proxy servers seem to have ignored that part of the specification. Until the WebSocket came around the <span class="monospaced">Upgrade</span> attribute was not used. The problem with Web applications that use long-lived connection like WebSocket is that the proxy servers may choose to close streaming or idle WebSocket connections, because they appear to be trying to connect to the unresponsive HTTP server. Additionally, proxy servers may buffer unencrypted HTTP responses assuming that the browser needs to receive the HTTP response in its entirety.</p></div>
<div class="paragraph"><p>If you want to get more details on how a WebSocket-enabled application has to deal with proxies there is comprehensive research paper by Google&#8217;s Peter Lubbers <a href="http://www.infoq.com/articles/Web-Sockets-Proxy-Servers/">WebSocket and proxy servers</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_an_auction_to_save_sick_child">Adding an Auction to Save Sick Child</h3>
<div class="paragraph"><p>We gave you just enough of a theory to whet your appetite to start implementing WebSocket in our Save Sick Child application. The goal is to create an auction where people can bid and purchase various goods so the proceeds would go to sick children. Auctions require real-time communications - everyone interested in the particular auction item must be immediately notified if she was overbid or won. So we&#8217;ll use WebSocket as a means for bidding and notifications of the changes in the auction.</p></div>
<div class="paragraph"><p>To start the auction, the user has to select the <em>Auction</em> option under the menu <em>Way To Give</em> (see <a href="#FIG9-9">[FIG9-9]</a>). We realize that only a small number of users will decide to participate in the auction, which from the architectural point of view means that the code supporting the auction should be loaded <em>on demand</em> only if the user chooses to visit the auction. This why we need to write this code as a loadable module, and the reader will get a practical example of how a Web application can be modularized.</p></div>
<div class="paragraph"><p>In this chapter we continue to use RequireJS (see Chapter 7) as a framework for modularization. Using RequireJS, we&#8217;re going to lazy load some modules if and only if they get requested by the user.</p></div>
<div class="paragraph"><p>This book is about development of the user interface and client side of the Web applications hence we&#8217;re not going to cover all the details of server side implementation, but will make our server side code available for download. We&#8217;ll keep our server up and running so you can test the UI by visiting <a href="http://savesickchild.org:8080/project-16-websocket-auction/">http://savesickchild.org:8080/project-16-websocket-auction/</a>, but our main goal in this section is to show you how you can exchange the auction data with the server and process them on the client side using WebSocket. We&#8217;ll use the Java application server GlassFish 4, which is a reference implementation of the latest Java EE 7 specification.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Authors of this book are Java developers and we have recorded a screencast (see the readme.asciidoc  at <a href="https://github.com/Farata/EnterpriseWebBook">https://github.com/Farata/EnterpriseWebBook</a> for the URL) highlighting WebSocket server API. If you are not a Java developer, you may want to learn on your own which WebSocket servers exist for your favorite programming language or platform.</td>
</tr></table>
</div>
<div class="paragraph"><p>In Chapter 7 you had a chance to see how a Web application can be sliced (see Aptana&#8217;s project-15-dynamic-modules) into several modules using Require.js framework.  We&#8217;ll take this project as a base and will create a new one: project-16-websocket-auction adding to it the new modules supporting the auction.</p></div>
<div class="listingblock">
<div class="title">Way To Give module (<span class="monospaced">js/modules/way-to-give.js</span>)</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">define</span></span><span style="color: #990000">([],</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> WayToGive<span style="color: #990000">;</span>
    console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"way-to-give module is loaded"</span><span style="color: #990000">);</span>
    WayToGive <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #FF0000">{</span>
            render<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>                                <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
                <span style="font-style: italic"><span style="color: #9A1900">// rendering code is omitted</span></span>
                console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"way-to-give module is rendered"</span><span style="color: #990000">);</span>
                rendered <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span>
                <span style="font-weight: bold"><span style="color: #0000FF">return</span></span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            startAuction<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span><span style="color: #FF0000">{</span>                           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            rendered<span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span>                                     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
        <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> WayToGive<span style="color: #990000">;</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
This function will lazy load the auction application content and render it to the top main section of the Web page.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The function <span class="monospaced">startAuction()</span> will start the auction.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The module stores the rendering state in the property <span class="monospaced">rendered</span>.
</td></tr>
</table></div>
<div class="paragraph"><p>Once the application starts, the require.js loads only essential modules - login and donation <a href="#FIG9-9">[FIG9-9]</a>.</p></div>
<div class="imageblock" id="FIG9-9">
<div class="content">
<img src="images/fig_09_09.png" alt="images/fig_09_09.png">
</div>
<div class="title">Figure 58. Initially only two modules are loaded</div>
</div>
<div class="paragraph"><p>In Google Chrome Developer Tools console you can see that login and donation modules are reporting about successful loading. <a href="#FIG9-10">[FIG9-10]</a> confirms that these modules perform fine - clicking on the button Donate reveals the form and clicking on the Login button makes the id/password fields visible.</p></div>
<div class="imageblock" id="FIG9-10">
<div class="content">
<img src="images/fig_09_10.png" alt="images/fig_09_10.png">
</div>
<div class="title">Figure 59. Two modules are loaded during the Save Sick Child application startup</div>
</div>
<div class="paragraph"><p>Now click the Way To Give menu item and keep an eye on the Developer Tools console <a href="#FIG9-11">[FIG9-11]</a>. You will see the way-to-give module reporting about its loading and rendering.</p></div>
<div class="imageblock" id="FIG9-11">
<div class="content">
<img src="images/fig_09_11.png" alt="images/fig_09_11.png">
</div>
<div class="title">Figure 60. The auction controls are loaded and rendered</div>
</div>
<div class="paragraph"><p>Once the user clicks the menu Way to Give the framework require.js has to load code of the WebSocket-based auction module. Here is the code snippet from the JavaScript file <span class="monospaced">app.js</span> - the entry point of our Save Sick Child application. This is how it loads the module <em>on demand</em> (see Chapter 7 for the Require.js refresher).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">require</span></span><span style="color: #990000">([],</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> lazyLoadingEventHandlerFactory<span style="color: #990000">,</span> wayToGiveHandleClick<span style="color: #990000">,</span> wayToGiveModule<span style="color: #990000">,</span> way_to_give<span style="color: #990000">;</span>
    way_to_give <span style="color: #990000">=</span> document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"way-to-give"</span><span style="color: #990000">);</span>

    wayToGiveModule <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>

    lazyLoadingEventHandlerFactory <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>module<span style="color: #990000">,</span> modulePath<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> clickEventHandler<span style="color: #990000">;</span>
      clickEventHandler <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>event<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
        console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span>event<span style="color: #990000">.</span>target<span style="color: #990000">);</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>module <span style="color: #990000">===</span> <span style="color: #FF0000">"loading"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>
        <span style="color: #FF0000">}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>module <span style="color: #990000">!==</span> <span style="font-weight: bold"><span style="color: #0000FF">null</span></span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> module<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">startAuction</span></span><span style="color: #990000">();</span>      <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
          module <span style="color: #990000">=</span> <span style="color: #FF0000">"loading"</span><span style="color: #990000">;</span>                <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/5.png" alt="5"></span></span>
          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">require</span></span><span style="color: #990000">([</span>modulePath<span style="color: #990000">],</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>moduleObject<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/6.png" alt="6"></span></span>
            module <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">moduleObject</span></span><span style="color: #990000">();</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> module<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">();</span>                             <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/7.png" alt="7"></span></span>
          <span style="color: #FF0000">}</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
      <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> clickEventHandler<span style="color: #990000">;</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
    wayToGiveHandleClick <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">lazyLoadingEventHandlerFactory</span></span><span style="color: #990000">(</span>wayToGiveModule<span style="color: #990000">,</span> <span style="color: #FF0000">"modules/way-to-give"</span><span style="color: #990000">);</span>

    way_to_give<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"click"</span><span style="color: #990000">,</span> wayToGiveHandleClick<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">false</span></span><span style="color: #990000">);</span>   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/8.png" alt="8"></span></span>
  <span style="color: #FF0000">}</span><span style="color: #990000">)();</span>
<span style="color: #FF0000">}</span><span style="color: #990000">);</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
This anonymous function will be lazy-loaded only if the user clicks on Way To Give menu.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The variable <span class="monospaced">wayToGiveModule</span> will have a value of <span class="monospaced">null</span> until loaded.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
If the user keeps clicking on the menu while the <span class="monospaced">way-to-give</span> module is still being loaded, simply ignore these clicks.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
If the module has been loaded and UI has been rendered start Auction application.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Set an intermediary value to the <span class="monospaced">way-to-give</span> module so that subsequent requests don&#8217;t try to launch the module more than once.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
Load module asynchronously and instantiate it.
</td></tr>
<tr><td><img src="images/icons/callouts/7.png" alt="7"></td><td>
Render UI component to the screen for first time.
</td></tr>
<tr><td><img src="images/icons/callouts/8.png" alt="8"></td><td>
Register the click event listener for the Way To Give menu.
</td></tr>
</table></div>
<div class="paragraph"><p>After the UI elements have rendered the client can connect to the WebSocket server and request the list of all available auction items.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>window<span style="color: #990000">.</span>WebSocket<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
   webSocket <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">WebSocket</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"ws://savesickchild.org:8080/project-16-websocket-auction//child-auction/auction"</span><span style="color: #990000">);</span>
   webSocket<span style="color: #990000">.</span>onopen <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
     console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"connection open..."</span><span style="color: #990000">);</span>         <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/1.png" alt="1"></span></span>
     <span style="font-weight: bold"><span style="color: #000000">getAuctionsList</span></span><span style="color: #990000">();</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
   webSocket<span style="color: #990000">.</span>onclose <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>closeEvent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
      <span style="font-style: italic"><span style="color: #9A1900">// notify user that connection was closed</span></span>
     console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"close code "</span> <span style="color: #990000">+</span> closeEvent<span style="color: #990000">.</span>code<span style="color: #990000">);</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
   webSocket<span style="color: #990000">.</span>onmessage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">(</span>messageEvent<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
     console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"data from server: "</span> <span style="color: #990000">+</span> messageEvent<span style="color: #990000">.</span>data<span style="color: #990000">);</span>
     <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">typeof</span></span> messageEvent<span style="color: #990000">.</span>data <span style="color: #990000">===</span> <span style="color: #FF0000">"string"</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
       <span style="font-weight: bold"><span style="color: #000000">handleMessage</span></span><span style="color: #990000">(</span>messageEvent<span style="color: #990000">.</span>data<span style="color: #990000">);</span>
     <span style="color: #FF0000">}</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
   <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> webSocket<span style="color: #990000">.</span>onerror <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
    <span style="font-style: italic"><span style="color: #9A1900">// notify user about connection error</span></span>
     console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"websocket error"</span><span style="color: #990000">);</span>
   <span style="color: #FF0000">}</span><span style="color: #990000">;</span>
 <span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
After establishing the connection the code requests the list of available auctions. We&#8217;ll see details of <span class="monospaced">getAuctionsList()</span> method in next snipped.
</td></tr>
</table></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">var</span></span> getAuctionsList <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">function</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #0000FF">var</span></span> auctionListMessage <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #0000FF">new</span></span> <span style="font-weight: bold"><span style="color: #000000">AuctionMessage</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"AUCTIONS_LIST"</span><span style="color: #990000">,</span> <span style="color: #FF0000">'gime'</span><span style="color: #990000">,</span> <span style="color: #FF0000">"-1"</span><span style="color: #990000">);</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span><span style="color: #990000">(</span>webSocket<span style="color: #990000">.</span>readyState <span style="color: #990000">===</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>        <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
            webSocket<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send</span></span><span style="color: #990000">(</span>auctionMessage<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">toJson</span></span><span style="color: #990000">());</span>
        <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> console<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">log</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"offline"</span><span style="color: #990000">);</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #FF0000">}</span><span style="color: #990000">;</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Forming the request message. The details of the message format could be found in <a href="#Auction_Messages_Specification">[Auction_Messages_Specification]</a> section.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Checking the WebSocket object state. If WebSocket is open (<span class="monospaced">readyState===1</span>) the application can send a message. If not, this code just simply logs the "offline" mesage on the console. In the real world you should always display this message on the user&#8217;s UI. Also, if your users work on unstable networks such as cellular or 3G you definitely don&#8217;t want to lose any bits of data. It&#8217;s a good idea to use the local storage API (see Chapter 1) to persist the data locally until the application gets back online and resubmit the data.
</td></tr>
</table></div>
<div class="paragraph"><p>The user can select the auction lot from the combo box and see its images. <a href="#FIG9-12">[FIG9-12]</a> shows what&#8217;s displayed on the console, while <a href="#FIG9-13">[FIG9-13]</a> and <a href="#FIG9-14">[FIG9-14]</a> show the content of the Network tab for both images.</p></div>
<div class="imageblock" id="FIG9-12">
<div class="content">
<img src="images/fig_09_12.png" alt="images/fig_09_12.png">
</div>
<div class="title">Figure 61. The console logs incoming message contains list of auction items.</div>
</div>
<div class="imageblock" id="FIG9-13">
<div class="content">
<img src="images/fig_09_13.png" alt="images/fig_09_13.png">
</div>
<div class="title">Figure 62. Using Network feature of Dev Tools we can monitor WebSocket frames.</div>
</div>
<div class="imageblock" id="FIG9-14">
<div class="content">
<img src="images/fig_09_14.png" alt="images/fig_09_14.png">
</div>
</div>
<div class="sect3">
<h4 id="_monitor_the_websocket_traffic_with_chrome_developers_tools">Monitor the WebSocket traffic with Chrome Developers Tools</h4>
<div class="paragraph"><p>Let&#8217;s review the practical use of the theory described in the <a href="#HANDSHAKE">[HANDSHAKE]</a> section earlier.  With the help of Chrome Developer Tools you can monitor the information about the initial handshake <a href="#FIG9-4">[FIG9-4]</a>. This can be viewed in the Network tab after selecting the path of the <span class="monospaced">WebSocket</span> endpoint on the left panel.</p></div>
<div class="imageblock" id="FIG9-4">
<div class="content">
<img src="images/fig_09_04.png" alt="images/fig_09_04.png">
</div>
<div class="title">Figure 63. Initial WebSocket handshake in Chrome DevTools</div>
</div>
<div class="paragraph"><p>You can also click on <span class="monospaced">WebSocket</span> at the bottom-right to show only the <span class="monospaced">WebSocket</span> endpoints. Click on <span class="monospaced">Frames</span> in the right panel to view the actual frames being exchanged between the client and server. <a href="#FIG9-5">[FIG9-5]</a>. The white colored rows represent incoming data, and the green (or gray on paper) rows - outgoing.</p></div>
<div class="imageblock" id="FIG9-5">
<div class="content">
<img src="images/fig_09_05.png" alt="images/fig_09_05.png">
</div>
<div class="title">Figure 64. Monitoring WebSocket frames in Chrome Developer Tools</div>
</div>
<div class="paragraph"><p>For more gore details you can navigate your Google Chrome to the secret URL - <span class="monospaced">chrome://net-internals</span>, which is a very useful URL showing a lot of additional information (see <a href="#FIG9-6">[FIG9-6]</a> and <a href="#FIG9-7">[FIG9-7]</a> ). You can find documentation about net-internal in <a href="http://www.chromium.org/developers/design-documents/network-stack/view-net-internals">Chromium Design Documents</a></p></div>
<div class="imageblock" id="FIG9-6">
<div class="content">
<img src="images/fig_09_06.png" alt="images/fig_09_06.png">
</div>
<div class="title">Figure 65. Details of initial handshake in Chrome Net Internals</div>
</div>
<div class="imageblock" id="FIG9-7">
<div class="content">
<img src="images/fig_09_07.png" alt="images/fig_09_07.png">
</div>
<div class="title">Figure 66. Details of the socket connection</div>
</div>
<div class="paragraph"><p>Google Developer Tools show just the length of the data. But <span class="monospaced">chrome://net-internals</span> shows the actual size of the WebSocket frame too. <a href="#FIG9-8">[FIG9-8]</a> compares the views of net-internals and Developer Tools. As we learned earlier in this chapter, the total size of the frame is slightly different from the size of the payload. There are few more bytes for the frame header. Moreover, all outgoing messages will be masked by the browser (see the note in the <a href="#FRAMES">[FRAMES]</a> section). This frame&#8217;s mask is going to be transferred to the server as a part of the frame itself, which creates additional 32 bits (4 bytes) overhead.</p></div>
<div class="imageblock" id="FIG9-8">
<div class="content">
<img src="images/fig_09_08.png" alt="images/fig_09_08.png">
</div>
<div class="title">Figure 67. Dev tools and net-internals side by side</div>
</div>
</div>
<div class="sect3">
<h4 id="_sniffing_websocket_frames_with_wireshark">Sniffing WebSocket frames with Wireshark</h4>
<div class="paragraph"><p>Wireshark is a powerful and comprehensive monitoring tool for analyzing the network traffic.You can download it from <a href="http://www.wireshark.org">their web site</a>. To start capturing the WebSocket traffic traffic on <em>localhost</em>  select the <span class="monospaced">loopback</span> network interface from the left panel and click "Start" (see <a href="#FIG9-15">[FIG9-15]</a>).</p></div>
<div class="imageblock" id="FIG9-15">
<div class="content">
<img src="images/fig_09_15.png" alt="images/fig_09_15.png">
</div>
<div class="title">Figure 68. Wireshark application main view</div>
</div>
<div class="paragraph"><p>Wireshark captures all network activity. Set up the filter to see only the data you are interested in. We want to capture HTTP and TCP traffic on the port <span class="monospaced">8080</span> because our WebSocket server (Oracle&#8217;s GlassFish) runs on this port <a href="#FIG9-16">[FIG9-16]</a>. Enter <span class="monospaced">http &amp;&amp; (tcp.dstport==8080)</span> in the filter text box and click Apply.</p></div>
<div class="imageblock" id="FIG9-16">
<div class="content">
<img src="images/fig_09_16.png" alt="images/fig_09_16.png">
</div>
<div class="title">Figure 69. Filter setup</div>
</div>
<div class="paragraph"><p>Now the Wireshark is ready to sniff at the traffic of our application. You can start the auction session and place bids. After you&#8217;re done with the auction you can return to the Wireshark window and analyze what we got. You can see the initial handshake (<span class="monospaced">GET</span> request on <a href="#FIG9-17">[FIG9-17]</a> and the <span class="monospaced">Upgrade</span> response on <a href="#FIG9-18">[FIG9-18]</a>).</p></div>
<div class="imageblock" id="FIG9-17">
<div class="content">
<img src="images/fig_09_17.png" alt="images/fig_09_17.png">
</div>
<div class="title">Figure 70. The <span class="monospaced">GET</span> request for protocol upgrade</div>
</div>
<div class="imageblock" id="FIG9-18">
<div class="content">
<img src="images/fig_09_18.png" alt="images/fig_09_18.png">
</div>
<div class="title">Figure 71. The <span class="monospaced">GET</span> response with protocol upgrade</div>
</div>
<div class="paragraph"><p>After the successful connection upgrade, Wireshark captured the <span class="monospaced">http-alt</span> stream (this is how it reports the Websocket&#8217;s traffic) on the 8080 port. Right click on this row and select <span class="monospaced">Follow TCP Stream</span> <a href="#FIG9-19">[FIG9-19]</a>.</p></div>
<div class="imageblock" id="FIG9-19">
<div class="content">
<img src="images/fig_09_19.png" alt="images/fig_09_19.png">
</div>
<div class="title">Figure 72. The <span class="monospaced">GET</span> response with protocol upgrade</div>
</div>
<div class="paragraph"><p>On the next screen you can see the details of WebSocket frame <a href="#FIG9-20">[FIG9-20]</a>. We took this screenshot right after the auction application started. You can see here the data with the list of available auctions. The outgoing data is marked with <em>red</em> color and the incoming data is shown in <em>blue</em>.</p></div>
<div class="imageblock" id="FIG9-20">
<div class="content">
<img src="images/fig_09_20.png" alt="images/fig_09_20.png">
</div>
<div class="title">Figure 73. WebSocket frame</div>
</div>
<div class="paragraph"><p>The screenshot <a href="#FIG9-21">[FIG9-21]</a> was taken  after the auction has been closed. You can see here the entire data that were sent over the WebSocket connection.</p></div>
<div class="imageblock" id="FIG9-21">
<div class="content">
<img src="images/fig_09_21.png" alt="images/fig_09_21.png">
</div>
<div class="title">Figure 74. Entire auction conversation</div>
</div>
</div>
<div class="sect3">
<h4 id="Auction_Messages_Specification">Save Sick Child Auction Protocol</h4>
<div class="paragraph"><p>Since WebSocket is just a transport protocol, we need to come up with the application-level protocol of how the auction messages should be formatted in the client-server interaction. This is how we decided to do it:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The client&#8217;s code connects to the WebSocket endpoint on the server.
</p>
</li>
<li>
<p>
The client&#8217;s code sends the <span class="monospaced">AUCTION_LIST</span> message to retrieve the list of currently running auctions.
</p>
<div class="listingblock">
<div class="title">The AUCTION_LIST Request</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AUCTIONS_LIST"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"empty"</span><span style="color: #990000">,</span>        <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
    <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"-1"</span>       <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The type of the message is <span class="monospaced">AUCTION_LIST</span>
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
This message doesn&#8217;t send any data
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
This message doesn&#8217;t request for any specific auction id,  so we just send <span class="monospaced">-1</span>.
</td></tr>
</table></div>
<div class="paragraph"><p>Let&#8217;s review the JSON object that will be arriving from the server as the auction&#8217;s response.</p></div>
<div class="listingblock">
<div class="title">Response with auction list data</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AUCTIONS_LIST"</span><span style="color: #990000">,</span>    <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>                   <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
        <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"auctionState"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AUCTION_NOT_RUNNING"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"item"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>           <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/3.png" alt="3"></span></span>
                <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Painting"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Fancy"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"startingPrice"</span><span style="color: #990000">:</span> <span style="color: #993399">1000.0</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"auctionStartTime"</span><span style="color: #990000">:</span> <span style="color: #993399">6000</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"bidTimeoutS"</span><span style="color: #990000">:</span> <span style="color: #993399">30</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"bestBid"</span><span style="color: #990000">:</span> <span style="color: #993399">1000.0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"participantList"</span><span style="color: #990000">:</span> <span style="color: #990000">[],</span>
            <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"first"</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/4.png" alt="4"></span></span>
        <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">{</span>
            <span style="color: #FF0000">"auctionState"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"AUCTION_RUNNING"</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"item"</span><span style="color: #990000">:</span> <span style="color: #FF0000">{</span>
                <span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Handmade hat"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"description"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Awesome"</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"startingPrice"</span><span style="color: #990000">:</span> <span style="color: #993399">2000.0</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"auctionStartTime"</span><span style="color: #990000">:</span> <span style="color: #993399">6000</span><span style="color: #990000">,</span>
                <span style="color: #FF0000">"bidTimeoutS"</span><span style="color: #990000">:</span> <span style="color: #993399">30</span>
            <span style="color: #FF0000">}</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"bestBid"</span><span style="color: #990000">:</span> <span style="color: #993399">2000.0</span><span style="color: #990000">,</span>
            <span style="color: #FF0000">"participantList"</span><span style="color: #990000">:</span> <span style="color: #990000">[],</span>
            <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"second"</span>
        <span style="color: #FF0000">}</span>
    <span style="color: #990000">],</span>
    <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"0"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The message type is <span class="monospaced">AUCTION_LIST</span>
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The <span class="monospaced">data</span> property of the response object contains the list of all running auctions. An auction can be in one of three states: <em>not running</em>, <em>running</em>, or <em>finished</em>.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The <span class="monospaced">item</span> property of the response object is a nested object that represents the auction item.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
The <span class="monospaced">auctionId</span> property contains a unique identifier of the selected auction.
</td></tr>
</table></div>
</li>
<li>
<p>
The user picks the auction from the list, enters a desired nick name, and joins to the auction. The client-side application sends the following <span class="monospaced">login</span> message.
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"LOGIN"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/1.png" alt="1"></span></span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"gamussa"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">// <img src="images/icons/callouts/2.png" alt="2"></span></span>
    <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"second"</span> <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/3.png" alt="3"></span></span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
The message type is <span class="monospaced">LOGIN</span>
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
The <span class="monospaced">data</span> property of the request contains the user&#8217;s nickname.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
The <span class="monospaced">auctionId</span> property helps the server-side code to route the message to the correct auction.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">As soon as the handshake completes successfully, the server side code that implements <span class="monospaced">WebSocket</span> protocol exposes the WebSocket <span class="monospaced">Session</span> object.  The <span class="monospaced">Session</span> object encapsulates the conversation between the WebSocket endpoint (server - side) and remote endpoint (browser). Check the documentation for your server side framework for details about how it handles and exposes the remote endpoints in API.</td>
</tr></table>
</div>
</li>
<li>
<p>
Each time when the user enters the bid price the client&#8217;s code sends following <span class="monospaced">bid</span> message:
</p>
<div class="listingblock">
<div class="title">Bit message</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"BID"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1100.0"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"second"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Above is the outgoing message. When user clicks on the "Bid!" button the value from the Bid text box is wrapped into the  <span class="monospaced">BID</span> message. On the server, when the new higher <span class="monospaced">BID</span> message arrives, the message <span class="monospaced">PRICE_UPDATE</span> has to be broadcast to all active clients.</p></div>
</li>
<li>
<p>
The <span class="monospaced">PRICE_UPDATE</span> message
</p>
<div class="listingblock">
<div class="title">The PRICE_UPDATE Message</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"PRICE_UPDATE"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/1.png" alt="1"></span></span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"1300.0"</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900">//<img src="images/icons/callouts/2.png" alt="2"></span></span>
    <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"second"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
If some auction participant outbids others, the rest of the participants will receive an update.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Such an update will contain the current highest bid.
</td></tr>
</table></div>
</li>
<li>
<p>
The <span class="monospaced">RESULT</span> message
</p>
<div class="listingblock">
<div class="title">The RESULT Message</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #FF0000">{</span>
    <span style="color: #FF0000">"type"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"RESULT"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"data"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"Congrats! You</span><span style="color: #CC33CC">\u</span><span style="color: #FF0000">0027ve won Painting for $1300.0"</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">"auctionId"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"first"</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>After the auction ends, the server broadcasts the message with the final auction results. If the wining user is online and connected to the auction server, she&#8217;ll receive the message with congratulations.  Other participants will get the "Sorry, you didn&#8217;t win" notification.</p></div>
</li>
</ol></div>
<div class="paragraph"><p>This is pretty much it. The amount of code to implement the client&#8217;s side of the auction is minimal. After the connection and upgrade are done, most of the processing is done in the message handler of the WebSocket object&#8217;s <span class="monospaced">onmessage</span>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_6">Summary</h3>
<div class="paragraph"><p>After reading this chapter you should see the benefits of using WebSocket protocol in Web applications. In many cases WebSocket is an ultimate means for improving the application performance by reducing the network latency and removing the HTTP-headers overhead. You&#8217;ve learned how to integrate the WebSocket-based functionality into the existing HTTP-based application Save Sick Child. There is no need to make the entire communication of the Web application over WebSocket. Use this powerful protocol when it&#8217;s clearly improves the performance and responsiveness of your application.</p></div>
<div class="paragraph"><p>As a side benefit, you&#8217;ve learned how to use the network monitoring capabilities of Google Chrome Developer Tools and Wireshark application by sniffing the WebSocket traffic. You can&#8217;t underestimate the importance of monitoring tools, which are the best friends of Web developers.</p></div>
</div>
</div>
</div>
<h1 id="_part_2_mobile">Part 2: Mobile</h1>
<div class="sect1">
<h2 id="_responsive_design_one_site_fits_all">Responsive Design: One Site Fits All</h2>
<div class="sectionbody">
<div class="paragraph"><p>Up till now we&#8217;ve been writing and re-writing the desktop version of the Save Sick Child application. Will it look good on the small screen of a mobile device?</p></div>
<div class="paragraph"><p>Let&#8217;s discuss different approaches to making the Web site for mobile devices. One of the approaches is having only one Web site for all devices. There are three choices:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Develop separate version of native applications for each mobile device. Developing of native mobile applications is not covered in this book.
</p>
</li>
<li>
<p>
Develop one HTML5 Web application, but create several different UI layouts that will be applied automatically based on the screen size of the user&#8217;s device.
</p>
</li>
<li>
<p>
Develop a <em>hybrid application</em>, which is a Web application on steroids - it can invoke native API of the mobile device. Chapter 14 is dedicated to hybrid applications.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The chapter is about the second approach called <em>Responsive Design</em>. This term was coined by Ethan Marcotte is the article <a href="http://www.alistapart.com/articles/responsive-web-design/">Responsive Web Design</a>. The design of the Web page changes responding (reacting) to the user&#8217;s display size. We&#8217;ll modify the design of the Save Sick Child site to introduce different layouts for the desktop, tablet, and smart phones. By the end of this chapter the site Save Sick Child will automatically change its layout based on the user&#8217;s device without the losing functionality.</p></div>
<div class="sect2">
<h3 id="_one_or_two_versions_of_code">One or Two Versions of Code?</h3>
<div class="paragraph"><p>Run any of the versions of our Save Sick Child applications on your desktop and start dragging the right border of the browser&#8217;s window to make it narrower. At some point you&#8217;ll see only a part of the content - the layout of Save Sick Child was not meant to be responsive. It defined fixed sizes for the page sections, which didn&#8217;t change even if the display area shrinks.</p></div>
<div class="paragraph"><p>Enter the address of one of the <a href="http://savesickchild.org:8080/project-15-dynamic-content-modules/">Save Sick Child</a> projects in your mobile phone&#8217;s browser. Either you&#8217;ll see a partial content of the page or the entire page with illegible small fonts. Our design of the Save Sick Child application doesn&#8217;t look good on all devices.</p></div>
<div class="paragraph"><p>How many versions of the UI do we need to create then? People responsible for developing a Web applications that can run on both desktop and mobile platforms usually start with making an important decision: HTML5 or native?  But even if a decision was made in the favor of the Web platform, the next question is if the desktop and mobile clients will use the same code or not.</p></div>
<div class="paragraph"><p>If a decision is made to go with separate versions of the Web applications, the Web server can be configured to perform the redirection to the appropriate code depending on the type of the user&#8217;s device. Web servers can do it based on the value of the <span class="monospaced">User-Agent</span> attribute of the HTTP request header. For example, the mobile Web browsers trying to access of <a href="http://www.bbc.com/">BBC</a> (or any other Web page) report their <span class="monospaced">User-Agent</span> to the server differently from desktop computers  hence they receive different content delivered from a different URL. The snapshots <a href="#FIG11-1">[FIG11-1]</a> and <a href="#FIG11-2">[FIG11-2]</a> of the BBC main page were taken at the same time, but <a href="#FIG11-1">[FIG11-1]</a> shows how the page looks on the desktop computer, while <a href="#FIG11-2">[FIG11-2]</a> was taken from the iPhone.</p></div>
<div class="imageblock" id="FIG11-1">
<div class="content">
<img src="images/fig_11_01.jpg" alt="images/fig_11_01.jpg">
</div>
<div class="title">Figure 75. The desktop version of bbc.com</div>
</div>
<div class="paragraph"><p>The <a href="#FIG11-1">[FIG11-1]</a> page layout delivers more content as it can be allocated nicely on the large desktop monitor or a tablet. But the mobile version on <a href="#FIG11-2">[FIG11-2]</a> substantially limits what&#8217;s delivered to the client, which is done not only because the screen is small, but the user may be accessing the page over the slower network.</p></div>
<div class="imageblock" id="FIG11-2">
<div class="content">
<img src="images/fig_11_02.png" alt="images/fig_11_02.png">
</div>
<div class="title">Figure 76. The mobile version of bbc.com</div>
</div>
<div class="paragraph"><p>Have you ever tried to share the link of the Web site from your iPhone? It&#8217;s so easy! Just press the button and enter the email of the person to share the site with. Go to bbc.com from your iPhone or Android phone and share this link with someone. That person will receive the link <a href="http://www.bbc.co.uk/mobile/i/">http://www.bbc.co.uk/mobile/i</a>, and if she&#8217;s visit this site from the desktop it won&#8217;t look pretty. It&#8217;ll just show the wider version of what you see in <a href="#FIG11-2">[FIG11-2]</a>. Try to enter this URL in your desktop browser to see for yourself.</p></div>
<div class="paragraph"><p>Maintaining two different versions of the application code requires more efforts than maintaining one: you need to have two sets of HTML, CSS, JavaScript, and images. Besides, most likely your Web application will use a  third-party JavaScript framework. At some point you may run into a bug and will need to upgrade the mobile version to use the latest version of, say jQuery framework. But the desktop version works just fine. In case of having two separate versions of the application you&#8217;ll have to either upgrade jQuery and thoroughly test both mobile and desktop versions of Save Sick Child, or live with two different versions of the framework.</p></div>
<div class="paragraph"><p>Responsive design allows you to create one version of the Web application, which includes multiple sections of CSS controlling page layouts for different screen sizes. In this chapter we&#8217;ll create yet another version of the  Save Sick Child application that will render UI differently on desktop and mobile devices. All these version will share the same HTML and JavaScript code, but will include several versions of styling using <em>CSS media queries</em>.</p></div>
<div class="paragraph"><p>There is a number of Web sites that were built using responsive design. Visit the following Web sites first from the desktop computer and then from smart phones (or just lower the width of the desktop browser window) to experience such fluid responsive design:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<a href="http://bostonglobe.com/">Boston Globe</a>
</p>
</li>
<li>
<p>
<a href="http://mashable.com/">Mashable</a>
</p>
</li>
<li>
<p>
<a href="http://cafeevoke.com/">Cafe Evoke</a>
</p>
</li>
<li>
<p>
<a href="http://www.fork-cms.com/">Fork CMS</a>
</p>
</li>
<li>
<p>
<a href="http://forefathersgroup.com/">Forefathers</a>
</p>
</li>
</ol></div>
<div class="paragraph"><p>Note that each of these Web pages displays the content on the desktop in three different layouts (often in three imaginary columns). As you make the window narrower, the layout will automatically switch to the tablet or a large smartphone mode (usually two columns layout), and then to the phone mode layout (the one column layout).</p></div>
<div class="paragraph"><p>This sounds like a great solution, but keep in mind that your users will be downloading unnecessary bytes - the entire CSS file that includes all versions of screen layouts. This is not the case in the BBC example, which has different versions of the code that load only what&#8217;s necessary for a particular device category.</p></div>
<div class="paragraph"><p>Now comes the million dollar question, "Do we need to create two different versions of the Web application or twenty two?  Why not two hundred and twenty two?" How many different mobile devices are there today and will be there tomorrow?</p></div>
<div class="sect3">
<h4 id="_how_many_user_agents_are_there">How many User Agents are there</h4>
<div class="paragraph"><p>The HTTP header&#8217;s attribute <span class="monospaced">User-Agent</span> contains information about the user agent originating request. Should you decide to create several versions of the UI based on the value in the <span class="monospaced">User-Agent</span> field, you can refer to the Web site <a href="http://useragentstring.com">http://useragentstring.com</a>. It lists not two, but hundreds of strings representing possible content of the <span class="monospaced">User-Agent</span> attribute for a variety of desktop and mobile devices. For example, <a href="#FIG11-3">[FIG11-3]</a> shows how the <span class="monospaced">User-Agent</span> string from  iPhone5 is reported and explained by <a href="http://useragentstring.com/">useragentstring.com</a>.</p></div>
<div class="imageblock" id="FIG11-3">
<div class="content">
<img src="images/fig_11_03.png" alt="images/fig_11_03.png">
</div>
<div class="title">Figure 77. The User-Agent String from iPhone 5</div>
</div>
<div class="paragraph"><p>It&#8217;s impossible to create different layouts of a Web application for thousands of user agents. Grouping devices by screen sizes is a more practical approach for lowering the number of UI layouts supported by your application. The responsive design is a collection of techniques based upon three pillars:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
CSS <em>media queries</em>
</p>
</li>
<li>
<p>
<em>Fluid grids</em> or fluid layouts
</p>
</li>
<li>
<p>
Fluid media
</p>
</li>
</ol></div>
<div class="paragraph"><p>Media queries allows to rearrange the sections (<span class="monospaced">&lt;div&gt;</span><em>s</em>) of the page based on the screen size, fluid grids allows to properly scale the content of these sections, and the fluid media is about resizing images or videos. But before going into technical details, let&#8217;s get back to the mockups to see how the UI should look like on different devices.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_back_to_mockups">Back to mockups</h3>
<div class="paragraph"><p>Jerry, our Web designer came up with another set of Balsamiq mockups for the Save Sick Child application. This time he had four different versions: desktop, tablet, large phone, and small phone. As a matter of fact, Jerry provided more mockups - the user can hold both smartphones and tablets either in portrait or landscape mode.  <a href="#FIG11-4">[FIG11-4]</a>, <a href="#FIG11-5">[FIG11-5]</a>, and <a href="#FIG11-6">[FIG11-6]</a>, <a href="#FIG11-7">[FIG11-7]</a> show the screenshots taken from Balsamiq Mockups for desktop, tablet, large, and small phone layouts. <a href="#FIG11-4">[FIG11-4]</a> shows the desktop mockup.</p></div>
<div class="imageblock" id="FIG11-4">
<div class="content">
<img src="images/fig_11_04.png" alt="images/fig_11_04.png">
</div>
<div class="title">Figure 78. The Desktop layout</div>
</div>
<div class="paragraph"><p>Jerry gave us several version of the images - with and without the grid background. The use of the grid will be explained later in the section "Fluid Grids". <a href="#FIG11-5">[FIG11-5]</a> depicts the rendering on tablet devices that fall in a category of under 768px width screen in the portrait mode.</p></div>
<div class="imageblock" id="FIG11-5">
<div class="content">
<img src="images/fig_11_05.png" alt="images/fig_11_05.png">
</div>
<div class="title">Figure 79. The tablet layout (portrait)</div>
</div>
<div class="paragraph"><p>Next comes the mockup for the large smart phones having the width of up to 640 pixels. <a href="#FIG11-6">[FIG11-6]</a> shows two different images of the screen next to each other (the user would need to scroll to see the second image).</p></div>
<div class="imageblock" id="FIG11-6">
<div class="content">
<img src="images/fig_11_06.png" alt="images/fig_11_06.png">
</div>
<div class="title">Figure 80. The large phone layout (portrait)</div>
</div>
<div class="paragraph"><p>The mockup for the smaller phones with the width of under 480 pixels is shown on <a href="#FIG11-7">[FIG11-7]</a>. The mockup looks wide, but it actually shows three views of the phone screen next to each other. The user would need to scroll vertically to see the middle or the right view. Physical screens are not too small - iPhone 3 falls into this category, but resolution-wise they are smaller.</p></div>
<div class="imageblock" id="FIG11-7">
<div class="content">
<img src="images/fig_11_07.png" alt="images/fig_11_07.png">
</div>
<div class="title">Figure 81. The small phone layout (portrait)</div>
</div>
<div class="paragraph"><p>If need be, you can ask Jerry to create mocupts for the really devices with the width under 320 pixels, but we won&#8217;t even try it here. Now we need to translate these mockups into working code. The first subject to learn is CSS media queries.</p></div>
</div>
<div class="sect2">
<h3 id="_css_media_queries">CSS Media Queries</h3>
<div class="paragraph"><p>First, let&#8217;s see the CSS media queries in action, and then we&#8217;ll explain how this magic was done. Run Aptana&#8217;s project titled Responsive_basic_media_queries, and it&#8217;ll look as in <a href="#FIG11-8">[FIG11-8]</a>. This is a desktop version for the desktops (or some tablets in the landscape mode). The section chart, map, and video divide the window into three imaginary columns.</p></div>
<div class="imageblock" id="FIG11-8">
<div class="content">
<img src="images/fig_11_08.png" alt="images/fig_11_08.png">
</div>
<div class="title">Figure 82. The tesktop layout implemented</div>
</div>
<div class="paragraph"><p>Drag the right border of your desktop Web browser&#8217;s window to the left to make it narrower. After reaching certain <em>breakpoint width</em> (in our project it&#8217;s 768 pixels) you&#8217;ll see how the <span class="monospaced">&lt;div&gt;</span><em>s</em> reallocate themselves into the two-column window shown on <a href="#FIG11-9">[FIG11-9]</a>.</p></div>
<div class="imageblock" id="FIG11-9">
<div class="content">
<img src="images/fig_11_09.png" alt="images/fig_11_09.png">
</div>
<div class="title">Figure 83. The tablet layout (portrait) implemented</div>
</div>
<div class="paragraph"><p>Keep making the browser&#8217;s window narrower, and when the width will pass another breakpoint (becomes less than 640 pixels), the window will re-arrange itself into one long column as in <a href="#FIG11-10">[FIG11-10]</a>. The users will have to use scrolling to see the lower portion of this window, but they don&#8217;t loose any content.</p></div>
<div class="imageblock" id="FIG11-10">
<div class="content">
<img src="images/fig_11_10.png" alt="images/fig_11_10.png">
</div>
<div class="title">Figure 84. The smaller phone layout (portrait) implemented</div>
</div>
<div class="paragraph"><p>The W3C Recommendation titled <a href="http://www.w3.org/TR/css3-mediaqueries/">Media Queries</a> has been introduced in CSS2 and HTML4. The idea was to provide different stylesheets for different media. For example, you can specify different stylesheets in HTML using the <span class="monospaced">media</span> for the regular screen and for the smaller ones (up to 640 pixel in width).</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/css/style.css"</span> <span style="color: #009900">media</span><span style="color: #990000">=</span><span style="color: #FF0000">"screen"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/css/style_small.css"</span>
                       <span style="color: #009900">media</span><span style="color: #990000">=</span><span style="color: #FF0000">"only screen and (max-width: 640px)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>You may have several of such <span class="monospaced">&lt;link&gt;</span> - tags for different screen widths. But all of them will be loaded regardless of the actual size of the user&#8217;s display area. The modern browser may defer loading of the CSS files that don&#8217;t match the current display size.</p></div>
<div class="paragraph"><p>The other choice is to specify a section in a CSS file using one or more <span class="monospaced">@media</span> rules. For example, the following style will be applied to the HTML element with the <span class="monospaced">id=main-top-section</span> if the width of the display area (screen) is less than 640 pixels. Screen is not the only media type that you can use with media queries. For example, you can use <span class="monospaced">print</span> for printed documents or <span class="monospaced">tv</span> for tv devices. For the up to date list of media types see the W3C Media Queries Recommendation.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@media only screen and (max-width: 640px) {

  #main-top-section {
                width: 100%;
                float: none;
 }
}</tt></pre></div></div>
<div class="paragraph"><p>The fragment of the CSS file styles.css from the project Responsive_basic_media_queries is shown next. It starts with defining styles for windows having 1280px width (we use 1140 pixels to leave some space for padding and browser&#8217;s chrome). This CSS mandates to change the page layouts if the screen size is or becomes below 768 or 640 pixels. Based on your Web designer&#8217;s recommendations you can specify as many breakout sizes as needed. Say, in the future, everyone will have at lease 1900px wide monitor - you can provide a layout that would use five imaginary columns. This can be a good idea for online newspapers or magazines, but Save Sick Child is not a publication so we keep its maximum width within 1140px. Or you may decide to make a version of Save Sick Child available for LCDs of only 320px in width - create a new media query section in your CSS and apply fluid grids to make the content readable.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
/* The main container width should to be 90% of viewport width but not wider than 1140px */
#main-container {
        width: 90%;
        max-width: 1140px;            // <img src="images/icons/callouts/1.png" alt="1">
        margin: 0 auto;
}

/* Background color of all elements was set just as an example */
header {
        background: #ccc;
        width: 100%;
        height: 80px;
}

#main-top-section {
        background: #bbb;
        width: 100%;
        height: 300px;
        position: relative;
}

#main-bottom-section {
        width: 100%;
}

#video-container, #map-container, #charts-container {
        width: 33.333%;                   // <img src="images/icons/callouts/2.png" alt="2">
        padding-bottom: 33.333%;
        float: left;                      // <img src="images/icons/callouts/3.png" alt="3">
        position: relative;
}

#video, #map, #charts {
        background: #aaa;
        width: 100%;
        height: 100%;
        position: absolute;
        padding: 0.5em;
}

#map {
        background: #999;
}

#charts {
        background: #7d7d7d;
}

footer {
        background: #555;
        width: 100%;
        height: 80px;
        color: #fff;
}

/* media queries */

@media only screen and (max-width: 768px) {    // <img src="images/icons/callouts/4.png" alt="4">
        #main-container {
                width: 98%
        }

        #main {
                background: #bbb;
        }

        #main-top-section, #main-bottom-section {
                width: 50%;                           // <img src="images/icons/callouts/5.png" alt="5">
                float: left;                          // <img src="images/icons/callouts/6.png" alt="6">
        }

        #main-top-section {
                height: 100%;
        }

        #video-container, #map-container, #charts-container {
                float: none;                         //   <img src="images/icons/callouts/7.png" alt="7">
                width: 100%;
                padding-bottom: 70%;
        }

}

@media only screen and (max-width: 640px) {   //  <img src="images/icons/callouts/8.png" alt="8">

        #main-top-section, #main-bottom-section {
                width: 100%;                          //  <img src="images/icons/callouts/9.png" alt="9">
                float: none;
        }

        #main-top-section {
                height: 400px;
        }

        #video, #map, #charts {
                height: 60%;
        }
}</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Setting the maximum width of the window on a desktop to 1140 pixels. It&#8217;s safe to assume that any modern monitor supports the resolution of 1280px width (minus about 10% for padding and chrome).
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Allocate one third of the width for video, charts, and maps each.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Float left instructs the browser to render each of these divs starting from the left and adding the next one to the right.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
The media query controlling layouts for devices with viewports with the max width of 768px starts here.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
Split the width fifty-fifty between the HTML elements with ID&#8217;s main-top-section and main-bottom-section.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
Allocate main-top-section and main-bottom-section next to each other (<span class="monospaced">float: left;</span>) as in <a href="#FIG11-9">[FIG11-9]</a>. To better understand how the CSS <span class="monospaced">float</span> property works, visualize a book page having an small image on the left with the text floating on the right (a text wrap) - this is what <span class="monospaced">float: left;</span> can do on a Web page.
</td></tr>
<tr><td><img src="images/icons/callouts/7.png" alt="7"></td><td>
Turn the floating off so the charts, maps, and video containers will start one under another as in <a href="#FIG11-9">[FIG11-9]</a>.
</td></tr>
<tr><td><img src="images/icons/callouts/8.png" alt="8"></td><td>
The media query controlling layouts for devices with viewports with the max width of 640px starts here.
</td></tr>
<tr><td><img src="images/icons/callouts/9.png" alt="9"></td><td>
Let the containers main-top-section, main-bottom-section take the entire width and be displayed one under another (<span class="monospaced">float: none;</span>) as in <a href="#FIG11-10">[FIG11-10]</a>.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Internet Explorer 8 and older don&#8217;t natively support media queries. Consider using Modernizr to detect support of this feature, and load the <a href="https://github.com/h5bp/mobile-boilerplate/wiki/Media-Queries-Polyfill">Media Queries Polyfill</a>, if needed.</td>
</tr></table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The Viewport Concept</div>
<div class="paragraph"><p>Mobile browsers use a concept of <em>viewport</em>, which is a virtual window where they render the Web page content. This virtual window can be wider than the actual width of the display of the user&#8217;s mobile device. For example, by default iOS Safari and Opera Mobile render the page to the width of 980px, and then shrinks it down to the actual width (320px on old iPhones and 640px on iPhone 4 and 5). By using the meta tag <span class="monospaced">viewport</span> your Web page overrides this default and renders itself according to the actual device size.  All code samples in this chapter include the <span class="monospaced">viewport</span> meta tag in index.html. All mobile browsers support it even though it&#8217;s not a part of the HTML standard yet.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>---
<span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"viewport"</span> <span style="color: #009900">content</span><span style="color: #990000">=</span><span style="color: #FF0000">"width=device-width, initial-scale=1.0"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
---</tt></pre></div></div>
<div class="paragraph"><p>This meta tag tels the browser that the width of the virtual viewport should be the same as the width of the display. It&#8217;ll will work fine if your responsive design includes a version of the page layout optimized for the width of the user&#8217;s device. But if you&#8217;d be rendering a page that&#8217;s narrower than the default width of the display (e.g. 500 pixels) setting the attribute <span class="monospaced">content="width=500"</span> would allow the mobile Web browser to scale the page to occupy the entire display real estate. Setting the initial scaling to 1.0 ensures that the page will be rendered as close to the physical device size as possible. If you don&#8217;t want to allow the user scale the Web page, add the attribute <span class="monospaced">user-scalable=no</span> to the meta tag <span class="monospaced">viewport</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/warning.png" alt="Warning">
</td>
<td class="content">If you&#8217;ll apply the initial scale to be 1.0, but to a Web page that was not build using responsive design principles, users will need to zoom or pan to see the entire page.</td>
</tr></table>
</div>
<div class="paragraph"><p>For details about configuring the viewport refer to <a href="https://developer.apple.com/library/safari/#documentation/AppleApplications/Reference/SafariWebContent/UsingtheViewport/UsingtheViewport.html">Apple&#8217;s</a> or <a href="http://dev.opera.com/articles/view/an-introduction-to-meta-viewport-and-viewport/">Opera&#8217;s</a> documentation.</p></div>
</div></div>
<div class="paragraph"><p>Some of the important concepts to take away from this example are to switch from pixels to percentages when specifying width. In the next examples you&#8217;ll see how to switch from using rigid <span class="monospaced">px</span> to more flexible <span class="monospaced">em</span> units. The CSS <span class="monospaced">float</span> property you can control relative (not absolute) positioning of your page components.</p></div>
<div class="sect3">
<h4 id="_how_many_breakpoints">How Many Breakpoints?</h4>
<div class="paragraph"><p>How many media queries is too many? It all depends on the Web page you&#8217;re designing. In the sample CSS shown in this section above we&#8217;ve used the breakpoint of 768px to represent the width of the tablet in the portrait mode, and this is fine for the iPad. But several tablets (e.g. 10.1" Samsung Galaxy) have 800px-wide viewport while Microsoft Surface Pro is 1080px wide.</p></div>
<div class="paragraph"><p>There is no general rule as to how many breakpoint is needed for a typical Web page. But if there is a vieport width when you change the layout of the page, create a breakpoint for this width. Just create a simple Lorem Ipsum prototype of your Web site and start changing its size. If you don&#8217;t like how the content looks, you may need to create a breakpoint and define a media query for it. It is recommended to start with designing for the smallest viewports (the "Mobile First" principle). As the viewport width increases you may decide to render more content hence define a new breakpoint.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Use Google Chrome Developer Tools to find out the current width of the viewport. Just type in the console <span class="monospaced">window.innerWidth</span> and you&#8217;ll see the width in pixels.</td>
</tr></table>
</div>
<div class="paragraph"><p>Don&#8217;t try to create a pixel perfect layout using responsive design. Use common sense and remember, the more different media queries you provide the heavier your CSS file will become. But in mobile world you should try to create Web applications as slim as possible.</p></div>
<div class="paragraph"><p>Warning: Be prepared to see inconsistencies among the desktop browsers in measuring the width of the viewport. Our tests showed that WebKit-based browsers add about 15px to the width, supposedly accounting for the width of the scrollbar. So if you have a media query that has to change the layout at 768px, it&#8217;ll change it at about 783px. Do more testing on different viewports and adjust your CSS as needed.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_fluid_grids">Fluid Grids</h3>
<div class="paragraph"><p>Fluid grids is a very important technique in the responsive design. Grids were used by Web designers for ages - a web page was divided by a number of imaginary rows and columns. But the fluid grid, as the name implies, is flexible and can scale based on the screen sizes.</p></div>
<div class="sect3">
<h4 id="_moving_away_from_absolute_sizing">Moving Away From Absolute Sizing</h4>
<div class="paragraph"><p>When a browser displays text it uses its default font size unless it was overruled by the <span class="monospaced">font-size</span> property. Typically, the default font size is 16 pixels. But instead of using the absolute font size, you can use the relative one by using so called <em>em</em> units. The default browser&#8217;s font size can be represented by 1em. Since the font size happens to be 16px then 1em is 16 px.</p></div>
<div class="paragraph"><p>The absolute sizes are enemies of the responsive design Web sites, and specifying the sizes in em unit allows you to create Web pages with the pretty flexible and fluid content. The size can be calculated based on a formula offered by Ethan Markotte in his <a href="http://www.alistapart.com/articles/fluidgrids/">article on fluid grids</a>: <span class="monospaced">target/context=result</span>, which in case of fonts becomes <span class="monospaced">size-in-pixels/16 = size-in-em</span>.</p></div>
<div class="paragraph"><p>For example, instead of specifying the size as 24px, you can set it to 1.5em: 24/16. In your CSS file you can write something like <span class="monospaced">padding-bottom: 1.5em</span>. This may seem not a big deal, but it is, because if everything is done in relative sizing, your page will look good and proportional regardless of the screen size and regardless of how big or small 24px may look on a particular screen.</p></div>
<div class="paragraph"><p>If we are talking about em units for representing font sizes, the font becomes <em>the context</em>, but what if you want to represent the width of an arbitrary HTML component in a browser&#8217;s window or any other container? Then the width of your component becomes the <span class="monospaced">target</span> and the total width of the container becomes the <span class="monospaced">context</span>. We can still use the above formula, but will multiply the result by 100%. This way the width on an HTML component will be represented not in em, but in percentages relative to the total width of the container.</p></div>
<div class="paragraph"><p>For example, if the total width of the browser&#8217;s window is 768px, and we want to create a 120px-wide panel on the left, instead of specifying this width in pixels we&#8217;ll use the formula and turn it into percentages.We want to calculate the target&#8217;s width in percents of the available context (100%):</p></div>
<div class="paragraph"><p>120 / 768 * 100% = 15.625%</p></div>
<div class="paragraph"><p>Such approach makes the page design <em>fluid</em>. If someone decides to open this page on a 480px-wide screen, the panel will still take 15.625% of the screen rather than demanding 120 pixels, which would look substantially wider on a smaller viewport.</p></div>
</div>
<div class="sect3">
<h4 id="_window_as_a_grid">Window as a Grid</h4>
<div class="paragraph"><p>While designing your page you can overlay any HTML container or the entire Web page real estate with imaginary grid with any number of columns. Make it flexible though - the width of each column has to be specified in percentages.</p></div>
<div class="paragraph"><p><a href="http://www.adobe.com/products/dreamweaver.html">Adobe Dreamweaver CS6</a> automates creation of media queries and it introduced Fluid Grid layout (see <a href="#FIG11-11">[FIG11-11]</a>). It also allows you to quickly see how your design will look like on the tablet or phone (you can pick screen size too) with a click on the corresponding status bar button.</p></div>
<div class="imageblock" id="FIG11-11">
<div class="content">
<img src="images/fig_11_11.png" alt="images/fig_11_11.png">
</div>
<div class="title">Figure 85. Creating a Fluid Grid Layout in Dreamweaver</div>
</div>
<div class="paragraph"><p>Web designers use different approaches in styling with fluid grids. When you design a new page with Dreamweaver&#8217;s Fluid Grid Layout it suggests you to allocate different number of columns for desktop, tablet and mobile, for example, its default offer is to allocate 12 columns for the desktops, 8 for the tablets, and 5 for phones, which is perfectly solid approach. But our Web designer Jerry prefers using 12 columns for all screen sizes playing with the width percentages for different layouts - you&#8217;ll see how he does it in the project Responsive Donation Section later in this chapter.</p></div>
<div class="paragraph"><p>Now imagine that you&#8217;ll overlay the entire window with an invisible grid containing twelve equally sized columns. In this case each column will occupy 8.333% of the total width. Now, if you&#8217;d need to allocate to some HTML component about 40% of the total width, you could do this by allocating five grid columns (8.333% * 5 = 41.665%). Accordingly, your CSS file can contain 12 classes that you can use in your page:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>.one-column {
        width: 8.333%;
}

.two-column {
        width: 16.666%;
}

.three-column {
        width: 24.999%;
}

.four-column {
        width: 33.332%;
}

.five-column {
        width: 41.665%;
}

.six-column {
        width: 49.998%;
}

.seven-column {
        width: 58.331%;
}

.eight-column {
        width: 66.664%;
}

.nine-column {
        width: 74.997%;
}

.ten-column {
        width: 83.33%;
}

.eleven-column {
        width: 91.663%;
}

.twelve-column {
        width: 100%;
        float: left;
}</tt></pre></div></div>
<div class="paragraph"><p>Now let&#8217;s see the fluid grid in action. Run the Aptana&#8217;s project Responsive Fluid Grid and you&#8217;ll see the Web page that looks similar to <a href="#FIG11-12">[FIG11-12]</a>. This example changes the grid layout if the viewport width falls under one of the following width breakpoints: 768px, 640px, and 480px. In this context the term <em>breakpoints</em> here has nothing to do with debugging - we just want the content of the Web page to be rearranged when the width of the viewport passes one of these values.</p></div>
<div class="imageblock" id="FIG11-12">
<div class="content">
<img src="images/fig_11_12.png" alt="images/fig_11_12.png">
</div>
<div class="title">Figure 86. Fluid Grid on the wide screen</div>
</div>
<div class="paragraph"><p>If you&#8217;ll start lowering the width of the browser&#8217;s window, you&#8217;ll see how the grid cells start squeezing, but the layout remains the same until the page size will become lower than one of the predefined breakpoints. Then another media query kicks in and the layout changes. For example, <a href="#FIG11-13">[FIG11-13]</a> shows the fragment of the Web page when the width of the browser&#8217;s window goes below 640px. The 12-, 6-, and 4-cell grids show all the cells vertically one under another. Only the 480px grids still have enough room to display their cells horizontally. But if you keep squeezing the window, all the grids will display their content in one column as long as the viewport width stays under 480px.</p></div>
<div class="imageblock" id="FIG11-13">
<div class="content">
<img src="images/fig_11_13.png" alt="images/fig_11_13.png">
</div>
<div class="title">Figure 87. Fluid Grid on the viewport under 640px</div>
</div>
<div class="paragraph"><p>The fragment of the index.html from the Responsive Fluid Grid project goes next. For brevity, we&#8217;ve removed some repetitive markup and marked such places with the comment "A fragment removed for brevity". This code fragment includes the 12-, 6-, and 4-column grids shown on top of <a href="#FIG11-12">[FIG11-12]</a>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">charset</span><span style="color: #990000">=</span><span style="color: #FF0000">"utf-8"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Responsive fluid grid<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"description"</span> <span style="color: #009900">content</span><span style="color: #990000">=</span><span style="color: #FF0000">"Responsive fluid grid example"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;meta</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"viewport"</span> <span style="color: #009900">content</span><span style="color: #990000">=</span><span style="color: #FF0000">"width=device-width,initial-scale=1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;link</span></span> <span style="color: #009900">rel</span><span style="color: #990000">=</span><span style="color: #FF0000">"stylesheet"</span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"css/style.css"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrapper-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Responsive fluid grid example<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Breakpoint-768: change float of HTML elements
                                          if viewport is 768px or smaller<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row breakpoint-768"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"one-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                1
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"one-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                2
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"one-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                3
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

          <span style="font-style: italic"><span style="color: #9A1900">&lt;!--  A fragment removed for brevity --&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"one-column cell last-cell"</span> <span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                12
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Breakpoint-768: change float of the 12-cell grid if viewport is 768px or smaller<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row breakpoint-768"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"two-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                1
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"two-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                2
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

             <span style="font-style: italic"><span style="color: #9A1900">&lt;!--  A fragment removed for brevity --&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"two-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                6
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h4</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"temp-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Breakpoint-768: change float of the 6-cell grid if viewport is 768px or smaller<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h4&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row breakpoint-640"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"three-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                1
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"three-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                2
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"three-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                3
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"three-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                4
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Note that some of the above HTML elements are styled with more than one class selector, for example <span class="monospaced">class="one-column cell"</span>. The entire content of the file styles.css from Responsive Fluid Grids project is shown next, and you can find the declarations of the class selectors <span class="monospaced">one-column</span> and <span class="monospaced">cell</span> there. Note the section with media queries in this file.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>* {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
        -webkit-box-sizing:border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
}

article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {
        display: block;
}

ul li {
        list-style: none;
}

.row:before, .row:after, .clearfix:before, .clearfix:after {
        content: "";
        display: table;
}

.row:after, .clearfix:after {
        clear: both;
}

/* Start of fluid grid styles */

.row {                          //  <img src="images/icons/callouts/1.png" alt="1">
        padding: 0 0 0 0.5em;
        background: #eee;
}

.breakpoint-480 .cell, .breakpoint-640 .cell, .breakpoint-768 .cell,
                       .breakpoint-960 .cell, .no-breakpoint .cell { //<img src="images/icons/callouts/2.png" alt="2">
        float: left;
        padding: 0 0.5em 0 0;
}

.one-column {
        width: 8.333%;    //  <img src="images/icons/callouts/3.png" alt="3">
}

.two-column {
        width: 16.666%;   //  <img src="images/icons/callouts/4.png" alt="4">
}

.three-column {
        width: 24.999%;   //   <img src="images/icons/callouts/5.png" alt="5">
}

.four-column {
        width: 33.332%;
}

.five-column {
        width: 41.665%;
}

.six-column {
        width: 49.998%;
}

.seven-column {
        width: 58.331%;
}

.eight-column {
        width: 66.664%;
}

.nine-column {
        width: 74.997%;
}

.ten-column {
        width: 83.33%;
}

.eleven-column {
        width: 91.663%;
}

.twelve-column {
        width: 100%;
        float: left;
}

.right {
        float: right;
}

.row.nested {
        padding: 0;
        margin-right: -0.5em
}

/* --------------- Media queries -------------- */

@media only screen and (max-width: 768px) {
        .breakpoint-768 .cell {
                float: none;                         // <img src="images/icons/callouts/6.png" alt="6">
                width: 100%;                         // <img src="images/icons/callouts/7.png" alt="7">
                padding-bottom: 0.5em
        }
}

@media only screen and (max-width: 640px) {
        .breakpoint-640 .cell {                  // <img src="images/icons/callouts/8.png" alt="8">
                float: none;
                width: 100%;
                padding-bottom: 0.5em
        }
}

@media only screen and (max-width: 480px) {
        .breakpoint-480 .cell {
                float: none;
                width: 100%;
                padding-bottom: 0.5em
        }
}

/*End of fluid grid styles*/

#wrapper-container {
        width: 95%;
        max-width: 1140px;
        margin: 0 auto;
}

/* --- .cell visualisation --- */
.cell {
        min-height: 50px;
        text-align:center;
        border-left: 1px solid #aaa;
        vertical-align: middle;
        line-height: 50px;
}
.cell .cell:first-child{
        border-left:none;
}
/* --- .cell visualisation end --- */

h1.temp-heading, h2.temp-heading, h4.temp-heading {
        font-size: 1.4em;
        margin: 1em 0;
        text-align: center
}
h4.temp-heading {
        font-size: 1.1em;
}

p.temp-project-description {
        margin: 2em 0;
}</tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1"></td><td>
Styling grid rows, which  are containers for cells.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2"></td><td>
Defining common class selectors (floating and padding) for the cells located in the viewports of any width. Please note the property <span class="monospaced">float: left;</span> - it&#8217;ll change in the media queries section.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3"></td><td>
Dividing 100% of the container&#8217;s width by 12 columns results in allocating 8.333% of width per column. Each cell in the 12-column table in our HTML has the <span class="monospaced">one-column</span> class selector.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4"></td><td>
Check the HTML for the 6-column grid - each cell is styled as <span class="monospaced">two-column</span> and will occupy 16.666% of the container&#8217;s width.
</td></tr>
<tr><td><img src="images/icons/callouts/5.png" alt="5"></td><td>
The HTML for the 4-column grid uses the <span class="monospaced">three-column</span> style for each cell that will use 24.999% of the container&#8217;s width.
</td></tr>
<tr><td><img src="images/icons/callouts/6.png" alt="6"></td><td>
This media query turns off the floating if the viewport is 768px or less. This will reallocate the cells vertically.
</td></tr>
<tr><td><img src="images/icons/callouts/7.png" alt="7"></td><td>
The cell should occupy the entire width of the container as opposed to, say 8.333% in the 12-column grid.
</td></tr>
<tr><td><img src="images/icons/callouts/8.png" alt="8"></td><td>
The media query for 640px won&#8217;t kick in until the viewport width goes below 640px. If you&#8217;ll resize the browser window to make it below 768px but larger than 640px, note that the 4-column grid (styled as <span class="monospaced">breakpoint-640</span>) has not changed its layout just yet.
</td></tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">In some cases you may need to use a mix of fluid and fixed layouts, for example, you may need to include an image of a fixed size on your fluid Web page. In such cases you can use a fixed width on some of the elements, and if needed, consider using CSS tables (not to be confused with HTML tables). CSS tables <a href="http://caniuse.com/css-table">are supported</a> by all current browsers.</td>
</tr></table>
</div>
<div class="paragraph"><p>Spend some time analyzing the content of index.html and styles.css files from the project named Responsive Fluid Grid. Try to modify the values in CSS and see how your changes affect the behavior of the fluid grid.In the next section we&#8217;ll apply these techniques to our Save Sick Child application.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">Twitter has developed a framework called <a href="https://github.com/twitter/bootstrap/">Bootstrap</a>, which supports <a href="http://twitter.github.com/bootstrap/scaffolding.html#fluidGridSystem">fluid grid system</a> and responsive design.</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_making_save_sick_child_responsive">Making Save Sick Child Responsive</h3>
<div class="paragraph"><p>First, run any of the previous versions of the Save Sick Child application to make sure it was not responsive. Just make the browser window narrower, and you won&#8217;t see some of the page content on the right.
We&#8217;ll make the page responsive gradually - the first version will make the header responsive, then the donation section, and, finally the entire page will become fluid. Run the Aptana&#8217;s project named Responsive Header and you&#8217;ll see a page similar to <a href="#FIG11-14">[FIG11-14]</a>.</p></div>
<div class="imageblock" id="FIG11-14">
<div class="content">
<img src="images/fig_11_14.png" alt="images/fig_11_14.png">
</div>
<div class="title">Figure 88. Responsive Header (width 580px+)</div>
</div>
<div class="paragraph"><p>Below is the fragment from index.html that&#8217;s displays the logo image and the header&#8217;s menus.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"wrapper-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;header</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row breakpoint-640"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"logo"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"four-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;img</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/img/logo.png"</span> <span style="color: #009900">alt</span><span style="color: #990000">=</span><span style="color: #FF0000">"Save Sick Child logo"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;&lt;/h1&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;nav</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"eight-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Who We Are<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>What We Do<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Where We Work<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0)"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Way To Give<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/nav&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Initially, this code uses the <span class="monospaced">four-column</span> style (<span class="monospaced">width: 33.332%;</span> of the container) for the logo and <span class="monospaced">eight-column</span> (<span class="monospaced">66.664%</span>) for the <span class="monospaced">&lt;nav&gt;</span> element. When the size of the viewport changes, the appropriate media query takes  effect. Note the <span class="monospaced">breakpoint-640</span> class selector in the <span class="monospaced">&lt;header&gt;</span> tag above. Jerry, our Web designer, decided that 640 pixels is not enough to display the logo and the four links from the <span class="monospaced">&lt;nav&gt;</span> section in one row. Besides, he wanted to fine tune the width of other elements too. This is how the media query for the 640px viewport looks like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@media only screen and (max-width: 640px) {
        .breakpoint-640 .cell {
                float: none;
                width: 100%;
                padding-bottom: 0.5em
        }

        header {
                margin-top: 1em;
        }
        #login {
                top: 1em;
        }
        #logo.four-column {
                width: 40%;
        }
        nav {
                width: 100%;
                margin-top: 0.8em
        }
        nav ul li {
                width: 24.5%;
                margin-left: 0.5%
        }
        nav li a {
                text-align: center;
                font-size: 0.6em;
        }
        #login-link-text {
                display: none;
        }
        a#login-submit {
                padding: 0.2em 0.5em
        }
        #login input {
                width: 9em;
        }
}</tt></pre></div></div>
<div class="paragraph"><p>As you see, if the <span class="monospaced">cell</span> has to be styled inside <span class="monospaced">breakdown-640</span>, the float gets turned off (<span class="monospaced">float: none;</span>) and each of the navigation items has to take 100% of the container&#8217;s width. The <span class="monospaced">logo</span>, <span class="monospaced">login</span>, and <span class="monospaced">nav</span> elements will change too. There is no exact science here - Jerry figured out all these values empirically.</p></div>
<div class="paragraph"><p>Start slowly changing the width of the viewport, and you&#8217;ll see how the layout changes.
The styles.css of this project has media queries for different viewport sizes. For example, when the page width is below 580 pixels, but more than 480 pixels it&#8217;ll look as in <a href="#FIG11-15">[FIG11-15]</a>.</p></div>
<div class="imageblock" id="FIG11-15">
<div class="content">
<img src="images/fig_11_15.png" alt="images/fig_11_15.png">
</div>
<div class="title">Figure 89. Responsive Header 2 (width between 480 and 580px )</div>
</div>
<div class="paragraph"><p>When the width shrinks to 480px, the header looks as in <a href="#FIG11-16">[FIG11-16]</a>. Once again, we are not tying the design to the specific device, but rather to a viewport width. The iPhone 4 will render this page using the layout shown at &lt;&lt;&gt;FIG11-16&gt;, but iPhone 5 will use the layout from <a href="#FIG11-15">[FIG11-15]</a>. You can&#8217;t go by a device type.</p></div>
<div class="imageblock" id="FIG11-16">
<div class="content">
<img src="images/fig_11_16.png" alt="images/fig_11_16.png">
</div>
<div class="title">Figure 90. Responsive Header (width below 480px)</div>
</div>
<div class="paragraph"><p>The next version of the Aptana project to try is called Responsive Donation. This version make the donation section fluid. The donation section contains the Lorem Ipsum text and the form, which is revealed when the user clicks the button Donate. First, let&#8217;s look at the HTML. The index.html contains the following fragment (some of the content that irrelevant for layout was removed for better readability):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-content"</span> <span style="color: #009900">role</span><span style="color: #990000">=</span><span style="color: #FF0000">"main"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
 <span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-top-section"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row breakpoint-480"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-address"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"seven-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-address"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                Lorem ipsum dolor sit amet              <span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;button</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-button"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-button"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;span</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-button-header"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Donate Now<span style="font-weight: bold"><span style="color: #0000FF">&lt;/span&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/button&gt;</span></span>

   <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donate-form-container"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Make a donation today<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"_xclick"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"https://www.paypal.com/cgi-bin/webscr"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"post"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

          <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row nested breakpoint-960"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"six-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                  <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row nested"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-amount"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"five-column left"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"donation-heading"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Donation amount<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"amount"</span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"d10"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;label</span></span> <span style="color: #009900">for</span><span style="color: #990000">=</span><span style="color: #FF0000">"d10"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>10<span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"donor-info"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"five-column left"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The donation section is located in the <span class="monospaced">main-top-section</span> of the page. Jerry wanted to keep the image of the boy visible for as long as possible on the narrower viewports. The top section of the Save Sick Child has two backgrounds: the flowers (bg-2.png) and the boy (child-1.png). This is how they are specified in the style.css:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>#main-top-section {
        background: url(../img/child-1.png) no-repeat right bottom,
                    url(../img/bg-2.png) no-repeat 20% bottom;
}</tt></pre></div></div>
<div class="paragraph"><p>If the viewport is wide enough, both backgrounds will be shown. What&#8217;s wide enough? Jerry figured it out after experimenting. The <span class="monospaced">seven-column</span> style prescribes to allocate more than a half (58.331%) of the viewport width for the <span class="monospaced">donation-address</span> section and <span class="monospaced">six-column</span> (49.998%) for the donation form.  For example <a href="#FIG11-17">[FIG11-17]</a> shows how the donation section will look when the viewport width is 570px.</p></div>
<div class="imageblock" id="FIG11-17">
<div class="content">
<img src="images/fig_11_17.png" alt="images/fig_11_17.png">
</div>
<div class="title">Figure 91. Responsive Donate Section: 570px</div>
</div>
<div class="paragraph"><p>But when the width become less then 480px, there is no room for two background images, and only the flowers will remain on the page background. The media query for 480px viewport is shown next - note that the background in the main top section has only one image now: bg2.png. Floating is off to show the navigation menu vertically as in <a href="#FIG11-18">[FIG11-18]</a>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@media only screen and (max-width: 480px) {
        .breakpoint-480 .cell {
                float: none;
                width: 100%;
                padding-bottom: 0.5em
        }
        #logo {
                padding-bottom: 11em
        }
        nav ul li {
                float: none;
                width: 100%;
                margin-left: 0;
                margin-bottom: 0.5%;
        }
        #main-top-section {
                background: url(../img/bg-2.png) no-repeat 20% bottom;
        }
        .donate-button {
                width: 14em;
                margin-left: auto;
                margin-right: auto;
        }
        .donate-button-header {
                font-size: 1.1em;
        }
        .donate-2nd-line {
                font-size: 0.9em;
        }
        #donate-later-link {
                display: block;
                width: 11em;
                margin-left: auto;
                margin-right: auto;
        }
        #make-payment p {
                width: 100%;
        }
        #donation-amount.five-column {
                width: 50%
        }
        #donor-info.six-column {
                width: 50%
        }
        #donate-form-container select, input[type=text], input[type=email] {
                width: 90%;
        }
}</tt></pre></div></div>
<div class="imageblock" id="FIG11-18">
<div class="content">
<img src="images/fig_11_18.png" alt="images/fig_11_18.png">
</div>
<div class="title">Figure 92. Responsive Donate Section under 480px</div>
</div>
<div class="paragraph"><p>The Aptana project Responsive Final includes the charts, maps, and video. Each of these sections uses <span class="monospaced">four-column</span> style, which is defined in styles.css as 33.332% of the container&#8217;s width.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;section</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"main-bottom-section"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"row breakpoint-768"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"charts-container"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"four-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;svg</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"svg-container"</span>  <span style="color: #009900">xmlns</span><span style="color: #990000">=</span><span style="color: #FF0000">"http://www.w3.org/2000/svg"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>

                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/svg&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Donation Stats<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h5&gt;</span></span>Lorem ipsum dolor sit amet, consect.<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h5&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"map-container"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"four-column cell"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"location-map"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"location-ui"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"video-container"</span> <span style="color: #009900">class</span><span style="color: #990000">=</span><span style="color: #FF0000">"four-column cell last"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;div</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"video-wrapper"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;video</span></span> <span style="color: #009900">id</span><span style="color: #990000">=</span><span style="color: #FF0000">"movie"</span> <span style="color: #009900">controls</span><span style="color: #990000">=</span><span style="color: #FF0000">"controls"</span> <span style="color: #009900">poster</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/media/intro.jpg"</span>
                                                                        <span style="color: #009900">preload</span><span style="color: #990000">=</span><span style="color: #FF0000">"metadata"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/media/intro.mp4"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"video/mp4"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"assets/media/intro.webm"</span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"video/webm"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
                                <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>Sorry, your browser doesn't support the video element<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
                        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/video&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h3&gt;</span></span>Video header goes here<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h3&gt;</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">&lt;h5&gt;&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"javascript:void(0);"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>More video link<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/h5&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/div&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/section&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>The id of this section is still <span class="monospaced">main-bottom-section</span>, and it&#8217;s shown at the bottom of the page on wide viewports. Now take another look at the image <a href="#FIG11-9">[FIG11-9]</a>. Jerry wants to display these three sections at the right hand side for tablets in the portrait mode, and it&#8217;s shown on <a href="#FIG11-19">[FIG11-19]</a>.</p></div>
<div class="imageblock" id="FIG11-19">
<div class="content">
<img src="images/fig_11_19.png" alt="images/fig_11_19.png">
</div>
<div class="title">Figure 93. The Portrait Mode on Tablets</div>
</div>
<div class="paragraph"><p>The relevant code from the style.css is shown below.The top and bottom sections get about a half of the width each, and the floating is turned off so the browser would allocate charts, maps, and video vertically.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>@media only screen and (max-width: 768px) {
        .breakpoint-768 .cell {
                float: none;
                width: 100%;
                padding-bottom: 0.5em;
        }

        #main-bottom-section, #main-top-section {
                width: 49%;
        }</tt></pre></div></div>
<div class="sect3">
<h4 id="_fluid_media">Fluid Media</h4>
<div class="paragraph"><p>If you responsive Web page contains images or videos, you want to make them fluid too - they should react to the current size of the containers they are in. Our page has a chart image and a video - both of them are made flexible, but we use different techniques.</p></div>
<div class="paragraph"><p>If you&#8217;ll keep narrowing the viewport, the project Responsive Final will show the page with the layout similar to <a href="#FIG11-10">[FIG11-10]</a>. While reading the code of this project, visit the main.js file. There is some work done in the JavaScript too, which listens to the resize event for the charts container.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>window<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addEventListener</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"resize"</span><span style="color: #990000">,</span> windowResizeHandler<span style="color: #990000">);</span>
<span style="font-weight: bold"><span style="color: #0000FF">function</span></span> <span style="font-weight: bold"><span style="color: #000000">windowResizeHandler</span></span><span style="color: #990000">()</span> <span style="color: #FF0000">{</span>
        <span style="font-weight: bold"><span style="color: #000000">drawPieChart</span></span><span style="color: #990000">(</span>document<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getElementById</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'svg-container'</span><span style="color: #990000">),</span>
                         donorsDataCache<span style="color: #990000">,</span> labelsDataCache<span style="color: #990000">);</span>
<span style="color: #FF0000">}</span></tt></pre></div></div>
<div class="paragraph"><p>Whenever the size changes, it invokes the function <span class="monospaced">drawPieChart()</span> that recalculates the width of the SVG container (it uses the <span class="monospaced">clientWidth</span> property of the <span class="monospaced">HTMLElement</span> ) and re-draws the chart accordingly.</p></div>
<div class="paragraph"><p>The video is flexible too, and it&#8217;s done a lot simpler. We do not specify the fixed size of the video, but use a CSS property <span class="monospaced">width</span> instructing the browser to allocate the 100% of the available container&#8217;s width.The height of the video must be  be automatically calculated to keep the proportional size.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>video {
        width: 100% !important;
        height: auto !important;
}</tt></pre></div></div>
<div class="paragraph"><p>The <span class="monospaced">!important</span> part disables regular cascading rules and ensures that these values will be applied overriding more specific width or height declarations, if any. If you prefer not always use the entire width of the container for the video, you can use the <span class="monospaced">max-width: 100%;</span>, which will display the video that fits in the container at its original size. If a video is larger than the container, the browser will resize it to fit inside the container.</p></div>
<div class="paragraph"><p>While the landing Web page of your application simply includes links to the required images, the rest of the images should be loaded from the server by making AJAX requests with passing parameter regarding the viewport size. This way the server&#8217;s software can either resize images dynamically and include them as base-64 encoded strings or use pre-created properly sized images depending on the viewport dimensions.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">While using base-64 encoding increases the total size of the image in bytes, it allows you to group together multiple images to minimize the number of network calls the browser needs to make to retrieve these images separately. The other way to combine multiple images into one is CSS sprites.</td>
</tr></table>
</div>
<div class="paragraph"><p>Regardless of what the width and height of the image is, use tools to reduce image sizes in bytes. Some of such tools are <a href="http://tinypng.org/">TinyPNG</a> or <a href="http://www.smushit.com/ysmush.it/">Smush.it</a>. If you use <em>lossy</em> tools, some of the image data will be lost during compression, but in many cases the difference between the original and compressed image is invisible.</p></div>
<div class="paragraph"><p>Besides making images responsive, keep in mind that some people have mobile devices with high resolution retina displays. The problem is that to make an image look good on such displays its size has to be large, which increases its loading time. There is no common recipe for doing the image size optimization properly - plan to spend an extra time just to preparing the images for your application.</p></div>
<div class="paragraph"><p>There is a living W3C document titled <a href="http://picture.responsiveimages.org/">An HTML extension for adaptive images</a> that will provide developers with a means to declare multiple sources for an image. The proposed  HTML element <span class="monospaced">&lt;picture&gt;</span> will allow to specify different images for different media (see <a href="http://responsiveimages.org/demos/">demos</a>), for example:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;picture</span></span> <span style="color: #009900">width</span><span style="color: #990000">=</span><span style="color: #FF0000">"500"</span> <span style="color: #009900">height</span><span style="color: #990000">=</span><span style="color: #FF0000">"500"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">media</span><span style="color: #990000">=</span><span style="color: #FF0000">"(min-width: 45em)"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"large.jpg"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">media</span><span style="color: #990000">=</span><span style="color: #FF0000">"(min-width: 18em)"</span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"med.jpg"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;source</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"small.jpg"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
   <span style="font-weight: bold"><span style="color: #0000FF">&lt;img</span></span> <span style="color: #009900">src</span><span style="color: #990000">=</span><span style="color: #FF0000">"small.jpg"</span> <span style="color: #009900">alt</span><span style="color: #990000">=</span><span style="color: #FF0000">""</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/picture&gt;</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_7">Summary</h3>
<div class="paragraph"><p>Authors of this book have different opinions about the merits of responsive design. One of us simply stated, "I haven&#8217;t seen complex single-code-base applications that work well on Android, iPhone, and desktop browsers". The other responded "We need to compromise". With browser plugins like Flash Player or Silverlight you can choose pixel-perfect design. Just set a pre-requisite: the user must have a 1024x768 viewport minus chrome and margins. But if you&#8217;ll need to make this application work on highly fragmented Android market, on all iPhones, Blackberies, desktops, and other devices, ask yourself a simple question, "Do we have money to hire two or three teams for developing and supporting several versions of the application for different devices or we&#8217;d rather compromise, and push the HTML5-based product out the door?"</p></div>
<div class="paragraph"><p>Each enterprise project has a limited budget, and if you&#8217;ll agree to compromise and move away from the pixel-perfect world accepting the fact that the Donate button will look a little bit different on different devices, go with the responsive design principles and have one code base. You&#8217;ll provide different CSS sections that will automatically apply different layouts based on the viewport size, and the HTML markup and JavaScript will be the same. This approach has drawbacks because some portions of unnecessary CSS will be loaded to the user&#8217;s device, but this still can be a practical business solution.</p></div>
<div class="paragraph"><p>On the other hand, using the same code and design for different platforms works perfectly only for  publishing information and not for all Web applications. If you need to publish the information using different layout managers, responsive design is a good fit. Mobile applications could be compiled either into the native code or into some byte code that performs close to the native one. But the UI could be different based on the available screen real estate and use touch interface.</p></div>
<div class="paragraph"><p>If you&#8217;ll take any framework that works on both desktop and mobile devices, you&#8217;ll get two sets of controls and the need to maintain two different source code bases. Not using mobile JavaScript frameworks limits the number of user-friendly UI controls. Besides, frameworks spare you from dealing with browsers incompatibilities.</p></div>
<div class="paragraph"><p>In this chapter you&#8217;ve seen how the Save Sick Child application (not a publishing site) was built with responsive design principles. We have several areas (<span class="monospaced">&lt;div&gt;'s</span>) and one of them include a donation form (we could have added the responsive <span class="monospaced">&lt;div&gt;</span> with the online auction too). On the wide screen we  displayed three  of these <span class="monospaced">&lt;div&gt;'s</span>  horizontally and two underneath, on the narrow screen each of these sections could scaled down and displayed one under another.</p></div>
<div class="paragraph"><p>But using responsive design for styles application that must run on a tablets or mobile devices will require Jerry-the-designer to work in tandem with the User Experience specialist so that UI will have larger controls and fonts, minimize the need of manual data entry. And don&#8217;t forget that half of the mobile screen could be covered by a virtual keyboard, and if you ignore this, the user will have to work with your UI via a keyhole, and even our fluid  <span class="monospaced">&lt;div&gt;'s</span> may not fit.</p></div>
<div class="paragraph"><p>In the next two chapters we&#8217;ll be working on yet another version of Save Sick Child. First, it&#8217;s going to be done with the jQuery Mobile framework and then with Sencha Touch.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hybrid_applications_html_native_api">Hybrid Applications: HTML + Native API</h2>
<div class="sectionbody">
<div class="paragraph"><p>Both Web and native applications have their pros and cons. Let&#8217;s start with some of the examples of the native applications that exist today.</p></div>
<div class="paragraph"><p>Bank of America&#8217;s native mobile application allows you to deposit checks by taking a photo of the front and back sides of the check and entering the amount. At the time of this writing, they support iPhones, Android, Windows phones, and iPads.</p></div>
<div class="paragraph"><p>Near Field Communication (NFC) technology allows NFC-enabled devices communicate with each other in close distance using radio frequencies. NFC can be used for payments (no need to enter passwords) and data sharing (contacts, photos, et al.). Proliferation of NFC in banking will seriously hurt the credit cards industry. A number of smartphones already support NFC technology (see <a href="http://www.nfcworld.com/nfc-phones-list/">http://www.nfcworld.com/nfc-phones-list</a>). Add one of the existing fingerprint biometrics solutions, and your mobile phone becomes your wallet.</p></div>
<div class="paragraph"><p>While native applications have full access to all hardware of the device (e.g. camera, microphone, et al.), they have drawbacks too. For instance, if you want to publish your application at Apple&#8217;s App Store you have to submit your application in advance and wait for an approval. If a crucial bug is found in your application, even though if you could fix it in a day, you can&#8217;t put a new version in production until it went through an approval process. Back in 2011 Financial Times (FT) decided to stop using their native iOS application because Apple wouldn&#8217;t share the data about FT subscribers. Don&#8217;t forget that Apple would get their own cut from each FT subscription.</p></div>
<div class="paragraph"><p>On one hand it&#8217;s good to have an ability to publish your latest Web applications on your own servers without the need to ask for a permission. On the other hand, the presence on Apple&#8217;s iTunes is a good channel for bringing new customers. The publisher of New York magazine is heavily investing into their native application for iPad but the newer versions of their Web applications are as engaging as their native piers. If you Web application has to be discoverable and visible by search engines, Web application are definitely better.</p></div>
<div class="paragraph"><p>The <em>hybrid applications</em> promise you to have the best of both worlds. A Web application written in HTML/JavaScript has access to the hardware of the mobile device via a third-party library such as PhoneGap.The PhoneGap recompiles HTML/JavaScript code to create a platform specific application with an embedded Web browser, where your HTML/JavaScript code will run. This embedded browser (a.k.a. Web View) is chrome-less and your application is getting access to full size of the device screen.</p></div>
<div class="paragraph"><p>The PhoneGap packaging tool takes your HTML/JavaScript/CSS code, compiles it for the required mobile platform and create a native application that has access to the native functionality of hardware, for example, if you need to deploy it under iOS, you&#8217;ll get an IPA file, and for deployment on Android devices you&#8217;d be getting an APK file. The hybrid applications may be not as fast as the native ones, and the architects responsible for defining mobile enterprise strategy must setting their priorities.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>If a particular application will be used only by the employees of the organization who will use limited and defined number of mobile devices, and if making employees productive is the main goal - develop native applications. Start with developing and deploying such an application for the pilot OS (typically iOS 6 or Android 4), and then gradually add support for more  platforms, budget permitting. If you are planning to develop a Web application with relatively simple UI (e.g. Save Sick Child) and have to support a wide variety of unknown consumer devices (e.g. allow people make donation from any device) - develop a HTML5 Web application.</pre>
</div></div>
<div class="paragraph"><p>Consider developing a hybrid application for anything in between, and in this chapter we&#8217;ll create a hybrid version of our Save Sick Child application with <a href="http://phonegap.com/">PhoneGap</a> framework. To be more specific, we&#8217;ll access the location services of the smartphone and will use the PhoneGap PayPal plugin to process donations.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/tip.png" alt="Tip">
</td>
<td class="content">For current list of available PhoneGap plugins for various mobile platforms visit the github repository at <a href="https://github.com/phonegap/phonegap-plugins">https://github.com/phonegap/phonegap-plugins</a>.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_what_8217_s_phonegap">What&#8217;s PhoneGap</h3>
<div class="paragraph"><p>First of all, PhoneGap is not a competitor of such JavaScript frameworks as jQuery, Ext JS, AngularJS, Ember.js and the like. PhoneGap is a technology for creating an application container can run code written with or without using these frameworks, and its main goal is to provide the JavaScript API for getting access to the hardware of mobile devices as well as the build tool for its subscribers.</p></div>
<div class="sidebarblock">
<div class="content">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note">
</td>
<td class="content">PhoneGap is a brand own by Adobe. Apache Foundation has an open source project called Cordova, which started from the code donated by Adobe to Apache. Lots of developers from around the world work on Cordova, but Adobe&#8217;s using this library to create their own way of compiling and distributing mobile applications, which is branded as PhoneGap. The closest analogy is the  Chrome and Safari browsers built on the same open source rendering engine Webkit.</td>
</tr></table>
</div>
</div></div>
<script type="text/javascript">

var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-36390249-1"]);_gaq.push(["_setDomainName","enterprisewebbook.com"]);_gaq.push(["_trackPageview"]);(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()

</script>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-02-12 14:10:39 EST
</div>
</div>
</body>
</html>
